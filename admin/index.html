<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Mind Core Fitness</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../js/dashboard-styles.css">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../Logo.PNG">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../Logo.PNG" alt="Mind Core Fitness">
                <h2>Mind Core Fitness</h2>
            </div>

            <nav class="sidebar-nav">
                <a class="nav-item active" data-section="overview">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Overview
                </a>
                <a class="nav-item" data-section="availability">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    Availability
                </a>
                <a class="nav-item" data-section="clients">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Clients
                </a>
                <a class="nav-item" data-section="calendar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Calendar
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">R</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Ross</div>
                        <div class="user-role">Admin</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn" onclick="window.location.href='login.html'">Sign Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Overview Section -->
            <section class="dashboard-section active" id="section-overview">
                <header class="dashboard-header">
                    <h1>Dashboard Overview</h1>
                </header>

                <div class="dashboard-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statClients">0</div>
                            <div class="stat-label">Active Clients</div>
                        </div>
                        <div class="stat-card accent">
                            <div class="stat-value" id="statBookingsToday">0</div>
                            <div class="stat-label">Sessions Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statBookingsWeek">0</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUpcoming">0</div>
                            <div class="stat-label">Upcoming</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Today's Schedule</h3>
                            <span id="todayDate"></span>
                        </div>
                        <div class="card-body">
                            <div class="booking-list" id="todayBookings">
                                <div class="empty-state">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    <h4>No sessions scheduled</h4>
                                    <p>Your day is free!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Availability Section -->
            <section class="dashboard-section" id="section-availability">
                <header class="dashboard-header">
                    <h1>Your Availability</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="saveAvailability" disabled>Save Changes</button>
                    </div>
                </header>

                <div class="dashboard-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Weekly Schedule</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Click a day to set your available hours</p>
                        </div>
                        <div class="card-body">
                            <div class="availability-grid" id="availabilityGrid">
                                <!-- Days will be generated by JS -->
                            </div>

                            <div id="timeEditor" style="display: none; margin-top: 24px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                                <h4 style="font-family: 'Montserrat', sans-serif; margin-bottom: 16px;">
                                    Set hours for <span id="selectedDayName"></span>
                                </h4>
                                <div class="time-input-group">
                                    <input type="time" id="startTime" value="09:00">
                                    <span>to</span>
                                    <input type="time" id="endTime" value="17:00">
                                    <button class="btn btn-success btn-sm" id="applyTime" disabled>Apply</button>
                                    <button class="btn btn-danger btn-sm" id="removeDay" disabled>Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3>Block Specific Times</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-muted); margin-bottom: 16px;">Need to block off time for a specific date? (e.g., holiday, appointment)</p>
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Date</label>
                                    <input type="date" id="blockDate" disabled>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Time Range</label>
                                    <div class="time-input-group" style="margin-top: 0;">
                                        <input type="time" id="blockStartTime" value="09:00" disabled>
                                        <span>to</span>
                                        <input type="time" id="blockEndTime" value="17:00" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                                <label>Reason (optional)</label>
                                <input type="text" id="blockReason" placeholder="e.g., Doctor's appointment" disabled>
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 16px;" id="addBlockedTime" disabled>Block This Time</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clients Section -->
            <section class="dashboard-section" id="section-clients">
                <header class="dashboard-header">
                    <h1>Manage Clients</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addClientBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Client
                        </button>
                    </div>
                </header>

                <div class="dashboard-content">
                    <div class="dashboard-card">
                        <div class="card-body">
                            <div class="client-list" id="clientList">
                                <div class="empty-state">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <h4>No clients yet</h4>
                                    <p>Add your first client to get started</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calendar Section -->
            <section class="dashboard-section" id="section-calendar">
                <header class="dashboard-header">
                    <h1>Booking Calendar</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addBookingBtn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Booking
                        </button>
                    </div>
                </header>

                <div class="dashboard-content">
                    <div class="calendar-container dashboard-card">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth">&lt;</button>
                            </div>
                            <h3 id="calendarMonth">February 2025</h3>
                            <div class="calendar-nav">
                                <button id="nextMonth">&gt;</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated by JS -->
                        </div>
                    </div>

                    <div class="dashboard-card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3>Selected Day: <span id="selectedDateDisplay">-</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="booking-list" id="selectedDayBookings">
                                <div class="empty-state">
                                    <p>Select a day to see bookings</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Mobile Sidebar Toggle -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="clientModalTitle">Add New Client</h3>
                <button class="modal-close" id="closeClientModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="clientName" required placeholder="John Smith">
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="clientEmail" required placeholder="john@example.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Block Duration</label>
                            <select id="clientBlockDuration">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Block End Date</label>
                            <input type="date" id="clientBlockEndDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Number of Sessions</label>
                        <input type="number" id="clientSessions" min="1" placeholder="e.g. 10">
                    </div>

                    <input type="hidden" id="clientId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClientBtn">Cancel</button>
                <button class="btn btn-primary" id="saveClientBtn">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Add Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Booking</h3>
                <button class="modal-close" id="closeBookingModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="form-group">
                        <label>Client *</label>
                        <select id="bookingClient" required>
                            <option value="">Select a client</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="bookingDate" required>
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <select id="bookingDuration">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Available Time Slots</label>
                        <div class="time-slots-grid" id="availableSlots">
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Select a date to see available slots</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="bookingNotes" rows="2" placeholder="Any notes for this session..."></textarea>
                    </div>

                    <input type="hidden" id="selectedSlot">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBookingBtn">Cancel</button>
                <button class="btn btn-primary" id="saveBookingBtn">Create Booking</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="../js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let currentMonth = new Date();
            let clients = [];

            // Toast notification
            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = '/dashboard/login.html';
                    return;
                }

                const role = await getUserRole(user.uid);
                if (role !== 'admin') {
                    window.location.href = '/dashboard/index.html';
                    return;
                }

                const userData = await getUserData(user.uid);
                if (userData) {
                    document.getElementById('userName').textContent = userData.name || 'Admin';
                    document.getElementById('userAvatar').textContent = (userData.name || 'A')[0].toUpperCase();
                }

                // Load clients after auth confirmed
                loadClients();
                updateStats();
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => logout());

            // Set today's date
            const today = new Date();
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // ==================
            // CLIENTS
            // ==================
            async function loadClients() {
                try {
                    const snapshot = await db.collection('users').where('role', '==', 'client').get();
                    clients = [];
                    snapshot.forEach(doc => {
                        clients.push({ id: doc.id, ...doc.data() });
                    });
                    renderClientList();
                    updateStats();
                } catch (error) {
                    console.error('Error loading clients:', error);
                    showToast('Failed to load clients', 'error');
                }
            }

            function renderClientList() {
                const container = document.getElementById('clientList');

                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                            </svg>
                            <h4>No clients yet</h4>
                            <p>Add your first client to get started</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = clients.map(client => `
                    <div class="client-item" data-id="${client.id}">
                        <div class="client-avatar">${(client.name || 'C')[0].toUpperCase()}</div>
                        <div class="client-info">
                            <div class="client-name">${client.name || 'Unknown'}</div>
                            <div class="client-email">${client.email}</div>
                        </div>
                        <div class="client-meta">
                            <span class="client-duration">${client.blockDuration || 60} min</span>
                            ${client.blockEndDate ? `<span class="client-end">Until ${new Date(client.blockEndDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</span>` : ''}
                        </div>
                        <div class="client-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editClient('${client.id}')">Edit</button>
                        </div>
                    </div>
                `).join('');
            }

            // Add Client Modal
            document.getElementById('addClientBtn').addEventListener('click', () => {
                document.getElementById('clientModalTitle').textContent = 'Add New Client';
                document.getElementById('clientForm').reset();
                document.getElementById('clientId').value = '';
                // Set default end date to 3 months from now
                const defaultEnd = new Date();
                defaultEnd.setMonth(defaultEnd.getMonth() + 3);
                document.getElementById('clientBlockEndDate').value = defaultEnd.toISOString().split('T')[0];
                document.getElementById('clientModal').classList.add('show');
            });

            // Save Client
            document.getElementById('saveClientBtn').addEventListener('click', async () => {
                const name = document.getElementById('clientName').value.trim();
                const email = document.getElementById('clientEmail').value.trim();
                const blockDuration = parseInt(document.getElementById('clientBlockDuration').value);
                const blockEndDate = document.getElementById('clientBlockEndDate').value;
                const totalSessions = parseInt(document.getElementById('clientSessions').value) || 0;
                const clientId = document.getElementById('clientId').value;

                if (!name || !email) {
                    showToast('Please fill in name and email', 'error');
                    return;
                }

                const saveBtn = document.getElementById('saveClientBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    if (clientId) {
                        // Update existing client
                        await db.collection('users').doc(clientId).update({
                            name,
                            email,
                            blockDuration,
                            blockEndDate,
                            totalSessions,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast('Client updated successfully');
                    } else {
                        // Try Cloud Function first (creates Auth user + Firestore doc)
                        let cloudFunctionWorked = false;

                        try {
                            const functions = firebase.functions();
                            const createClientFn = functions.httpsCallable('createClient');

                            const result = await createClientFn({
                                name,
                                email,
                                blockDuration,
                                blockEndDate,
                                totalSessions
                            });

                            if (result.data.success) {
                                cloudFunctionWorked = true;
                                showToast(`Client created! Password reset email sent to ${email}`);
                            }
                        } catch (cfError) {
                            console.log('Cloud Function not available, using fallback:', cfError.message);
                        }

                        // Fallback: Create Firestore document only if Cloud Function failed
                        if (!cloudFunctionWorked) {
                            // Create user document in Firestore
                            const newUserRef = db.collection('users').doc();
                            await newUserRef.set({
                                name,
                                email,
                                role: 'client',
                                blockDuration,
                                blockEndDate,
                                totalSessions,
                                sessionsUsed: 0,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                needsPasswordSetup: true,
                                onboardingComplete: false
                            });

                            // Note: Without Cloud Functions, we can't create Firebase Auth user
                            // The client will need to be set up manually or Cloud Functions deployed
                            showToast(`Client added to database. Note: Deploy Cloud Functions to enable automatic login setup, or manually create their Firebase Auth account.`, 'warning');
                        }
                    }

                    document.getElementById('clientModal').classList.remove('show');
                    loadClients();
                } catch (error) {
                    console.error('Error saving client:', error);
                    showToast('Failed to save client: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Client';
                }
            });

            // Edit client function (global)
            window.editClient = async (id) => {
                const client = clients.find(c => c.id === id);
                if (!client) return;

                document.getElementById('clientModalTitle').textContent = 'Edit Client';
                document.getElementById('clientId').value = id;
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientBlockDuration').value = client.blockDuration || 60;
                document.getElementById('clientBlockEndDate').value = client.blockEndDate || '';
                document.getElementById('clientSessions').value = client.totalSessions || '';

                document.getElementById('clientModal').classList.add('show');
            };

            // Update stats
            async function updateStats() {
                document.getElementById('statClients').textContent = clients.length;

                // Get today's bookings
                const todayStr = today.toISOString().split('T')[0];
                try {
                    const bookingsToday = await db.collection('bookings')
                        .where('date', '==', todayStr)
                        .get();
                    document.getElementById('statBookingsToday').textContent = bookingsToday.size;

                    // Get this week's bookings
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const bookingsWeek = await db.collection('bookings')
                        .where('date', '>=', weekStart.toISOString().split('T')[0])
                        .where('date', '<=', weekEnd.toISOString().split('T')[0])
                        .get();
                    document.getElementById('statBookingsWeek').textContent = bookingsWeek.size;

                    // Get all upcoming bookings
                    const upcoming = await db.collection('bookings')
                        .where('date', '>=', todayStr)
                        .get();
                    document.getElementById('statUpcoming').textContent = upcoming.size;
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            // ==================
            // NAVIGATION
            // ==================
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
                    document.getElementById('section-' + section).classList.add('active');
                    document.getElementById('sidebar').classList.remove('open');

                    if (section === 'calendar') renderCalendar();
                    else if (section === 'availability') renderAvailabilityGrid();
                    else if (section === 'clients') loadClients();
                });
            });

            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // ==================
            // AVAILABILITY
            // ==================
            function renderAvailabilityGrid() {
                const grid = document.getElementById('availabilityGrid');
                grid.innerHTML = DAYS.map((day, i) => `
                    <div class="day-card" data-day="${i}">
                        <div class="day-name">${DAYS_SHORT[i]}</div>
                        <div class="day-times">Not set</div>
                    </div>
                `).join('');
            }
            renderAvailabilityGrid();

            // ==================
            // CALENDAR
            // ==================
            function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();

                document.getElementById('calendarMonth').textContent =
                    currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

                let html = DAYS_SHORT.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay();

                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = startDay - 1; i >= 0; i--) {
                    html += `<div class="calendar-day other-month"><span class="calendar-date">${prevMonthLastDay - i}</span></div>`;
                }

                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const isToday = date.toDateString() === today.toDateString();
                    const dateStr = date.toISOString().split('T')[0];
                    html += `
                        <div class="calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}">
                            <span class="calendar-date">${day}</span>
                        </div>
                    `;
                }

                const remainingDays = 42 - (startDay + lastDay.getDate());
                for (let day = 1; day <= remainingDays; day++) {
                    html += `<div class="calendar-day other-month"><span class="calendar-date">${day}</span></div>`;
                }

                grid.innerHTML = html;

                grid.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
                    day.addEventListener('click', function() {
                        const date = this.dataset.date;
                        if (date) {
                            document.getElementById('selectedDateDisplay').textContent =
                                new Date(date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
                        }
                    });
                });
            }

            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            renderCalendar();

            // Modal close handlers
            document.getElementById('closeClientModal').addEventListener('click', () => {
                document.getElementById('clientModal').classList.remove('show');
            });
            document.getElementById('cancelClientBtn').addEventListener('click', () => {
                document.getElementById('clientModal').classList.remove('show');
            });
            document.getElementById('closeBookingModal').addEventListener('click', () => {
                document.getElementById('bookingModal').classList.remove('show');
            });
            document.getElementById('cancelBookingBtn').addEventListener('click', () => {
                document.getElementById('bookingModal').classList.remove('show');
            });

            // ==================
            // BOOKING FUNCTIONALITY
            // ==================

            // Enable the Add Booking button
            document.getElementById('addBookingBtn').disabled = false;

            // Open booking modal
            document.getElementById('addBookingBtn').addEventListener('click', () => {
                // Populate client dropdown
                const clientSelect = document.getElementById('bookingClient');
                clientSelect.innerHTML = '<option value="">Select a client</option>';
                clients.forEach(client => {
                    clientSelect.innerHTML += `<option value="${client.id}" data-duration="${client.blockDuration || 60}">${client.name || client.email}</option>`;
                });

                // Set default date to today
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('bookingDate').value = todayStr;
                document.getElementById('bookingDate').min = todayStr;

                // Reset form
                document.getElementById('bookingNotes').value = '';
                document.getElementById('selectedSlot').value = '';
                document.getElementById('availableSlots').innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">Select a date to see available slots</p>';

                // Generate initial time slots
                generateTimeSlots(todayStr);

                document.getElementById('bookingModal').classList.add('show');
            });

            // When client is selected, update duration default
            document.getElementById('bookingClient').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.duration) {
                    document.getElementById('bookingDuration').value = selectedOption.dataset.duration;
                }
                // Regenerate slots with new duration
                const dateVal = document.getElementById('bookingDate').value;
                if (dateVal) generateTimeSlots(dateVal);
            });

            // When date changes, regenerate time slots
            document.getElementById('bookingDate').addEventListener('change', function() {
                generateTimeSlots(this.value);
            });

            // When duration changes, regenerate time slots
            document.getElementById('bookingDuration').addEventListener('change', function() {
                const dateVal = document.getElementById('bookingDate').value;
                if (dateVal) generateTimeSlots(dateVal);
            });

            // Generate available time slots
            async function generateTimeSlots(dateStr) {
                const slotsContainer = document.getElementById('availableSlots');
                slotsContainer.innerHTML = '<p style="color: var(--text-muted);">Loading slots...</p>';

                const duration = parseInt(document.getElementById('bookingDuration').value) || 60;

                // Define working hours (can be made configurable later)
                const workingHours = { start: 6, end: 21 }; // 6 AM to 9 PM

                // Get existing bookings for this date
                let existingBookings = [];
                try {
                    const snapshot = await db.collection('bookings')
                        .where('date', '==', dateStr)
                        .get();
                    existingBookings = snapshot.docs.map(doc => doc.data());
                } catch (error) {
                    console.error('Error loading existing bookings:', error);
                }

                // Generate slots
                const slots = [];
                for (let hour = workingHours.start; hour < workingHours.end; hour++) {
                    for (let minute of [0, 30]) {
                        const slotStart = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const slotEndMinutes = hour * 60 + minute + duration;
                        const slotEndHour = Math.floor(slotEndMinutes / 60);
                        const slotEndMin = slotEndMinutes % 60;

                        // Don't show slots that would extend past working hours
                        if (slotEndHour > workingHours.end) continue;

                        // Check if slot conflicts with existing bookings
                        const slotStartMinutes = hour * 60 + minute;
                        const isBooked = existingBookings.some(booking => {
                            const [bHour, bMin] = booking.time.split(':').map(Number);
                            const bookingStart = bHour * 60 + bMin;
                            const bookingEnd = bookingStart + (booking.duration || 60);
                            // Check for overlap
                            return (slotStartMinutes < bookingEnd && slotEndMinutes > bookingStart);
                        });

                        slots.push({
                            time: slotStart,
                            endTime: `${slotEndHour.toString().padStart(2, '0')}:${slotEndMin.toString().padStart(2, '0')}`,
                            isBooked
                        });
                    }
                }

                if (slots.length === 0) {
                    slotsContainer.innerHTML = '<p style="color: var(--text-muted);">No available slots for this date</p>';
                    return;
                }

                slotsContainer.innerHTML = slots.map(slot => `
                    <button type="button" class="time-slot ${slot.isBooked ? 'booked' : ''}"
                            data-time="${slot.time}"
                            ${slot.isBooked ? 'disabled' : ''}>
                        ${formatTime12Hour(slot.time)}
                    </button>
                `).join('');

                // Add click handlers to slots
                slotsContainer.querySelectorAll('.time-slot:not(.booked)').forEach(btn => {
                    btn.addEventListener('click', function() {
                        slotsContainer.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('selectedSlot').value = this.dataset.time;
                    });
                });
            }

            // Format time to 12-hour format
            function formatTime12Hour(time24) {
                const [hours, minutes] = time24.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const hours12 = hours % 12 || 12;
                return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
            }

            // Save booking
            document.getElementById('saveBookingBtn').addEventListener('click', async () => {
                const clientId = document.getElementById('bookingClient').value;
                const dateVal = document.getElementById('bookingDate').value;
                const duration = parseInt(document.getElementById('bookingDuration').value);
                const timeVal = document.getElementById('selectedSlot').value;
                const notes = document.getElementById('bookingNotes').value.trim();

                if (!clientId) {
                    showToast('Please select a client', 'error');
                    return;
                }
                if (!dateVal) {
                    showToast('Please select a date', 'error');
                    return;
                }
                if (!timeVal) {
                    showToast('Please select a time slot', 'error');
                    return;
                }

                const saveBtn = document.getElementById('saveBookingBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Creating...';

                try {
                    // Get client info for the booking
                    const client = clients.find(c => c.id === clientId);

                    await db.collection('bookings').add({
                        clientId: clientId,
                        clientName: client ? client.name : 'Unknown',
                        clientEmail: client ? client.email : '',
                        date: dateVal,
                        time: timeVal,
                        duration: duration,
                        notes: notes,
                        status: 'confirmed',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    });

                    showToast('Booking created successfully!');
                    document.getElementById('bookingModal').classList.remove('show');

                    // Refresh stats and calendar
                    updateStats();
                    loadTodayBookings();
                } catch (error) {
                    console.error('Error creating booking:', error);
                    showToast('Failed to create booking: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Create Booking';
                }
            });

            // Load today's bookings for dashboard
            async function loadTodayBookings() {
                const container = document.getElementById('todayBookings');
                const todayStr = new Date().toISOString().split('T')[0];

                try {
                    const snapshot = await db.collection('bookings')
                        .where('date', '==', todayStr)
                        .orderBy('time')
                        .get();

                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <h4>No sessions scheduled</h4>
                                <p>Your day is free!</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = snapshot.docs.map(doc => {
                        const booking = doc.data();
                        return `
                            <div class="booking-item">
                                <div class="booking-time">${formatTime12Hour(booking.time)}</div>
                                <div class="booking-info">
                                    <div class="booking-client">${booking.clientName || 'Unknown Client'}</div>
                                    <div class="booking-duration">${booking.duration} minutes</div>
                                </div>
                                <div class="booking-status ${booking.status}">${booking.status}</div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error loading today\'s bookings:', error);
                    // Try without orderBy if index doesn't exist
                    try {
                        const snapshot = await db.collection('bookings')
                            .where('date', '==', todayStr)
                            .get();

                        if (snapshot.empty) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <h4>No sessions scheduled</h4>
                                    <p>Your day is free!</p>
                                </div>
                            `;
                            return;
                        }

                        const bookings = snapshot.docs.map(doc => doc.data()).sort((a, b) => a.time.localeCompare(b.time));

                        container.innerHTML = bookings.map(booking => `
                            <div class="booking-item">
                                <div class="booking-time">${formatTime12Hour(booking.time)}</div>
                                <div class="booking-info">
                                    <div class="booking-client">${booking.clientName || 'Unknown Client'}</div>
                                    <div class="booking-duration">${booking.duration} minutes</div>
                                </div>
                                <div class="booking-status ${booking.status}">${booking.status}</div>
                            </div>
                        `).join('');
                    } catch (err) {
                        console.error('Error loading bookings (fallback):', err);
                    }
                }
            }

            // Load today's bookings on page load
            loadTodayBookings();

            // Load bookings for selected day in calendar
            async function loadSelectedDayBookings(dateStr) {
                const container = document.getElementById('selectedDayBookings');
                container.innerHTML = '<p style="color: var(--text-muted);">Loading...</p>';

                try {
                    const snapshot = await db.collection('bookings')
                        .where('date', '==', dateStr)
                        .get();

                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <p>No bookings for this day</p>
                            </div>
                        `;
                        return;
                    }

                    const bookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.time.localeCompare(b.time));

                    container.innerHTML = bookings.map(booking => `
                        <div class="booking-item">
                            <div class="booking-time">${formatTime12Hour(booking.time)}</div>
                            <div class="booking-info">
                                <div class="booking-client">${booking.clientName || 'Unknown Client'}</div>
                                <div class="booking-duration">${booking.duration} minutes</div>
                            </div>
                            <div class="booking-actions">
                                <button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}', '${dateStr}')">Cancel</button>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading bookings:', error);
                    container.innerHTML = '<p style="color: var(--danger);">Error loading bookings</p>';
                }
            }

            // Cancel booking function (global)
            window.cancelBooking = async (bookingId, dateStr) => {
                if (!confirm('Are you sure you want to cancel this booking?')) return;

                try {
                    await db.collection('bookings').doc(bookingId).delete();
                    showToast('Booking cancelled');
                    loadSelectedDayBookings(dateStr);
                    updateStats();
                    loadTodayBookings();
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    showToast('Failed to cancel booking', 'error');
                }
            };

            // Update calendar day click to load bookings
            const originalRenderCalendar = renderCalendar;
            renderCalendar = function() {
                originalRenderCalendar();
                document.querySelectorAll('#calendarGrid .calendar-day:not(.other-month)').forEach(day => {
                    day.addEventListener('click', function() {
                        const date = this.dataset.date;
                        if (date) {
                            // Update selected state
                            document.querySelectorAll('#calendarGrid .calendar-day').forEach(d => d.classList.remove('selected'));
                            this.classList.add('selected');

                            // Update display and load bookings
                            document.getElementById('selectedDateDisplay').textContent =
                                new Date(date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
                            loadSelectedDayBookings(date);
                        }
                    });
                });
            };
            // Re-render to apply new click handlers
            renderCalendar();
        });
    </script>
</body>
</html>
