import{r as v,h as X,q as Se,f as O,b as S,z as Oe,j as e,p as Ne,T as J,w as Ae,t as je,d as U,m as Ue,n as Fe,o as Ve,c as me,s as Ye,g as Ge,u as Ke,e as Je,a as Qe}from"./index-B3GJmSMX.js";function Xe(){const[o,w]=v.useState([]),[x,N]=v.useState([]),[$,q]=v.useState(!0),[u,W]=v.useState(null),[c,H]=v.useState({}),[L,B]=v.useState(null),[V,K]=v.useState(""),[m,E]=v.useState("all"),[k,_]=v.useState(null),[D,R]=v.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[se,Z]=v.useState([]),[xe,d]=v.useState(!1),[G,I]=v.useState(!1),[Y,Q]=v.useState("list");v.useEffect(()=>{oe()},[]);const oe=async()=>{try{const[s,h]=await Promise.all([X(Se(O(S,"clients"),Oe("name","asc"))),X(O(S,"sessions"))]),T=s.docs.map(f=>({id:f.id,...f.data()})),F=h.docs.map(f=>({id:f.id,...f.data()}));w(T),N(F)}catch(s){console.error("Error fetching data:",s)}q(!1)},le=s=>{const h=new Date,T=h.getFullYear(),F=(h.getMonth()+1).toString().padStart(2,"0"),f=h.getDate().toString().padStart(2,"0"),M=`${T}-${F}-${f}`,ee=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;return x.filter(re=>re.clientId!==s?!1:re.date<M||re.date===M&&re.time<ee).length},he=s=>{const h=le(s.id);return(s.totalSessions||0)-h},ce=s=>{const h=new Date,T=h.getFullYear(),F=(h.getMonth()+1).toString().padStart(2,"0"),f=h.getDate().toString().padStart(2,"0"),M=`${T}-${F}-${f}`,ee=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;return x.filter(re=>re.clientId!==s?!1:re.date>M||re.date===M&&re.time>=ee).length},te=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",ue=async(s,h)=>{if(window.confirm(`Are you sure you want to delete ${h}? This will also delete all their booked sessions.`))try{const F=x.filter(f=>f.clientId===s).map(f=>je(U(S,"sessions",f.id)));await Promise.all(F),await je(U(S,"clients",s)),w(o.filter(f=>f.id!==s)),N(x.filter(f=>f.clientId!==s))}catch(T){console.error("Error deleting client:",T),alert("Failed to delete client")}},fe=s=>{if(!s)return"";const h=s.toDate?s.toDate():new Date(s),T=h.getFullYear(),F=(h.getMonth()+1).toString().padStart(2,"0"),f=h.getDate().toString().padStart(2,"0");return`${T}-${F}-${f}`},ne=s=>{W(s.id),H({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:fe(s.startDate),endDate:fe(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,isJunior:!!s.isJunior})},z=s=>{const{name:h,value:T}=s.target;if(H(F=>({...F,[h]:T})),h==="startDate"||h==="weeksInBlock"){const F=h==="startDate"?T:c.startDate,f=parseInt(h==="weeksInBlock"?T:c.weeksInBlock);if(F&&f>0){const M=new Date(F),ee=new Date(M);ee.setDate(ee.getDate()+f*7);const re=ee.getFullYear(),ke=(ee.getMonth()+1).toString().padStart(2,"0"),ye=ee.getDate().toString().padStart(2,"0");H($e=>({...$e,[h]:T,endDate:`${re}-${ke}-${ye}`}))}}},pe=async s=>{try{const h=o.find(M=>M.id===s);let T=h?.uid;if(c.password&&c.password.length>=6&&!h?.uid)try{const M=await Ue(Fe,c.email.trim().toLowerCase(),c.password);await Ve(Fe),T=M.user.uid}catch(M){if(console.error("Error creating auth account:",M),M.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(M.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+M.message);return}}const F=c.clientType==="block",f={name:c.name.trim(),email:c.email.trim().toLowerCase(),clientType:c.clientType,status:c.status,coreBuddyAccess:c.coreBuddyAccess,isJunior:c.isJunior};if(F)f.weeksInBlock=parseInt(c.weeksInBlock)||0,f.totalSessions=parseInt(c.totalSessions)||0,f.sessionDuration=parseInt(c.sessionDuration),f.circuitAccess=c.circuitAccess,c.startDate&&(f.startDate=J.fromDate(new Date(c.startDate))),c.endDate&&(f.endDate=J.fromDate(new Date(c.endDate)));else{const M=o.find(ee=>ee.id===s);M?.circuitStrikes===void 0&&(f.circuitStrikes=0),M?.circuitBanUntil===void 0&&(f.circuitBanUntil=null)}T&&!h?.uid&&(f.uid=T),await me(U(S,"clients",s),f),w(o.map(M=>M.id===s?{...M,...c,uid:T||M.uid,weeksInBlock:parseInt(c.weeksInBlock),totalSessions:parseInt(c.totalSessions),sessionDuration:parseInt(c.sessionDuration),startDate:J.fromDate(new Date(c.startDate)),endDate:J.fromDate(new Date(c.endDate))}:M)),W(null),T&&!h?.uid&&alert("Portal access created! Client can now log in.")}catch(h){console.error("Error updating client:",h),alert("Failed to update client")}},ve=async s=>{try{const h=o.find(T=>T.id===s)?.status==="archived"?"active":"archived";await me(U(S,"clients",s),{status:h}),w(o.map(T=>T.id===s?{...T,status:h}:T))}catch(h){console.error("Error archiving client:",h),alert("Failed to update client status")}},ge=async s=>{_({clientId:s.id,clientName:s.name}),Q("list"),R({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),d(!0);try{const h=Se(O(S,"sessionNotes"),Ae("clientId","==",s.id)),F=(await X(h)).docs.map(f=>({id:f.id,...f.data()}));F.sort((f,M)=>{const ee=f.createdAt?.toMillis?.()||0;return(M.createdAt?.toMillis?.()||0)-ee}),Z(F)}catch(h){console.error("Error fetching notes:",h),Z([])}d(!1)},de=()=>{_(null),Z([]),Q("list")},i=async()=>{if(!k)return;const{sessionNotes:s,whatWentWell:h,whatWentWrong:T,whatsNext:F}=D;if(!(!s.trim()&&!h.trim()&&!T.trim()&&!F.trim())){I(!0);try{const M=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await Ne(O(S,"sessionNotes"),{clientId:k.clientId,date:M,sessionNotes:s.trim(),whatWentWell:h.trim(),whatWentWrong:T.trim(),whatsNext:F.trim(),createdAt:J.now()}),R({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const ee=Se(O(S,"sessionNotes"),Ae("clientId","==",k.clientId)),ke=(await X(ee)).docs.map(ye=>({id:ye.id,...ye.data()}));ke.sort((ye,$e)=>{const ze=ye.createdAt?.toMillis?.()||0;return($e.createdAt?.toMillis?.()||0)-ze}),Z(ke),Q("list")}catch(f){console.error("Error saving note:",f),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}I(!1)}},g=async s=>{if(window.confirm("Delete this session note?"))try{await je(U(S,"sessionNotes",s)),Z(se.filter(h=>h.id!==s))}catch(h){console.error("Error deleting note:",h)}};if($)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(o.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const a=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",n=o.filter(s=>s.name?.toLowerCase().includes(V.toLowerCase())||s.email?.toLowerCase().includes(V.toLowerCase())).sort((s,h)=>(s.name||"").localeCompare(h.name||"")),p=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",j=s=>s.clientType==="core_buddy",r=s=>s.status==="archived",t=n.filter(s=>!r(s)),l=t.filter(s=>!p(s)&&!j(s)),y=t.filter(s=>p(s)),b=t.filter(s=>j(s)),A=n.filter(s=>r(s)),C=m==="block"?l:m==="circuit"?y:m==="core_buddy"?b:m==="archived"?A:t,ie=s=>{u||B(h=>h===s?null:s)},P=s=>{const h=L===s.id,T=u===s.id,F=!s.clientType||s.clientType==="block";return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${h||T?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>ie(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:F?`${he(s)}/${s.totalSessions||0} sessions`:a(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:a(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${h||T?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(h||T)&&e.jsx("div",{className:"client-expand-panel",children:T?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(f=>e.jsx("button",{type:"button",className:`edit-type-btn ${c.clientType===f.value?"active":""}`,onClick:()=>H(M=>({...M,clientType:f.value})),children:f.label},f.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:c.name,onChange:z,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:c.email,onChange:z,placeholder:"Email"})]}),c.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:c.weeksInBlock,onChange:z,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:c.totalSessions,onChange:z,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:c.sessionDuration,onChange:z,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:c.startDate,onChange:z}),e.jsx("input",{type:"date",name:"endDate",value:c.endDate,onChange:z})]})]}),e.jsx("div",{className:"edit-row password-row",children:c.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:c.password,onChange:z,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.circuitAccess,onChange:f=>H(M=>({...M,circuitAccess:f.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),c.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.coreBuddyAccess,onChange:f=>H(M=>({...M,coreBuddyAccess:f.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.isJunior,onChange:f=>H(M=>({...M,isJunior:f.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>pe(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{W(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),F?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[he(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[ce(s.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:te(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:te(s.endDate)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:te(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[F&&e.jsxs("button",{className:"action-btn notes",onClick:f=>{f.stopPropagation(),ge(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:f=>{f.stopPropagation(),ne(s)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:f=>{f.stopPropagation(),ve(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:f=>{f.stopPropagation(),ue(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:V,onChange:s=>K(s.target.value),className:"client-search-input"}),V&&e.jsx("button",{className:"client-search-clear",onClick:()=>K(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsx("div",{className:"client-type-filter",children:[{value:"all",label:"All",count:t.length},{value:"block",label:"Block",count:l.length},{value:"circuit",label:"Circuit",count:y.length},{value:"core_buddy",label:"Core Buddy",count:b.length},{value:"archived",label:"Archived",count:A.length}].map(s=>e.jsxs("button",{className:`client-filter-btn ${m===s.value?"active":""}`,onClick:()=>E(s.value),children:[s.label,e.jsx("span",{className:"client-filter-count",children:s.count})]},s.value))}),m==="all"?e.jsxs(e.Fragment,{children:[l.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:l.length})]}),l.map(P)]}),y.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:y.length})]}),y.map(P)]}),b.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:b.length})]}),b.map(P)]})]}):m==="archived"?e.jsx(e.Fragment,{children:A.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:A.length})]}),A.map(P)]})}):e.jsxs(e.Fragment,{children:[C.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",m," clients found"]}),C.map(P)]}),k&&e.jsx("div",{className:"notes-modal-overlay",onClick:de,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),k.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:de,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),Y==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:xe?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):se.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:se.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>g(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>Q("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:D.sessionNotes,onChange:s=>R(h=>({...h,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:D.whatWentWell,onChange:s=>R(h=>({...h,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:D.whatWentWrong,onChange:s=>R(h=>({...h,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:D.whatsNext,onChange:s=>R(h=>({...h,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>Q("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:i,disabled:G,children:G?"Saving...":"Save Notes"})]})]})]})})]})}const Me={monday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},tuesday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},wednesday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},thursday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},friday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"12:00",end:"17:00"},defaultBlocked:!0}},De=["monday","tuesday","wednesday","thursday","friday"],Ze=["Monday","Tuesday","Wednesday","Thursday","Friday"],es=["Mon","Tue","Wed","Thu","Fri"],We=o=>{const[w,x]=o.split(":"),N=parseInt(w),$=N>=12?"pm":"am";return`${N>12?N-12:N===0?12:N}:${x}${$}`},ss=o=>{const w=new Date(o),x=w.getDay(),N=w.getDate()-x+(x===0?-6:1);return w.setDate(N),De.map(($,q)=>{const u=new Date(w);return u.setDate(w.getDate()+q),u})},ae=o=>{const w=o.getFullYear(),x=(o.getMonth()+1).toString().padStart(2,"0"),N=o.getDate().toString().padStart(2,"0");return`${w}-${x}-${N}`},Le=o=>{const[w,x]=o.split(":").map(Number);return w*60+x},we=(o,w)=>{const x=Le(o)+w,N=Math.floor(x/60),$=x%60;return`${N.toString().padStart(2,"0")}:${$.toString().padStart(2,"0")}`},ts=o=>{const w=Me[o];if(!w)return[];const x=[];if(w.morning){let N=w.morning.start;for(;N<w.morning.end;)x.push({time:N,period:"morning"}),N=we(N,15)}if(w.afternoon){let N=w.afternoon.start;for(;N<w.afternoon.end;)x.push({time:N,period:"afternoon"}),N=we(N,15)}return x};function as(){const[o,w]=v.useState(new Date),[x,N]=v.useState([]),[$,q]=v.useState([]),[u,W]=v.useState([]),[c,H]=v.useState([]),[L,B]=v.useState([]),[V,K]=v.useState([]),[m,E]=v.useState(null),[k,_]=v.useState(null),[D,R]=v.useState(!1),[se,Z]=v.useState(!0);v.useEffect(()=>{N(ss(o))},[o]),v.useEffect(()=>{Y()},[]);const xe=a=>{if(E(a),R(!1),a.startDate){const n=a.startDate.toDate?a.startDate.toDate():new Date(a.startDate);w(n)}_(null)},d=a=>{const n=new Date,p=ae(n),j=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return u.filter(r=>r.clientId!==a?!1:r.date<p||r.date===p&&r.time<j).length},G=a=>{const n=d(a.id);return(a.totalSessions||0)-n},I=a=>{const n=new Date,p=n.getFullYear(),j=(n.getMonth()+1).toString().padStart(2,"0"),r=n.getDate().toString().padStart(2,"0"),t=`${p}-${j}-${r}`,l=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return u.filter(y=>y.clientId!==a?!1:y.date>t||y.date===t&&y.time>=l).length},Y=async()=>{try{const n=(await X(O(S,"clients"))).docs.map(C=>({id:C.id,...C.data()})).filter(C=>C.status==="active");q(n);const j=(await X(O(S,"sessions"))).docs.map(C=>({id:C.id,...C.data()}));W(j);const t=(await X(O(S,"holidays"))).docs.map(C=>({id:C.id,...C.data()}));H(t);const y=(await X(O(S,"blockedTimes"))).docs.map(C=>({id:C.id,...C.data()}));B(y);const A=(await X(O(S,"openedSlots"))).docs.map(C=>({id:C.id,...C.data()}));K(A)}catch(a){console.error("Error fetching data:",a)}Z(!1)},Q=a=>{const n=new Date(o);n.setDate(n.getDate()+a*7),w(n),_(null)},oe=()=>{w(new Date),_(null)},le=a=>{const n=ae(a);return c.some(p=>p.date===n)},he=(a,n)=>{const p=ae(a);return L.some(j=>j.date===p&&j.time===n)},ce=(a,n)=>{const p=ae(a);return V.some(j=>j.date===p&&j.time===n)},te=a=>{const n=De[a.getDay()-1];return n&&Me[n]?.defaultBlocked},ue=async(a,n)=>{const p=ae(a);if(te(a)){const r=V.find(t=>t.date===p&&t.time===n);try{if(r)await je(U(S,"openedSlots",r.id)),K(V.filter(t=>t.id!==r.id));else{const t=await Ne(O(S,"openedSlots"),{date:p,time:n,createdAt:J.now()});K([...V,{id:t.id,date:p,time:n}])}}catch(t){console.error("Error toggling opened slot:",t),alert("Failed to update time slot")}return}const j=L.find(r=>r.date===p&&r.time===n);try{if(j)await je(U(S,"blockedTimes",j.id)),B(L.filter(r=>r.id!==j.id));else{const r=await Ne(O(S,"blockedTimes"),{date:p,time:n,createdAt:J.now()});B([...L,{id:r.id,date:p,time:n}])}}catch(r){console.error("Error toggling blocked time:",r),alert("Failed to update time slot")}},fe=a=>{const n=ae(a);return u.filter(p=>p.date===n)},ne=(a,n)=>{const p=ae(a);return u.find(j=>j.date===p&&j.time===n)},z=(a,n,p)=>{const j=De[a.getDay()-1];if(!j||le(a))return!1;const r=Me[j],t=Math.ceil(p/15);if(r.defaultBlocked)for(let s=0;s<t;s++){const h=we(n,s*15);if(!ce(a,h))return!1}else for(let s=0;s<t;s++){const h=we(n,s*15);if(he(a,h))return!1}const l=ae(a);if(u.find(s=>s.date===l&&s.time===n))return!1;const b=we(n,p),A=r.morning&&b<=r.morning.end,C=r.afternoon&&b<=r.afternoon.end,ie=r.morning&&n>=r.morning.start&&n<r.morning.end,P=r.afternoon&&n>=r.afternoon.start&&n<r.afternoon.end;if(ie&&!A||P&&!C)return!1;for(const s of u){if(s.date!==l)continue;const h=Le(s.time),T=h+(s.duration||45),F=Le(n),f=F+p;if(F<T&&f>h)return!1}return!0},pe=async(a,n)=>{const p=ne(a,n);if(p){if(window.confirm(`Cancel ${p.clientName}'s session at ${We(n)}?`))try{await je(U(S,"sessions",p.id)),W(u.filter(r=>r.id!==p.id))}catch(r){console.error("Error cancelling session:",r),alert("Failed to cancel session")}return}if(!m){alert("Please select a client first");return}if(!z(a,n,m.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}if(I(m.id)>=m.totalSessions){alert(`${m.name} has already booked all ${m.totalSessions} sessions`);return}try{const r=ae(a),t={clientId:m.id,clientName:m.name,date:r,time:n,duration:m.sessionDuration||45,createdAt:J.now()},l=await Ne(O(S,"sessions"),t);W([...u,{id:l.id,...t}])}catch(r){console.error("Error booking session:",r),alert("Failed to book session")}},ve=async()=>{if(!m)return;const a=m.startDate?.toDate?m.startDate.toDate():new Date(m.startDate),n=m.endDate?.toDate?m.endDate.toDate():new Date(m.endDate),p=u.filter(b=>b.clientId!==m.id?!1:x.some(A=>ae(A)===b.date));if(p.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const j=m.weeksInBlock||Math.ceil((n-a)/(10080*60*1e3)),r=p.map(b=>({dayOfWeek:new Date(b.date).getDay(),time:b.time}));let t=[];const l=I(m.id);for(let b=0;b<j;b++){const A=new Date(a);A.setDate(A.getDate()+b*7);const C=new Date(A),ie=C.getDay(),P=C.getDate()-ie+(ie===0?-6:1);C.setDate(P);for(const s of r){const h=new Date(C),T=s.dayOfWeek===0?6:s.dayOfWeek-1;h.setDate(C.getDate()+T);const F=ae(h);u.some(f=>f.clientId===m.id&&f.date===F&&f.time===s.time)||h<a||h>n||c.some(f=>f.date===F)||t.push({dateKey:F,time:s.time,sessionDate:h})}}const y=l+t.length;if(y>m.totalSessions){alert(`This would create ${t.length} new sessions (${y} total), but client only has ${m.totalSessions} sessions in their package.

You can still book ${m.totalSessions-l} more sessions.`);return}if(t.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${t.length} new sessions across the block.

(${l} existing + ${t.length} new = ${y} total)

Continue?`))try{const b=[];for(const A of t){const C={clientId:m.id,clientName:m.name,date:A.dateKey,time:A.time,duration:m.sessionDuration||45,createdAt:J.now()},ie=await Ne(O(S,"sessions"),C);b.push({id:ie.id,...C})}W([...u,...b]),alert(`Created ${b.length} new sessions!`)}catch(b){console.error("Error repeating weekly:",b),alert("Failed to repeat sessions")}},ge=async a=>{const n=ae(a),p=c.find(j=>j.date===n);try{if(p)await je(U(S,"holidays",p.id)),H(c.filter(j=>j.id!==p.id));else{const j=await Ne(O(S,"holidays"),{date:n,createdAt:J.now()});H([...c,{id:j.id,date:n}])}}catch(j){console.error("Error toggling day availability:",j),alert("Failed to update day availability")}};if(se)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const de=x[0],i=x[4],g=de&&i?`${de.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${i.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>Q(-1),children:"←"}),e.jsx("button",{onClick:oe,children:"Today"}),e.jsx("button",{onClick:()=>Q(1),children:"→"})]}),e.jsx("h3",{children:g})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),m?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:m.name}),e.jsxs("span",{children:[m.sessionDuration||45,"min • ",G(m),"/",m.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[I(m.id)," booked"]})]}),e.jsx("button",{onClick:()=>E(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>R(!0),children:"Select Client"})]}),m&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:ve,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:x.map((a,n)=>{const p=fe(a),j=ae(a)===ae(new Date),r=le(a);return e.jsxs("div",{className:`day-card ${k===n?"selected":""} ${j?"today":""} ${r?"holiday":""}`,onClick:()=>_(k===n?null:n),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:es[n]}),e.jsx("span",{className:"day-date",children:a.getDate()})]}),r?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[p.length," session",p.length!==1?"s":""]})]},n)})}),k!==null&&x[k]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[Ze[k]," ",x[k].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>_(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${le(x[k])?"unavailable":"available"}`,onClick:()=>ge(x[k]),children:le(x[k])?"Mark Day Available":"Mark Day Unavailable"})}),le(x[k])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[te(x[k])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),ts(De[k]).map(({time:a,period:n},p,j)=>{const r=ne(x[k],a),t=te(x[k]),l=t?!ce(x[k],a):he(x[k],a),y=t&&ce(x[k],a),b=m&&z(x[k],a,m.sessionDuration||45),A=p===0||j[p-1]?.period!==n;return e.jsxs("div",{children:[A&&e.jsx("div",{className:"period-label",children:n==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${r?"booked":""} ${l&&!r?"blocked":""} ${y&&!r?"opened":""} ${b?"available":""} ${!r&&!l&&!b&&m?"unavailable":""}`,onClick:()=>(!l||r)&&pe(x[k],a),disabled:l&&!r,children:[e.jsx("span",{className:"slot-time",children:We(a)}),r?e.jsxs("span",{className:"slot-client",children:[r.clientName," (",r.duration,"m)"]}):l?e.jsx("span",{className:"slot-blocked",children:t?"Closed":"Blocked"}):b?e.jsx("span",{className:"slot-available",children:"Available"}):m?e.jsx("span",{className:"slot-unavailable",children:"Unavailable"}):y?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${t?y?"is-opened":"":l?"is-blocked":""}`,onClick:()=>ue(x[k],a),disabled:!!r,title:t?y?"Close this slot":"Open this slot":l?"Unblock this time":"Block this time",children:t?y?"✓":"+":l?"✓":"✕"})]})]},a)})]})]}),D&&e.jsx("div",{className:"modal-overlay",onClick:()=>R(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>R(!1),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:$.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):$.map(a=>{const n=a.startDate?.toDate?a.startDate.toDate():new Date(a.startDate),p=a.endDate?.toDate?a.endDate.toDate():new Date(a.endDate),j=G(a),r=I(a.id);return e.jsxs("button",{className:"client-option",onClick:()=>xe(a),children:[e.jsx("strong",{children:a.name}),e.jsxs("span",{children:[a.sessionDuration||45,"min • ",j,"/",a.totalSessions," remaining • ",r," booked"]}),e.jsxs("span",{className:"client-dates",children:[n.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," - ",p.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},a.id)})})]})})]})}const Ee=o=>{const[w,x]=o.split(":"),N=parseInt(w),$=N>=12?"pm":"am";return`${N>12?N-12:N===0?12:N}:${x}${$}`},be=o=>{const w=o.getFullYear(),x=(o.getMonth()+1).toString().padStart(2,"0"),N=o.getDate().toString().padStart(2,"0");return`${w}-${x}-${N}`},_e=o=>o===be(new Date),ns=o=>{const w=new Date;return w.setDate(w.getDate()+1),o===be(w)},Ie=o=>_e(o)?"Today":ns(o)?"Tomorrow":new Date(o).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),Re=o=>{const w=new Date,x=be(w),N=`${w.getHours().toString().padStart(2,"0")}:${w.getMinutes().toString().padStart(2,"0")}`;if(o.date<x)return!0;if(o.date===x){const $=Pe(o.time)+(o.duration||45);return Pe(N)>=$}return!1},Pe=o=>{const[w,x]=o.split(":").map(Number);return w*60+x};function is(){const[o,w]=v.useState([]),[x,N]=v.useState(!0),[$,q]=v.useState(new Date);v.useEffect(()=>{u();const m=setInterval(()=>{q(new Date)},6e4);return()=>clearInterval(m)},[]);const u=async()=>{try{const E=(await X(O(S,"sessions"))).docs.map(D=>({id:D.id,...D.data()})),k=be(new Date),_=E.filter(D=>D.date>=k).sort((D,R)=>D.date!==R.date?D.date.localeCompare(R.date):D.time.localeCompare(R.time));w(_)}catch(m){console.error("Error fetching sessions:",m)}N(!1)},W=async m=>{if(window.confirm(`Cancel ${m.clientName}'s session at ${Ee(m.time)} on ${Ie(m.date)}?`))try{await je(U(S,"sessions",m.id)),w(o.filter(E=>E.id!==m.id))}catch(E){console.error("Error cancelling session:",E),alert("Failed to cancel session")}};if(x)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const c=o.reduce((m,E)=>{const k=E.date;return m[k]||(m[k]=[]),m[k].push(E),m},{}),H=Object.keys(c).sort(),L=be(new Date),B=c[L]||[],V=B.filter(m=>Re(m)).length,K=B.length-V;return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:B.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[V," completed"]}),e.jsxs("span",{className:"remaining-count",children:[K," remaining"]})]})})]}),H.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:"No upcoming sessions booked"})}):e.jsx("div",{className:"sessions-list",children:H.map(m=>e.jsxs("div",{className:`date-group ${_e(m)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ie(m)}),e.jsxs("span",{className:"date-count",children:[c[m].length," session",c[m].length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:c[m].map(E=>{const k=Re(E);return e.jsxs("div",{className:`session-card ${k?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ee(E.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:E.clientName}),e.jsxs("span",{children:[E.duration,"min session"]})]}),k?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>W(E),children:"Cancel"})]},E.id)})})]},m))})]})}const rs={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},os={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},ls={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},cs=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function ds(){const[o,w]=v.useState([]),[x,N]=v.useState(!0),[$,q]=v.useState(null),[u,W]=v.useState(null),[c,H]=v.useState("all"),[L,B]=v.useState("");v.useEffect(()=>{V()},[]);const V=async()=>{try{const G=(await X(O(S,"clients"))).docs.map(I=>({id:I.id,...I.data()}));G.sort((I,Y)=>(I.name||"").localeCompare(Y.name||"")),w(G)}catch(d){console.error("Error fetching clients:",d)}N(!1)},K=d=>!!d.welcomeForm?.completedAt,m=d=>!!d.parqForm?.completedAt,E=d=>K(d)||m(d),k=d=>K(d)&&m(d),_=d=>d?(d.toDate?d.toDate():new Date(d)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",D=o.filter(d=>!L||d.name?.toLowerCase().includes(L.toLowerCase())?c==="all"?!0:c==="completed"?k(d):c==="partial"?E(d)&&!k(d):c==="pending"?!E(d):!0:!1),R=o.filter(k).length,se=o.filter(d=>E(d)&&!k(d)).length,Z=o.filter(d=>!E(d)).length,xe=d=>{$===d?(q(null),W(null)):(q(d),W(null))};return x?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:R}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:se}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:Z}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:L,onChange:d=>B(d.target.value)}),L&&e.jsx("button",{className:"forms-search-clear",onClick:()=>B(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${c==="all"?"active":""}`,onClick:()=>H("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:o.length})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="completed"?"active":""}`,onClick:()=>H("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:R})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="partial"?"active":""}`,onClick:()=>H("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:se})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="pending"?"active":""}`,onClick:()=>H("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:Z})]})]}),D.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:D.map(d=>{const G=$===d.id,I=K(d),Y=m(d);return e.jsxs("div",{className:`forms-client-card ${G?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>xe(d.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(d.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:d.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${I?"done":"not-done"}`,children:[I?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${Y?"done":"not-done"}`,children:[Y?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${G?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),G&&e.jsx("div",{className:"forms-expand-panel",children:!I&&!Y?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[I&&e.jsx("button",{className:`forms-toggle-btn ${u==="welcome"||!u&&I?"active":""}`,onClick:()=>W("welcome"),children:"Welcome Questionnaire"}),Y&&e.jsx("button",{className:`forms-toggle-btn ${u==="parq"||!u&&!I&&Y?"active":""}`,onClick:()=>W("parq"),children:"PAR-Q Health Screening"})]}),(u==="welcome"||!u&&I)&&I&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",_(d.welcomeForm.completedAt)]})]}),d.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:d.welcomeForm.fitnessGoals})]}),d.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:rs[d.welcomeForm.currentActivityLevel]||d.welcomeForm.currentActivityLevel})]}),d.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:d.welcomeForm.exerciseHistory})]}),d.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:d.welcomeForm.injuries})]}),d.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:d.welcomeForm.medicalConditions})]}),d.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:os[d.welcomeForm.sleepHours]||d.welcomeForm.sleepHours})]}),d.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:ls[d.welcomeForm.stressLevel]||d.welcomeForm.stressLevel})]}),d.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:d.welcomeForm.dietaryInfo})]}),d.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:d.welcomeForm.availability})]}),d.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:d.welcomeForm.additionalInfo})]})]}),u==="parq"&&Y&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",_(d.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:cs.map(Q=>{const oe=d.parqForm[Q.key];return e.jsxs("div",{className:`parq-result-item ${oe?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${oe?"yes":"no"}`,children:oe?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:Q.text})]},Q.key)})}),d.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:d.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:d.parqForm.declaration?"declared":"not-declared",children:d.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},d.id)})})]})}const Be=o=>`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,qe=o=>new Date(o+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),He=()=>{const o=new Date;let x=(6-o.getDay()+7)%7;if(x===0){const $=new Date(o);$.setHours(9,45,0,0),o>$&&(x=7)}const N=new Date(o);return N.setDate(o.getDate()+x),N},Ce=o=>o==="circuit_vip"?"VIP":o==="circuit_dropin"?"Drop-in":"Block",Te=o=>o==="circuit_vip"?"vip":o==="circuit_dropin"?"dropin":"block";function ms(){const[o,w]=v.useState(!0),[x,N]=v.useState([]),[$,q]=v.useState([]),[u,W]=v.useState(null),[c,H]=v.useState("upcoming"),[L,B]=v.useState(!1),[V,K]=v.useState(null),[m,E]=v.useState(!1),[k,_]=v.useState(!1),D=v.useCallback((i,g="info")=>{K({message:i,type:g}),setTimeout(()=>K(null),4e3)},[]);v.useEffect(()=>{R()},[]);const R=async()=>{try{const g=(await X(O(S,"circuitSessions"))).docs.map(r=>({id:r.id,...r.data()}));g.sort((r,t)=>t.date.localeCompare(r.date)),N(g);const n=(await X(O(S,"clients"))).docs.map(r=>({id:r.id,...r.data()})).filter(r=>r.clientType==="circuit_vip"||r.clientType==="circuit_dropin"||r.circuitAccess===!0);q(n);const p=Be(He());let j=g.find(r=>r.date===p);if(!j){const r=n.filter(y=>y.clientType==="circuit_vip"&&y.status==="active"),t=[];for(let y=0;y<8;y++)y<r.length?t.push({slotNumber:y+1,memberId:r[y].id,memberName:r[y].name,memberType:"circuit_vip",status:"confirmed",bookedAt:J.now()}):t.push({slotNumber:y+1,memberId:null,memberName:null,memberType:null,status:"available"});const l={date:p,time:"09:00",endTime:"09:45",maxCapacity:8,slots:t,waitlist:[],createdAt:J.now()};await Ye(U(S,"circuitSessions",p),l),j={id:p,...l},g.unshift(j),N([...g])}j?W(j):g.length>0&&W(g[0])}catch(i){console.error("Error loading circuit data:",i),D("Failed to load circuit data","error")}w(!1)},se=async i=>{if(!(!u||L)&&window.confirm("Remove this member from the slot?")){B(!0);try{const g=[...u.slots],a=g.findIndex(l=>l.slotNumber===i);if(a===-1){B(!1);return}const n=g[a],p=n.memberType==="circuit_vip";let j=[...u.waitlist||[]];if(j.length>0){const l=j.shift();g[a]={slotNumber:i,memberId:l.memberId,memberName:l.memberName,memberType:l.memberType,status:"confirmed",bookedAt:J.now()},D(`Slot given to ${l.memberName} from waitlist`,"success")}else g[a]={slotNumber:i,memberId:null,memberName:null,memberType:null,status:"available"},D("Member removed from slot","success");const r={slots:g,waitlist:j};if(p&&n.memberId){const l=u.vipOptOuts||[];l.includes(n.memberId)||(r.vipOptOuts=[...l,n.memberId])}await me(U(S,"circuitSessions",u.id),r);const t={...u,...r};W(t),N(l=>l.map(y=>y.id===t.id?t:y))}catch(g){console.error("Error removing from slot:",g),D("Failed to remove member","error")}B(!1)}},Z=async(i,g)=>{if(!(!u||L)){B(!0);try{const a=[...u.slots],n=a.findIndex(t=>t.slotNumber===i&&t.status==="available");if(n===-1){D("Slot is not available","error"),B(!1);return}if(a.some(t=>t.memberId===g.id)){D(`${g.name} already has a slot`,"error"),B(!1);return}a[n]={slotNumber:i,memberId:g.id,memberName:g.name,memberType:g.clientType||"block",status:"confirmed",bookedAt:J.now()};const p=(u.waitlist||[]).filter(t=>t.memberId!==g.id),j={slots:a,waitlist:p};if(g.clientType==="circuit_vip"){const t=u.vipOptOuts||[];t.includes(g.id)&&(j.vipOptOuts=t.filter(l=>l!==g.id))}await me(U(S,"circuitSessions",u.id),j);const r={...u,...j};W(r),N(t=>t.map(l=>l.id===r.id?r:l)),D(`${g.name} added to slot ${i}`,"success")}catch(a){console.error("Error adding to slot:",a),D("Failed to add member","error")}B(!1)}},xe=async i=>{if(!(!u||L)){B(!0);try{const g=(u.waitlist||[]).filter(n=>n.memberId!==i);await me(U(S,"circuitSessions",u.id),{waitlist:g});const a={...u,waitlist:g};W(a),N(n=>n.map(p=>p.id===a.id?a:p)),D("Removed from waitlist","success")}catch(g){console.error("Error removing from waitlist:",g),D("Failed to remove from waitlist","error")}B(!1)}},d=async(i,g)=>{if(!(!u||L)){B(!0);try{const a=[...u.slots],n=a.findIndex(j=>j.slotNumber===i);if(n===-1){B(!1);return}if(a[n]={...a[n],attended:g},await me(U(S,"circuitSessions",u.id),{slots:a}),g===!1){const j=a[n].memberId;if(j){const r=U(S,"clients",j),t=await Ge(r);if(t.exists()){const y=(t.data().circuitStrikes||0)+1,b={circuitStrikes:y};if(y>=3){const A=new Date;A.setMonth(A.getMonth()+1),b.circuitBanUntil=J.fromDate(A),b.circuitStrikes=0,D(`${a[n].memberName} banned for 1 month (3 strikes)`,"error")}else D(`No-show recorded - ${a[n].memberName} (${y}/3 strikes)`,"error");await me(r,b)}}}else D(`${a[n].memberName} marked as attended`,"success");const p={...u,slots:a};W(p),N(j=>j.map(r=>r.id===p.id?p:r))}catch(a){console.error("Error marking attendance:",a),D("Failed to update attendance","error")}B(!1)}},G=async(i,g)=>{if(!L&&window.confirm(`Reset strikes for ${g}?`)){B(!0);try{await me(U(S,"clients",i),{circuitStrikes:0,circuitBanUntil:null}),q(a=>a.map(n=>n.id===i?{...n,circuitStrikes:0,circuitBanUntil:null}:n)),D(`Strikes reset for ${g}`,"success")}catch(a){console.error("Error resetting strikes:",a),D("Failed to reset strikes","error")}B(!1)}},I=async(i,g)=>{if(!L&&window.confirm(`Lift ban for ${g}?`)){B(!0);try{await me(U(S,"clients",i),{circuitBanUntil:null,circuitStrikes:0}),q(a=>a.map(n=>n.id===i?{...n,circuitBanUntil:null,circuitStrikes:0}:n)),D(`Ban lifted for ${g}`,"success")}catch(a){console.error("Error lifting ban:",a),D("Failed to lift ban","error")}B(!1)}};if(o)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const Y=Be(new Date),Q=Be(He()),oe=x.filter(i=>i.date>=Y),le=x.filter(i=>i.date<Y),he=c==="upcoming"?oe:le,ce=u?u.slots.filter(i=>i.status!=="available").length:0,te=u?u.slots.filter(i=>i.status==="available").length:0,ue=u?u.date>=Y:!1,fe=u?u.slots.filter(i=>i.memberId).map(i=>i.memberId):[],ne=u?(u.waitlist||[]).map(i=>i.memberId):[],z=$.filter(i=>!fe.includes(i.id)&&!ne.includes(i.id)),pe=$.filter(i=>i.clientType==="circuit_vip").length,ve=$.filter(i=>i.clientType==="circuit_dropin").length,ge=$.filter(i=>i.circuitAccess&&i.clientType!=="circuit_vip"&&i.clientType!=="circuit_dropin").length,de=$.filter(i=>i.circuitBanUntil?(i.circuitBanUntil.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:pe}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ve}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ge}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:x.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${m?"":"active"}`,onClick:()=>E(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${m?"active":""}`,onClick:()=>E(!0),children:"Members"})]}),!m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${c==="upcoming"?"active":""}`,onClick:()=>H("upcoming"),children:["Upcoming (",oe.length,")"]}),e.jsxs("button",{className:`cm-tab ${c==="past"?"active":""}`,onClick:()=>H("past"),children:["Past (",le.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:he.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",c," sessions"]})}):he.map(i=>{const g=i.slots.filter(p=>p.status!=="available").length,a=u?.id===i.id,n=i.date===Q;return e.jsxs("button",{className:`cm-session-btn ${a?"selected":""} ${n?"next":""}`,onClick:()=>{W(i),_(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:qe(i.date)}),n&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[g,"/8"]}),(i.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",i.waitlist.length," wl"]})]})]},i.id)})}),u&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:qe(u.date)}),e.jsxs("p",{children:[u.time," - ",u.endTime," • ",ce,"/8 booked • ",te," available"]})]}),!ue&&e.jsx("button",{className:`cm-attendance-btn ${k?"active":""}`,onClick:()=>_(!k),children:k?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:u.slots.map(i=>{const g=i.status==="available";return e.jsxs("div",{className:`cm-slot ${g?"empty":"filled"} ${i.attended===!0?"attended":""} ${i.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:i.slotNumber}),g?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),ue&&e.jsx(hs,{members:z,onSelect:a=>Z(i.slotNumber,a),disabled:L})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${Te(i.memberType)}`,children:Ce(i.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[k&&i.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>d(i.slotNumber,!0),disabled:L,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>d(i.slotNumber,!1),disabled:L,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),i.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),i.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),ue&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>se(i.slotNumber),disabled:L,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},i.slotNumber)})}),(u.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",u.waitlist.length,")"]}),u.waitlist.map((i,g)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",g+1]}),e.jsx("span",{className:"cm-wl-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${Te(i.memberType)}`,children:Ce(i.memberType)}),ue&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>xe(i.memberId),disabled:L,children:"Remove"})]},i.memberId))]})]})]}),m&&e.jsxs("div",{className:"cm-members",children:[de.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",de.length,")"]}),de.map(i=>{const g=i.circuitBanUntil?.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:i.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",g.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>I(i.id,i.name),disabled:L,children:"Lift Ban"})]},i.id)})]}),e.jsx("div",{className:"cm-members-list",children:$.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):$.map(i=>{const g=i.circuitStrikes||0,a=de.some(n=>n.id===i.id);return e.jsxs("div",{className:`cm-member-card ${a?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:i.name}),e.jsx("span",{className:`cm-type-badge ${Te(i.clientType)}`,children:Ce(i.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(n=>e.jsx("span",{className:`cm-strike-dot ${n<g?"active":""}`},n)),e.jsxs("span",{className:"cm-strike-text",children:[g,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[a&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>I(i.id,i.name),disabled:L,children:"Lift Ban"}),g>0&&!a&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>G(i.id,i.name),disabled:L,children:"Reset"})]})]})]},i.id)})})]}),V&&e.jsx("div",{className:`cm-toast ${V.type}`,children:e.jsx("span",{children:V.message})})]})}function hs({members:o,onSelect:w,disabled:x}){const[N,$]=v.useState(!1),[q,u]=v.useState(""),W=o.filter(c=>c.name.toLowerCase().includes(q.toLowerCase()));return o.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>$(!N),disabled:x,children:"+ Add"}),N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{$(!1),u("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[o.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:q,onChange:c=>u(c.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[W.map(c=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{w(c),$(!1),u("")},children:[e.jsx("span",{children:c.name}),e.jsx("span",{className:`cm-type-badge sm ${Te(c.clientType)}`,children:Ce(c.clientType)})]},c.id)),W.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function ps(){const[o,w]=v.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),x=t=>{w(t),localStorage.setItem("adminActiveView",t)},[N,$]=v.useState(0),[q,u]=v.useState(!1),[W,c]=v.useState([]),[H,L]=v.useState(null),[B,V]=v.useState(null),[K,m]=v.useState([]),[E,k]=v.useState([]),{currentUser:_,logout:D,isAdmin:R,loading:se}=Ke(),{isDark:Z,toggleTheme:xe}=Je(),d=Qe(),G=v.useRef(0),I=v.useRef(!1);v.useRef(null);const Y=v.useCallback((t,l="info")=>{V({message:t,type:l}),setTimeout(()=>V(null),4e3)},[]);v.useEffect(()=>{!se&&(!_||!R)&&d("/")},[_,R,se,d]),v.useEffect(()=>{_&&R&&Q()},[_,R]);const Q=async()=>{try{const t=Se(O(S,"rescheduleRequests"),Ae("status","==","pending")),y=(await X(t)).docs.map(b=>({id:b.id,...b.data()}));y.sort((b,A)=>{const C=b.createdAt?.toDate?b.createdAt.toDate():new Date(0);return(A.createdAt?.toDate?A.createdAt.toDate():new Date(0))-C}),c(y)}catch(t){console.error("Error fetching reschedule requests:",t)}};v.useEffect(()=>{(async()=>{if(!(!_||!R))try{const[l,y]=await Promise.all([X(O(S,"clients")),X(O(S,"sessions"))]),b=l.docs.map(P=>({id:P.id,...P.data()})),A=y.docs.map(P=>({id:P.id,...P.data()}));m(b);const C=new Set(b.map(P=>P.id)),ie=y.docs.filter(P=>!C.has(P.data().clientId));if(ie.length>0){const P=ie.map(s=>je(U(S,"sessions",s.id)));await Promise.all(P)}k(A.filter(P=>C.has(P.clientId)))}catch(l){console.error("Error fetching dashboard data:",l)}})()},[_,R]),v.useEffect(()=>{const t=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,l=A=>{t()<=0&&(G.current=A.touches[0].clientY,I.current=!1)},y=A=>{const C=t(),P=A.touches[0].clientY-G.current;if(C>5||P<=0){I.current=!1,$(0);return}P>20&&C<=0&&(I.current=!0,$(Math.min((P-20)*.4,80)))},b=()=>{I.current&&N>60?(u(!0),setTimeout(()=>{window.location.reload()},300)):$(0),I.current=!1};return document.addEventListener("touchstart",l,{passive:!0}),document.addEventListener("touchmove",y,{passive:!0}),document.addEventListener("touchend",b),()=>{document.removeEventListener("touchstart",l),document.removeEventListener("touchmove",y),document.removeEventListener("touchend",b)}},[N]);const oe=()=>{u(!0),setTimeout(()=>{window.location.reload()},300)},le=async()=>{try{await D(),d("/")}catch(t){console.error("Failed to log out:",t)}},he=()=>{d("/add-client")},ce=t=>new Date(t).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),te=t=>{const[l,y]=t.split(":"),b=parseInt(l),A=b>=12?"pm":"am";return`${b>12?b-12:b===0?12:b}:${y}${A}`},ue=async t=>{if(window.confirm(`Approve reschedule for ${t.clientName}?

From: ${ce(t.originalDate)} at ${te(t.originalTime)}
To: ${ce(t.requestedDate)} at ${te(t.requestedTime)}`)){L(t.id);try{await me(U(S,"sessions",t.sessionId),{date:t.requestedDate,time:t.requestedTime}),await me(U(S,"rescheduleRequests",t.id),{status:"approved",respondedAt:J.now()}),c(W.filter(l=>l.id!==t.id)),Y(`Approved reschedule for ${t.clientName}`,"success")}catch(l){console.error("Error approving request:",l),Y("Failed to approve request","error")}L(null)}},fe=async t=>{if(window.confirm(`Reject reschedule request from ${t.clientName}?`)){L(t.id);try{await me(U(S,"rescheduleRequests",t.id),{status:"rejected",respondedAt:J.now()}),c(W.filter(l=>l.id!==t.id)),Y(`Request from ${t.clientName} rejected`,"info")}catch(l){console.error("Error rejecting request:",l),Y("Failed to reject request","error")}L(null)}};if(se)return e.jsx("div",{className:"loading",children:"Loading..."});if(!_||!R)return null;const ne=W.length,z=new Date,pe=`${z.getFullYear()}-${(z.getMonth()+1).toString().padStart(2,"0")}-${z.getDate().toString().padStart(2,"0")}`,ve=`${z.getHours().toString().padStart(2,"0")}:${z.getMinutes().toString().padStart(2,"0")}`,de=E.filter(t=>t.date===pe).length,i=t=>E.filter(l=>l.clientId!==t?!1:l.date<pe||l.date===pe&&l.time<ve).length,g=K.filter(t=>t.status!=="archived"&&(!t.clientType||t.clientType==="block")),a=new Date(z);a.setDate(a.getDate()+7);const n=g.filter(t=>{if(!t.endDate)return!1;const l=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate);return l>=z&&l<=a}),p=g.filter(t=>(t.totalSessions||0)-i(t.id)<=2),j=new Map;n.forEach(t=>{const l=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate),y=Math.ceil((l-z)/(1e3*60*60*24));j.set(t.id,{client:t,reasons:[`Block ends in ${y} day${y!==1?"s":""}`]})}),p.forEach(t=>{const l=(t.totalSessions||0)-i(t.id),y=l<=0?"No sessions left":`${l} session${l!==1?"s":""} left`;j.has(t.id)?j.get(t.id).reasons.push(y):j.set(t.id,{client:t,reasons:[y]})});const r=Array.from(j.values());return e.jsxs("div",{className:"dashboard",children:[N>0&&e.jsxs("div",{className:"pull-indicator",style:{height:N},children:[e.jsx("div",{className:`pull-spinner ${q?"spinning":""}`,children:q?"↻":"↓"}),e.jsx("span",{children:q?"Refreshing...":N>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${o==="requests"?"active":""} ${ne>0?"has-badge":""}`,onClick:()=>x("requests"),children:["Requests",ne>0&&e.jsx("span",{className:"nav-badge",children:ne})]}),e.jsx("button",{className:`nav-btn ${o==="forms"?"active":""}`,onClick:()=>x("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${o==="circuits"?"active":""}`,onClick:()=>x("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:xe,"aria-label":Z?"Switch to light mode":"Switch to dark mode",children:Z?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"refresh-btn",onClick:oe,disabled:q,children:q?"↻":"⟳"}),e.jsx("button",{className:"logout-btn",onClick:le,children:"Log Out"})]})]}),B&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${B.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[B.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),B.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),B.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:B.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[o==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:de}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>ne>0&&x("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${ne>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ne}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>x("clients"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${n.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:n.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>x("clients"),children:[e.jsx("div",{className:`summary-icon low-icon ${p.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:p.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),r.length>0&&e.jsxs("div",{className:"attention-section",children:[e.jsxs("div",{className:"attention-header",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),e.jsx("span",{children:"Needs Attention"})]}),r.map(({client:t,reasons:l})=>e.jsxs("div",{className:"attention-item",children:[e.jsx("span",{className:"attention-name",children:t.name}),e.jsx("div",{className:"attention-reasons",children:l.map((y,b)=>e.jsx("span",{className:`attention-tag ${y.includes("No sessions")?"urgent":y.includes("ends")?"warning":"low"}`,children:y},b))})]},t.id))]}),e.jsx(is,{})]}),o==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:he,children:"+ Add Client"})]}),e.jsx(Xe,{})]}),o==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(as,{})]}),o==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Reschedule Requests"})}),W.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:W.map(t=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:t.clientName}),e.jsx("span",{className:"request-time",children:t.createdAt?.toDate?t.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[ce(t.originalDate)," at ",te(t.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[ce(t.requestedDate)," at ",te(t.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>ue(t),disabled:H===t.id,children:H===t.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>fe(t),disabled:H===t.id,children:"Reject"})]})]},t.id))})]}),o==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(ds,{})]}),o==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(ms,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${o==="schedule"?"active":""}`,onClick:()=>x("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${o==="clients"?"active":""}`,onClick:()=>x("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${o==="calendar"?"active":""}`,onClick:()=>x("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{ps as default};
