import{r as p,g as se,q as Se,c as V,d as S,o as Ue,j as e,a as ye,T as ee,w as Le,b as je,e as Y,f as ze,s as Me,h as Ve,u as he,i as Ye,k as Ge,l as Ke,m as Je,n as Qe}from"./index-BX19T4d5.js";import{f as ne,D as Xe,g as Ze,a as Fe,b as De,S as We,t as ke,c as Be}from"./scheduleUtils-BAUZ6756.js";function es(){const[m,D]=p.useState([]),[f,B]=p.useState([]),[M,O]=p.useState(!0),[x,F]=p.useState(null),[o,_]=p.useState({}),[L,A]=p.useState(null),[G,X]=p.useState(""),[d,W]=p.useState("all"),[N,H]=p.useState(null),[$,P]=p.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[ie,te]=p.useState([]),[ue,c]=p.useState(!1),[J,I]=p.useState(!1),[U,Q]=p.useState("list");p.useEffect(()=>{oe()},[]);const oe=async()=>{try{const[s,h]=await Promise.all([se(Se(V(S,"clients"),Ue("name","asc"))),se(V(S,"sessions"))]),C=s.docs.map(u=>({id:u.id,...u.data()})),w=h.docs.map(u=>({id:u.id,...u.data()}));D(C),B(w)}catch(s){console.error("Error fetching data:",s)}O(!1)},pe=s=>{const h=new Date,C=h.getFullYear(),w=(h.getMonth()+1).toString().padStart(2,"0"),u=h.getDate().toString().padStart(2,"0"),T=`${C}-${w}-${u}`,z=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;return f.filter(K=>K.clientId!==s?!1:K.date<T||K.date===T&&K.time<z).length},ce=s=>{const h=pe(s.id);return(s.totalSessions||0)-h},le=s=>{const h=new Date,C=h.getFullYear(),w=(h.getMonth()+1).toString().padStart(2,"0"),u=h.getDate().toString().padStart(2,"0"),T=`${C}-${w}-${u}`,z=`${h.getHours().toString().padStart(2,"0")}:${h.getMinutes().toString().padStart(2,"0")}`;return f.filter(K=>K.clientId!==s?!1:K.date>T||K.date===T&&K.time>=z).length},xe=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",de=async(s,h)=>{if(window.confirm(`Are you sure you want to delete ${h}? This will also delete all their booked sessions.`))try{const w=f.filter(u=>u.clientId===s).map(u=>je(Y(S,"sessions",u.id)));await Promise.all(w),await je(Y(S,"clients",s)),D(m.filter(u=>u.id!==s)),B(f.filter(u=>u.clientId!==s))}catch(C){console.error("Error deleting client:",C),alert("Failed to delete client")}},ae=s=>{if(!s)return"";const h=s.toDate?s.toDate():new Date(s),C=h.getFullYear(),w=(h.getMonth()+1).toString().padStart(2,"0"),u=h.getDate().toString().padStart(2,"0");return`${C}-${w}-${u}`},re=s=>{F(s.id),_({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:ae(s.startDate),endDate:ae(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,buddyEnabled:!!s.buddyEnabled,coreBuddyPlan:s.coreBuddyPlan||"free",isJunior:!!s.isJunior})},Z=s=>{const{name:h,value:C}=s.target;if(_(w=>({...w,[h]:C})),h==="startDate"||h==="weeksInBlock"){const w=h==="startDate"?C:o.startDate,u=parseInt(h==="weeksInBlock"?C:o.weeksInBlock);if(w&&u>0){const T=new Date(w),z=new Date(T);z.setDate(z.getDate()+u*7);const K=z.getFullYear(),we=(z.getMonth()+1).toString().padStart(2,"0"),Ne=z.getDate().toString().padStart(2,"0");_($e=>({...$e,[h]:C,endDate:`${K}-${we}-${Ne}`}))}}},fe=async s=>{try{const h=m.find(T=>T.id===s);let C=h?.uid;if(o.password&&o.password.length>=6&&!h?.uid)try{const T=await ze(Me,o.email.trim().toLowerCase(),o.password);await Ve(Me),C=T.user.uid}catch(T){if(console.error("Error creating auth account:",T),T.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(T.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+T.message);return}}const w=o.clientType==="block",u={name:o.name.trim(),email:o.email.trim().toLowerCase(),clientType:o.clientType,status:o.status,coreBuddyAccess:o.coreBuddyAccess,buddyEnabled:o.buddyEnabled,isJunior:o.isJunior};if(w)u.weeksInBlock=parseInt(o.weeksInBlock)||0,u.totalSessions=parseInt(o.totalSessions)||0,u.sessionDuration=parseInt(o.sessionDuration),u.circuitAccess=o.circuitAccess,o.startDate&&(u.startDate=ee.fromDate(new Date(o.startDate))),o.endDate&&(u.endDate=ee.fromDate(new Date(o.endDate)));else if(o.clientType==="core_buddy")u.coreBuddyPlan=o.coreBuddyPlan||"free",u.coreBuddyAccess=!0;else{const T=m.find(z=>z.id===s);T?.circuitStrikes===void 0&&(u.circuitStrikes=0),T?.circuitBanUntil===void 0&&(u.circuitBanUntil=null)}C&&!h?.uid&&(u.uid=C),await he(Y(S,"clients",s),u),D(m.map(T=>T.id===s?{...T,...o,uid:C||T.uid,weeksInBlock:parseInt(o.weeksInBlock),totalSessions:parseInt(o.totalSessions),sessionDuration:parseInt(o.sessionDuration),startDate:ee.fromDate(new Date(o.startDate)),endDate:ee.fromDate(new Date(o.endDate))}:T)),F(null),C&&!h?.uid&&alert("Portal access created! Client can now log in.")}catch(h){console.error("Error updating client:",h),alert("Failed to update client")}},ge=async s=>{try{const h=m.find(C=>C.id===s)?.status==="archived"?"active":"archived";await he(Y(S,"clients",s),{status:h}),D(m.map(C=>C.id===s?{...C,status:h}:C))}catch(h){console.error("Error archiving client:",h),alert("Failed to update client status")}},ve=async s=>{H({clientId:s.id,clientName:s.name}),Q("list"),P({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),c(!0);try{const h=Se(V(S,"sessionNotes"),Le("clientId","==",s.id)),w=(await se(h)).docs.map(u=>({id:u.id,...u.data()}));w.sort((u,T)=>{const z=u.createdAt?.toMillis?.()||0;return(T.createdAt?.toMillis?.()||0)-z}),te(w)}catch(h){console.error("Error fetching notes:",h),te([])}c(!1)},me=()=>{H(null),te([]),Q("list")},n=async()=>{if(!N)return;const{sessionNotes:s,whatWentWell:h,whatWentWrong:C,whatsNext:w}=$;if(!(!s.trim()&&!h.trim()&&!C.trim()&&!w.trim())){I(!0);try{const T=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await ye(V(S,"sessionNotes"),{clientId:N.clientId,date:T,sessionNotes:s.trim(),whatWentWell:h.trim(),whatWentWrong:C.trim(),whatsNext:w.trim(),createdAt:ee.now()}),P({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const z=Se(V(S,"sessionNotes"),Le("clientId","==",N.clientId)),we=(await se(z)).docs.map(Ne=>({id:Ne.id,...Ne.data()}));we.sort((Ne,$e)=>{const Oe=Ne.createdAt?.toMillis?.()||0;return($e.createdAt?.toMillis?.()||0)-Oe}),te(we),Q("list")}catch(u){console.error("Error saving note:",u),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}I(!1)}},j=async s=>{if(window.confirm("Delete this session note?"))try{await je(Y(S,"sessionNotes",s)),te(ie.filter(h=>h.id!==s))}catch(h){console.error("Error deleting note:",h)}};if(M)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(m.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const g=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",y=m.filter(s=>s.name?.toLowerCase().includes(G.toLowerCase())||s.email?.toLowerCase().includes(G.toLowerCase())).sort((s,h)=>(s.name||"").localeCompare(h.name||"")),R=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",i=s=>s.clientType==="core_buddy",t=s=>s.status==="archived",a=y.filter(s=>!t(s)),r=a.filter(s=>!R(s)&&!i(s)),l=a.filter(s=>R(s)),v=a.filter(s=>i(s)),k=y.filter(s=>t(s)),q=d==="block"?r:d==="circuit"?l:d==="core_buddy"?v:d==="archived"?k:a,b=s=>{x||A(h=>h===s?null:s)},E=s=>{const h=L===s.id,C=x===s.id,w=!s.clientType||s.clientType==="block";return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${h||C?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>b(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:w?`${ce(s)}/${s.totalSessions||0} sessions`:g(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:g(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${h||C?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(h||C)&&e.jsx("div",{className:"client-expand-panel",children:C?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(u=>e.jsx("button",{type:"button",className:`edit-type-btn ${o.clientType===u.value?"active":""}`,onClick:()=>_(T=>({...T,clientType:u.value})),children:u.label},u.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:o.name,onChange:Z,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:o.email,onChange:Z,placeholder:"Email"})]}),o.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:o.weeksInBlock,onChange:Z,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:o.totalSessions,onChange:Z,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:o.sessionDuration,onChange:Z,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:o.startDate,onChange:Z}),e.jsx("input",{type:"date",name:"endDate",value:o.endDate,onChange:Z})]})]}),o.clientType==="core_buddy"&&e.jsx("div",{className:"edit-row",children:e.jsxs("select",{name:"coreBuddyPlan",value:o.coreBuddyPlan,onChange:Z,children:[e.jsx("option",{value:"free",children:"Free"}),e.jsx("option",{value:"premium",children:"Premium"})]})}),e.jsx("div",{className:"edit-row password-row",children:o.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:o.password,onChange:Z,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),o.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.circuitAccess,onChange:u=>_(T=>({...T,circuitAccess:u.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),o.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.coreBuddyAccess,onChange:u=>_(T=>({...T,coreBuddyAccess:u.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.buddyEnabled,onChange:u=>_(T=>({...T,buddyEnabled:u.target.checked}))}),e.jsx("span",{children:"AI Buddy"})]})}),o.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.isJunior,onChange:u=>_(T=>({...T,isJunior:u.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>fe(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{F(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),w?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[ce(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[le(s.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:xe(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:xe(s.endDate)})]})]}):s.clientType==="core_buddy"?e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Plan"}),e.jsx("span",{className:"detail-value",children:s.coreBuddyPlan==="premium"?"Premium":"Free"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:xe(s.createdAt)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:xe(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[w&&e.jsxs("button",{className:"action-btn notes",onClick:u=>{u.stopPropagation(),ve(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:u=>{u.stopPropagation(),re(s)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:u=>{u.stopPropagation(),ge(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:u=>{u.stopPropagation(),de(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:G,onChange:s=>X(s.target.value),className:"client-search-input"}),G&&e.jsx("button",{className:"client-search-clear",onClick:()=>X(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsx("div",{className:"client-type-filter",children:[{value:"all",label:"All",count:a.length},{value:"block",label:"Block",count:r.length},{value:"circuit",label:"Circuit",count:l.length},{value:"core_buddy",label:"Core Buddy",count:v.length},{value:"archived",label:"Archived",count:k.length}].map(s=>e.jsxs("button",{className:`client-filter-btn ${d===s.value?"active":""}`,onClick:()=>W(s.value),children:[s.label,e.jsx("span",{className:"client-filter-count",children:s.count})]},s.value))}),d==="all"?e.jsxs(e.Fragment,{children:[r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:r.length})]}),r.map(E)]}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:l.length})]}),l.map(E)]}),v.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:v.length})]}),v.map(E)]})]}):d==="archived"?e.jsx(e.Fragment,{children:k.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:k.length})]}),k.map(E)]})}):e.jsxs(e.Fragment,{children:[q.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",d," clients found"]}),q.map(E)]}),N&&e.jsx("div",{className:"notes-modal-overlay",onClick:me,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),N.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:me,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),U==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:ue?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):ie.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:ie.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>j(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>Q("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:$.sessionNotes,onChange:s=>P(h=>({...h,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:$.whatWentWell,onChange:s=>P(h=>({...h,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:$.whatWentWrong,onChange:s=>P(h=>({...h,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:$.whatsNext,onChange:s=>P(h=>({...h,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>Q("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:n,disabled:J,children:J?"Saving...":"Save Notes"})]})]})]})})]})}const ss=["Mon","Tue","Wed","Thu","Fri"],ts=m=>{const D=new Date(m),f=D.getDay(),B=D.getDate()-f+(f===0?-6:1);return D.setDate(B),De.map((M,O)=>{const x=new Date(D);return x.setDate(D.getDate()+O),x})};function as(){const[m,D]=p.useState(new Date),[f,B]=p.useState([]),[M,O]=p.useState([]),[x,F]=p.useState([]),[o,_]=p.useState([]),[L,A]=p.useState([]),[G,X]=p.useState([]),[d,W]=p.useState(null),[N,H]=p.useState(null),[$,P]=p.useState(!1),[ie,te]=p.useState(!0),[ue,c]=p.useState("");p.useEffect(()=>{B(ts(m))},[m]),p.useEffect(()=>{oe()},[]);const J=i=>{if(W(i),P(!1),i.startDate){const t=i.startDate.toDate?i.startDate.toDate():new Date(i.startDate);D(t)}H(null)},I=i=>{const t=new Date,a=ne(t),r=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;return x.filter(l=>l.clientId!==i?!1:l.date<a||l.date===a&&l.time<r).length},U=i=>{const t=I(i.id);return(i.totalSessions||0)-t},Q=i=>{const t=new Date,a=t.getFullYear(),r=(t.getMonth()+1).toString().padStart(2,"0"),l=t.getDate().toString().padStart(2,"0"),v=`${a}-${r}-${l}`,k=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;return x.filter(q=>q.clientId!==i?!1:q.date>v||q.date===v&&q.time>=k).length},oe=async()=>{try{const t=(await se(V(S,"clients"))).docs.map(s=>({id:s.id,...s.data()})).filter(s=>s.status==="active").sort((s,h)=>s.name.localeCompare(h.name));O(t);const r=(await se(V(S,"sessions"))).docs.map(s=>({id:s.id,...s.data()}));F(r);const v=(await se(V(S,"holidays"))).docs.map(s=>({id:s.id,...s.data()}));_(v);const q=(await se(V(S,"blockedTimes"))).docs.map(s=>({id:s.id,...s.data()}));A(q);const E=(await se(V(S,"openedSlots"))).docs.map(s=>({id:s.id,...s.data()}));X(E)}catch(i){console.error("Error fetching data:",i)}te(!1)},pe=i=>{const t=new Date(m);t.setDate(t.getDate()+i*7),D(t),H(null)},ce=()=>{D(new Date),H(null)},le=i=>{const t=ne(i);return o.some(a=>a.date===t)},xe=(i,t)=>{const a=ne(i);return L.some(r=>r.date===a&&r.time===t)},de=(i,t)=>{const a=ne(i);return G.some(r=>r.date===a&&r.time===t)},ae=i=>{const t=De[i.getDay()-1];return t&&We[t]?.defaultBlocked},re=async(i,t)=>{const a=ne(i);if(ae(i)){const l=G.find(v=>v.date===a&&v.time===t);try{if(l)await je(Y(S,"openedSlots",l.id)),X(G.filter(v=>v.id!==l.id));else{const v=await ye(V(S,"openedSlots"),{date:a,time:t,createdAt:ee.now()});X([...G,{id:v.id,date:a,time:t}])}}catch(v){console.error("Error toggling opened slot:",v),alert("Failed to update time slot")}return}const r=L.find(l=>l.date===a&&l.time===t);try{if(r)await je(Y(S,"blockedTimes",r.id)),A(L.filter(l=>l.id!==r.id));else{const l=await ye(V(S,"blockedTimes"),{date:a,time:t,createdAt:ee.now()});A([...L,{id:l.id,date:a,time:t}])}}catch(l){console.error("Error toggling blocked time:",l),alert("Failed to update time slot")}},Z=i=>{const t=ne(i);return x.filter(a=>a.date===t)},fe=(i,t)=>{const a=ne(i);return x.find(r=>r.date===a&&r.time===t)},ge=(i,t)=>{const a=ne(i),r=ke(t);return x.find(l=>{if(l.date!==a)return!1;const v=ke(l.time),k=v+(l.duration||45);return r>=v&&r<k})},ve=(i,t,a)=>{const r=De[i.getDay()-1];if(!r||le(i))return!1;const l=We[r],v=Math.ceil(a/15);if(l.defaultBlocked)for(let w=0;w<v;w++){const u=Be(t,w*15);if(!de(i,u))return!1}else for(let w=0;w<v;w++){const u=Be(t,w*15);if(xe(i,u))return!1}const k=ne(i);if(x.find(w=>w.date===k&&w.time===t))return!1;const b=Be(t,a),E=l.morning&&b<=l.morning.end,s=l.afternoon&&b<=l.afternoon.end,h=l.morning&&t>=l.morning.start&&t<l.morning.end,C=l.afternoon&&t>=l.afternoon.start&&t<l.afternoon.end;if(h&&!E||C&&!s)return!1;for(const w of x){if(w.date!==k)continue;const u=ke(w.time),T=u+(w.duration||45),z=ke(t),K=z+a;if(z<T&&K>u)return!1}return!0},me=async(i,t)=>{const a=ge(i,t);if(a){if(window.confirm(`Cancel ${a.clientName}'s session at ${Fe(a.time)}?`))try{await je(Y(S,"sessions",a.id)),F(x.filter(v=>v.id!==a.id))}catch(v){console.error("Error cancelling session:",v),alert("Failed to cancel session")}return}if(!d){alert("Please select a client first");return}if(!ve(i,t,d.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}const r=Q(d.id);if(I(d.id)+r>=d.totalSessions){alert(`${d.name} has used all ${d.totalSessions} sessions in their package`);return}try{const v=ne(i),k={clientId:d.id,clientName:d.name,date:v,time:t,duration:d.sessionDuration||45,createdAt:ee.now()},q=await ye(V(S,"sessions"),k);F([...x,{id:q.id,...k}])}catch(v){console.error("Error booking session:",v),alert("Failed to book session")}},n=async()=>{if(!d)return;const i=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),t=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),a=x.filter(b=>b.clientId!==d.id?!1:f.some(E=>ne(E)===b.date));if(a.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const r=d.weeksInBlock||Math.ceil((t-i)/(10080*60*1e3)),l=a.map(b=>({dayOfWeek:new Date(b.date).getDay(),time:b.time}));let v=[];const k=Q(d.id)+I(d.id);for(let b=0;b<r;b++){const E=new Date(i);E.setDate(E.getDate()+b*7);const s=new Date(E),h=s.getDay(),C=s.getDate()-h+(h===0?-6:1);s.setDate(C);for(const w of l){const u=new Date(s),T=w.dayOfWeek===0?6:w.dayOfWeek-1;u.setDate(s.getDate()+T);const z=ne(u);x.some(K=>K.clientId===d.id&&K.date===z&&K.time===w.time)||u<i||u>t||o.some(K=>K.date===z)||v.push({dateKey:z,time:w.time,sessionDate:u})}}const q=k+v.length;if(q>d.totalSessions){alert(`This would create ${v.length} new sessions (${q} total), but client only has ${d.totalSessions} sessions in their package.

You can still book ${d.totalSessions-k} more sessions.`);return}if(v.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${v.length} new sessions across the block.

(${k} existing + ${v.length} new = ${q} total)

Continue?`))try{const b=[];for(const E of v){const s={clientId:d.id,clientName:d.name,date:E.dateKey,time:E.time,duration:d.sessionDuration||45,createdAt:ee.now()},h=await ye(V(S,"sessions"),s);b.push({id:h.id,...s})}F([...x,...b]),alert(`Created ${b.length} new sessions!`)}catch(b){console.error("Error repeating weekly:",b),alert("Failed to repeat sessions")}},j=async i=>{const t=ne(i),a=o.find(r=>r.date===t);try{if(a)await je(Y(S,"holidays",a.id)),_(o.filter(r=>r.id!==a.id));else{const r=await ye(V(S,"holidays"),{date:t,createdAt:ee.now()});_([...o,{id:r.id,date:t}])}}catch(r){console.error("Error toggling day availability:",r),alert("Failed to update day availability")}};if(ie)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const g=f[0],y=f[4],R=g&&y?`${g.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${y.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>pe(-1),children:"←"}),e.jsx("button",{onClick:ce,children:"Today"}),e.jsx("button",{onClick:()=>pe(1),children:"→"})]}),e.jsx("h3",{children:R})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),d?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:d.name}),e.jsxs("span",{children:[d.sessionDuration||45,"min • ",U(d),"/",d.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[Q(d.id)," booked"]})]}),e.jsx("button",{onClick:()=>W(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>P(!0),children:"Select Client"})]}),d&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:n,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:f.map((i,t)=>{const a=Z(i),r=ne(i)===ne(new Date),l=le(i);return e.jsxs("div",{className:`day-card ${N===t?"selected":""} ${r?"today":""} ${l?"holiday":""}`,onClick:()=>H(N===t?null:t),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:ss[t]}),e.jsx("span",{className:"day-date",children:i.getDate()})]}),l?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[a.length," session",a.length!==1?"s":""]})]},t)})}),N!==null&&f[N]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[Xe[N]," ",f[N].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>H(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${le(f[N])?"unavailable":"available"}`,onClick:()=>j(f[N]),children:le(f[N])?"Mark Day Available":"Mark Day Unavailable"})}),le(f[N])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[ae(f[N])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),Ze(De[N]).map(({time:i,period:t},a,r)=>{const l=fe(f[N],i),v=ge(f[N],i),k=!!v,q=!l&&!!v,b=ae(f[N]),E=b?!de(f[N],i):xe(f[N],i),s=b&&de(f[N],i),h=d&&!k&&ve(f[N],i,d.sessionDuration||45),C=a===0||r[a-1]?.period!==t;return e.jsxs("div",{children:[C&&e.jsx("div",{className:"period-label",children:t==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${k?"booked":""} ${q?"booked-continuation":""} ${E&&!k?"blocked":""} ${s&&!k?"opened":""} ${h?"available":""} ${!k&&!E&&!h&&d?"unavailable":""}`,onClick:()=>(!E||k)&&me(f[N],i),disabled:E&&!k,children:[e.jsx("span",{className:"slot-time",children:Fe(i)}),l?e.jsxs("span",{className:"slot-client",children:[l.clientName," (",l.duration,"m)"]}):q?e.jsxs("span",{className:"slot-client",children:[v.clientName," ↑"]}):E?e.jsx("span",{className:"slot-blocked",children:b?"Closed":"Blocked"}):h?e.jsx("span",{className:"slot-available",children:"Available"}):d?e.jsx("span",{className:"slot-unavailable",children:"Unavailable"}):s?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${b?s?"is-opened":"":E?"is-blocked":""}`,onClick:()=>re(f[N],i),disabled:!!k,title:b?s?"Close this slot":"Open this slot":E?"Unblock this time":"Block this time",children:b?s?"✓":"+":E?"✓":"✕"})]})]},i)})]})]}),$&&e.jsx("div",{className:"modal-overlay",onClick:()=>{P(!1),c("")},children:e.jsxs("div",{className:"modal-content",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>{P(!1),c("")},children:"×"})]}),e.jsx("div",{className:"client-search-wrapper",children:e.jsx("input",{className:"client-search-input",type:"text",placeholder:"Search by name...",value:ue,onChange:i=>c(i.target.value),autoFocus:!0})}),e.jsx("div",{className:"client-list-picker",children:M.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):(()=>{const i={block:"Block",core_buddy:"Core Buddy",circuit_vip:"Circuit VIP",circuit_dropin:"Circuit Drop-in"},t=M.filter(a=>a.name.toLowerCase().includes(ue.toLowerCase()));return t.length===0?e.jsxs("p",{className:"no-items",children:['No clients match "',ue,'"']}):t.map(a=>{const r=a.startDate&&a.endDate,l=r?a.startDate?.toDate?a.startDate.toDate():new Date(a.startDate):null,v=r?a.endDate?.toDate?a.endDate.toDate():new Date(a.endDate):null,k=U(a),q=Q(a.id);return e.jsxs("button",{className:"client-option",onClick:()=>{J(a),c("")},children:[e.jsxs("div",{className:"client-option-header",children:[e.jsx("strong",{children:a.name}),a.clientType&&e.jsx("span",{className:"client-type-badge",children:i[a.clientType]||a.clientType})]}),e.jsxs("span",{children:[a.sessionDuration||45,"min • ",k,"/",a.totalSessions," remaining • ",q," booked"]}),l&&v&&e.jsxs("span",{className:"client-dates",children:[l.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," – ",v.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},a.id)})})()})]})})]})}const Ee=m=>{const[D,f]=m.split(":"),B=parseInt(D),M=B>=12?"pm":"am";return`${B>12?B-12:B===0?12:B}:${f}${M}`},be=m=>{const D=m.getFullYear(),f=(m.getMonth()+1).toString().padStart(2,"0"),B=m.getDate().toString().padStart(2,"0");return`${D}-${f}-${B}`},He=m=>m===be(new Date),ns=m=>{const D=new Date;return D.setDate(D.getDate()+1),m===be(D)},Ie=m=>He(m)?"Today":ns(m)?"Tomorrow":new Date(m).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),Pe=m=>{const D=new Date,f=be(D),B=`${D.getHours().toString().padStart(2,"0")}:${D.getMinutes().toString().padStart(2,"0")}`;if(m.date<f)return!0;if(m.date===f){const M=Re(m.time)+(m.duration||45);return Re(B)>=M}return!1},Re=m=>{const[D,f]=m.split(":").map(Number);return D*60+f};function is(){const[m,D]=p.useState([]),[f,B]=p.useState(!0),[M,O]=p.useState(new Date);p.useEffect(()=>{x();const d=setInterval(()=>{O(new Date)},6e4);return()=>clearInterval(d)},[]);const x=async()=>{try{const W=(await se(V(S,"sessions"))).docs.map($=>({id:$.id,...$.data()})),N=be(new Date),H=W.filter($=>$.date>=N).sort(($,P)=>$.date!==P.date?$.date.localeCompare(P.date):$.time.localeCompare(P.time));D(H)}catch(d){console.error("Error fetching sessions:",d)}B(!1)},F=async d=>{if(window.confirm(`Cancel ${d.clientName}'s session at ${Ee(d.time)} on ${Ie(d.date)}?`))try{await je(Y(S,"sessions",d.id)),D(m.filter(W=>W.id!==d.id))}catch(W){console.error("Error cancelling session:",W),alert("Failed to cancel session")}};if(f)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const o=m.reduce((d,W)=>{const N=W.date;return d[N]||(d[N]=[]),d[N].push(W),d},{}),_=Object.keys(o).sort(),L=be(new Date),A=o[L]||[],G=A.filter(d=>Pe(d)).length,X=A.length-G;return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:A.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[G," completed"]}),e.jsxs("span",{className:"remaining-count",children:[X," remaining"]})]})})]}),_.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:"No upcoming sessions booked"})}):e.jsx("div",{className:"sessions-list",children:_.map(d=>e.jsxs("div",{className:`date-group ${He(d)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ie(d)}),e.jsxs("span",{className:"date-count",children:[o[d].length," session",o[d].length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:o[d].map(W=>{const N=Pe(W);return e.jsxs("div",{className:`session-card ${N?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ee(W.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:W.clientName}),e.jsxs("span",{children:[W.duration,"min session"]})]}),N?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>F(W),children:"Cancel"})]},W.id)})})]},d))})]})}const ls={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},rs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},os={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},cs=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function ds(){const[m,D]=p.useState([]),[f,B]=p.useState(!0),[M,O]=p.useState(null),[x,F]=p.useState(null),[o,_]=p.useState("all"),[L,A]=p.useState("");p.useEffect(()=>{G()},[]);const G=async()=>{try{const J=(await se(V(S,"clients"))).docs.map(I=>({id:I.id,...I.data()}));J.sort((I,U)=>(I.name||"").localeCompare(U.name||"")),D(J)}catch(c){console.error("Error fetching clients:",c)}B(!1)},X=c=>!!c.welcomeForm?.completedAt,d=c=>!!c.parqForm?.completedAt,W=c=>X(c)||d(c),N=c=>X(c)&&d(c),H=c=>c?(c.toDate?c.toDate():new Date(c)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",$=m.filter(c=>!L||c.name?.toLowerCase().includes(L.toLowerCase())?o==="all"?!0:o==="completed"?N(c):o==="partial"?W(c)&&!N(c):o==="pending"?!W(c):!0:!1),P=m.filter(N).length,ie=m.filter(c=>W(c)&&!N(c)).length,te=m.filter(c=>!W(c)).length,ue=c=>{M===c?(O(null),F(null)):(O(c),F(null))};return f?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:P}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:ie}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:te}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:L,onChange:c=>A(c.target.value)}),L&&e.jsx("button",{className:"forms-search-clear",onClick:()=>A(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${o==="all"?"active":""}`,onClick:()=>_("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:m.length})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="completed"?"active":""}`,onClick:()=>_("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:P})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="partial"?"active":""}`,onClick:()=>_("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:ie})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="pending"?"active":""}`,onClick:()=>_("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:te})]})]}),$.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:$.map(c=>{const J=M===c.id,I=X(c),U=d(c);return e.jsxs("div",{className:`forms-client-card ${J?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>ue(c.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(c.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:c.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${I?"done":"not-done"}`,children:[I?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${U?"done":"not-done"}`,children:[U?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${J?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),J&&e.jsx("div",{className:"forms-expand-panel",children:!I&&!U?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[I&&e.jsx("button",{className:`forms-toggle-btn ${x==="welcome"||!x&&I?"active":""}`,onClick:()=>F("welcome"),children:"Welcome Questionnaire"}),U&&e.jsx("button",{className:`forms-toggle-btn ${x==="parq"||!x&&!I&&U?"active":""}`,onClick:()=>F("parq"),children:"PAR-Q Health Screening"})]}),(x==="welcome"||!x&&I)&&I&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",H(c.welcomeForm.completedAt)]})]}),c.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:c.welcomeForm.fitnessGoals})]}),c.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:ls[c.welcomeForm.currentActivityLevel]||c.welcomeForm.currentActivityLevel})]}),c.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:c.welcomeForm.exerciseHistory})]}),c.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:c.welcomeForm.injuries})]}),c.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:c.welcomeForm.medicalConditions})]}),c.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:rs[c.welcomeForm.sleepHours]||c.welcomeForm.sleepHours})]}),c.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:os[c.welcomeForm.stressLevel]||c.welcomeForm.stressLevel})]}),c.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:c.welcomeForm.dietaryInfo})]}),c.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:c.welcomeForm.availability})]}),c.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:c.welcomeForm.additionalInfo})]})]}),x==="parq"&&U&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",H(c.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:cs.map(Q=>{const oe=c.parqForm[Q.key];return e.jsxs("div",{className:`parq-result-item ${oe?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${oe?"yes":"no"}`,children:oe?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:Q.text})]},Q.key)})}),c.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:c.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:c.parqForm.declaration?"declared":"not-declared",children:c.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},c.id)})})]})}const Ae=m=>`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`,_e=m=>new Date(m+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),qe=()=>{const m=new Date;let f=(6-m.getDay()+7)%7;if(f===0){const M=new Date(m);M.setHours(9,45,0,0),m>M&&(f=7)}const B=new Date(m);return B.setDate(m.getDate()+f),B},Ce=m=>m==="circuit_vip"?"VIP":m==="circuit_dropin"?"Drop-in":"Block",Te=m=>m==="circuit_vip"?"vip":m==="circuit_dropin"?"dropin":"block";function ms(){const[m,D]=p.useState(!0),[f,B]=p.useState([]),[M,O]=p.useState([]),[x,F]=p.useState(null),[o,_]=p.useState("upcoming"),[L,A]=p.useState(!1),[G,X]=p.useState(null),[d,W]=p.useState(!1),[N,H]=p.useState(!1),$=p.useCallback((n,j="info")=>{X({message:n,type:j}),setTimeout(()=>X(null),4e3)},[]);p.useEffect(()=>{P()},[]);const P=async()=>{try{const j=(await se(V(S,"circuitSessions"))).docs.map(t=>({id:t.id,...t.data()}));j.sort((t,a)=>a.date.localeCompare(t.date)),B(j);const y=(await se(V(S,"clients"))).docs.map(t=>({id:t.id,...t.data()})).filter(t=>t.clientType==="circuit_vip"||t.clientType==="circuit_dropin"||t.circuitAccess===!0);O(y);const R=Ae(qe());let i=j.find(t=>t.date===R);if(!i){const t=y.filter(l=>l.clientType==="circuit_vip"&&l.status==="active"),a=[];for(let l=0;l<8;l++)l<t.length?a.push({slotNumber:l+1,memberId:t[l].id,memberName:t[l].name,memberType:"circuit_vip",status:"confirmed",bookedAt:ee.now()}):a.push({slotNumber:l+1,memberId:null,memberName:null,memberType:null,status:"available"});const r={date:R,time:"09:00",endTime:"09:45",maxCapacity:8,slots:a,waitlist:[],createdAt:ee.now()};await Ye(Y(S,"circuitSessions",R),r),i={id:R,...r},j.unshift(i),B([...j])}i?F(i):j.length>0&&F(j[0])}catch(n){console.error("Error loading circuit data:",n),$("Failed to load circuit data","error")}D(!1)},ie=async n=>{if(!(!x||L)&&window.confirm("Remove this member from the slot?")){A(!0);try{const j=[...x.slots],g=j.findIndex(r=>r.slotNumber===n);if(g===-1){A(!1);return}const y=j[g],R=y.memberType==="circuit_vip";let i=[...x.waitlist||[]];if(i.length>0){const r=i.shift();j[g]={slotNumber:n,memberId:r.memberId,memberName:r.memberName,memberType:r.memberType,status:"confirmed",bookedAt:ee.now()},$(`Slot given to ${r.memberName} from waitlist`,"success")}else j[g]={slotNumber:n,memberId:null,memberName:null,memberType:null,status:"available"},$("Member removed from slot","success");const t={slots:j,waitlist:i};if(R&&y.memberId){const r=x.vipOptOuts||[];r.includes(y.memberId)||(t.vipOptOuts=[...r,y.memberId])}await he(Y(S,"circuitSessions",x.id),t);const a={...x,...t};F(a),B(r=>r.map(l=>l.id===a.id?a:l))}catch(j){console.error("Error removing from slot:",j),$("Failed to remove member","error")}A(!1)}},te=async(n,j)=>{if(!(!x||L)){A(!0);try{const g=[...x.slots],y=g.findIndex(a=>a.slotNumber===n&&a.status==="available");if(y===-1){$("Slot is not available","error"),A(!1);return}if(g.some(a=>a.memberId===j.id)){$(`${j.name} already has a slot`,"error"),A(!1);return}g[y]={slotNumber:n,memberId:j.id,memberName:j.name,memberType:j.clientType||"block",status:"confirmed",bookedAt:ee.now()};const R=(x.waitlist||[]).filter(a=>a.memberId!==j.id),i={slots:g,waitlist:R};if(j.clientType==="circuit_vip"){const a=x.vipOptOuts||[];a.includes(j.id)&&(i.vipOptOuts=a.filter(r=>r!==j.id))}await he(Y(S,"circuitSessions",x.id),i);const t={...x,...i};F(t),B(a=>a.map(r=>r.id===t.id?t:r)),$(`${j.name} added to slot ${n}`,"success")}catch(g){console.error("Error adding to slot:",g),$("Failed to add member","error")}A(!1)}},ue=async n=>{if(!(!x||L)){A(!0);try{const j=(x.waitlist||[]).filter(y=>y.memberId!==n);await he(Y(S,"circuitSessions",x.id),{waitlist:j});const g={...x,waitlist:j};F(g),B(y=>y.map(R=>R.id===g.id?g:R)),$("Removed from waitlist","success")}catch(j){console.error("Error removing from waitlist:",j),$("Failed to remove from waitlist","error")}A(!1)}},c=async(n,j)=>{if(!(!x||L)){A(!0);try{const g=[...x.slots],y=g.findIndex(i=>i.slotNumber===n);if(y===-1){A(!1);return}if(g[y]={...g[y],attended:j},await he(Y(S,"circuitSessions",x.id),{slots:g}),j===!1){const i=g[y].memberId;if(i){const t=Y(S,"clients",i),a=await Ge(t);if(a.exists()){const l=(a.data().circuitStrikes||0)+1,v={circuitStrikes:l};if(l>=3){const k=new Date;k.setMonth(k.getMonth()+1),v.circuitBanUntil=ee.fromDate(k),v.circuitStrikes=0,$(`${g[y].memberName} banned for 1 month (3 strikes)`,"error")}else $(`No-show recorded - ${g[y].memberName} (${l}/3 strikes)`,"error");await he(t,v)}}}else $(`${g[y].memberName} marked as attended`,"success");const R={...x,slots:g};F(R),B(i=>i.map(t=>t.id===R.id?R:t))}catch(g){console.error("Error marking attendance:",g),$("Failed to update attendance","error")}A(!1)}},J=async(n,j)=>{if(!L&&window.confirm(`Reset strikes for ${j}?`)){A(!0);try{await he(Y(S,"clients",n),{circuitStrikes:0,circuitBanUntil:null}),O(g=>g.map(y=>y.id===n?{...y,circuitStrikes:0,circuitBanUntil:null}:y)),$(`Strikes reset for ${j}`,"success")}catch(g){console.error("Error resetting strikes:",g),$("Failed to reset strikes","error")}A(!1)}},I=async(n,j)=>{if(!L&&window.confirm(`Lift ban for ${j}?`)){A(!0);try{await he(Y(S,"clients",n),{circuitBanUntil:null,circuitStrikes:0}),O(g=>g.map(y=>y.id===n?{...y,circuitBanUntil:null,circuitStrikes:0}:y)),$(`Ban lifted for ${j}`,"success")}catch(g){console.error("Error lifting ban:",g),$("Failed to lift ban","error")}A(!1)}};if(m)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const U=Ae(new Date),Q=Ae(qe()),oe=f.filter(n=>n.date>=U),pe=f.filter(n=>n.date<U),ce=o==="upcoming"?oe:pe,le=x?x.slots.filter(n=>n.status!=="available").length:0,xe=x?x.slots.filter(n=>n.status==="available").length:0,de=x?x.date>=U:!1,ae=x?x.slots.filter(n=>n.memberId).map(n=>n.memberId):[],re=x?(x.waitlist||[]).map(n=>n.memberId):[],Z=M.filter(n=>!ae.includes(n.id)&&!re.includes(n.id)),fe=M.filter(n=>n.clientType==="circuit_vip").length,ge=M.filter(n=>n.clientType==="circuit_dropin").length,ve=M.filter(n=>n.circuitAccess&&n.clientType!=="circuit_vip"&&n.clientType!=="circuit_dropin").length,me=M.filter(n=>n.circuitBanUntil?(n.circuitBanUntil.toDate?n.circuitBanUntil.toDate():new Date(n.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:fe}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ge}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ve}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:f.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${d?"":"active"}`,onClick:()=>W(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${d?"active":""}`,onClick:()=>W(!0),children:"Members"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${o==="upcoming"?"active":""}`,onClick:()=>_("upcoming"),children:["Upcoming (",oe.length,")"]}),e.jsxs("button",{className:`cm-tab ${o==="past"?"active":""}`,onClick:()=>_("past"),children:["Past (",pe.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:ce.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",o," sessions"]})}):ce.map(n=>{const j=n.slots.filter(R=>R.status!=="available").length,g=x?.id===n.id,y=n.date===Q;return e.jsxs("button",{className:`cm-session-btn ${g?"selected":""} ${y?"next":""}`,onClick:()=>{F(n),H(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:_e(n.date)}),y&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[j,"/8"]}),(n.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",n.waitlist.length," wl"]})]})]},n.id)})}),x&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:_e(x.date)}),e.jsxs("p",{children:[x.time," - ",x.endTime," • ",le,"/8 booked • ",xe," available"]})]}),!de&&e.jsx("button",{className:`cm-attendance-btn ${N?"active":""}`,onClick:()=>H(!N),children:N?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:x.slots.map(n=>{const j=n.status==="available";return e.jsxs("div",{className:`cm-slot ${j?"empty":"filled"} ${n.attended===!0?"attended":""} ${n.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:n.slotNumber}),j?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),de&&e.jsx(hs,{members:Z,onSelect:g=>te(n.slotNumber,g),disabled:L})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:n.memberName}),e.jsx("span",{className:`cm-type-badge ${Te(n.memberType)}`,children:Ce(n.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[N&&n.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>c(n.slotNumber,!0),disabled:L,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>c(n.slotNumber,!1),disabled:L,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),n.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),n.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),de&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>ie(n.slotNumber),disabled:L,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},n.slotNumber)})}),(x.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",x.waitlist.length,")"]}),x.waitlist.map((n,j)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",j+1]}),e.jsx("span",{className:"cm-wl-name",children:n.memberName}),e.jsx("span",{className:`cm-type-badge ${Te(n.memberType)}`,children:Ce(n.memberType)}),de&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>ue(n.memberId),disabled:L,children:"Remove"})]},n.memberId))]})]})]}),d&&e.jsxs("div",{className:"cm-members",children:[me.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",me.length,")"]}),me.map(n=>{const j=n.circuitBanUntil?.toDate?n.circuitBanUntil.toDate():new Date(n.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:n.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",j.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>I(n.id,n.name),disabled:L,children:"Lift Ban"})]},n.id)})]}),e.jsx("div",{className:"cm-members-list",children:M.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):M.map(n=>{const j=n.circuitStrikes||0,g=me.some(y=>y.id===n.id);return e.jsxs("div",{className:`cm-member-card ${g?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:n.name}),e.jsx("span",{className:`cm-type-badge ${Te(n.clientType)}`,children:Ce(n.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(y=>e.jsx("span",{className:`cm-strike-dot ${y<j?"active":""}`},y)),e.jsxs("span",{className:"cm-strike-text",children:[j,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[g&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>I(n.id,n.name),disabled:L,children:"Lift Ban"}),j>0&&!g&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>J(n.id,n.name),disabled:L,children:"Reset"})]})]})]},n.id)})})]}),G&&e.jsx("div",{className:`cm-toast ${G.type}`,children:e.jsx("span",{children:G.message})})]})}function hs({members:m,onSelect:D,disabled:f}){const[B,M]=p.useState(!1),[O,x]=p.useState(""),F=m.filter(o=>o.name.toLowerCase().includes(O.toLowerCase()));return m.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>M(!B),disabled:f,children:"+ Add"}),B&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{M(!1),x("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[m.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:O,onChange:o=>x(o.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[F.map(o=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{D(o),M(!1),x("")},children:[e.jsx("span",{children:o.name}),e.jsx("span",{className:`cm-type-badge sm ${Te(o.clientType)}`,children:Ce(o.clientType)})]},o.id)),F.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function js(){const[m,D]=p.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),f=t=>{D(t),localStorage.setItem("adminActiveView",t)},[B,M]=p.useState(0),[O,x]=p.useState(!1),[F,o]=p.useState([]),[_,L]=p.useState(null),[A,G]=p.useState(null),[X,d]=p.useState([]),[W,N]=p.useState([]),{currentUser:H,logout:$,isAdmin:P,loading:ie}=Ke(),{isDark:te,toggleTheme:ue}=Je(),c=Qe(),J=p.useRef(0),I=p.useRef(!1);p.useRef(null);const U=p.useCallback((t,a="info")=>{G({message:t,type:a}),setTimeout(()=>G(null),4e3)},[]);p.useEffect(()=>{!ie&&(!H||!P)&&c("/")},[H,P,ie,c]),p.useEffect(()=>{H&&P&&Q()},[H,P]);const Q=async()=>{try{const t=Se(V(S,"rescheduleRequests"),Le("status","==","pending")),r=(await se(t)).docs.map(l=>({id:l.id,...l.data()}));r.sort((l,v)=>{const k=l.createdAt?.toDate?l.createdAt.toDate():new Date(0);return(v.createdAt?.toDate?v.createdAt.toDate():new Date(0))-k}),o(r)}catch(t){console.error("Error fetching reschedule requests:",t)}};p.useEffect(()=>{(async()=>{if(!(!H||!P))try{const[a,r]=await Promise.all([se(V(S,"clients")),se(V(S,"sessions"))]),l=a.docs.map(b=>({id:b.id,...b.data()})),v=r.docs.map(b=>({id:b.id,...b.data()}));d(l);const k=new Set(l.map(b=>b.id)),q=r.docs.filter(b=>!k.has(b.data().clientId));if(q.length>0){const b=q.map(E=>je(Y(S,"sessions",E.id)));await Promise.all(b)}N(v.filter(b=>k.has(b.clientId)))}catch(a){console.error("Error fetching dashboard data:",a)}})()},[H,P]),p.useEffect(()=>{const t=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,a=v=>{t()<=0&&(J.current=v.touches[0].clientY,I.current=!1)},r=v=>{const k=t(),b=v.touches[0].clientY-J.current;if(k>5||b<=0){I.current=!1,M(0);return}b>20&&k<=0&&(I.current=!0,M(Math.min((b-20)*.4,80)))},l=()=>{I.current&&B>60?(x(!0),setTimeout(()=>{window.location.reload()},300)):M(0),I.current=!1};return document.addEventListener("touchstart",a,{passive:!0}),document.addEventListener("touchmove",r,{passive:!0}),document.addEventListener("touchend",l),()=>{document.removeEventListener("touchstart",a),document.removeEventListener("touchmove",r),document.removeEventListener("touchend",l)}},[B]);const oe=async()=>{try{await $(),c("/")}catch(t){console.error("Failed to log out:",t)}},pe=()=>{c("/add-client")},ce=t=>new Date(t).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),le=t=>{const[a,r]=t.split(":"),l=parseInt(a),v=l>=12?"pm":"am";return`${l>12?l-12:l===0?12:l}:${r}${v}`},xe=async t=>{if(window.confirm(`Approve reschedule for ${t.clientName}?

From: ${ce(t.originalDate)} at ${le(t.originalTime)}
To: ${ce(t.requestedDate)} at ${le(t.requestedTime)}`)){L(t.id);try{await he(Y(S,"sessions",t.sessionId),{date:t.requestedDate,time:t.requestedTime}),await he(Y(S,"rescheduleRequests",t.id),{status:"approved",respondedAt:ee.now()}),o(F.filter(a=>a.id!==t.id)),U(`Approved reschedule for ${t.clientName}`,"success")}catch(a){console.error("Error approving request:",a),U("Failed to approve request","error")}L(null)}},de=async t=>{if(window.confirm(`Reject reschedule request from ${t.clientName}?`)){L(t.id);try{await he(Y(S,"rescheduleRequests",t.id),{status:"rejected",respondedAt:ee.now()}),o(F.filter(a=>a.id!==t.id)),U(`Request from ${t.clientName} rejected`,"info")}catch(a){console.error("Error rejecting request:",a),U("Failed to reject request","error")}L(null)}};if(ie)return e.jsx("div",{className:"loading",children:"Loading..."});if(!H||!P)return null;const ae=F.length,re=new Date,Z=`${re.getFullYear()}-${(re.getMonth()+1).toString().padStart(2,"0")}-${re.getDate().toString().padStart(2,"0")}`,fe=`${re.getHours().toString().padStart(2,"0")}:${re.getMinutes().toString().padStart(2,"0")}`,ve=W.filter(t=>t.date===Z).length,me=t=>W.filter(a=>a.clientId!==t?!1:a.date<Z||a.date===Z&&a.time<fe).length,n=X.filter(t=>t.status!=="archived"&&(!t.clientType||t.clientType==="block")),j=new Date(re);j.setDate(j.getDate()+7);const g=n.filter(t=>{if(!t.endDate)return!1;const a=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate);return a>=re&&a<=j}),y=n.filter(t=>(t.totalSessions||0)-me(t.id)<=2),R=new Map;g.forEach(t=>{const a=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate),r=Math.ceil((a-re)/(1e3*60*60*24));R.set(t.id,{client:t,reasons:[`Block ends in ${r} day${r!==1?"s":""}`]})}),y.forEach(t=>{const a=(t.totalSessions||0)-me(t.id),r=a<=0?"No sessions left":`${a} session${a!==1?"s":""} left`;R.has(t.id)?R.get(t.id).reasons.push(r):R.set(t.id,{client:t,reasons:[r]})});const i=Array.from(R.values());return e.jsxs("div",{className:"dashboard",children:[B>0&&e.jsxs("div",{className:"pull-indicator",style:{height:B},children:[e.jsx("div",{className:`pull-spinner ${O?"spinning":""}`,children:O?"↻":"↓"}),e.jsx("span",{children:O?"Refreshing...":B>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${m==="requests"?"active":""} ${ae>0?"has-badge":""}`,onClick:()=>f("requests"),children:["Requests",ae>0&&e.jsx("span",{className:"nav-badge",children:ae})]}),e.jsx("button",{className:`nav-btn ${m==="forms"?"active":""}`,onClick:()=>f("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${m==="circuits"?"active":""}`,onClick:()=>f("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:ue,"aria-label":te?"Switch to light mode":"Switch to dark mode",children:te?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"logout-btn",onClick:oe,children:"Log Out"})]})]}),A&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${A.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[A.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),A.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),A.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:A.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[m==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ve}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>ae>0&&f("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${ae>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ae}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>f("clients"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${g.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:g.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>f("clients"),children:[e.jsx("div",{className:`summary-icon low-icon ${y.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:y.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),i.length>0&&e.jsxs("div",{className:"attention-section",children:[e.jsxs("div",{className:"attention-header",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),e.jsx("span",{children:"Needs Attention"})]}),i.map(({client:t,reasons:a})=>e.jsxs("div",{className:"attention-item",children:[e.jsx("span",{className:"attention-name",children:t.name}),e.jsx("div",{className:"attention-reasons",children:a.map((r,l)=>e.jsx("span",{className:`attention-tag ${r.includes("No sessions")?"urgent":r.includes("ends")?"warning":"low"}`,children:r},l))})]},t.id))]}),e.jsx(is,{})]}),m==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:pe,children:"+ Add Client"})]}),e.jsx(es,{})]}),m==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(as,{})]}),m==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Reschedule Requests"})}),F.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:F.map(t=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:t.clientName}),e.jsx("span",{className:"request-time",children:t.createdAt?.toDate?t.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[ce(t.originalDate)," at ",le(t.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[ce(t.requestedDate)," at ",le(t.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>xe(t),disabled:_===t.id,children:_===t.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>de(t),disabled:_===t.id,children:"Reject"})]})]},t.id))})]}),m==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(ds,{})]}),m==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(ms,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${m==="schedule"?"active":""}`,onClick:()=>f("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${m==="clients"?"active":""}`,onClick:()=>f("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${m==="calendar"?"active":""}`,onClick:()=>f("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{js as default};
