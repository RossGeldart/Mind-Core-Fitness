import{r as p,g as ue,q as Re,c as se,d as C,o as es,j as e,a as Ee,T as je,w as We,b as Be,e as oe,f as ss,s as Qe,h as ts,u as Se,i as as,k as ns,l as is,m as ls,n as os}from"./index-KLi_FzO2.js";import{f as ne,D as rs,g as cs,i as Ie,a as Pe,t as Fe,b as qe,c as _e,S as ze,d as ds}from"./scheduleUtils-a2tn0x12.js";function ms(){const[x,M]=p.useState([]),[g,A]=p.useState([]),[R,ee]=p.useState(!0),[m,L]=p.useState(null),[r,Z]=p.useState({}),[E,$]=p.useState(null),[z,te]=p.useState(""),[c,pe]=p.useState("all"),[B,ce]=p.useState(null),[W,re]=p.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[we,he]=p.useState([]),[ve,d]=p.useState(!1),[X,Y]=p.useState(!1),[T,P]=p.useState("list");p.useEffect(()=>{N()},[]);const N=async()=>{try{const[s,l]=await Promise.all([ue(Re(se(C,"clients"),es("name","asc"))),ue(se(C,"sessions"))]),f=s.docs.map(t=>({id:t.id,...t.data()})),k=l.docs.map(t=>({id:t.id,...t.data()}));M(f),A(k)}catch(s){console.error("Error fetching data:",s)}ee(!1)},O=s=>{const l=new Date,f=l.getFullYear(),k=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0"),a=`${f}-${k}-${t}`,n=`${l.getHours().toString().padStart(2,"0")}:${l.getMinutes().toString().padStart(2,"0")}`;return g.filter(h=>h.clientId!==s?!1:h.date<a||h.date===a&&h.time<n).length},J=s=>{const l=O(s.id);return(s.totalSessions||0)-l},De=s=>{const l=new Date,f=l.getFullYear(),k=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0"),a=`${f}-${k}-${t}`,n=`${l.getHours().toString().padStart(2,"0")}:${l.getMinutes().toString().padStart(2,"0")}`;return g.filter(h=>h.clientId!==s?!1:h.date>a||h.date===a&&h.time>=n).length},ae=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",de=async(s,l)=>{if(window.confirm(`Are you sure you want to delete ${l}? This will also delete all their booked sessions.`))try{const k=g.filter(t=>t.clientId===s).map(t=>Be(oe(C,"sessions",t.id)));await Promise.all(k),await Be(oe(C,"clients",s)),M(x.filter(t=>t.id!==s)),A(g.filter(t=>t.clientId!==s))}catch(f){console.error("Error deleting client:",f),alert("Failed to delete client")}},ie=s=>{if(!s)return"";const l=s.toDate?s.toDate():new Date(s),f=l.getFullYear(),k=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0");return`${f}-${k}-${t}`},Ne=s=>{L(s.id),Z({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:ie(s.startDate),endDate:ie(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,coreBuddyPlan:s.coreBuddyPlan||"free",isJunior:!!s.isJunior})},me=s=>{const{name:l,value:f}=s.target;if(Z(k=>({...k,[l]:f})),l==="startDate"||l==="weeksInBlock"){const k=l==="startDate"?f:r.startDate,t=parseInt(l==="weeksInBlock"?f:r.weeksInBlock);if(k&&t>0){const a=new Date(k),n=new Date(a);n.setDate(n.getDate()+t*7);const h=n.getFullYear(),u=(n.getMonth()+1).toString().padStart(2,"0"),y=n.getDate().toString().padStart(2,"0");Z(j=>({...j,[l]:f,endDate:`${h}-${u}-${y}`}))}}},fe=async s=>{try{const l=x.find(a=>a.id===s);let f=l?.uid;if(r.password&&r.password.length>=6&&!l?.uid)try{const a=await ss(Qe,r.email.trim().toLowerCase(),r.password);await ts(Qe),f=a.user.uid}catch(a){if(console.error("Error creating auth account:",a),a.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(a.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+a.message);return}}const k=r.clientType==="block",t={name:r.name.trim(),email:r.email.trim().toLowerCase(),clientType:r.clientType,status:r.status,coreBuddyAccess:r.coreBuddyAccess,isJunior:r.isJunior};if(k)t.weeksInBlock=parseInt(r.weeksInBlock)||0,t.totalSessions=parseInt(r.totalSessions)||0,t.sessionDuration=parseInt(r.sessionDuration),t.circuitAccess=r.circuitAccess,r.startDate&&(t.startDate=je.fromDate(new Date(r.startDate))),r.endDate&&(t.endDate=je.fromDate(new Date(r.endDate)));else if(r.clientType==="core_buddy")t.coreBuddyPlan=r.coreBuddyPlan||"free",t.coreBuddyAccess=!0;else{const a=x.find(n=>n.id===s);a?.circuitStrikes===void 0&&(t.circuitStrikes=0),a?.circuitBanUntil===void 0&&(t.circuitBanUntil=null)}f&&!l?.uid&&(t.uid=f),await Se(oe(C,"clients",s),t),M(x.map(a=>a.id===s?{...a,...r,uid:f||a.uid,weeksInBlock:parseInt(r.weeksInBlock),totalSessions:parseInt(r.totalSessions),sessionDuration:parseInt(r.sessionDuration),startDate:je.fromDate(new Date(r.startDate)),endDate:je.fromDate(new Date(r.endDate))}:a)),L(null),f&&!l?.uid&&alert("Portal access created! Client can now log in.")}catch(l){console.error("Error updating client:",l),alert("Failed to update client")}},$e=async s=>{try{const l=x.find(f=>f.id===s)?.status==="archived"?"active":"archived";await Se(oe(C,"clients",s),{status:l}),M(x.map(f=>f.id===s?{...f,status:l}:f))}catch(l){console.error("Error archiving client:",l),alert("Failed to update client status")}},Ae=async s=>{ce({clientId:s.id,clientName:s.name}),P("list"),re({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),d(!0);try{const l=Re(se(C,"sessionNotes"),We("clientId","==",s.id)),k=(await ue(l)).docs.map(t=>({id:t.id,...t.data()}));k.sort((t,a)=>{const n=t.createdAt?.toMillis?.()||0;return(a.createdAt?.toMillis?.()||0)-n}),he(k)}catch(l){console.error("Error fetching notes:",l),he([])}d(!1)},ge=()=>{ce(null),he([]),P("list")},o=async()=>{if(!B)return;const{sessionNotes:s,whatWentWell:l,whatWentWrong:f,whatsNext:k}=W;if(!(!s.trim()&&!l.trim()&&!f.trim()&&!k.trim())){Y(!0);try{const a=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await Ee(se(C,"sessionNotes"),{clientId:B.clientId,date:a,sessionNotes:s.trim(),whatWentWell:l.trim(),whatWentWrong:f.trim(),whatsNext:k.trim(),createdAt:je.now()}),re({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const n=Re(se(C,"sessionNotes"),We("clientId","==",B.clientId)),u=(await ue(n)).docs.map(y=>({id:y.id,...y.data()}));u.sort((y,j)=>{const I=y.createdAt?.toMillis?.()||0;return(j.createdAt?.toMillis?.()||0)-I}),he(u),P("list")}catch(t){console.error("Error saving note:",t),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}Y(!1)}},v=async s=>{if(window.confirm("Delete this session note?"))try{await Be(oe(C,"sessionNotes",s)),he(we.filter(l=>l.id!==s))}catch(l){console.error("Error deleting note:",l)}};if(R)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(x.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const b=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",D=()=>{const s=j=>j&&j.toDate?j.toDate().toLocaleDateString("en-GB"):"",l=c==="all"?H:Te,f=c==="all"?"all-clients":c==="block"?"block-members":c==="circuit"?"circuit-members":c==="core_buddy"?"core-buddy":"archived",k=["Name","Email","Type","Status","Total Sessions","Sessions Remaining","Session Duration (min)","Weeks in Block","Start Date","End Date","Portal Access","Circuit Access","Core Buddy Access","Core Buddy Plan","Is Junior","Created At"],t=l.map(j=>[j.name||"",j.email||"",b(j),j.status||"active",j.totalSessions||"",J(j)||"",j.sessionDuration||"",j.weeksInBlock||"",s(j.startDate),s(j.endDate),j.uid?"Yes":"No",j.circuitAccess?"Yes":"No",j.coreBuddyAccess?"Yes":"No",j.coreBuddyPlan||"",j.isJunior?"Yes":"No",s(j.createdAt)]),a=j=>{const I=String(j);return I.includes(",")||I.includes('"')||I.includes(`
`)?`"${I.replace(/"/g,'""')}"`:I},n=[k,...t].map(j=>j.map(a).join(",")).join(`
`),h=new Blob([n],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(h),y=document.createElement("a");y.href=u,y.download=`mind-core-${f}-${new Date().toISOString().slice(0,10)}.csv`,y.click(),URL.revokeObjectURL(u)},_=x.filter(s=>s.name?.toLowerCase().includes(z.toLowerCase())||s.email?.toLowerCase().includes(z.toLowerCase())).sort((s,l)=>(s.name||"").localeCompare(l.name||"")),q=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",F=s=>s.clientType==="core_buddy",U=s=>s.status==="archived",H=_.filter(s=>!U(s)),V=H.filter(s=>!q(s)&&!F(s)),be=H.filter(s=>q(s)),ye=H.filter(s=>F(s)),ke=_.filter(s=>U(s)),Te=c==="block"?V:c==="circuit"?be:c==="core_buddy"?ye:c==="archived"?ke:H,i=s=>{m||$(l=>l===s?null:s)},S=s=>{const l=E===s.id,f=m===s.id,k=!s.clientType||s.clientType==="block";let t=null,a=null;if(k&&s.status!=="archived"){const n=J(s);if(n<=2&&(t={text:n<=0?"No sessions":`${n} left`,urgent:n<=0}),s.endDate){const h=s.endDate.toDate?s.endDate.toDate():new Date(s.endDate),u=Math.ceil((h-new Date)/(1e3*60*60*24));u<=7&&(a={text:u<=0?"Expired":u===1?"Ends today":`${u}d left`,urgent:u<=1})}}return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${l||f?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>i(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:k?`${J(s)}/${s.totalSessions||0} sessions`:b(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[t&&e.jsx("span",{className:`client-warn-badge ${t.urgent?"urgent":"warning"}`,children:t.text}),a&&e.jsx("span",{className:`client-warn-badge ${a.urgent?"urgent":"expiry"}`,children:a.text}),(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:b(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${l||f?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(l||f)&&e.jsx("div",{className:"client-expand-panel",children:f?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(n=>e.jsx("button",{type:"button",className:`edit-type-btn ${r.clientType===n.value?"active":""}`,onClick:()=>Z(h=>({...h,clientType:n.value})),children:n.label},n.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:r.name,onChange:me,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:r.email,onChange:me,placeholder:"Email"})]}),r.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:r.weeksInBlock,onChange:me,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:r.totalSessions,onChange:me,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:r.sessionDuration,onChange:me,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:r.startDate,onChange:me}),e.jsx("input",{type:"date",name:"endDate",value:r.endDate,onChange:me})]})]}),r.clientType==="core_buddy"&&e.jsx("div",{className:"edit-row",children:e.jsxs("select",{name:"coreBuddyPlan",value:r.coreBuddyPlan,onChange:me,children:[e.jsx("option",{value:"free",children:"Free"}),e.jsx("option",{value:"premium",children:"Premium"})]})}),e.jsx("div",{className:"edit-row password-row",children:r.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:r.password,onChange:me,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),r.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:r.circuitAccess,onChange:n=>Z(h=>({...h,circuitAccess:n.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),r.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:r.coreBuddyAccess,onChange:n=>Z(h=>({...h,coreBuddyAccess:n.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),r.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:r.isJunior,onChange:n=>Z(h=>({...h,isJunior:n.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>fe(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{L(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),k?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[J(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[De(s.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:ae(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:ae(s.endDate)})]})]}):s.clientType==="core_buddy"?e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Plan"}),e.jsx("span",{className:"detail-value",children:s.coreBuddyPlan==="premium"?"Premium":"Free"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ae(s.createdAt)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ae(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[k&&e.jsxs("button",{className:"action-btn notes",onClick:n=>{n.stopPropagation(),Ae(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:n=>{n.stopPropagation(),Ne(s)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:n=>{n.stopPropagation(),$e(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:n=>{n.stopPropagation(),de(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:z,onChange:s=>te(s.target.value),className:"client-search-input"}),z&&e.jsx("button",{className:"client-search-clear",onClick:()=>te(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"client-filter-row",children:[e.jsxs("select",{className:"client-type-select",value:c,onChange:s=>pe(s.target.value),children:[e.jsxs("option",{value:"all",children:["All Clients (",H.length,")"]}),e.jsxs("option",{value:"block",children:["Block Members (",V.length,")"]}),e.jsxs("option",{value:"circuit",children:["Circuit Members (",be.length,")"]}),e.jsxs("option",{value:"core_buddy",children:["Core Buddy (",ye.length,")"]}),e.jsxs("option",{value:"archived",children:["Archived (",ke.length,")"]})]}),e.jsxs("button",{className:"export-csv-btn",onClick:D,title:"Export current view to CSV",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Export CSV"]})]}),c==="all"?e.jsxs(e.Fragment,{children:[V.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:V.length})]}),V.map(S)]}),be.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:be.length})]}),be.map(S)]}),ye.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:ye.length})]}),ye.map(S)]})]}):c==="archived"?e.jsx(e.Fragment,{children:ke.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:ke.length})]}),ke.map(S)]})}):e.jsxs(e.Fragment,{children:[Te.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",c," clients found"]}),Te.map(S)]}),B&&e.jsx("div",{className:"notes-modal-overlay",onClick:ge,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),B.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:ge,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),T==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:ve?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):we.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:we.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>v(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>P("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:W.sessionNotes,onChange:s=>re(l=>({...l,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:W.whatWentWell,onChange:s=>re(l=>({...l,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:W.whatWentWrong,onChange:s=>re(l=>({...l,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:W.whatsNext,onChange:s=>re(l=>({...l,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>P("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:o,disabled:X,children:X?"Saving...":"Save Notes"})]})]})]})})]})}const hs=["Mon","Tue","Wed","Thu","Fri"],us=x=>{const M=new Date(x),g=M.getDay(),A=M.getDate()-g+(g===0?-6:1);return M.setDate(A),qe.map((R,ee)=>{const m=new Date(M);return m.setDate(M.getDate()+ee),m})};function ps(){const[x,M]=p.useState(new Date),[g,A]=p.useState([]),[R,ee]=p.useState([]),[m,L]=p.useState([]),[r,Z]=p.useState([]),[E,$]=p.useState([]),[z,te]=p.useState([]),[c,pe]=p.useState(null),[B,ce]=p.useState(null),[W,re]=p.useState(!1),[we,he]=p.useState(!0),[ve,d]=p.useState(""),[X,Y]=p.useState([]),[T,P]=p.useState(null),[N,O]=p.useState(!1);p.useEffect(()=>{A(us(x))},[x]),p.useEffect(()=>{fe()},[]);const J=t=>{pe(t),re(!1),ce(null)},De=()=>{if(!c)return null;const t=c.startDate?.toDate?c.startDate.toDate():new Date(c.startDate),a=c.endDate?.toDate?c.endDate.toDate():new Date(c.endDate),n=g[0];if(!n)return null;const h=10080*60*1e3,u=Math.floor((n-t)/h)+1,y=c.weeksInBlock||Math.ceil((a-t)/h),j=n>=t&&n<=a;return{startDate:t,endDate:a,weekNumber:u,totalWeeks:y,isWithinBlock:j}},ae=()=>{if(c?.startDate){const t=c.startDate.toDate?c.startDate.toDate():new Date(c.startDate);M(t),ce(null)}},de=()=>{if(c?.endDate){const t=c.endDate.toDate?c.endDate.toDate():new Date(c.endDate);M(t),ce(null)}},ie=t=>{const a=new Date,n=ne(a),h=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`,u=t.startDate?.toDate?t.startDate.toDate():t.startDate?new Date(t.startDate):null,y=t.endDate?.toDate?t.endDate.toDate():t.endDate?new Date(t.endDate):null,j=u?ne(u):null,I=y?ne(y):null;return m.filter(w=>w.clientId!==t.id||j&&w.date<j||I&&w.date>I?!1:w.date<n||w.date===n&&w.time<h).length},Ne=t=>{const a=ie(t);return(t.totalSessions||0)-a},me=t=>{const a=new Date,n=ne(a),h=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`,u=t.startDate?.toDate?t.startDate.toDate():t.startDate?new Date(t.startDate):null,y=t.endDate?.toDate?t.endDate.toDate():t.endDate?new Date(t.endDate):null,j=u?ne(u):null,I=y?ne(y):null;return m.filter(w=>w.clientId!==t.id||j&&w.date<j||I&&w.date>I?!1:w.date>n||w.date===n&&w.time>=h).length},fe=async()=>{try{const a=(await ue(se(C,"clients"))).docs.map(K=>({id:K.id,...K.data()})).filter(K=>K.status==="active").sort((K,le)=>K.name.localeCompare(le.name));ee(a);const h=(await ue(se(C,"sessions"))).docs.map(K=>({id:K.id,...K.data()}));L(h);const y=(await ue(se(C,"holidays"))).docs.map(K=>({id:K.id,...K.data()}));Z(y);const I=(await ue(se(C,"blockedTimes"))).docs.map(K=>({id:K.id,...K.data()}));$(I);const G=(await ue(se(C,"openedSlots"))).docs.map(K=>({id:K.id,...K.data()}));te(G);const xe=(await ue(se(C,"sessionNotes"))).docs.map(K=>({id:K.id,...K.data()}));Y(xe)}catch(t){console.error("Error fetching data:",t)}he(!1)},$e=t=>X.some(a=>a.clientId===t.clientId&&a.date===t.date),Ae=(t,a)=>{if(!c)return"Unavailable";const n=c.sessionDuration||45,h=ne(t),u=Fe(a),y=u+n,j=m.find(G=>{if(G.date!==h)return!1;const Q=Fe(G.time),xe=Q+(G.duration||45);return u<xe&&y>Q});if(j)return`Taken — ${j.clientName}`;const I=qe[t.getDay()-1],w=ze[I];if(w){const G=_e(a,n),Q=w.morning&&a>=w.morning.start&&a<w.morning.end,xe=w.afternoon&&a>=w.afternoon.start&&a<w.afternoon.end;if(Q&&G>w.morning.end)return"Splits break";if(xe&&G>w.afternoon.end)return"Overruns end"}return"Unavailable"},ge=t=>{const a=R.find(w=>w.id===t.clientId);if(!a||!a.startDate||!a.endDate)return[];const n=a.startDate?.toDate?a.startDate.toDate():new Date(a.startDate),h=a.endDate?.toDate?a.endDate.toDate():new Date(a.endDate),u=new Date,y=new Date(u.getFullYear(),u.getMonth(),u.getDate()),j=[],I=new Date(Math.max(n.getTime(),y.getTime()));for(;I<=h;){const w=I.getDay();if(w>=1&&w<=5){const G=ne(I);r.some(Q=>Q.date===G)||j.push(new Date(I))}I.setDate(I.getDate()+1)}return j},o=(t,a)=>a?ds(a,t.duration||45,m,r,t.id,E,z):[],v=async t=>{if(P(null),window.confirm(`Cancel ${t.clientName}'s session at ${Pe(t.time)}?`))try{await Be(oe(C,"sessions",t.id)),L(m.filter(a=>a.id!==t.id))}catch(a){console.error("Error cancelling session:",a),alert("Failed to cancel session")}},b=async(t,a,n)=>{O(!0);try{const h=ne(a);await Se(oe(C,"sessions",t.id),{date:h,time:n}),L(m.map(u=>u.id===t.id?{...u,date:h,time:n}:u)),P(null)}catch(h){console.error("Error rescheduling session:",h),alert("Failed to reschedule session")}O(!1)},D=t=>{const a=new Date(x);a.setDate(a.getDate()+t*7),M(a),ce(null)},_=()=>{M(new Date),ce(null)},q=t=>{const a=ne(t);return r.some(n=>n.date===a)},F=(t,a)=>{const n=ne(t);return E.some(h=>h.date===n&&h.time===a)},U=(t,a)=>{const n=ne(t);return z.some(h=>h.date===n&&h.time===a)},H=t=>{const a=qe[t.getDay()-1];return a&&ze[a]?.defaultBlocked},V=async(t,a)=>{const n=ne(t);if(H(t)){const u=z.find(y=>y.date===n&&y.time===a);try{if(u)await Be(oe(C,"openedSlots",u.id)),te(z.filter(y=>y.id!==u.id));else{const y=await Ee(se(C,"openedSlots"),{date:n,time:a,createdAt:je.now()});te([...z,{id:y.id,date:n,time:a}])}}catch(y){console.error("Error toggling opened slot:",y),alert("Failed to update time slot")}return}const h=E.find(u=>u.date===n&&u.time===a);try{if(h)await Be(oe(C,"blockedTimes",h.id)),$(E.filter(u=>u.id!==h.id));else{const u=await Ee(se(C,"blockedTimes"),{date:n,time:a,createdAt:je.now()});$([...E,{id:u.id,date:n,time:a}])}}catch(u){console.error("Error toggling blocked time:",u),alert("Failed to update time slot")}},be=t=>{const a=ne(t);return m.filter(n=>n.date===a)},ye=(t,a)=>{const n=ne(t);return m.find(h=>h.date===n&&h.time===a)},ke=(t,a)=>{const n=ne(t),h=Fe(a);return m.find(u=>{if(u.date!==n)return!1;const y=Fe(u.time),j=y+(u.duration||45);return h>=y&&h<j})},Te=(t,a,n)=>{const h=qe[t.getDay()-1];if(!h||q(t))return!1;const u=ze[h],y=Math.ceil(n/15);if(u.defaultBlocked)for(let le=0;le<y;le++){const Ce=_e(a,le*15);if(!U(t,Ce))return!1}else for(let le=0;le<y;le++){const Ce=_e(a,le*15);if(F(t,Ce))return!1}const j=ne(t);if(m.find(le=>le.date===j&&le.time===a))return!1;const w=_e(a,n),G=u.morning&&w<=u.morning.end,Q=u.afternoon&&w<=u.afternoon.end,xe=u.morning&&a>=u.morning.start&&a<u.morning.end,K=u.afternoon&&a>=u.afternoon.start&&a<u.afternoon.end;if(xe&&!G||K&&!Q)return!1;for(const le of m){if(le.date!==j)continue;const Ce=Fe(le.time),Ve=Ce+(le.duration||45),Le=Fe(a),Me=Le+n;if(Le<Ve&&Me>Ce)return!1}return!0},i=async(t,a)=>{const n=ke(t,a);if(n){if(Ie(n))return;P({session:n,step:"action",selectedDate:null,selectedTime:null});return}if(!c){alert("Please select a client first");return}if(!Te(t,a,c.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}const h=me(c);if(ie(c)+h>=c.totalSessions){alert(`${c.name} has used all ${c.totalSessions} sessions in their package`);return}try{const y=ne(t),j={clientId:c.id,clientName:c.name,date:y,time:a,duration:c.sessionDuration||45,createdAt:je.now()},I=await Ee(se(C,"sessions"),j);L([...m,{id:I.id,...j}])}catch(y){console.error("Error booking session:",y),alert("Failed to book session")}},S=async()=>{if(!c)return;const t=c.startDate?.toDate?c.startDate.toDate():new Date(c.startDate),a=c.endDate?.toDate?c.endDate.toDate():new Date(c.endDate),n=m.filter(w=>w.clientId!==c.id?!1:g.some(G=>ne(G)===w.date));if(n.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const h=c.weeksInBlock||Math.ceil((a-t)/(10080*60*1e3)),u=n.map(w=>({dayOfWeek:new Date(w.date).getDay(),time:w.time}));let y=[];const j=me(c)+ie(c);for(let w=0;w<h;w++){const G=new Date(t);G.setDate(G.getDate()+w*7);const Q=new Date(G),xe=Q.getDay(),K=Q.getDate()-xe+(xe===0?-6:1);Q.setDate(K);for(const le of u){const Ce=new Date(Q),Ve=le.dayOfWeek===0?6:le.dayOfWeek-1;Ce.setDate(Q.getDate()+Ve);const Le=ne(Ce);m.some(Me=>Me.clientId===c.id&&Me.date===Le&&Me.time===le.time)||Ce<t||Ce>a||r.some(Me=>Me.date===Le)||y.push({dateKey:Le,time:le.time,sessionDate:Ce})}}const I=j+y.length;if(I>c.totalSessions){alert(`This would create ${y.length} new sessions (${I} total), but client only has ${c.totalSessions} sessions in their package.

You can still book ${c.totalSessions-j} more sessions.`);return}if(y.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${y.length} new sessions across the block.

(${j} existing + ${y.length} new = ${I} total)

Continue?`))try{const w=[];for(const G of y){const Q={clientId:c.id,clientName:c.name,date:G.dateKey,time:G.time,duration:c.sessionDuration||45,createdAt:je.now()},xe=await Ee(se(C,"sessions"),Q);w.push({id:xe.id,...Q})}L([...m,...w]),alert(`Created ${w.length} new sessions!`)}catch(w){console.error("Error repeating weekly:",w),alert("Failed to repeat sessions")}},s=async t=>{const a=ne(t),n=r.find(h=>h.date===a);try{if(n)await Be(oe(C,"holidays",n.id)),Z(r.filter(h=>h.id!==n.id));else{const h=await Ee(se(C,"holidays"),{date:a,createdAt:je.now()});Z([...r,{id:h.id,date:a}])}}catch(h){console.error("Error toggling day availability:",h),alert("Failed to update day availability")}};if(we)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const l=g[0],f=g[4],k=l&&f?`${l.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${f.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>D(-1),children:"←"}),e.jsx("button",{onClick:_,children:"Today"}),e.jsx("button",{onClick:()=>D(1),children:"→"})]}),e.jsx("h3",{children:k})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),c?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:c.name}),e.jsxs("span",{children:[c.sessionDuration||45,"min • ",Ne(c),"/",c.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[me(c)," booked"]})]}),e.jsx("button",{onClick:()=>pe(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>re(!0),children:"Select Client"})]}),c&&c.startDate&&c.endDate&&(()=>{const t=De();return t?e.jsxs("div",{className:"block-nav",children:[e.jsx("button",{onClick:ae,children:"← Block Start"}),e.jsx("span",{className:"block-range",children:t.isWithinBlock?`Week ${t.weekNumber} of ${t.totalWeeks}`:g[0]<t.startDate?"Before block":"After block"}),e.jsx("button",{onClick:de,children:"Block End →"})]}):null})(),c&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:S,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:g.map((t,a)=>{const n=be(t),h=ne(t)===ne(new Date),u=q(t);return e.jsxs("div",{className:`day-card ${B===a?"selected":""} ${h?"today":""} ${u?"holiday":""}`,onClick:()=>ce(B===a?null:a),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:hs[a]}),e.jsx("span",{className:"day-date",children:t.getDate()})]}),u?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[n.length," session",n.length!==1?"s":""]})]},a)})}),B!==null&&g[B]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[rs[B]," ",g[B].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>ce(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${q(g[B])?"unavailable":"available"}`,onClick:()=>s(g[B]),children:q(g[B])?"Mark Day Available":"Mark Day Unavailable"})}),q(g[B])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[H(g[B])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),cs(qe[B]).map(({time:t,period:a},n,h)=>{const u=ye(g[B],t),y=ke(g[B],t),j=!!y,I=!u&&!!y,w=y?Ie(y):!1,G=H(g[B]),Q=G?!U(g[B],t):F(g[B],t),xe=G&&U(g[B],t),K=c&&!j&&Te(g[B],t,c.sessionDuration||45),le=n===0||h[n-1]?.period!==a;return e.jsxs("div",{children:[le&&e.jsx("div",{className:"period-label",children:a==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${j&&w?"completed":""} ${j&&!w?"booked":""} ${I?"booked-continuation":""} ${Q&&!j?"blocked":""} ${xe&&!j?"opened":""} ${K?"available":""} ${!j&&!Q&&!K&&c?"unavailable":""}`,onClick:()=>!w&&(!Q||j)&&i(g[B],t),disabled:w||Q&&!j,children:[e.jsx("span",{className:"slot-time",children:Pe(t)}),u&&w?e.jsxs("span",{className:"slot-done",children:[u.clientName," (",u.duration,"m) ✓",$e(u)&&e.jsx("span",{className:"note-dot",title:"Has session note"})]}):u?e.jsxs("span",{className:"slot-client",children:[u.clientName," (",u.duration,"m)"]}):I&&w?e.jsxs("span",{className:"slot-done",children:[y.clientName," ↑"]}):I?e.jsxs("span",{className:"slot-client",children:[y.clientName," ↑"]}):Q?e.jsx("span",{className:"slot-blocked",children:G?"Closed":"Blocked"}):K?e.jsx("span",{className:"slot-available",children:"Available"}):c?e.jsx("span",{className:"slot-unavailable",children:Ae(g[B],t)}):xe?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${G?xe?"is-opened":"":Q?"is-blocked":""}`,onClick:()=>V(g[B],t),disabled:w||!!j,title:G?xe?"Close this slot":"Open this slot":Q?"Unblock this time":"Block this time",children:G?xe?"✓":"+":Q?"✓":"✕"})]})]},t)})]})]}),T&&e.jsx("div",{className:"modal-overlay",onClick:()=>P(null),children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[T.step==="action"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:T.session.clientName}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsxs("div",{className:"edit-session-info",children:[e.jsx("p",{className:"edit-session-date",children:new Date(T.session.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short",timeZone:"UTC"})}),e.jsxs("p",{className:"edit-session-time",children:[Pe(T.session.time)," · ",T.session.duration,"min"]})]}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"reschedule-edit-btn",onClick:()=>P({...T,step:"date"}),children:"Reschedule"}),e.jsx("button",{className:"cancel-session-btn",onClick:()=>v(T.session),children:"Cancel Session"})]})]}),T.step==="date"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>P({...T,step:"action"}),children:"←"}),e.jsx("h3",{children:"Pick New Date"}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const t=ge(T.session);return t.length===0?e.jsx("p",{className:"no-items",children:"No available dates in block"}):t.map(a=>{const n=ne(a);return e.jsx("button",{className:"client-option date-option",onClick:()=>P({...T,step:"time",selectedDate:a,selectedTime:null}),children:a.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"})},n)})})()})]}),T.step==="time"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>P({...T,step:"date",selectedTime:null}),children:"←"}),e.jsx("h3",{children:T.selectedDate?.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const t=o(T.session,T.selectedDate);return t.length===0?e.jsx("p",{className:"no-items",children:"No available slots on this day"}):t.map(a=>e.jsxs("button",{className:`client-option time-option ${T.selectedTime===a.time?"selected":""}`,onClick:()=>P({...T,selectedTime:a.time}),children:[Pe(a.time),e.jsx("span",{className:"time-option-period",children:a.period})]},a.time))})()}),T.selectedTime&&e.jsx("div",{className:"edit-confirm-bar",children:e.jsx("button",{className:"confirm-reschedule-btn",onClick:()=>b(T.session,T.selectedDate,T.selectedTime),disabled:N,children:N?"Saving...":`Confirm — ${Pe(T.selectedTime)}`})})]})]})}),W&&e.jsx("div",{className:"modal-overlay",onClick:()=>{re(!1),d("")},children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>{re(!1),d("")},children:"×"})]}),e.jsx("div",{className:"client-search-wrapper",children:e.jsx("input",{className:"client-search-input",type:"text",placeholder:"Search by name...",value:ve,onChange:t=>d(t.target.value),autoFocus:!0})}),e.jsx("div",{className:"client-list-picker",children:R.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):(()=>{const t={block:"Block",core_buddy:"Core Buddy",circuit_vip:"Circuit VIP",circuit_dropin:"Circuit Drop-in"},a=R.filter(n=>n.name.toLowerCase().includes(ve.toLowerCase()));return a.length===0?e.jsxs("p",{className:"no-items",children:['No clients match "',ve,'"']}):a.map(n=>{const h=n.startDate&&n.endDate,u=h?n.startDate?.toDate?n.startDate.toDate():new Date(n.startDate):null,y=h?n.endDate?.toDate?n.endDate.toDate():new Date(n.endDate):null,j=Ne(n),I=me(n);return e.jsxs("button",{className:"client-option",onClick:()=>{J(n),d("")},children:[e.jsxs("div",{className:"client-option-header",children:[e.jsx("strong",{children:n.name}),n.clientType&&e.jsx("span",{className:"client-type-badge",children:t[n.clientType]||n.clientType})]}),e.jsxs("span",{children:[n.sessionDuration||45,"min • ",j,"/",n.totalSessions," remaining • ",I," booked"]}),u&&y&&e.jsxs("span",{className:"client-dates",children:[u.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," – ",y.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},n.id)})})()})]})})]})}const Ye=x=>{const[M,g]=x.split(":"),A=parseInt(M),R=A>=12?"pm":"am";return`${A>12?A-12:A===0?12:A}:${g}${R}`},He=x=>{const M=x.getFullYear(),g=(x.getMonth()+1).toString().padStart(2,"0"),A=x.getDate().toString().padStart(2,"0");return`${M}-${g}-${A}`},Je=x=>x===He(new Date),xs=x=>{const M=new Date;return M.setDate(M.getDate()+1),x===He(M)},Ge=x=>Je(x)?"Today":xs(x)?"Tomorrow":new Date(x).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),js=x=>{if(x.length===0)return[];const M=new Date,g=new Date(M),A=g.getDay();g.setDate(g.getDate()-(A===0?6:A-1)),g.setHours(0,0,0,0);const R=new Date(g);R.setDate(R.getDate()+7);const ee=new Date(R);ee.setDate(ee.getDate()+7);const m=new Map;return x.forEach(L=>{const[r,Z,E]=L.split("-").map(Number),$=new Date(r,Z-1,E);let z,te,c;$<R?(z="this-week",te="This Week",c=0):$<ee?(z="next-week",te="Next Week",c=1):(z=`${$.getFullYear()}-${$.getMonth()}`,te=$.toLocaleDateString("en-GB",{month:"long",year:"numeric"}),c=100+$.getFullYear()*12+$.getMonth()),m.has(z)||m.set(z,{key:z,label:te,order:c,dates:[]}),m.get(z).dates.push(L)}),Array.from(m.values()).sort((L,r)=>L.order-r.order)};function fs(){const[x,M]=p.useState([]),[g,A]=p.useState(!0),[R,ee]=p.useState(new Date),[m,L]=p.useState(""),[r,Z]=p.useState(""),[E,$]=p.useState(!1),[z,te]=p.useState(new Set);p.useEffect(()=>{c();const N=setInterval(()=>ee(new Date),6e4);return()=>clearInterval(N)},[]);const c=async()=>{try{const O=(await ue(se(C,"sessions"))).docs.map(ae=>({id:ae.id,...ae.data()})),J=He(new Date),De=O.filter(ae=>ae.date>=J).sort((ae,de)=>ae.date!==de.date?ae.date.localeCompare(de.date):ae.time.localeCompare(de.time));M(De)}catch(N){console.error("Error fetching sessions:",N)}A(!1)},pe=async N=>{if(window.confirm(`Cancel ${N.clientName}'s session at ${Ye(N.time)} on ${Ge(N.date)}?`))try{await Be(oe(C,"sessions",N.id)),M(x.filter(O=>O.id!==N.id))}catch(O){console.error("Error cancelling session:",O),alert("Failed to cancel session")}},B=N=>{te(O=>{const J=new Set(O);return J.has(N)?J.delete(N):J.add(N),J})};if(g)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const ce=r?x.filter(N=>N.clientName.toLowerCase().includes(r.toLowerCase())):x,W=ce.reduce((N,O)=>(N[O.date]||(N[O.date]=[]),N[O.date].push(O),N),{}),re=Object.keys(W).sort(),we=He(new Date),he=W[we]||[],ve=he.filter(N=>Ie(N)).length,d=he.length-ve,X=ce.find(N=>!Ie(N)),T=(()=>{if(!X||X.date!==He(new Date))return null;const[N,O]=X.time.split(":").map(Number),J=N*60+O-(new Date().getHours()*60+new Date().getMinutes());return J<=0||J>180?null:J<60?`${J}m`:`${Math.floor(J/60)}h ${J%60}m`})(),P=js(re);return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:he.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[ve," completed"]}),e.jsxs("span",{className:"remaining-count",children:[d," remaining"]})]})}),ve>0&&e.jsx("button",{className:"hide-completed-btn",onClick:()=>$(N=>!N),children:E?"Show all":"Hide done"})]}),X&&T&&e.jsxs("div",{className:"next-session-banner",children:[e.jsx("div",{className:"next-session-label",children:"Up next"}),e.jsxs("div",{className:"next-session-info",children:[e.jsx("span",{className:"next-session-name",children:X.clientName}),e.jsx("span",{className:"next-session-time",children:Ye(X.time)})]}),e.jsx("div",{className:"next-session-countdown",children:T})]}),re.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:r?`No sessions found for "${r}"`:"No upcoming sessions booked"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"schedule-controls",children:[e.jsx("input",{className:"client-filter-input",type:"text",placeholder:"Filter by client...",value:r,onChange:N=>Z(N.target.value)}),e.jsxs("select",{className:"date-jump-select",value:m,onChange:N=>{const O=N.target.value;L(O),O&&(document.getElementById(`date-${O}`)?.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>L(""),600))},children:[e.jsx("option",{value:"",children:"Jump to date..."}),re.map(N=>e.jsxs("option",{value:N,children:[Ge(N)," (",W[N].length,")"]},N))]})]}),e.jsx("div",{className:"sessions-list",children:P.map(({key:N,label:O,dates:J})=>{const ae=N!=="this-week"&&N!=="next-week"?!z.has(N):z.has(N),de=J.reduce((ie,Ne)=>ie+W[Ne].length,0);return e.jsxs("div",{className:"week-group",children:[e.jsxs("button",{className:`week-group-header ${ae?"collapsed":""}`,onClick:()=>B(N),children:[e.jsx("span",{className:"week-label",children:O}),e.jsxs("span",{className:"week-count",children:[de," session",de!==1?"s":""]}),e.jsx("span",{className:"week-chevron",children:ae?"▸":"▾"})]}),!ae&&e.jsx("div",{className:"week-group-body",children:J.map(ie=>{const Ne=W[ie],me=E&&Je(ie)?Ne.filter(fe=>!Ie(fe)):Ne;return e.jsxs("div",{id:`date-${ie}`,className:`date-group ${Je(ie)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ge(ie)}),e.jsxs("span",{className:"date-count",children:[Ne.length," session",Ne.length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:me.length===0?e.jsx("div",{className:"all-done-msg",children:"All sessions completed ✓"}):me.map(fe=>{const $e=Ie(fe);return e.jsxs("div",{className:`session-card ${$e?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ye(fe.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:fe.clientName}),e.jsxs("span",{children:[fe.duration,"min session"]})]}),$e?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>pe(fe),children:"Cancel"})]},fe.id)})})]},ie)})})]},N)})})]})]})}const gs={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},vs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},Ns={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},ys=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function ws(){const[x,M]=p.useState([]),[g,A]=p.useState(!0),[R,ee]=p.useState(null),[m,L]=p.useState(null),[r,Z]=p.useState("all"),[E,$]=p.useState("");p.useEffect(()=>{z()},[]);const z=async()=>{try{const X=(await ue(se(C,"clients"))).docs.map(Y=>({id:Y.id,...Y.data()}));X.sort((Y,T)=>(Y.name||"").localeCompare(T.name||"")),M(X)}catch(d){console.error("Error fetching clients:",d)}A(!1)},te=d=>!!d.welcomeForm?.completedAt,c=d=>!!d.parqForm?.completedAt,pe=d=>te(d)||c(d),B=d=>te(d)&&c(d),ce=d=>d?(d.toDate?d.toDate():new Date(d)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",W=x.filter(d=>!E||d.name?.toLowerCase().includes(E.toLowerCase())?r==="all"?!0:r==="completed"?B(d):r==="partial"?pe(d)&&!B(d):r==="pending"?!pe(d):!0:!1),re=x.filter(B).length,we=x.filter(d=>pe(d)&&!B(d)).length,he=x.filter(d=>!pe(d)).length,ve=d=>{R===d?(ee(null),L(null)):(ee(d),L(null))};return g?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:re}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:we}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:he}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:E,onChange:d=>$(d.target.value)}),E&&e.jsx("button",{className:"forms-search-clear",onClick:()=>$(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${r==="all"?"active":""}`,onClick:()=>Z("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:x.length})]}),e.jsxs("button",{className:`forms-filter-btn ${r==="completed"?"active":""}`,onClick:()=>Z("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:re})]}),e.jsxs("button",{className:`forms-filter-btn ${r==="partial"?"active":""}`,onClick:()=>Z("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:we})]}),e.jsxs("button",{className:`forms-filter-btn ${r==="pending"?"active":""}`,onClick:()=>Z("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:he})]})]}),W.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:W.map(d=>{const X=R===d.id,Y=te(d),T=c(d);return e.jsxs("div",{className:`forms-client-card ${X?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>ve(d.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(d.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:d.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${Y?"done":"not-done"}`,children:[Y?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${T?"done":"not-done"}`,children:[T?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${X?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),X&&e.jsx("div",{className:"forms-expand-panel",children:!Y&&!T?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[Y&&e.jsx("button",{className:`forms-toggle-btn ${m==="welcome"||!m&&Y?"active":""}`,onClick:()=>L("welcome"),children:"Welcome Questionnaire"}),T&&e.jsx("button",{className:`forms-toggle-btn ${m==="parq"||!m&&!Y&&T?"active":""}`,onClick:()=>L("parq"),children:"PAR-Q Health Screening"})]}),(m==="welcome"||!m&&Y)&&Y&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",ce(d.welcomeForm.completedAt)]})]}),d.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:d.welcomeForm.fitnessGoals})]}),d.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:gs[d.welcomeForm.currentActivityLevel]||d.welcomeForm.currentActivityLevel})]}),d.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:d.welcomeForm.exerciseHistory})]}),d.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:d.welcomeForm.injuries})]}),d.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:d.welcomeForm.medicalConditions})]}),d.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:vs[d.welcomeForm.sleepHours]||d.welcomeForm.sleepHours})]}),d.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:Ns[d.welcomeForm.stressLevel]||d.welcomeForm.stressLevel})]}),d.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:d.welcomeForm.dietaryInfo})]}),d.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:d.welcomeForm.availability})]}),d.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:d.welcomeForm.additionalInfo})]})]}),m==="parq"&&T&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",ce(d.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:ys.map(P=>{const N=d.parqForm[P.key];return e.jsxs("div",{className:`parq-result-item ${N?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${N?"yes":"no"}`,children:N?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:P.text})]},P.key)})}),d.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:d.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:d.parqForm.declaration?"declared":"not-declared",children:d.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},d.id)})})]})}const Ke=x=>`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`,Ze=x=>new Date(x+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),Xe=()=>{const x=new Date;let g=(6-x.getDay()+7)%7;if(g===0){const R=new Date(x);R.setHours(9,45,0,0),x>R&&(g=7)}const A=new Date(x);return A.setDate(x.getDate()+g),A},Ue=x=>x==="circuit_vip"?"VIP":x==="circuit_dropin"?"Drop-in":"Block",Oe=x=>x==="circuit_vip"?"vip":x==="circuit_dropin"?"dropin":"block";function bs(){const[x,M]=p.useState(!0),[g,A]=p.useState([]),[R,ee]=p.useState([]),[m,L]=p.useState(null),[r,Z]=p.useState("upcoming"),[E,$]=p.useState(!1),[z,te]=p.useState(null),[c,pe]=p.useState(!1),[B,ce]=p.useState(!1),W=p.useCallback((o,v="info")=>{te({message:o,type:v}),setTimeout(()=>te(null),4e3)},[]);p.useEffect(()=>{re()},[]);const re=async()=>{try{const v=(await ue(se(C,"circuitSessions"))).docs.map(F=>({id:F.id,...F.data()}));v.sort((F,U)=>U.date.localeCompare(F.date)),A(v);const D=(await ue(se(C,"clients"))).docs.map(F=>({id:F.id,...F.data()})).filter(F=>F.clientType==="circuit_vip"||F.clientType==="circuit_dropin"||F.circuitAccess===!0);ee(D);const _=Ke(Xe());let q=v.find(F=>F.date===_);if(!q){const F=D.filter(V=>V.clientType==="circuit_vip"&&V.status==="active"),U=[];for(let V=0;V<8;V++)V<F.length?U.push({slotNumber:V+1,memberId:F[V].id,memberName:F[V].name,memberType:"circuit_vip",status:"confirmed",bookedAt:je.now()}):U.push({slotNumber:V+1,memberId:null,memberName:null,memberType:null,status:"available"});const H={date:_,time:"09:00",endTime:"09:45",maxCapacity:8,slots:U,waitlist:[],createdAt:je.now()};await as(oe(C,"circuitSessions",_),H),q={id:_,...H},v.unshift(q),A([...v])}q?L(q):v.length>0&&L(v[0])}catch(o){console.error("Error loading circuit data:",o),W("Failed to load circuit data","error")}M(!1)},we=async o=>{if(!(!m||E)&&window.confirm("Remove this member from the slot?")){$(!0);try{const v=[...m.slots],b=v.findIndex(H=>H.slotNumber===o);if(b===-1){$(!1);return}const D=v[b],_=D.memberType==="circuit_vip";let q=[...m.waitlist||[]];if(q.length>0){const H=q.shift();v[b]={slotNumber:o,memberId:H.memberId,memberName:H.memberName,memberType:H.memberType,status:"confirmed",bookedAt:je.now()},W(`Slot given to ${H.memberName} from waitlist`,"success")}else v[b]={slotNumber:o,memberId:null,memberName:null,memberType:null,status:"available"},W("Member removed from slot","success");const F={slots:v,waitlist:q};if(_&&D.memberId){const H=m.vipOptOuts||[];H.includes(D.memberId)||(F.vipOptOuts=[...H,D.memberId])}await Se(oe(C,"circuitSessions",m.id),F);const U={...m,...F};L(U),A(H=>H.map(V=>V.id===U.id?U:V))}catch(v){console.error("Error removing from slot:",v),W("Failed to remove member","error")}$(!1)}},he=async(o,v)=>{if(!(!m||E)){$(!0);try{const b=[...m.slots],D=b.findIndex(U=>U.slotNumber===o&&U.status==="available");if(D===-1){W("Slot is not available","error"),$(!1);return}if(b.some(U=>U.memberId===v.id)){W(`${v.name} already has a slot`,"error"),$(!1);return}b[D]={slotNumber:o,memberId:v.id,memberName:v.name,memberType:v.clientType||"block",status:"confirmed",bookedAt:je.now()};const _=(m.waitlist||[]).filter(U=>U.memberId!==v.id),q={slots:b,waitlist:_};if(v.clientType==="circuit_vip"){const U=m.vipOptOuts||[];U.includes(v.id)&&(q.vipOptOuts=U.filter(H=>H!==v.id))}await Se(oe(C,"circuitSessions",m.id),q);const F={...m,...q};L(F),A(U=>U.map(H=>H.id===F.id?F:H)),W(`${v.name} added to slot ${o}`,"success")}catch(b){console.error("Error adding to slot:",b),W("Failed to add member","error")}$(!1)}},ve=async o=>{if(!(!m||E)){$(!0);try{const v=(m.waitlist||[]).filter(D=>D.memberId!==o);await Se(oe(C,"circuitSessions",m.id),{waitlist:v});const b={...m,waitlist:v};L(b),A(D=>D.map(_=>_.id===b.id?b:_)),W("Removed from waitlist","success")}catch(v){console.error("Error removing from waitlist:",v),W("Failed to remove from waitlist","error")}$(!1)}},d=async(o,v)=>{if(!(!m||E)){$(!0);try{const b=[...m.slots],D=b.findIndex(q=>q.slotNumber===o);if(D===-1){$(!1);return}if(b[D]={...b[D],attended:v},await Se(oe(C,"circuitSessions",m.id),{slots:b}),v===!1){const q=b[D].memberId;if(q){const F=oe(C,"clients",q),U=await ns(F);if(U.exists()){const V=(U.data().circuitStrikes||0)+1,be={circuitStrikes:V};if(V>=3){const ye=new Date;ye.setMonth(ye.getMonth()+1),be.circuitBanUntil=je.fromDate(ye),be.circuitStrikes=0,W(`${b[D].memberName} banned for 1 month (3 strikes)`,"error")}else W(`No-show recorded - ${b[D].memberName} (${V}/3 strikes)`,"error");await Se(F,be)}}}else W(`${b[D].memberName} marked as attended`,"success");const _={...m,slots:b};L(_),A(q=>q.map(F=>F.id===_.id?_:F))}catch(b){console.error("Error marking attendance:",b),W("Failed to update attendance","error")}$(!1)}},X=async(o,v)=>{if(!E&&window.confirm(`Reset strikes for ${v}?`)){$(!0);try{await Se(oe(C,"clients",o),{circuitStrikes:0,circuitBanUntil:null}),ee(b=>b.map(D=>D.id===o?{...D,circuitStrikes:0,circuitBanUntil:null}:D)),W(`Strikes reset for ${v}`,"success")}catch(b){console.error("Error resetting strikes:",b),W("Failed to reset strikes","error")}$(!1)}},Y=async(o,v)=>{if(!E&&window.confirm(`Lift ban for ${v}?`)){$(!0);try{await Se(oe(C,"clients",o),{circuitBanUntil:null,circuitStrikes:0}),ee(b=>b.map(D=>D.id===o?{...D,circuitBanUntil:null,circuitStrikes:0}:D)),W(`Ban lifted for ${v}`,"success")}catch(b){console.error("Error lifting ban:",b),W("Failed to lift ban","error")}$(!1)}};if(x)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const T=Ke(new Date),P=Ke(Xe()),N=g.filter(o=>o.date>=T),O=g.filter(o=>o.date<T),J=r==="upcoming"?N:O,De=m?m.slots.filter(o=>o.status!=="available").length:0,ae=m?m.slots.filter(o=>o.status==="available").length:0,de=m?m.date>=T:!1,ie=m?m.slots.filter(o=>o.memberId).map(o=>o.memberId):[],Ne=m?(m.waitlist||[]).map(o=>o.memberId):[],me=R.filter(o=>!ie.includes(o.id)&&!Ne.includes(o.id)),fe=R.filter(o=>o.clientType==="circuit_vip").length,$e=R.filter(o=>o.clientType==="circuit_dropin").length,Ae=R.filter(o=>o.circuitAccess&&o.clientType!=="circuit_vip"&&o.clientType!=="circuit_dropin").length,ge=R.filter(o=>o.circuitBanUntil?(o.circuitBanUntil.toDate?o.circuitBanUntil.toDate():new Date(o.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:fe}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:$e}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:Ae}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:g.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${c?"":"active"}`,onClick:()=>pe(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${c?"active":""}`,onClick:()=>pe(!0),children:"Members"})]}),!c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${r==="upcoming"?"active":""}`,onClick:()=>Z("upcoming"),children:["Upcoming (",N.length,")"]}),e.jsxs("button",{className:`cm-tab ${r==="past"?"active":""}`,onClick:()=>Z("past"),children:["Past (",O.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:J.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",r," sessions"]})}):J.map(o=>{const v=o.slots.filter(_=>_.status!=="available").length,b=m?.id===o.id,D=o.date===P;return e.jsxs("button",{className:`cm-session-btn ${b?"selected":""} ${D?"next":""}`,onClick:()=>{L(o),ce(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:Ze(o.date)}),D&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[v,"/8"]}),(o.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",o.waitlist.length," wl"]})]})]},o.id)})}),m&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:Ze(m.date)}),e.jsxs("p",{children:[m.time," - ",m.endTime," • ",De,"/8 booked • ",ae," available"]})]}),!de&&e.jsx("button",{className:`cm-attendance-btn ${B?"active":""}`,onClick:()=>ce(!B),children:B?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:m.slots.map(o=>{const v=o.status==="available";return e.jsxs("div",{className:`cm-slot ${v?"empty":"filled"} ${o.attended===!0?"attended":""} ${o.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:o.slotNumber}),v?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),de&&e.jsx(Ds,{members:me,onSelect:b=>he(o.slotNumber,b),disabled:E})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:o.memberName}),e.jsx("span",{className:`cm-type-badge ${Oe(o.memberType)}`,children:Ue(o.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[B&&o.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>d(o.slotNumber,!0),disabled:E,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>d(o.slotNumber,!1),disabled:E,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),o.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),o.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),de&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>we(o.slotNumber),disabled:E,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},o.slotNumber)})}),(m.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",m.waitlist.length,")"]}),m.waitlist.map((o,v)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",v+1]}),e.jsx("span",{className:"cm-wl-name",children:o.memberName}),e.jsx("span",{className:`cm-type-badge ${Oe(o.memberType)}`,children:Ue(o.memberType)}),de&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>ve(o.memberId),disabled:E,children:"Remove"})]},o.memberId))]})]})]}),c&&e.jsxs("div",{className:"cm-members",children:[ge.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",ge.length,")"]}),ge.map(o=>{const v=o.circuitBanUntil?.toDate?o.circuitBanUntil.toDate():new Date(o.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:o.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",v.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>Y(o.id,o.name),disabled:E,children:"Lift Ban"})]},o.id)})]}),e.jsx("div",{className:"cm-members-list",children:R.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):R.map(o=>{const v=o.circuitStrikes||0,b=ge.some(D=>D.id===o.id);return e.jsxs("div",{className:`cm-member-card ${b?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:o.name}),e.jsx("span",{className:`cm-type-badge ${Oe(o.clientType)}`,children:Ue(o.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(D=>e.jsx("span",{className:`cm-strike-dot ${D<v?"active":""}`},D)),e.jsxs("span",{className:"cm-strike-text",children:[v,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[b&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>Y(o.id,o.name),disabled:E,children:"Lift Ban"}),v>0&&!b&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>X(o.id,o.name),disabled:E,children:"Reset"})]})]})]},o.id)})})]}),z&&e.jsx("div",{className:`cm-toast ${z.type}`,children:e.jsx("span",{children:z.message})})]})}function Ds({members:x,onSelect:M,disabled:g}){const[A,R]=p.useState(!1),[ee,m]=p.useState(""),L=x.filter(r=>r.name.toLowerCase().includes(ee.toLowerCase()));return x.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>R(!A),disabled:g,children:"+ Add"}),A&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{R(!1),m("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[x.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:ee,onChange:r=>m(r.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[L.map(r=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{M(r),R(!1),m("")},children:[e.jsx("span",{children:r.name}),e.jsx("span",{className:`cm-type-badge sm ${Oe(r.clientType)}`,children:Ue(r.clientType)})]},r.id)),L.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function Cs(){const[x,M]=p.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),g=i=>{M(i),localStorage.setItem("adminActiveView",i)},[A,R]=p.useState(0),[ee,m]=p.useState(!1),[L,r]=p.useState([]),[Z,E]=p.useState(null),[$,z]=p.useState(null),[te,c]=p.useState(!1),[pe,B]=p.useState([]),[ce,W]=p.useState(!1),[re,we]=p.useState([]),[he,ve]=p.useState([]),[d,X]=p.useState(null),{currentUser:Y,logout:T,isAdmin:P,loading:N}=is(),{isDark:O,toggleTheme:J}=ls(),De=os(),ae=p.useRef(0),de=p.useRef(!1);p.useRef(null);const ie=p.useCallback((i,S="info")=>{z({message:i,type:S}),setTimeout(()=>z(null),4e3)},[]);p.useEffect(()=>{!N&&(!Y||!P)&&De("/")},[Y,P,N,De]),p.useEffect(()=>{Y&&P&&fe()},[Y,P]);const Ne=async()=>{W(!0);try{const i=Re(se(C,"rescheduleRequests"),We("status","in",["approved","rejected"])),s=(await ue(i)).docs.map(l=>({id:l.id,...l.data()}));s.sort((l,f)=>{const k=l.respondedAt?.toDate?l.respondedAt.toDate():new Date(0);return(f.respondedAt?.toDate?f.respondedAt.toDate():new Date(0))-k}),B(s)}catch(i){console.error("Error fetching request history:",i)}W(!1)},me=()=>{!te&&pe.length===0&&Ne(),c(i=>!i)},fe=async()=>{try{const i=Re(se(C,"rescheduleRequests"),We("status","==","pending")),s=(await ue(i)).docs.map(l=>({id:l.id,...l.data()}));s.sort((l,f)=>{const k=l.createdAt?.toDate?l.createdAt.toDate():new Date(0);return(f.createdAt?.toDate?f.createdAt.toDate():new Date(0))-k}),r(s)}catch(i){console.error("Error fetching reschedule requests:",i)}};p.useEffect(()=>{(async()=>{if(!(!Y||!P))try{const[S,s]=await Promise.all([ue(se(C,"clients")),ue(se(C,"sessions"))]),l=S.docs.map(a=>({id:a.id,...a.data()})),f=s.docs.map(a=>({id:a.id,...a.data()}));we(l);const k=new Set(l.map(a=>a.id)),t=s.docs.filter(a=>!k.has(a.data().clientId));if(t.length>0){const a=t.map(n=>Be(oe(C,"sessions",n.id)));await Promise.all(a)}ve(f.filter(a=>k.has(a.clientId)))}catch(S){console.error("Error fetching dashboard data:",S)}})()},[Y,P]),p.useEffect(()=>{const i=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,S=f=>{i()<=0&&(ae.current=f.touches[0].clientY,de.current=!1)},s=f=>{const k=i(),a=f.touches[0].clientY-ae.current;if(k>5||a<=0){de.current=!1,R(0);return}a>20&&k<=0&&(de.current=!0,R(Math.min((a-20)*.4,80)))},l=()=>{de.current&&A>60?(m(!0),setTimeout(()=>{window.location.reload()},300)):R(0),de.current=!1};return document.addEventListener("touchstart",S,{passive:!0}),document.addEventListener("touchmove",s,{passive:!0}),document.addEventListener("touchend",l),()=>{document.removeEventListener("touchstart",S),document.removeEventListener("touchmove",s),document.removeEventListener("touchend",l)}},[A]);const $e=async()=>{try{await T(),De("/")}catch(i){console.error("Failed to log out:",i)}},Ae=()=>{De("/add-client")},ge=i=>new Date(i).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),o=i=>{const[S,s]=i.split(":"),l=parseInt(S),f=l>=12?"pm":"am";return`${l>12?l-12:l===0?12:l}:${s}${f}`},v=async i=>{if(window.confirm(`Approve reschedule for ${i.clientName}?

From: ${ge(i.originalDate)} at ${o(i.originalTime)}
To: ${ge(i.requestedDate)} at ${o(i.requestedTime)}`)){E(i.id);try{const S=Re(se(C,"sessions"),We("date","==",i.requestedDate),We("time","==",i.requestedTime)),l=(await ue(S)).docs.filter(f=>f.id!==i.sessionId);if(l.length>0){const f=l[0].data().clientName;ie(`Cannot approve — ${f} is already booked at that time`,"error"),E(null);return}await Se(oe(C,"sessions",i.sessionId),{date:i.requestedDate,time:i.requestedTime}),await Se(oe(C,"rescheduleRequests",i.id),{status:"approved",respondedAt:je.now()}),r(L.filter(f=>f.id!==i.id)),ie(`Approved reschedule for ${i.clientName}`,"success")}catch(S){console.error("Error approving request:",S),ie("Failed to approve request","error")}E(null)}},b=async i=>{if(window.confirm(`Reject reschedule request from ${i.clientName}?`)){E(i.id);try{await Se(oe(C,"rescheduleRequests",i.id),{status:"rejected",respondedAt:je.now()}),r(L.filter(S=>S.id!==i.id)),ie(`Request from ${i.clientName} rejected`,"info")}catch(S){console.error("Error rejecting request:",S),ie("Failed to reject request","error")}E(null)}};if(N)return e.jsx("div",{className:"loading",children:"Loading..."});if(!Y||!P)return null;const D=L.length,_=new Date,q=`${_.getFullYear()}-${(_.getMonth()+1).toString().padStart(2,"0")}-${_.getDate().toString().padStart(2,"0")}`,F=`${_.getHours().toString().padStart(2,"0")}:${_.getMinutes().toString().padStart(2,"0")}`,H=he.filter(i=>i.date===q).length,V=i=>{const S=i.startDate?.toDate?i.startDate.toDate():i.startDate?new Date(i.startDate):null,s=i.endDate?.toDate?i.endDate.toDate():i.endDate?new Date(i.endDate):null,l=S?`${S.getFullYear()}-${(S.getMonth()+1).toString().padStart(2,"0")}-${S.getDate().toString().padStart(2,"0")}`:null,f=s?`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}-${s.getDate().toString().padStart(2,"0")}`:null;return he.filter(k=>k.clientId!==i.id||l&&k.date<l||f&&k.date>f?!1:k.date<q||k.date===q&&k.time<F).length},be=re.filter(i=>i.status!=="archived"&&(!i.clientType||i.clientType==="block")),ye=new Date(_);ye.setDate(ye.getDate()+7);const ke=be.filter(i=>{if(!i.endDate)return!1;const S=i.endDate.toDate?i.endDate.toDate():new Date(i.endDate);return S>=_&&S<=ye}),Te=be.filter(i=>(i.totalSessions||0)-V(i)<=2);return e.jsxs("div",{className:"dashboard",children:[A>0&&e.jsxs("div",{className:"pull-indicator",style:{height:A},children:[e.jsx("div",{className:`pull-spinner ${ee?"spinning":""}`,children:ee?"↻":"↓"}),e.jsx("span",{children:ee?"Refreshing...":A>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${x==="requests"?"active":""} ${D>0?"has-badge":""}`,onClick:()=>g("requests"),children:["Requests",D>0&&e.jsx("span",{className:"nav-badge",children:D})]}),e.jsx("button",{className:`nav-btn ${x==="forms"?"active":""}`,onClick:()=>g("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${x==="circuits"?"active":""}`,onClick:()=>g("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:J,"aria-label":O?"Switch to light mode":"Switch to dark mode",children:O?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"logout-btn",onClick:$e,children:"Log Out"})]})]}),$&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${$.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[$.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),$.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),$.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:$.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[x==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:H}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>g("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${D>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:D}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:`summary-card ${d==="expiring"?"active":""}`,onClick:()=>X(d==="expiring"?null:"expiring"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${ke.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ke.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:`summary-card ${d==="low"?"active":""}`,onClick:()=>X(d==="low"?null:"low"),children:[e.jsx("div",{className:`summary-icon low-icon ${Te.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:Te.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),d==="expiring"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Expiring Soon"}),e.jsx("button",{className:"card-detail-close",onClick:()=>X(null),children:"✕"})]}),ke.length===0?e.jsx("p",{className:"card-detail-empty",children:"No clients expiring within 7 days"}):ke.map(i=>{const S=i.endDate.toDate?i.endDate.toDate():new Date(i.endDate),s=Math.ceil((S-_)/(1e3*60*60*24)),l=(i.totalSessions||0)-V(i);return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:i.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:"card-detail-tag warning",children:s<=1?"Ends today":`Ends in ${s} days`}),e.jsx("span",{className:`card-detail-tag ${l<=0?"urgent":"info"}`,children:l<=0?"No sessions left":`${l} session${l!==1?"s":""} left`})]})]},i.id)})]}),d==="low"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Low / No Sessions"}),e.jsx("button",{className:"card-detail-close",onClick:()=>X(null),children:"✕"})]}),Te.length===0?e.jsx("p",{className:"card-detail-empty",children:"All clients have sessions available"}):[...Te].sort((i,S)=>{const s=(i.totalSessions||0)-V(i),l=(S.totalSessions||0)-V(S);return s-l}).map(i=>{const S=(i.totalSessions||0)-V(i),s=i.endDate?i.endDate.toDate?i.endDate.toDate():new Date(i.endDate):null,l=s?Math.ceil((s-_)/(1e3*60*60*24)):null;return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:i.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:`card-detail-tag ${S<=0?"urgent":"low"}`,children:S<=0?"No sessions left":`${S} session${S!==1?"s":""} left`}),l!==null&&l<=14&&e.jsxs("span",{className:"card-detail-tag warning",children:["Block ends ",l<=1?"today":`in ${l}d`]})]})]},i.id)})]}),e.jsx(fs,{})]}),x==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:Ae,children:"+ Add Client"})]}),e.jsx(ms,{})]}),x==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(ps,{})]}),x==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Reschedule Requests"}),e.jsx("button",{className:"history-toggle-btn",onClick:me,children:te?"Hide History":"View History"})]}),te&&e.jsxs("div",{className:"request-history-section",children:[e.jsx("div",{className:"history-section-header",children:"Past Requests"}),ce?e.jsx("p",{className:"history-empty",children:"Loading..."}):pe.length===0?e.jsx("p",{className:"history-empty",children:"No past requests"}):pe.map(i=>e.jsxs("div",{className:"history-request-card",children:[e.jsxs("div",{className:"history-request-top",children:[e.jsx("span",{className:"history-client-name",children:i.clientName}),e.jsx("span",{className:`history-status-badge ${i.status}`,children:i.status})]}),e.jsxs("div",{className:"history-request-detail",children:[e.jsxs("span",{children:[ge(i.originalDate)," ",o(i.originalTime)]}),e.jsx("span",{className:"history-arrow",children:"→"}),e.jsxs("span",{children:[ge(i.requestedDate)," ",o(i.requestedTime)]})]}),i.respondedAt&&e.jsx("div",{className:"history-responded-at",children:i.respondedAt.toDate?i.respondedAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):""})]},i.id))]}),L.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:L.map(i=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:i.clientName}),e.jsx("span",{className:"request-time",children:i.createdAt?.toDate?i.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[ge(i.originalDate)," at ",o(i.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[ge(i.requestedDate)," at ",o(i.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>v(i),disabled:Z===i.id,children:Z===i.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>b(i),disabled:Z===i.id,children:"Reject"})]})]},i.id))})]}),x==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(ws,{})]}),x==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(bs,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${x==="schedule"?"active":""}`,onClick:()=>g("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${x==="clients"?"active":""}`,onClick:()=>g("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${x==="calendar"?"active":""}`,onClick:()=>g("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{Cs as default};
