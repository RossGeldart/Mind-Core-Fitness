import{r as x,k as ie,l as ae,m as re,e as w,d as f,i as ne,q as P,c as V,w as S,g as q,T as v,u as y,p as le,j as e}from"./index-D31nnDzK.js";/* empty css                         */const B=()=>{const l=new Date;let b=(6-l.getDay()+7)%7;if(b===0){const i=new Date(l);i.setHours(9,45,0,0),l>i&&(b=7)}const o=new Date(l);return o.setDate(l.getDate()+b),o},oe=l=>`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,ce=l=>new Date(l+"T09:00:00").toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"}),G=l=>l==="circuit_vip"?"VIP":l==="circuit_dropin"?"Drop-in":"Block",J=l=>l==="circuit_vip"?"vip":l==="circuit_dropin"?"dropin":"block";function be(){const[l,k]=x.useState(!0),[b,o]=x.useState(!1),[i,g]=x.useState(null),[de,W]=x.useState(!1),[C,E]=x.useState(null),{currentUser:F,isClient:A,clientData:a,loading:D}=ie(),{isDark:_}=ae(),p=re(),m=x.useCallback((s,t="info")=>{E({message:s,type:t}),setTimeout(()=>E(null),4e3)},[]);x.useEffect(()=>{!D&&(!F||!A)&&p("/")},[F,A,D,p]),x.useEffect(()=>{a&&M()},[a]);const M=async()=>{try{const s=oe(B()),t=w(f,"circuitSessions",s),d=await ne(t);if(d.exists()){const c={id:d.id,...d.data()};try{const n=P(V(f,"clients"),S("clientType","==","circuit_vip"),S("status","==","active")),r=(await q(n)).docs.map(u=>({id:u.id,...u.data()})),U=c.slots.filter(u=>u.memberId).map(u=>u.memberId),j=r.filter(u=>!U.includes(u.id));if(j.length>0){const u=[...c.slots];let R=!1;for(const Y of j){const L=u.findIndex(te=>te.status==="available");if(L===-1)break;u[L]={slotNumber:u[L].slotNumber,memberId:Y.id,memberName:Y.name,memberType:"circuit_vip",status:"confirmed",bookedAt:v.now()},R=!0}R&&(await y(t,{slots:u}),c.slots=u)}}catch(n){console.error("VIP auto-slot check failed (non-critical):",n)}g(c)}else{let c=[];try{const r=P(V(f,"clients"),S("clientType","==","circuit_vip"),S("status","==","active"));c=(await q(r)).docs.map(j=>({id:j.id,...j.data()}))}catch(r){console.error("VIP query failed, creating session with empty slots:",r)}const n=[];for(let r=0;r<8;r++)r<c.length?n.push({slotNumber:r+1,memberId:c[r].id,memberName:c[r].name,memberType:"circuit_vip",status:"confirmed",bookedAt:v.now()}):n.push({slotNumber:r+1,memberId:null,memberName:null,memberType:null,status:"available"});const h={date:s,time:"09:00",endTime:"09:45",maxCapacity:8,slots:n,waitlist:[],createdAt:v.now()};await le(t,h),g({id:s,...h})}}catch(s){console.error("Error loading session:",s),W(!0),m("Failed to load session","error")}k(!1)},Q=async s=>{if(!b){o(!0);try{if(a.circuitBanUntil&&(a.circuitBanUntil.toDate?a.circuitBanUntil.toDate():new Date(a.circuitBanUntil))>new Date){m("You are currently suspended from booking","error"),o(!1);return}if(i.slots.some(n=>n.memberId===a.id)){m("You already have a slot booked","error"),o(!1);return}const t=[...i.slots],d=t.findIndex(n=>n.slotNumber===s&&n.status==="available");if(d===-1){m("Slot is no longer available","error"),o(!1);return}t[d]={slotNumber:s,memberId:a.id,memberName:a.name,memberType:a.clientType||"block",status:"confirmed",bookedAt:v.now()};const c=(i.waitlist||[]).filter(n=>n.memberId!==a.id);await y(w(f,"circuitSessions",i.id),{slots:t,waitlist:c}),g(n=>({...n,slots:t,waitlist:c})),m("Slot booked!","success")}catch(t){console.error("Error booking slot:",t),m("Failed to book slot","error")}o(!1)}},z=async()=>{if(!b){o(!0);try{const s=B();s.setHours(9,0,0,0);const t=new Date(s.getTime()-1440*60*1e3);if(new Date>t){m("Cancellation deadline passed (24hrs before class)","error"),o(!1);return}const d=[...i.slots],c=d.findIndex(r=>r.memberId===a.id);if(c===-1){o(!1);return}const n=d[c].slotNumber;let h=[...i.waitlist||[]];if(h.length>0){const r=h.shift();d[c]={slotNumber:n,memberId:r.memberId,memberName:r.memberName,memberType:r.memberType,status:"confirmed",bookedAt:v.now()}}else d[c]={slotNumber:n,memberId:null,memberName:null,memberType:null,status:"available"};await y(w(f,"circuitSessions",i.id),{slots:d,waitlist:h}),g(r=>({...r,slots:d,waitlist:h})),m("Slot released","success")}catch(s){console.error("Error releasing slot:",s),m("Failed to release slot","error")}o(!1)}},O=async()=>{if(!b){o(!0);try{if(i.waitlist?.some(t=>t.memberId===a.id)){m("Already on the waitlist","error"),o(!1);return}if(i.slots.some(t=>t.memberId===a.id)){m("You already have a slot","error"),o(!1);return}const s=[...i.waitlist||[],{memberId:a.id,memberName:a.name,memberType:a.clientType||"block",addedAt:v.now()}];await y(w(f,"circuitSessions",i.id),{waitlist:s}),g(t=>({...t,waitlist:s})),m("Added to waitlist!","success")}catch(s){console.error("Error joining waitlist:",s),m("Failed to join waitlist","error")}o(!1)}},K=async()=>{if(!b){o(!0);try{const s=(i.waitlist||[]).filter(t=>t.memberId!==a.id);await y(w(f,"circuitSessions",i.id),{waitlist:s}),g(t=>({...t,waitlist:s})),m("Removed from waitlist","success")}catch(s){console.error("Error leaving waitlist:",s),m("Failed to leave waitlist","error")}o(!1)}};if(D||l)return e.jsx("div",{className:"cb-page",children:e.jsx("div",{className:"cb-loading",children:e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"cb-loading-logo"})})});if(!i)return e.jsxs("div",{className:`cb-page ${_?"dark":""}`,children:[e.jsxs("header",{className:"cb-header",children:[e.jsx("button",{className:"cb-back-btn",onClick:()=>p("/client/circuit"),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})})}),e.jsx("h1",{children:"Class Booking"}),e.jsx("div",{className:"cb-header-spacer"})]}),e.jsx("main",{className:"cb-main",children:e.jsxs("div",{className:"cb-error-state",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"48",height:"48",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("circle",{cx:"12",cy:"16",r:"1",fill:"currentColor"})]}),e.jsx("h3",{children:"Couldn't load booking"}),e.jsx("p",{children:"Something went wrong. Please try again."}),e.jsx("button",{className:"cb-retry-btn",onClick:()=>{k(!0),W(!1),M()},children:"Retry"})]})})]});const $=a?.clientType||"block",X=$==="circuit_vip"||$==="circuit_dropin",H=i.slots.find(s=>s.memberId===a.id),Z=i.waitlist?.some(s=>s.memberId===a.id),I=i.slots.filter(s=>s.status==="available").length,ee=I===0,se=B(),N=new Date(se);N.setHours(9,0,0,0),N.setTime(N.getTime()-1440*60*1e3);const T=new Date>N;return e.jsxs("div",{className:`cb-page ${_?"dark":""}`,children:[e.jsx("header",{className:"client-header",children:e.jsxs("div",{className:"header-content",children:[e.jsx("button",{className:"header-back-btn",onClick:()=>p("/client/circuit"),"aria-label":"Go back",children:e.jsx("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M15 18l-6-6 6-6"})})}),e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"header-logo",width:"50",height:"50"})]})}),e.jsxs("main",{className:"cb-main",children:[e.jsxs("div",{className:"cb-class-info",children:[e.jsx("h2",{children:ce(i.date)}),e.jsxs("p",{children:[i.time," - ",i.endTime," • ",I," slot",I!==1?"s":""," available"]})]}),e.jsx("div",{className:"cb-slots-grid",children:i.slots.map(s=>{const t=s.memberId===a.id,d=s.status==="available";return s.memberType,e.jsxs("div",{className:`cb-slot ${t?"mine":""} ${d?"available":"filled"}`,children:[e.jsx("div",{className:"cb-slot-number",children:s.slotNumber}),e.jsx("div",{className:"cb-slot-body",children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"cb-slot-available",children:"Available"}),!H&&e.jsx("button",{className:"cb-slot-book-btn",onClick:()=>Q(s.slotNumber),disabled:b,children:"Book"})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"cb-slot-name",children:s.memberName}),e.jsx("span",{className:`cb-slot-badge ${J(s.memberType)}`,children:G(s.memberType)})]})}),t&&e.jsx("button",{className:"cb-slot-release-btn",onClick:z,disabled:b||T,title:T?"Cancellation deadline passed":"Cancel this slot",children:T?"Locked":"Cancel"})]},s.slotNumber)})}),!H&&ee&&e.jsx("div",{className:"cb-waitlist-section",children:Z?e.jsxs("div",{className:"cb-waitlist-status",children:[e.jsxs("p",{children:["You're on the waitlist (position #",(i.waitlist?.findIndex(s=>s.memberId===a.id)||0)+1,")"]}),e.jsx("button",{className:"cb-waitlist-leave-btn",onClick:K,disabled:b,children:"Leave Waitlist"})]}):e.jsx("button",{className:"cb-waitlist-join-btn",onClick:O,disabled:b,children:"Class Full - Join Waitlist"})}),i.waitlist?.length>0&&e.jsxs("div",{className:"cb-waitlist-preview",children:[e.jsxs("h4",{children:["Waitlist (",i.waitlist.length,")"]}),i.waitlist.map((s,t)=>e.jsxs("div",{className:"cb-waitlist-item",children:[e.jsxs("span",{className:"cb-waitlist-pos",children:["#",t+1]}),e.jsx("span",{className:"cb-waitlist-name",children:s.memberName}),e.jsx("span",{className:`cb-slot-badge ${J(s.memberType)}`,children:G(s.memberType)})]},s.memberId))]}),e.jsx("div",{className:"cb-rules",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Book anytime before class"})," • ",e.jsx("strong",{children:"Cancel 24hrs before"})," • ",e.jsx("strong",{children:"3 no-shows = 1 month ban"})]})})]}),e.jsxs("nav",{className:"circuit-bottom-nav",children:[!X&&e.jsxs("button",{className:"circuit-nav-tab",onClick:()=>p("/client"),children:[e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M15 18l-6-6 6-6"})}),e.jsx("span",{children:"Dashboard"})]}),e.jsxs("button",{className:"circuit-nav-tab",onClick:()=>p("/client/circuit"),children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),e.jsx("polyline",{points:"9 22 9 12 15 12 15 22"})]}),e.jsx("span",{children:"Home"})]}),e.jsxs("button",{className:"circuit-nav-tab active",onClick:()=>p("/client/circuit/booking"),children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Class"})]})]}),C&&e.jsx("div",{className:`toast-notification ${C.type}`,children:e.jsx("span",{children:C.message})})]})}export{be as default};
