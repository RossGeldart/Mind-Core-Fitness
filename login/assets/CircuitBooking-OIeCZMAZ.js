import{r as x,l as ae,m as ne,n as re,e as y,d as v,k as le,q as Y,c as P,w as D,g as q,T as w,u as k,i as oe,j as e}from"./index-B86y-d2z.js";/* empty css                         */const O=()=>{const n=new Date;let p=(6-n.getDay()+7)%7;if(p===0){const t=new Date(n);t.setHours(9,45,0,0),n>t&&(p=7)}const l=new Date(n);return l.setDate(n.getDate()+p),l},ce=n=>`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`,de=n=>new Date(n+"T09:00:00").toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"}),G=n=>n==="circuit_vip"?"VIP":n==="circuit_dropin"?"Drop-in":"Block",J=n=>n==="circuit_vip"?"vip":n==="circuit_dropin"?"dropin":"block";function he(){const[n,N]=x.useState(!0),[p,l]=x.useState(!1),[t,g]=x.useState(null),[me,W]=x.useState(!1),[C,E]=x.useState(null),{currentUser:_,isClient:F,clientData:i,loading:T}=ae(),{isDark:A}=ne(),f=re(),m=x.useCallback((s,a="info")=>{E({message:s,type:a}),setTimeout(()=>E(null),4e3)},[]);x.useEffect(()=>{!T&&(!_||!F)&&f("/")},[_,F,T,f]),x.useEffect(()=>{i&&M()},[i]);const M=async()=>{try{const s=ce(O()),a=y(v,"circuitSessions",s),d=await le(a);if(d.exists()){const o={id:d.id,...d.data()};try{const h=Y(P(v,"clients"),D("clientType","==","circuit_vip"),D("status","==","active")),r=(await q(h)).docs.map(b=>({id:b.id,...b.data()})),j=o.slots.filter(b=>b.memberId).map(b=>b.memberId),u=o.vipOptOuts||[],U=r.filter(b=>!j.includes(b.id)&&!u.includes(b.id));if(U.length>0){const b=[...o.slots];let R=!1;for(const V of U){const B=b.findIndex(ie=>ie.status==="available");if(B===-1)break;b[B]={slotNumber:b[B].slotNumber,memberId:V.id,memberName:V.name,memberType:"circuit_vip",status:"confirmed",bookedAt:w.now()},R=!0}R&&(await k(a,{slots:b}),o.slots=b)}}catch(h){console.error("VIP auto-slot check failed (non-critical):",h)}g(o)}else{let o=[];try{const r=Y(P(v,"clients"),D("clientType","==","circuit_vip"),D("status","==","active"));o=(await q(r)).docs.map(u=>({id:u.id,...u.data()}))}catch(r){console.error("VIP query failed, creating session with empty slots:",r)}const h=[];for(let r=0;r<8;r++)r<o.length?h.push({slotNumber:r+1,memberId:o[r].id,memberName:o[r].name,memberType:"circuit_vip",status:"confirmed",bookedAt:w.now()}):h.push({slotNumber:r+1,memberId:null,memberName:null,memberType:null,status:"available"});const c={date:s,time:"09:00",endTime:"09:45",maxCapacity:8,slots:h,waitlist:[],createdAt:w.now()};await oe(a,c),g({id:s,...c})}}catch(s){console.error("Error loading session:",s),W(!0),m("Failed to load session","error")}N(!1)},Q=async s=>{if(!p){l(!0);try{if(i.circuitBanUntil&&(i.circuitBanUntil.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil))>new Date){m("You are currently suspended from booking","error"),l(!1);return}if(t.slots.some(c=>c.memberId===i.id)){m("You already have a slot booked","error"),l(!1);return}const a=[...t.slots],d=a.findIndex(c=>c.slotNumber===s&&c.status==="available");if(d===-1){m("Slot is no longer available","error"),l(!1);return}a[d]={slotNumber:s,memberId:i.id,memberName:i.name,memberType:i.clientType||"block",status:"confirmed",bookedAt:w.now()};const o=(t.waitlist||[]).filter(c=>c.memberId!==i.id),h={slots:a,waitlist:o};if(i.clientType==="circuit_vip"){const c=t.vipOptOuts||[];c.includes(i.id)&&(h.vipOptOuts=c.filter(r=>r!==i.id))}await k(y(v,"circuitSessions",t.id),h),g(c=>({...c,...h})),m("Slot booked!","success")}catch(a){console.error("Error booking slot:",a),m("Failed to book slot","error")}l(!1)}},z=async()=>{if(!p){l(!0);try{const s=O();s.setHours(9,0,0,0);const a=new Date(s.getTime()-1440*60*1e3);if(new Date>a){m("Cancellation deadline passed (24hrs before class)","error"),l(!1);return}const d=[...t.slots],o=d.findIndex(u=>u.memberId===i.id);if(o===-1){l(!1);return}const h=d[o].slotNumber,c=d[o].memberType==="circuit_vip";let r=[...t.waitlist||[]];if(r.length>0){const u=r.shift();d[o]={slotNumber:h,memberId:u.memberId,memberName:u.memberName,memberType:u.memberType,status:"confirmed",bookedAt:w.now()}}else d[o]={slotNumber:h,memberId:null,memberName:null,memberType:null,status:"available"};const j={slots:d,waitlist:r};if(c){const u=t.vipOptOuts||[];u.includes(i.id)||(j.vipOptOuts=[...u,i.id])}await k(y(v,"circuitSessions",t.id),j),g(u=>({...u,...j})),m("Slot released","success")}catch(s){console.error("Error releasing slot:",s),m("Failed to release slot","error")}l(!1)}},K=async()=>{if(!p){l(!0);try{if(t.waitlist?.some(a=>a.memberId===i.id)){m("Already on the waitlist","error"),l(!1);return}if(t.slots.some(a=>a.memberId===i.id)){m("You already have a slot","error"),l(!1);return}const s=[...t.waitlist||[],{memberId:i.id,memberName:i.name,memberType:i.clientType||"block",addedAt:w.now()}];await k(y(v,"circuitSessions",t.id),{waitlist:s}),g(a=>({...a,waitlist:s})),m("Added to waitlist!","success")}catch(s){console.error("Error joining waitlist:",s),m("Failed to join waitlist","error")}l(!1)}},X=async()=>{if(!p){l(!0);try{const s=(t.waitlist||[]).filter(a=>a.memberId!==i.id);await k(y(v,"circuitSessions",t.id),{waitlist:s}),g(a=>({...a,waitlist:s})),m("Removed from waitlist","success")}catch(s){console.error("Error leaving waitlist:",s),m("Failed to leave waitlist","error")}l(!1)}};if(T||n)return e.jsx("div",{className:"cb-page",children:e.jsx("div",{className:"cb-loading",children:e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"cb-loading-logo"})})});if(!t)return e.jsxs("div",{className:`cb-page ${A?"dark":""}`,children:[e.jsxs("header",{className:"cb-header",children:[e.jsx("button",{className:"cb-back-btn",onClick:()=>f("/client/circuit"),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})})}),e.jsx("h1",{children:"Class Booking"}),e.jsx("div",{className:"cb-header-spacer"})]}),e.jsx("main",{className:"cb-main",children:e.jsxs("div",{className:"cb-error-state",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"48",height:"48",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("circle",{cx:"12",cy:"16",r:"1",fill:"currentColor"})]}),e.jsx("h3",{children:"Couldn't load booking"}),e.jsx("p",{children:"Something went wrong. Please try again."}),e.jsx("button",{className:"cb-retry-btn",onClick:()=>{N(!0),W(!1),M()},children:"Retry"})]})})]});const $=i?.clientType||"block",Z=$==="circuit_vip"||$==="circuit_dropin",H=t.slots.find(s=>s.memberId===i.id),ee=t.waitlist?.some(s=>s.memberId===i.id),I=t.slots.filter(s=>s.status==="available").length,se=I===0,te=O(),S=new Date(te);S.setHours(9,0,0,0),S.setTime(S.getTime()-1440*60*1e3);const L=new Date>S;return e.jsxs("div",{className:`cb-page ${A?"dark":""}`,children:[e.jsx("header",{className:"client-header",children:e.jsxs("div",{className:"header-content",children:[e.jsx("button",{className:"header-back-btn",onClick:()=>f("/client/circuit"),"aria-label":"Go back",children:e.jsx("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M15 18l-6-6 6-6"})})}),e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"header-logo",width:"50",height:"50"})]})}),e.jsxs("main",{className:"cb-main",children:[e.jsxs("div",{className:"cb-class-info",children:[e.jsx("h2",{children:de(t.date)}),e.jsxs("p",{children:[t.time," - ",t.endTime," • ",I," slot",I!==1?"s":""," available"]})]}),e.jsx("div",{className:"cb-slots-grid",children:t.slots.map(s=>{const a=s.memberId===i.id,d=s.status==="available";return s.memberType,e.jsxs("div",{className:`cb-slot ${a?"mine":""} ${d?"available":"filled"}`,children:[e.jsx("div",{className:"cb-slot-number",children:s.slotNumber}),e.jsx("div",{className:"cb-slot-body",children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"cb-slot-available",children:"Available"}),!H&&e.jsx("button",{className:"cb-slot-book-btn",onClick:()=>Q(s.slotNumber),disabled:p,children:"Book"})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"cb-slot-name",children:s.memberName}),e.jsx("span",{className:`cb-slot-badge ${J(s.memberType)}`,children:G(s.memberType)})]})}),a&&e.jsx("button",{className:"cb-slot-release-btn",onClick:z,disabled:p||L,title:L?"Cancellation deadline passed":"Cancel this slot",children:L?"Locked":"Cancel"})]},s.slotNumber)})}),!H&&se&&e.jsx("div",{className:"cb-waitlist-section",children:ee?e.jsxs("div",{className:"cb-waitlist-status",children:[e.jsxs("p",{children:["You're on the waitlist (position #",(t.waitlist?.findIndex(s=>s.memberId===i.id)||0)+1,")"]}),e.jsx("button",{className:"cb-waitlist-leave-btn",onClick:X,disabled:p,children:"Leave Waitlist"})]}):e.jsx("button",{className:"cb-waitlist-join-btn",onClick:K,disabled:p,children:"Class Full - Join Waitlist"})}),t.waitlist?.length>0&&e.jsxs("div",{className:"cb-waitlist-preview",children:[e.jsxs("h4",{children:["Waitlist (",t.waitlist.length,")"]}),t.waitlist.map((s,a)=>e.jsxs("div",{className:"cb-waitlist-item",children:[e.jsxs("span",{className:"cb-waitlist-pos",children:["#",a+1]}),e.jsx("span",{className:"cb-waitlist-name",children:s.memberName}),e.jsx("span",{className:`cb-slot-badge ${J(s.memberType)}`,children:G(s.memberType)})]},s.memberId))]}),e.jsx("div",{className:"cb-rules",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Book anytime before class"})," • ",e.jsx("strong",{children:"Cancel 24hrs before"})," • ",e.jsx("strong",{children:"3 no-shows = 1 month ban"})]})})]}),e.jsxs("nav",{className:"circuit-bottom-nav",children:[!Z&&e.jsxs("button",{className:"circuit-nav-tab",onClick:()=>f("/client"),children:[e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M15 18l-6-6 6-6"})}),e.jsx("span",{children:"Dashboard"})]}),e.jsxs("button",{className:"circuit-nav-tab",onClick:()=>f("/client/circuit"),children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),e.jsx("polyline",{points:"9 22 9 12 15 12 15 22"})]}),e.jsx("span",{children:"Home"})]}),e.jsxs("button",{className:"circuit-nav-tab active",onClick:()=>f("/client/circuit/booking"),children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Class"})]})]}),C&&e.jsx("div",{className:`toast-notification ${C.type}`,children:e.jsx("span",{children:C.message})})]})}export{he as default};
