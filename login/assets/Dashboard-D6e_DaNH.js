import{r as h,g as ue,q as Re,c as se,d as k,o as es,j as e,a as Ee,T as je,w as We,b as Be,e as le,f as ss,s as Qe,h as ts,u as ke,i as as,k as ns,l as is,m as ls,n as os}from"./index-CwyBlbal.js";import{f as he,D as rs,g as cs,i as Ie,a as Pe,t as Le,b as qe,c as _e,S as ze,d as ds}from"./scheduleUtils-a2tn0x12.js";function ms(){const[u,A]=h.useState([]),[g,B]=h.useState([]),[W,ee]=h.useState(!0),[m,M]=h.useState(null),[o,J]=h.useState({}),[L,C]=h.useState(null),[V,te]=h.useState(""),[d,pe]=h.useState("all"),[T,re]=h.useState(null),[E,oe]=h.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[we,me]=h.useState([]),[ve,c]=h.useState(!1),[Z,z]=h.useState(!1),[S,P]=h.useState("list");h.useEffect(()=>{v()},[]);const v=async()=>{try{const[s,r]=await Promise.all([ue(Re(se(k,"clients"),es("name","asc"))),ue(se(k,"sessions"))]),p=s.docs.map(N=>({id:N.id,...N.data()})),D=r.docs.map(N=>({id:N.id,...N.data()}));A(p),B(D)}catch(s){console.error("Error fetching data:",s)}ee(!1)},U=s=>{const r=new Date,p=r.getFullYear(),D=(r.getMonth()+1).toString().padStart(2,"0"),N=r.getDate().toString().padStart(2,"0"),a=`${p}-${D}-${N}`,t=`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`;return g.filter(l=>l.clientId!==s?!1:l.date<a||l.date===a&&l.time<t).length},X=s=>{const r=U(s.id);return(s.totalSessions||0)-r},De=s=>{const r=new Date,p=r.getFullYear(),D=(r.getMonth()+1).toString().padStart(2,"0"),N=r.getDate().toString().padStart(2,"0"),a=`${p}-${D}-${N}`,t=`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`;return g.filter(l=>l.clientId!==s?!1:l.date>a||l.date===a&&l.time>=t).length},ae=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",ce=async(s,r)=>{if(window.confirm(`Are you sure you want to delete ${r}? This will also delete all their booked sessions.`))try{const D=g.filter(N=>N.clientId===s).map(N=>Be(le(k,"sessions",N.id)));await Promise.all(D),await Be(le(k,"clients",s)),A(u.filter(N=>N.id!==s)),B(g.filter(N=>N.clientId!==s))}catch(p){console.error("Error deleting client:",p),alert("Failed to delete client")}},ne=s=>{if(!s)return"";const r=s.toDate?s.toDate():new Date(s),p=r.getFullYear(),D=(r.getMonth()+1).toString().padStart(2,"0"),N=r.getDate().toString().padStart(2,"0");return`${p}-${D}-${N}`},Ne=s=>{M(s.id),J({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:ne(s.startDate),endDate:ne(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,buddyEnabled:!!s.buddyEnabled,coreBuddyPlan:s.coreBuddyPlan||"free",isJunior:!!s.isJunior})},de=s=>{const{name:r,value:p}=s.target;if(J(D=>({...D,[r]:p})),r==="startDate"||r==="weeksInBlock"){const D=r==="startDate"?p:o.startDate,N=parseInt(r==="weeksInBlock"?p:o.weeksInBlock);if(D&&N>0){const a=new Date(D),t=new Date(a);t.setDate(t.getDate()+N*7);const l=t.getFullYear(),j=(t.getMonth()+1).toString().padStart(2,"0"),x=t.getDate().toString().padStart(2,"0");J(w=>({...w,[r]:p,endDate:`${l}-${j}-${x}`}))}}},ge=async s=>{try{const r=u.find(a=>a.id===s);let p=r?.uid;if(o.password&&o.password.length>=6&&!r?.uid)try{const a=await ss(Qe,o.email.trim().toLowerCase(),o.password);await ts(Qe),p=a.user.uid}catch(a){if(console.error("Error creating auth account:",a),a.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(a.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+a.message);return}}const D=o.clientType==="block",N={name:o.name.trim(),email:o.email.trim().toLowerCase(),clientType:o.clientType,status:o.status,coreBuddyAccess:o.coreBuddyAccess,buddyEnabled:o.buddyEnabled,isJunior:o.isJunior};if(D)N.weeksInBlock=parseInt(o.weeksInBlock)||0,N.totalSessions=parseInt(o.totalSessions)||0,N.sessionDuration=parseInt(o.sessionDuration),N.circuitAccess=o.circuitAccess,o.startDate&&(N.startDate=je.fromDate(new Date(o.startDate))),o.endDate&&(N.endDate=je.fromDate(new Date(o.endDate)));else if(o.clientType==="core_buddy")N.coreBuddyPlan=o.coreBuddyPlan||"free",N.coreBuddyAccess=!0;else{const a=u.find(t=>t.id===s);a?.circuitStrikes===void 0&&(N.circuitStrikes=0),a?.circuitBanUntil===void 0&&(N.circuitBanUntil=null)}p&&!r?.uid&&(N.uid=p),await ke(le(k,"clients",s),N),A(u.map(a=>a.id===s?{...a,...o,uid:p||a.uid,weeksInBlock:parseInt(o.weeksInBlock),totalSessions:parseInt(o.totalSessions),sessionDuration:parseInt(o.sessionDuration),startDate:je.fromDate(new Date(o.startDate)),endDate:je.fromDate(new Date(o.endDate))}:a)),M(null),p&&!r?.uid&&alert("Portal access created! Client can now log in.")}catch(r){console.error("Error updating client:",r),alert("Failed to update client")}},Ce=async s=>{try{const r=u.find(p=>p.id===s)?.status==="archived"?"active":"archived";await ke(le(k,"clients",s),{status:r}),A(u.map(p=>p.id===s?{...p,status:r}:p))}catch(r){console.error("Error archiving client:",r),alert("Failed to update client status")}},Ae=async s=>{re({clientId:s.id,clientName:s.name}),P("list"),oe({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),c(!0);try{const r=Re(se(k,"sessionNotes"),We("clientId","==",s.id)),D=(await ue(r)).docs.map(N=>({id:N.id,...N.data()}));D.sort((N,a)=>{const t=N.createdAt?.toMillis?.()||0;return(a.createdAt?.toMillis?.()||0)-t}),me(D)}catch(r){console.error("Error fetching notes:",r),me([])}c(!1)},fe=()=>{re(null),me([]),P("list")},i=async()=>{if(!T)return;const{sessionNotes:s,whatWentWell:r,whatWentWrong:p,whatsNext:D}=E;if(!(!s.trim()&&!r.trim()&&!p.trim()&&!D.trim())){z(!0);try{const a=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await Ee(se(k,"sessionNotes"),{clientId:T.clientId,date:a,sessionNotes:s.trim(),whatWentWell:r.trim(),whatWentWrong:p.trim(),whatsNext:D.trim(),createdAt:je.now()}),oe({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const t=Re(se(k,"sessionNotes"),We("clientId","==",T.clientId)),j=(await ue(t)).docs.map(x=>({id:x.id,...x.data()}));j.sort((x,w)=>{const I=x.createdAt?.toMillis?.()||0;return(w.createdAt?.toMillis?.()||0)-I}),me(j),P("list")}catch(N){console.error("Error saving note:",N),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}z(!1)}},f=async s=>{if(window.confirm("Delete this session note?"))try{await Be(le(k,"sessionNotes",s)),me(we.filter(r=>r.id!==s))}catch(r){console.error("Error deleting note:",r)}};if(W)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(u.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const y=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",b=u.filter(s=>s.name?.toLowerCase().includes(V.toLowerCase())||s.email?.toLowerCase().includes(V.toLowerCase())).sort((s,r)=>(s.name||"").localeCompare(r.name||"")),H=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",q=s=>s.clientType==="core_buddy",F=s=>s.status==="archived",R=b.filter(s=>!F(s)),_=R.filter(s=>!H(s)&&!q(s)),O=R.filter(s=>H(s)),be=R.filter(s=>q(s)),ye=b.filter(s=>F(s)),Te=d==="block"?_:d==="circuit"?O:d==="core_buddy"?be:d==="archived"?ye:R,$e=s=>{m||C(r=>r===s?null:s)},n=s=>{const r=L===s.id,p=m===s.id,D=!s.clientType||s.clientType==="block";let N=null,a=null;if(D&&s.status!=="archived"){const t=X(s);if(t<=2&&(N={text:t<=0?"No sessions":`${t} left`,urgent:t<=0}),s.endDate){const l=s.endDate.toDate?s.endDate.toDate():new Date(s.endDate),j=Math.ceil((l-new Date)/(1e3*60*60*24));j<=7&&(a={text:j<=0?"Expired":j===1?"Ends today":`${j}d left`,urgent:j<=1})}}return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${r||p?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>$e(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:D?`${X(s)}/${s.totalSessions||0} sessions`:y(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[N&&e.jsx("span",{className:`client-warn-badge ${N.urgent?"urgent":"warning"}`,children:N.text}),a&&e.jsx("span",{className:`client-warn-badge ${a.urgent?"urgent":"expiry"}`,children:a.text}),(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:y(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${r||p?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(r||p)&&e.jsx("div",{className:"client-expand-panel",children:p?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(t=>e.jsx("button",{type:"button",className:`edit-type-btn ${o.clientType===t.value?"active":""}`,onClick:()=>J(l=>({...l,clientType:t.value})),children:t.label},t.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:o.name,onChange:de,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:o.email,onChange:de,placeholder:"Email"})]}),o.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:o.weeksInBlock,onChange:de,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:o.totalSessions,onChange:de,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:o.sessionDuration,onChange:de,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:o.startDate,onChange:de}),e.jsx("input",{type:"date",name:"endDate",value:o.endDate,onChange:de})]})]}),o.clientType==="core_buddy"&&e.jsx("div",{className:"edit-row",children:e.jsxs("select",{name:"coreBuddyPlan",value:o.coreBuddyPlan,onChange:de,children:[e.jsx("option",{value:"free",children:"Free"}),e.jsx("option",{value:"premium",children:"Premium"})]})}),e.jsx("div",{className:"edit-row password-row",children:o.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:o.password,onChange:de,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),o.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.circuitAccess,onChange:t=>J(l=>({...l,circuitAccess:t.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),o.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.coreBuddyAccess,onChange:t=>J(l=>({...l,coreBuddyAccess:t.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.buddyEnabled,onChange:t=>J(l=>({...l,buddyEnabled:t.target.checked}))}),e.jsx("span",{children:"AI Buddy"})]})}),o.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:o.isJunior,onChange:t=>J(l=>({...l,isJunior:t.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>ge(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{M(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),D?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[X(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[De(s.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:ae(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:ae(s.endDate)})]})]}):s.clientType==="core_buddy"?e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Plan"}),e.jsx("span",{className:"detail-value",children:s.coreBuddyPlan==="premium"?"Premium":"Free"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ae(s.createdAt)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ae(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[D&&e.jsxs("button",{className:"action-btn notes",onClick:t=>{t.stopPropagation(),Ae(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:t=>{t.stopPropagation(),Ne(s)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:t=>{t.stopPropagation(),Ce(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:t=>{t.stopPropagation(),ce(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:V,onChange:s=>te(s.target.value),className:"client-search-input"}),V&&e.jsx("button",{className:"client-search-clear",onClick:()=>te(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("select",{className:"client-type-select",value:d,onChange:s=>pe(s.target.value),children:[e.jsxs("option",{value:"all",children:["All Clients (",R.length,")"]}),e.jsxs("option",{value:"block",children:["Block Members (",_.length,")"]}),e.jsxs("option",{value:"circuit",children:["Circuit Members (",O.length,")"]}),e.jsxs("option",{value:"core_buddy",children:["Core Buddy (",be.length,")"]}),e.jsxs("option",{value:"archived",children:["Archived (",ye.length,")"]})]}),d==="all"?e.jsxs(e.Fragment,{children:[_.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:_.length})]}),_.map(n)]}),O.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:O.length})]}),O.map(n)]}),be.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:be.length})]}),be.map(n)]})]}):d==="archived"?e.jsx(e.Fragment,{children:ye.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:ye.length})]}),ye.map(n)]})}):e.jsxs(e.Fragment,{children:[Te.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",d," clients found"]}),Te.map(n)]}),T&&e.jsx("div",{className:"notes-modal-overlay",onClick:fe,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),T.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:fe,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),S==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:ve?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):we.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:we.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>f(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>P("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:E.sessionNotes,onChange:s=>oe(r=>({...r,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:E.whatWentWell,onChange:s=>oe(r=>({...r,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:E.whatWentWrong,onChange:s=>oe(r=>({...r,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:E.whatsNext,onChange:s=>oe(r=>({...r,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>P("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:i,disabled:Z,children:Z?"Saving...":"Save Notes"})]})]})]})})]})}const hs=["Mon","Tue","Wed","Thu","Fri"],us=u=>{const A=new Date(u),g=A.getDay(),B=A.getDate()-g+(g===0?-6:1);return A.setDate(B),qe.map((W,ee)=>{const m=new Date(A);return m.setDate(A.getDate()+ee),m})};function ps(){const[u,A]=h.useState(new Date),[g,B]=h.useState([]),[W,ee]=h.useState([]),[m,M]=h.useState([]),[o,J]=h.useState([]),[L,C]=h.useState([]),[V,te]=h.useState([]),[d,pe]=h.useState(null),[T,re]=h.useState(null),[E,oe]=h.useState(!1),[we,me]=h.useState(!0),[ve,c]=h.useState(""),[Z,z]=h.useState([]),[S,P]=h.useState(null),[v,U]=h.useState(!1);h.useEffect(()=>{B(us(u))},[u]),h.useEffect(()=>{ge()},[]);const X=a=>{pe(a),oe(!1),re(null)},De=()=>{if(!d)return null;const a=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),t=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),l=g[0];if(!l)return null;const j=10080*60*1e3,x=Math.floor((l-a)/j)+1,w=d.weeksInBlock||Math.ceil((t-a)/j),I=l>=a&&l<=t;return{startDate:a,endDate:t,weekNumber:x,totalWeeks:w,isWithinBlock:I}},ae=()=>{if(d?.startDate){const a=d.startDate.toDate?d.startDate.toDate():new Date(d.startDate);A(a),re(null)}},ce=()=>{if(d?.endDate){const a=d.endDate.toDate?d.endDate.toDate():new Date(d.endDate);A(a),re(null)}},ne=a=>{const t=new Date,l=he(t),j=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;return m.filter(x=>x.clientId!==a?!1:x.date<l||x.date===l&&x.time<j).length},Ne=a=>{const t=ne(a.id);return(a.totalSessions||0)-t},de=a=>{const t=new Date,l=t.getFullYear(),j=(t.getMonth()+1).toString().padStart(2,"0"),x=t.getDate().toString().padStart(2,"0"),w=`${l}-${j}-${x}`,I=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;return m.filter(G=>G.clientId!==a?!1:G.date>w||G.date===w&&G.time>=I).length},ge=async()=>{try{const t=(await ue(se(k,"clients"))).docs.map(K=>({id:K.id,...K.data()})).filter(K=>K.status==="active").sort((K,ie)=>K.name.localeCompare(ie.name));ee(t);const j=(await ue(se(k,"sessions"))).docs.map(K=>({id:K.id,...K.data()}));M(j);const w=(await ue(se(k,"holidays"))).docs.map(K=>({id:K.id,...K.data()}));J(w);const G=(await ue(se(k,"blockedTimes"))).docs.map(K=>({id:K.id,...K.data()}));C(G);const Y=(await ue(se(k,"openedSlots"))).docs.map(K=>({id:K.id,...K.data()}));te(Y);const xe=(await ue(se(k,"sessionNotes"))).docs.map(K=>({id:K.id,...K.data()}));z(xe)}catch(a){console.error("Error fetching data:",a)}me(!1)},Ce=a=>Z.some(t=>t.clientId===a.clientId&&t.date===a.date),Ae=(a,t)=>{if(!d)return"Unavailable";const l=d.sessionDuration||45,j=he(a),x=Le(t),w=x+l,I=m.find(Y=>{if(Y.date!==j)return!1;const Q=Le(Y.time),xe=Q+(Y.duration||45);return x<xe&&w>Q});if(I)return`Taken — ${I.clientName}`;const G=qe[a.getDay()-1],$=ze[G];if($){const Y=_e(t,l),Q=$.morning&&t>=$.morning.start&&t<$.morning.end,xe=$.afternoon&&t>=$.afternoon.start&&t<$.afternoon.end;if(Q&&Y>$.morning.end)return"Splits break";if(xe&&Y>$.afternoon.end)return"Overruns end"}return"Unavailable"},fe=a=>{const t=W.find($=>$.id===a.clientId);if(!t||!t.startDate||!t.endDate)return[];const l=t.startDate?.toDate?t.startDate.toDate():new Date(t.startDate),j=t.endDate?.toDate?t.endDate.toDate():new Date(t.endDate),x=new Date,w=new Date(x.getFullYear(),x.getMonth(),x.getDate()),I=[],G=new Date(Math.max(l.getTime(),w.getTime()));for(;G<=j;){const $=G.getDay();if($>=1&&$<=5){const Y=he(G);o.some(Q=>Q.date===Y)||I.push(new Date(G))}G.setDate(G.getDate()+1)}return I},i=(a,t)=>t?ds(t,a.duration||45,m,o,a.id,L,V):[],f=async a=>{if(P(null),window.confirm(`Cancel ${a.clientName}'s session at ${Pe(a.time)}?`))try{await Be(le(k,"sessions",a.id)),M(m.filter(t=>t.id!==a.id))}catch(t){console.error("Error cancelling session:",t),alert("Failed to cancel session")}},y=async(a,t,l)=>{U(!0);try{const j=he(t);await ke(le(k,"sessions",a.id),{date:j,time:l}),M(m.map(x=>x.id===a.id?{...x,date:j,time:l}:x)),P(null)}catch(j){console.error("Error rescheduling session:",j),alert("Failed to reschedule session")}U(!1)},b=a=>{const t=new Date(u);t.setDate(t.getDate()+a*7),A(t),re(null)},H=()=>{A(new Date),re(null)},q=a=>{const t=he(a);return o.some(l=>l.date===t)},F=(a,t)=>{const l=he(a);return L.some(j=>j.date===l&&j.time===t)},R=(a,t)=>{const l=he(a);return V.some(j=>j.date===l&&j.time===t)},_=a=>{const t=qe[a.getDay()-1];return t&&ze[t]?.defaultBlocked},O=async(a,t)=>{const l=he(a);if(_(a)){const x=V.find(w=>w.date===l&&w.time===t);try{if(x)await Be(le(k,"openedSlots",x.id)),te(V.filter(w=>w.id!==x.id));else{const w=await Ee(se(k,"openedSlots"),{date:l,time:t,createdAt:je.now()});te([...V,{id:w.id,date:l,time:t}])}}catch(w){console.error("Error toggling opened slot:",w),alert("Failed to update time slot")}return}const j=L.find(x=>x.date===l&&x.time===t);try{if(j)await Be(le(k,"blockedTimes",j.id)),C(L.filter(x=>x.id!==j.id));else{const x=await Ee(se(k,"blockedTimes"),{date:l,time:t,createdAt:je.now()});C([...L,{id:x.id,date:l,time:t}])}}catch(x){console.error("Error toggling blocked time:",x),alert("Failed to update time slot")}},be=a=>{const t=he(a);return m.filter(l=>l.date===t)},ye=(a,t)=>{const l=he(a);return m.find(j=>j.date===l&&j.time===t)},Te=(a,t)=>{const l=he(a),j=Le(t);return m.find(x=>{if(x.date!==l)return!1;const w=Le(x.time),I=w+(x.duration||45);return j>=w&&j<I})},$e=(a,t,l)=>{const j=qe[a.getDay()-1];if(!j||q(a))return!1;const x=ze[j],w=Math.ceil(l/15);if(x.defaultBlocked)for(let ie=0;ie<w;ie++){const Se=_e(t,ie*15);if(!R(a,Se))return!1}else for(let ie=0;ie<w;ie++){const Se=_e(t,ie*15);if(F(a,Se))return!1}const I=he(a);if(m.find(ie=>ie.date===I&&ie.time===t))return!1;const $=_e(t,l),Y=x.morning&&$<=x.morning.end,Q=x.afternoon&&$<=x.afternoon.end,xe=x.morning&&t>=x.morning.start&&t<x.morning.end,K=x.afternoon&&t>=x.afternoon.start&&t<x.afternoon.end;if(xe&&!Y||K&&!Q)return!1;for(const ie of m){if(ie.date!==I)continue;const Se=Le(ie.time),Ve=Se+(ie.duration||45),Fe=Le(t),Me=Fe+l;if(Fe<Ve&&Me>Se)return!1}return!0},n=async(a,t)=>{const l=Te(a,t);if(l){if(Ie(l))return;P({session:l,step:"action",selectedDate:null,selectedTime:null});return}if(!d){alert("Please select a client first");return}if(!$e(a,t,d.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}const j=de(d.id);if(ne(d.id)+j>=d.totalSessions){alert(`${d.name} has used all ${d.totalSessions} sessions in their package`);return}try{const w=he(a),I={clientId:d.id,clientName:d.name,date:w,time:t,duration:d.sessionDuration||45,createdAt:je.now()},G=await Ee(se(k,"sessions"),I);M([...m,{id:G.id,...I}])}catch(w){console.error("Error booking session:",w),alert("Failed to book session")}},s=async()=>{if(!d)return;const a=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),t=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),l=m.filter($=>$.clientId!==d.id?!1:g.some(Y=>he(Y)===$.date));if(l.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const j=d.weeksInBlock||Math.ceil((t-a)/(10080*60*1e3)),x=l.map($=>({dayOfWeek:new Date($.date).getDay(),time:$.time}));let w=[];const I=de(d.id)+ne(d.id);for(let $=0;$<j;$++){const Y=new Date(a);Y.setDate(Y.getDate()+$*7);const Q=new Date(Y),xe=Q.getDay(),K=Q.getDate()-xe+(xe===0?-6:1);Q.setDate(K);for(const ie of x){const Se=new Date(Q),Ve=ie.dayOfWeek===0?6:ie.dayOfWeek-1;Se.setDate(Q.getDate()+Ve);const Fe=he(Se);m.some(Me=>Me.clientId===d.id&&Me.date===Fe&&Me.time===ie.time)||Se<a||Se>t||o.some(Me=>Me.date===Fe)||w.push({dateKey:Fe,time:ie.time,sessionDate:Se})}}const G=I+w.length;if(G>d.totalSessions){alert(`This would create ${w.length} new sessions (${G} total), but client only has ${d.totalSessions} sessions in their package.

You can still book ${d.totalSessions-I} more sessions.`);return}if(w.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${w.length} new sessions across the block.

(${I} existing + ${w.length} new = ${G} total)

Continue?`))try{const $=[];for(const Y of w){const Q={clientId:d.id,clientName:d.name,date:Y.dateKey,time:Y.time,duration:d.sessionDuration||45,createdAt:je.now()},xe=await Ee(se(k,"sessions"),Q);$.push({id:xe.id,...Q})}M([...m,...$]),alert(`Created ${$.length} new sessions!`)}catch($){console.error("Error repeating weekly:",$),alert("Failed to repeat sessions")}},r=async a=>{const t=he(a),l=o.find(j=>j.date===t);try{if(l)await Be(le(k,"holidays",l.id)),J(o.filter(j=>j.id!==l.id));else{const j=await Ee(se(k,"holidays"),{date:t,createdAt:je.now()});J([...o,{id:j.id,date:t}])}}catch(j){console.error("Error toggling day availability:",j),alert("Failed to update day availability")}};if(we)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const p=g[0],D=g[4],N=p&&D?`${p.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${D.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>b(-1),children:"←"}),e.jsx("button",{onClick:H,children:"Today"}),e.jsx("button",{onClick:()=>b(1),children:"→"})]}),e.jsx("h3",{children:N})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),d?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:d.name}),e.jsxs("span",{children:[d.sessionDuration||45,"min • ",Ne(d),"/",d.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[de(d.id)," booked"]})]}),e.jsx("button",{onClick:()=>pe(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>oe(!0),children:"Select Client"})]}),d&&d.startDate&&d.endDate&&(()=>{const a=De();return a?e.jsxs("div",{className:"block-nav",children:[e.jsx("button",{onClick:ae,children:"← Block Start"}),e.jsx("span",{className:"block-range",children:a.isWithinBlock?`Week ${a.weekNumber} of ${a.totalWeeks}`:g[0]<a.startDate?"Before block":"After block"}),e.jsx("button",{onClick:ce,children:"Block End →"})]}):null})(),d&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:s,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:g.map((a,t)=>{const l=be(a),j=he(a)===he(new Date),x=q(a);return e.jsxs("div",{className:`day-card ${T===t?"selected":""} ${j?"today":""} ${x?"holiday":""}`,onClick:()=>re(T===t?null:t),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:hs[t]}),e.jsx("span",{className:"day-date",children:a.getDate()})]}),x?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[l.length," session",l.length!==1?"s":""]})]},t)})}),T!==null&&g[T]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[rs[T]," ",g[T].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>re(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${q(g[T])?"unavailable":"available"}`,onClick:()=>r(g[T]),children:q(g[T])?"Mark Day Available":"Mark Day Unavailable"})}),q(g[T])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[_(g[T])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),cs(qe[T]).map(({time:a,period:t},l,j)=>{const x=ye(g[T],a),w=Te(g[T],a),I=!!w,G=!x&&!!w,$=w?Ie(w):!1,Y=_(g[T]),Q=Y?!R(g[T],a):F(g[T],a),xe=Y&&R(g[T],a),K=d&&!I&&$e(g[T],a,d.sessionDuration||45),ie=l===0||j[l-1]?.period!==t;return e.jsxs("div",{children:[ie&&e.jsx("div",{className:"period-label",children:t==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${I&&$?"completed":""} ${I&&!$?"booked":""} ${G?"booked-continuation":""} ${Q&&!I?"blocked":""} ${xe&&!I?"opened":""} ${K?"available":""} ${!I&&!Q&&!K&&d?"unavailable":""}`,onClick:()=>!$&&(!Q||I)&&n(g[T],a),disabled:$||Q&&!I,children:[e.jsx("span",{className:"slot-time",children:Pe(a)}),x&&$?e.jsxs("span",{className:"slot-done",children:[x.clientName," (",x.duration,"m) ✓",Ce(x)&&e.jsx("span",{className:"note-dot",title:"Has session note"})]}):x?e.jsxs("span",{className:"slot-client",children:[x.clientName," (",x.duration,"m)"]}):G&&$?e.jsxs("span",{className:"slot-done",children:[w.clientName," ↑"]}):G?e.jsxs("span",{className:"slot-client",children:[w.clientName," ↑"]}):Q?e.jsx("span",{className:"slot-blocked",children:Y?"Closed":"Blocked"}):K?e.jsx("span",{className:"slot-available",children:"Available"}):d?e.jsx("span",{className:"slot-unavailable",children:Ae(g[T],a)}):xe?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${Y?xe?"is-opened":"":Q?"is-blocked":""}`,onClick:()=>O(g[T],a),disabled:$||!!I,title:Y?xe?"Close this slot":"Open this slot":Q?"Unblock this time":"Block this time",children:Y?xe?"✓":"+":Q?"✓":"✕"})]})]},a)})]})]}),S&&e.jsx("div",{className:"modal-overlay",onClick:()=>P(null),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[S.step==="action"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:S.session.clientName}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsxs("div",{className:"edit-session-info",children:[e.jsx("p",{className:"edit-session-date",children:new Date(S.session.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short",timeZone:"UTC"})}),e.jsxs("p",{className:"edit-session-time",children:[Pe(S.session.time)," · ",S.session.duration,"min"]})]}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"reschedule-edit-btn",onClick:()=>P({...S,step:"date"}),children:"Reschedule"}),e.jsx("button",{className:"cancel-session-btn",onClick:()=>f(S.session),children:"Cancel Session"})]})]}),S.step==="date"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>P({...S,step:"action"}),children:"←"}),e.jsx("h3",{children:"Pick New Date"}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const a=fe(S.session);return a.length===0?e.jsx("p",{className:"no-items",children:"No available dates in block"}):a.map(t=>{const l=he(t);return e.jsx("button",{className:"client-option date-option",onClick:()=>P({...S,step:"time",selectedDate:t,selectedTime:null}),children:t.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"})},l)})})()})]}),S.step==="time"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>P({...S,step:"date",selectedTime:null}),children:"←"}),e.jsx("h3",{children:S.selectedDate?.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("button",{className:"close-btn",onClick:()=>P(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const a=i(S.session,S.selectedDate);return a.length===0?e.jsx("p",{className:"no-items",children:"No available slots on this day"}):a.map(t=>e.jsxs("button",{className:`client-option time-option ${S.selectedTime===t.time?"selected":""}`,onClick:()=>P({...S,selectedTime:t.time}),children:[Pe(t.time),e.jsx("span",{className:"time-option-period",children:t.period})]},t.time))})()}),S.selectedTime&&e.jsx("div",{className:"edit-confirm-bar",children:e.jsx("button",{className:"confirm-reschedule-btn",onClick:()=>y(S.session,S.selectedDate,S.selectedTime),disabled:v,children:v?"Saving...":`Confirm — ${Pe(S.selectedTime)}`})})]})]})}),E&&e.jsx("div",{className:"modal-overlay",onClick:()=>{oe(!1),c("")},children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>{oe(!1),c("")},children:"×"})]}),e.jsx("div",{className:"client-search-wrapper",children:e.jsx("input",{className:"client-search-input",type:"text",placeholder:"Search by name...",value:ve,onChange:a=>c(a.target.value),autoFocus:!0})}),e.jsx("div",{className:"client-list-picker",children:W.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):(()=>{const a={block:"Block",core_buddy:"Core Buddy",circuit_vip:"Circuit VIP",circuit_dropin:"Circuit Drop-in"},t=W.filter(l=>l.name.toLowerCase().includes(ve.toLowerCase()));return t.length===0?e.jsxs("p",{className:"no-items",children:['No clients match "',ve,'"']}):t.map(l=>{const j=l.startDate&&l.endDate,x=j?l.startDate?.toDate?l.startDate.toDate():new Date(l.startDate):null,w=j?l.endDate?.toDate?l.endDate.toDate():new Date(l.endDate):null,I=Ne(l),G=de(l.id);return e.jsxs("button",{className:"client-option",onClick:()=>{X(l),c("")},children:[e.jsxs("div",{className:"client-option-header",children:[e.jsx("strong",{children:l.name}),l.clientType&&e.jsx("span",{className:"client-type-badge",children:a[l.clientType]||l.clientType})]}),e.jsxs("span",{children:[l.sessionDuration||45,"min • ",I,"/",l.totalSessions," remaining • ",G," booked"]}),x&&w&&e.jsxs("span",{className:"client-dates",children:[x.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," – ",w.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},l.id)})})()})]})})]})}const Ge=u=>{const[A,g]=u.split(":"),B=parseInt(A),W=B>=12?"pm":"am";return`${B>12?B-12:B===0?12:B}:${g}${W}`},He=u=>{const A=u.getFullYear(),g=(u.getMonth()+1).toString().padStart(2,"0"),B=u.getDate().toString().padStart(2,"0");return`${A}-${g}-${B}`},Je=u=>u===He(new Date),xs=u=>{const A=new Date;return A.setDate(A.getDate()+1),u===He(A)},Ye=u=>Je(u)?"Today":xs(u)?"Tomorrow":new Date(u).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),js=u=>{if(u.length===0)return[];const A=new Date,g=new Date(A),B=g.getDay();g.setDate(g.getDate()-(B===0?6:B-1)),g.setHours(0,0,0,0);const W=new Date(g);W.setDate(W.getDate()+7);const ee=new Date(W);ee.setDate(ee.getDate()+7);const m=new Map;return u.forEach(M=>{const[o,J,L]=M.split("-").map(Number),C=new Date(o,J-1,L);let V,te,d;C<W?(V="this-week",te="This Week",d=0):C<ee?(V="next-week",te="Next Week",d=1):(V=`${C.getFullYear()}-${C.getMonth()}`,te=C.toLocaleDateString("en-GB",{month:"long",year:"numeric"}),d=100+C.getFullYear()*12+C.getMonth()),m.has(V)||m.set(V,{key:V,label:te,order:d,dates:[]}),m.get(V).dates.push(M)}),Array.from(m.values()).sort((M,o)=>M.order-o.order)};function gs(){const[u,A]=h.useState([]),[g,B]=h.useState(!0),[W,ee]=h.useState(new Date),[m,M]=h.useState(""),[o,J]=h.useState(""),[L,C]=h.useState(!1),[V,te]=h.useState(new Set);h.useEffect(()=>{d();const v=setInterval(()=>ee(new Date),6e4);return()=>clearInterval(v)},[]);const d=async()=>{try{const U=(await ue(se(k,"sessions"))).docs.map(ae=>({id:ae.id,...ae.data()})),X=He(new Date),De=U.filter(ae=>ae.date>=X).sort((ae,ce)=>ae.date!==ce.date?ae.date.localeCompare(ce.date):ae.time.localeCompare(ce.time));A(De)}catch(v){console.error("Error fetching sessions:",v)}B(!1)},pe=async v=>{if(window.confirm(`Cancel ${v.clientName}'s session at ${Ge(v.time)} on ${Ye(v.date)}?`))try{await Be(le(k,"sessions",v.id)),A(u.filter(U=>U.id!==v.id))}catch(U){console.error("Error cancelling session:",U),alert("Failed to cancel session")}},T=v=>{te(U=>{const X=new Set(U);return X.has(v)?X.delete(v):X.add(v),X})};if(g)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const re=o?u.filter(v=>v.clientName.toLowerCase().includes(o.toLowerCase())):u,E=re.reduce((v,U)=>(v[U.date]||(v[U.date]=[]),v[U.date].push(U),v),{}),oe=Object.keys(E).sort(),we=He(new Date),me=E[we]||[],ve=me.filter(v=>Ie(v)).length,c=me.length-ve,Z=re.find(v=>!Ie(v)),S=(()=>{if(!Z||Z.date!==He(new Date))return null;const[v,U]=Z.time.split(":").map(Number),X=v*60+U-(new Date().getHours()*60+new Date().getMinutes());return X<=0||X>180?null:X<60?`${X}m`:`${Math.floor(X/60)}h ${X%60}m`})(),P=js(oe);return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:me.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[ve," completed"]}),e.jsxs("span",{className:"remaining-count",children:[c," remaining"]})]})}),ve>0&&e.jsx("button",{className:"hide-completed-btn",onClick:()=>C(v=>!v),children:L?"Show all":"Hide done"})]}),Z&&S&&e.jsxs("div",{className:"next-session-banner",children:[e.jsx("div",{className:"next-session-label",children:"Up next"}),e.jsxs("div",{className:"next-session-info",children:[e.jsx("span",{className:"next-session-name",children:Z.clientName}),e.jsx("span",{className:"next-session-time",children:Ge(Z.time)})]}),e.jsx("div",{className:"next-session-countdown",children:S})]}),oe.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:o?`No sessions found for "${o}"`:"No upcoming sessions booked"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"schedule-controls",children:[e.jsx("input",{className:"client-filter-input",type:"text",placeholder:"Filter by client...",value:o,onChange:v=>J(v.target.value)}),e.jsxs("select",{className:"date-jump-select",value:m,onChange:v=>{const U=v.target.value;M(U),U&&(document.getElementById(`date-${U}`)?.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>M(""),600))},children:[e.jsx("option",{value:"",children:"Jump to date..."}),oe.map(v=>e.jsxs("option",{value:v,children:[Ye(v)," (",E[v].length,")"]},v))]})]}),e.jsx("div",{className:"sessions-list",children:P.map(({key:v,label:U,dates:X})=>{const ae=v!=="this-week"&&v!=="next-week"?!V.has(v):V.has(v),ce=X.reduce((ne,Ne)=>ne+E[Ne].length,0);return e.jsxs("div",{className:"week-group",children:[e.jsxs("button",{className:`week-group-header ${ae?"collapsed":""}`,onClick:()=>T(v),children:[e.jsx("span",{className:"week-label",children:U}),e.jsxs("span",{className:"week-count",children:[ce," session",ce!==1?"s":""]}),e.jsx("span",{className:"week-chevron",children:ae?"▸":"▾"})]}),!ae&&e.jsx("div",{className:"week-group-body",children:X.map(ne=>{const Ne=E[ne],de=L&&Je(ne)?Ne.filter(ge=>!Ie(ge)):Ne;return e.jsxs("div",{id:`date-${ne}`,className:`date-group ${Je(ne)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ye(ne)}),e.jsxs("span",{className:"date-count",children:[Ne.length," session",Ne.length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:de.length===0?e.jsx("div",{className:"all-done-msg",children:"All sessions completed ✓"}):de.map(ge=>{const Ce=Ie(ge);return e.jsxs("div",{className:`session-card ${Ce?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ge(ge.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:ge.clientName}),e.jsxs("span",{children:[ge.duration,"min session"]})]}),Ce?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>pe(ge),children:"Cancel"})]},ge.id)})})]},ne)})})]},v)})})]})]})}const fs={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},vs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},Ns={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},ys=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function ws(){const[u,A]=h.useState([]),[g,B]=h.useState(!0),[W,ee]=h.useState(null),[m,M]=h.useState(null),[o,J]=h.useState("all"),[L,C]=h.useState("");h.useEffect(()=>{V()},[]);const V=async()=>{try{const Z=(await ue(se(k,"clients"))).docs.map(z=>({id:z.id,...z.data()}));Z.sort((z,S)=>(z.name||"").localeCompare(S.name||"")),A(Z)}catch(c){console.error("Error fetching clients:",c)}B(!1)},te=c=>!!c.welcomeForm?.completedAt,d=c=>!!c.parqForm?.completedAt,pe=c=>te(c)||d(c),T=c=>te(c)&&d(c),re=c=>c?(c.toDate?c.toDate():new Date(c)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",E=u.filter(c=>!L||c.name?.toLowerCase().includes(L.toLowerCase())?o==="all"?!0:o==="completed"?T(c):o==="partial"?pe(c)&&!T(c):o==="pending"?!pe(c):!0:!1),oe=u.filter(T).length,we=u.filter(c=>pe(c)&&!T(c)).length,me=u.filter(c=>!pe(c)).length,ve=c=>{W===c?(ee(null),M(null)):(ee(c),M(null))};return g?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:oe}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:we}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:me}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:L,onChange:c=>C(c.target.value)}),L&&e.jsx("button",{className:"forms-search-clear",onClick:()=>C(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${o==="all"?"active":""}`,onClick:()=>J("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:u.length})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="completed"?"active":""}`,onClick:()=>J("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:oe})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="partial"?"active":""}`,onClick:()=>J("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:we})]}),e.jsxs("button",{className:`forms-filter-btn ${o==="pending"?"active":""}`,onClick:()=>J("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:me})]})]}),E.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:E.map(c=>{const Z=W===c.id,z=te(c),S=d(c);return e.jsxs("div",{className:`forms-client-card ${Z?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>ve(c.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(c.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:c.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${z?"done":"not-done"}`,children:[z?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${S?"done":"not-done"}`,children:[S?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${Z?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),Z&&e.jsx("div",{className:"forms-expand-panel",children:!z&&!S?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[z&&e.jsx("button",{className:`forms-toggle-btn ${m==="welcome"||!m&&z?"active":""}`,onClick:()=>M("welcome"),children:"Welcome Questionnaire"}),S&&e.jsx("button",{className:`forms-toggle-btn ${m==="parq"||!m&&!z&&S?"active":""}`,onClick:()=>M("parq"),children:"PAR-Q Health Screening"})]}),(m==="welcome"||!m&&z)&&z&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",re(c.welcomeForm.completedAt)]})]}),c.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:c.welcomeForm.fitnessGoals})]}),c.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:fs[c.welcomeForm.currentActivityLevel]||c.welcomeForm.currentActivityLevel})]}),c.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:c.welcomeForm.exerciseHistory})]}),c.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:c.welcomeForm.injuries})]}),c.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:c.welcomeForm.medicalConditions})]}),c.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:vs[c.welcomeForm.sleepHours]||c.welcomeForm.sleepHours})]}),c.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:Ns[c.welcomeForm.stressLevel]||c.welcomeForm.stressLevel})]}),c.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:c.welcomeForm.dietaryInfo})]}),c.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:c.welcomeForm.availability})]}),c.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:c.welcomeForm.additionalInfo})]})]}),m==="parq"&&S&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",re(c.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:ys.map(P=>{const v=c.parqForm[P.key];return e.jsxs("div",{className:`parq-result-item ${v?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${v?"yes":"no"}`,children:v?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:P.text})]},P.key)})}),c.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:c.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:c.parqForm.declaration?"declared":"not-declared",children:c.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},c.id)})})]})}const Ke=u=>`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-${String(u.getDate()).padStart(2,"0")}`,Ze=u=>new Date(u+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),Xe=()=>{const u=new Date;let g=(6-u.getDay()+7)%7;if(g===0){const W=new Date(u);W.setHours(9,45,0,0),u>W&&(g=7)}const B=new Date(u);return B.setDate(u.getDate()+g),B},Ue=u=>u==="circuit_vip"?"VIP":u==="circuit_dropin"?"Drop-in":"Block",Oe=u=>u==="circuit_vip"?"vip":u==="circuit_dropin"?"dropin":"block";function bs(){const[u,A]=h.useState(!0),[g,B]=h.useState([]),[W,ee]=h.useState([]),[m,M]=h.useState(null),[o,J]=h.useState("upcoming"),[L,C]=h.useState(!1),[V,te]=h.useState(null),[d,pe]=h.useState(!1),[T,re]=h.useState(!1),E=h.useCallback((i,f="info")=>{te({message:i,type:f}),setTimeout(()=>te(null),4e3)},[]);h.useEffect(()=>{oe()},[]);const oe=async()=>{try{const f=(await ue(se(k,"circuitSessions"))).docs.map(F=>({id:F.id,...F.data()}));f.sort((F,R)=>R.date.localeCompare(F.date)),B(f);const b=(await ue(se(k,"clients"))).docs.map(F=>({id:F.id,...F.data()})).filter(F=>F.clientType==="circuit_vip"||F.clientType==="circuit_dropin"||F.circuitAccess===!0);ee(b);const H=Ke(Xe());let q=f.find(F=>F.date===H);if(!q){const F=b.filter(O=>O.clientType==="circuit_vip"&&O.status==="active"),R=[];for(let O=0;O<8;O++)O<F.length?R.push({slotNumber:O+1,memberId:F[O].id,memberName:F[O].name,memberType:"circuit_vip",status:"confirmed",bookedAt:je.now()}):R.push({slotNumber:O+1,memberId:null,memberName:null,memberType:null,status:"available"});const _={date:H,time:"09:00",endTime:"09:45",maxCapacity:8,slots:R,waitlist:[],createdAt:je.now()};await as(le(k,"circuitSessions",H),_),q={id:H,..._},f.unshift(q),B([...f])}q?M(q):f.length>0&&M(f[0])}catch(i){console.error("Error loading circuit data:",i),E("Failed to load circuit data","error")}A(!1)},we=async i=>{if(!(!m||L)&&window.confirm("Remove this member from the slot?")){C(!0);try{const f=[...m.slots],y=f.findIndex(_=>_.slotNumber===i);if(y===-1){C(!1);return}const b=f[y],H=b.memberType==="circuit_vip";let q=[...m.waitlist||[]];if(q.length>0){const _=q.shift();f[y]={slotNumber:i,memberId:_.memberId,memberName:_.memberName,memberType:_.memberType,status:"confirmed",bookedAt:je.now()},E(`Slot given to ${_.memberName} from waitlist`,"success")}else f[y]={slotNumber:i,memberId:null,memberName:null,memberType:null,status:"available"},E("Member removed from slot","success");const F={slots:f,waitlist:q};if(H&&b.memberId){const _=m.vipOptOuts||[];_.includes(b.memberId)||(F.vipOptOuts=[..._,b.memberId])}await ke(le(k,"circuitSessions",m.id),F);const R={...m,...F};M(R),B(_=>_.map(O=>O.id===R.id?R:O))}catch(f){console.error("Error removing from slot:",f),E("Failed to remove member","error")}C(!1)}},me=async(i,f)=>{if(!(!m||L)){C(!0);try{const y=[...m.slots],b=y.findIndex(R=>R.slotNumber===i&&R.status==="available");if(b===-1){E("Slot is not available","error"),C(!1);return}if(y.some(R=>R.memberId===f.id)){E(`${f.name} already has a slot`,"error"),C(!1);return}y[b]={slotNumber:i,memberId:f.id,memberName:f.name,memberType:f.clientType||"block",status:"confirmed",bookedAt:je.now()};const H=(m.waitlist||[]).filter(R=>R.memberId!==f.id),q={slots:y,waitlist:H};if(f.clientType==="circuit_vip"){const R=m.vipOptOuts||[];R.includes(f.id)&&(q.vipOptOuts=R.filter(_=>_!==f.id))}await ke(le(k,"circuitSessions",m.id),q);const F={...m,...q};M(F),B(R=>R.map(_=>_.id===F.id?F:_)),E(`${f.name} added to slot ${i}`,"success")}catch(y){console.error("Error adding to slot:",y),E("Failed to add member","error")}C(!1)}},ve=async i=>{if(!(!m||L)){C(!0);try{const f=(m.waitlist||[]).filter(b=>b.memberId!==i);await ke(le(k,"circuitSessions",m.id),{waitlist:f});const y={...m,waitlist:f};M(y),B(b=>b.map(H=>H.id===y.id?y:H)),E("Removed from waitlist","success")}catch(f){console.error("Error removing from waitlist:",f),E("Failed to remove from waitlist","error")}C(!1)}},c=async(i,f)=>{if(!(!m||L)){C(!0);try{const y=[...m.slots],b=y.findIndex(q=>q.slotNumber===i);if(b===-1){C(!1);return}if(y[b]={...y[b],attended:f},await ke(le(k,"circuitSessions",m.id),{slots:y}),f===!1){const q=y[b].memberId;if(q){const F=le(k,"clients",q),R=await ns(F);if(R.exists()){const O=(R.data().circuitStrikes||0)+1,be={circuitStrikes:O};if(O>=3){const ye=new Date;ye.setMonth(ye.getMonth()+1),be.circuitBanUntil=je.fromDate(ye),be.circuitStrikes=0,E(`${y[b].memberName} banned for 1 month (3 strikes)`,"error")}else E(`No-show recorded - ${y[b].memberName} (${O}/3 strikes)`,"error");await ke(F,be)}}}else E(`${y[b].memberName} marked as attended`,"success");const H={...m,slots:y};M(H),B(q=>q.map(F=>F.id===H.id?H:F))}catch(y){console.error("Error marking attendance:",y),E("Failed to update attendance","error")}C(!1)}},Z=async(i,f)=>{if(!L&&window.confirm(`Reset strikes for ${f}?`)){C(!0);try{await ke(le(k,"clients",i),{circuitStrikes:0,circuitBanUntil:null}),ee(y=>y.map(b=>b.id===i?{...b,circuitStrikes:0,circuitBanUntil:null}:b)),E(`Strikes reset for ${f}`,"success")}catch(y){console.error("Error resetting strikes:",y),E("Failed to reset strikes","error")}C(!1)}},z=async(i,f)=>{if(!L&&window.confirm(`Lift ban for ${f}?`)){C(!0);try{await ke(le(k,"clients",i),{circuitBanUntil:null,circuitStrikes:0}),ee(y=>y.map(b=>b.id===i?{...b,circuitBanUntil:null,circuitStrikes:0}:b)),E(`Ban lifted for ${f}`,"success")}catch(y){console.error("Error lifting ban:",y),E("Failed to lift ban","error")}C(!1)}};if(u)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const S=Ke(new Date),P=Ke(Xe()),v=g.filter(i=>i.date>=S),U=g.filter(i=>i.date<S),X=o==="upcoming"?v:U,De=m?m.slots.filter(i=>i.status!=="available").length:0,ae=m?m.slots.filter(i=>i.status==="available").length:0,ce=m?m.date>=S:!1,ne=m?m.slots.filter(i=>i.memberId).map(i=>i.memberId):[],Ne=m?(m.waitlist||[]).map(i=>i.memberId):[],de=W.filter(i=>!ne.includes(i.id)&&!Ne.includes(i.id)),ge=W.filter(i=>i.clientType==="circuit_vip").length,Ce=W.filter(i=>i.clientType==="circuit_dropin").length,Ae=W.filter(i=>i.circuitAccess&&i.clientType!=="circuit_vip"&&i.clientType!=="circuit_dropin").length,fe=W.filter(i=>i.circuitBanUntil?(i.circuitBanUntil.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ge}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:Ce}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:Ae}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:g.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${d?"":"active"}`,onClick:()=>pe(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${d?"active":""}`,onClick:()=>pe(!0),children:"Members"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${o==="upcoming"?"active":""}`,onClick:()=>J("upcoming"),children:["Upcoming (",v.length,")"]}),e.jsxs("button",{className:`cm-tab ${o==="past"?"active":""}`,onClick:()=>J("past"),children:["Past (",U.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:X.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",o," sessions"]})}):X.map(i=>{const f=i.slots.filter(H=>H.status!=="available").length,y=m?.id===i.id,b=i.date===P;return e.jsxs("button",{className:`cm-session-btn ${y?"selected":""} ${b?"next":""}`,onClick:()=>{M(i),re(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:Ze(i.date)}),b&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[f,"/8"]}),(i.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",i.waitlist.length," wl"]})]})]},i.id)})}),m&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:Ze(m.date)}),e.jsxs("p",{children:[m.time," - ",m.endTime," • ",De,"/8 booked • ",ae," available"]})]}),!ce&&e.jsx("button",{className:`cm-attendance-btn ${T?"active":""}`,onClick:()=>re(!T),children:T?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:m.slots.map(i=>{const f=i.status==="available";return e.jsxs("div",{className:`cm-slot ${f?"empty":"filled"} ${i.attended===!0?"attended":""} ${i.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:i.slotNumber}),f?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),ce&&e.jsx(Ds,{members:de,onSelect:y=>me(i.slotNumber,y),disabled:L})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${Oe(i.memberType)}`,children:Ue(i.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[T&&i.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>c(i.slotNumber,!0),disabled:L,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>c(i.slotNumber,!1),disabled:L,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),i.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),i.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),ce&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>we(i.slotNumber),disabled:L,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},i.slotNumber)})}),(m.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",m.waitlist.length,")"]}),m.waitlist.map((i,f)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",f+1]}),e.jsx("span",{className:"cm-wl-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${Oe(i.memberType)}`,children:Ue(i.memberType)}),ce&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>ve(i.memberId),disabled:L,children:"Remove"})]},i.memberId))]})]})]}),d&&e.jsxs("div",{className:"cm-members",children:[fe.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",fe.length,")"]}),fe.map(i=>{const f=i.circuitBanUntil?.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:i.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",f.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>z(i.id,i.name),disabled:L,children:"Lift Ban"})]},i.id)})]}),e.jsx("div",{className:"cm-members-list",children:W.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):W.map(i=>{const f=i.circuitStrikes||0,y=fe.some(b=>b.id===i.id);return e.jsxs("div",{className:`cm-member-card ${y?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:i.name}),e.jsx("span",{className:`cm-type-badge ${Oe(i.clientType)}`,children:Ue(i.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(b=>e.jsx("span",{className:`cm-strike-dot ${b<f?"active":""}`},b)),e.jsxs("span",{className:"cm-strike-text",children:[f,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[y&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>z(i.id,i.name),disabled:L,children:"Lift Ban"}),f>0&&!y&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>Z(i.id,i.name),disabled:L,children:"Reset"})]})]})]},i.id)})})]}),V&&e.jsx("div",{className:`cm-toast ${V.type}`,children:e.jsx("span",{children:V.message})})]})}function Ds({members:u,onSelect:A,disabled:g}){const[B,W]=h.useState(!1),[ee,m]=h.useState(""),M=u.filter(o=>o.name.toLowerCase().includes(ee.toLowerCase()));return u.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>W(!B),disabled:g,children:"+ Add"}),B&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{W(!1),m("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[u.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:ee,onChange:o=>m(o.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[M.map(o=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{A(o),W(!1),m("")},children:[e.jsx("span",{children:o.name}),e.jsx("span",{className:`cm-type-badge sm ${Oe(o.clientType)}`,children:Ue(o.clientType)})]},o.id)),M.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function Cs(){const[u,A]=h.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),g=n=>{A(n),localStorage.setItem("adminActiveView",n)},[B,W]=h.useState(0),[ee,m]=h.useState(!1),[M,o]=h.useState([]),[J,L]=h.useState(null),[C,V]=h.useState(null),[te,d]=h.useState(!1),[pe,T]=h.useState([]),[re,E]=h.useState(!1),[oe,we]=h.useState([]),[me,ve]=h.useState([]),[c,Z]=h.useState(null),{currentUser:z,logout:S,isAdmin:P,loading:v}=is(),{isDark:U,toggleTheme:X}=ls(),De=os(),ae=h.useRef(0),ce=h.useRef(!1);h.useRef(null);const ne=h.useCallback((n,s="info")=>{V({message:n,type:s}),setTimeout(()=>V(null),4e3)},[]);h.useEffect(()=>{!v&&(!z||!P)&&De("/")},[z,P,v,De]),h.useEffect(()=>{z&&P&&ge()},[z,P]);const Ne=async()=>{E(!0);try{const n=Re(se(k,"rescheduleRequests"),We("status","in",["approved","rejected"])),r=(await ue(n)).docs.map(p=>({id:p.id,...p.data()}));r.sort((p,D)=>{const N=p.respondedAt?.toDate?p.respondedAt.toDate():new Date(0);return(D.respondedAt?.toDate?D.respondedAt.toDate():new Date(0))-N}),T(r)}catch(n){console.error("Error fetching request history:",n)}E(!1)},de=()=>{!te&&pe.length===0&&Ne(),d(n=>!n)},ge=async()=>{try{const n=Re(se(k,"rescheduleRequests"),We("status","==","pending")),r=(await ue(n)).docs.map(p=>({id:p.id,...p.data()}));r.sort((p,D)=>{const N=p.createdAt?.toDate?p.createdAt.toDate():new Date(0);return(D.createdAt?.toDate?D.createdAt.toDate():new Date(0))-N}),o(r)}catch(n){console.error("Error fetching reschedule requests:",n)}};h.useEffect(()=>{(async()=>{if(!(!z||!P))try{const[s,r]=await Promise.all([ue(se(k,"clients")),ue(se(k,"sessions"))]),p=s.docs.map(t=>({id:t.id,...t.data()})),D=r.docs.map(t=>({id:t.id,...t.data()}));we(p);const N=new Set(p.map(t=>t.id)),a=r.docs.filter(t=>!N.has(t.data().clientId));if(a.length>0){const t=a.map(l=>Be(le(k,"sessions",l.id)));await Promise.all(t)}ve(D.filter(t=>N.has(t.clientId)))}catch(s){console.error("Error fetching dashboard data:",s)}})()},[z,P]),h.useEffect(()=>{const n=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,s=D=>{n()<=0&&(ae.current=D.touches[0].clientY,ce.current=!1)},r=D=>{const N=n(),t=D.touches[0].clientY-ae.current;if(N>5||t<=0){ce.current=!1,W(0);return}t>20&&N<=0&&(ce.current=!0,W(Math.min((t-20)*.4,80)))},p=()=>{ce.current&&B>60?(m(!0),setTimeout(()=>{window.location.reload()},300)):W(0),ce.current=!1};return document.addEventListener("touchstart",s,{passive:!0}),document.addEventListener("touchmove",r,{passive:!0}),document.addEventListener("touchend",p),()=>{document.removeEventListener("touchstart",s),document.removeEventListener("touchmove",r),document.removeEventListener("touchend",p)}},[B]);const Ce=async()=>{try{await S(),De("/")}catch(n){console.error("Failed to log out:",n)}},Ae=()=>{De("/add-client")},fe=n=>new Date(n).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),i=n=>{const[s,r]=n.split(":"),p=parseInt(s),D=p>=12?"pm":"am";return`${p>12?p-12:p===0?12:p}:${r}${D}`},f=async n=>{if(window.confirm(`Approve reschedule for ${n.clientName}?

From: ${fe(n.originalDate)} at ${i(n.originalTime)}
To: ${fe(n.requestedDate)} at ${i(n.requestedTime)}`)){L(n.id);try{const s=Re(se(k,"sessions"),We("date","==",n.requestedDate),We("time","==",n.requestedTime)),p=(await ue(s)).docs.filter(D=>D.id!==n.sessionId);if(p.length>0){const D=p[0].data().clientName;ne(`Cannot approve — ${D} is already booked at that time`,"error"),L(null);return}await ke(le(k,"sessions",n.sessionId),{date:n.requestedDate,time:n.requestedTime}),await ke(le(k,"rescheduleRequests",n.id),{status:"approved",respondedAt:je.now()}),o(M.filter(D=>D.id!==n.id)),ne(`Approved reschedule for ${n.clientName}`,"success")}catch(s){console.error("Error approving request:",s),ne("Failed to approve request","error")}L(null)}},y=async n=>{if(window.confirm(`Reject reschedule request from ${n.clientName}?`)){L(n.id);try{await ke(le(k,"rescheduleRequests",n.id),{status:"rejected",respondedAt:je.now()}),o(M.filter(s=>s.id!==n.id)),ne(`Request from ${n.clientName} rejected`,"info")}catch(s){console.error("Error rejecting request:",s),ne("Failed to reject request","error")}L(null)}};if(v)return e.jsx("div",{className:"loading",children:"Loading..."});if(!z||!P)return null;const b=M.length,H=new Date,q=`${H.getFullYear()}-${(H.getMonth()+1).toString().padStart(2,"0")}-${H.getDate().toString().padStart(2,"0")}`,F=`${H.getHours().toString().padStart(2,"0")}:${H.getMinutes().toString().padStart(2,"0")}`,_=me.filter(n=>n.date===q).length,O=n=>me.filter(s=>s.clientId!==n?!1:s.date<q||s.date===q&&s.time<F).length,be=oe.filter(n=>n.status!=="archived"&&(!n.clientType||n.clientType==="block")),ye=new Date(H);ye.setDate(ye.getDate()+7);const Te=be.filter(n=>{if(!n.endDate)return!1;const s=n.endDate.toDate?n.endDate.toDate():new Date(n.endDate);return s>=H&&s<=ye}),$e=be.filter(n=>(n.totalSessions||0)-O(n.id)<=2);return e.jsxs("div",{className:"dashboard",children:[B>0&&e.jsxs("div",{className:"pull-indicator",style:{height:B},children:[e.jsx("div",{className:`pull-spinner ${ee?"spinning":""}`,children:ee?"↻":"↓"}),e.jsx("span",{children:ee?"Refreshing...":B>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${u==="requests"?"active":""} ${b>0?"has-badge":""}`,onClick:()=>g("requests"),children:["Requests",b>0&&e.jsx("span",{className:"nav-badge",children:b})]}),e.jsx("button",{className:`nav-btn ${u==="forms"?"active":""}`,onClick:()=>g("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${u==="circuits"?"active":""}`,onClick:()=>g("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:X,"aria-label":U?"Switch to light mode":"Switch to dark mode",children:U?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"logout-btn",onClick:Ce,children:"Log Out"})]})]}),C&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${C.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[C.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),C.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),C.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:C.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[u==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:_}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>g("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${b>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:b}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:`summary-card ${c==="expiring"?"active":""}`,onClick:()=>Z(c==="expiring"?null:"expiring"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${Te.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:Te.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:`summary-card ${c==="low"?"active":""}`,onClick:()=>Z(c==="low"?null:"low"),children:[e.jsx("div",{className:`summary-icon low-icon ${$e.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:$e.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),c==="expiring"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Expiring Soon"}),e.jsx("button",{className:"card-detail-close",onClick:()=>Z(null),children:"✕"})]}),Te.length===0?e.jsx("p",{className:"card-detail-empty",children:"No clients expiring within 7 days"}):Te.map(n=>{const s=n.endDate.toDate?n.endDate.toDate():new Date(n.endDate),r=Math.ceil((s-H)/(1e3*60*60*24)),p=(n.totalSessions||0)-O(n.id);return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:n.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:"card-detail-tag warning",children:r<=1?"Ends today":`Ends in ${r} days`}),e.jsx("span",{className:`card-detail-tag ${p<=0?"urgent":"info"}`,children:p<=0?"No sessions left":`${p} session${p!==1?"s":""} left`})]})]},n.id)})]}),c==="low"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Low / No Sessions"}),e.jsx("button",{className:"card-detail-close",onClick:()=>Z(null),children:"✕"})]}),$e.length===0?e.jsx("p",{className:"card-detail-empty",children:"All clients have sessions available"}):[...$e].sort((n,s)=>{const r=(n.totalSessions||0)-O(n.id),p=(s.totalSessions||0)-O(s.id);return r-p}).map(n=>{const s=(n.totalSessions||0)-O(n.id),r=n.endDate?n.endDate.toDate?n.endDate.toDate():new Date(n.endDate):null,p=r?Math.ceil((r-H)/(1e3*60*60*24)):null;return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:n.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:`card-detail-tag ${s<=0?"urgent":"low"}`,children:s<=0?"No sessions left":`${s} session${s!==1?"s":""} left`}),p!==null&&p<=14&&e.jsxs("span",{className:"card-detail-tag warning",children:["Block ends ",p<=1?"today":`in ${p}d`]})]})]},n.id)})]}),e.jsx(gs,{})]}),u==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:Ae,children:"+ Add Client"})]}),e.jsx(ms,{})]}),u==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(ps,{})]}),u==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Reschedule Requests"}),e.jsx("button",{className:"history-toggle-btn",onClick:de,children:te?"Hide History":"View History"})]}),te&&e.jsxs("div",{className:"request-history-section",children:[e.jsx("div",{className:"history-section-header",children:"Past Requests"}),re?e.jsx("p",{className:"history-empty",children:"Loading..."}):pe.length===0?e.jsx("p",{className:"history-empty",children:"No past requests"}):pe.map(n=>e.jsxs("div",{className:"history-request-card",children:[e.jsxs("div",{className:"history-request-top",children:[e.jsx("span",{className:"history-client-name",children:n.clientName}),e.jsx("span",{className:`history-status-badge ${n.status}`,children:n.status})]}),e.jsxs("div",{className:"history-request-detail",children:[e.jsxs("span",{children:[fe(n.originalDate)," ",i(n.originalTime)]}),e.jsx("span",{className:"history-arrow",children:"→"}),e.jsxs("span",{children:[fe(n.requestedDate)," ",i(n.requestedTime)]})]}),n.respondedAt&&e.jsx("div",{className:"history-responded-at",children:n.respondedAt.toDate?n.respondedAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):""})]},n.id))]}),M.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:M.map(n=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:n.clientName}),e.jsx("span",{className:"request-time",children:n.createdAt?.toDate?n.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[fe(n.originalDate)," at ",i(n.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[fe(n.requestedDate)," at ",i(n.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>f(n),disabled:J===n.id,children:J===n.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>y(n),disabled:J===n.id,children:"Reject"})]})]},n.id))})]}),u==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(ws,{})]}),u==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(bs,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${u==="schedule"?"active":""}`,onClick:()=>g("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${u==="clients"?"active":""}`,onClick:()=>g("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${u==="calendar"?"active":""}`,onClick:()=>g("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{Cs as default};
