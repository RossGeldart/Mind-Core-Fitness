import{r as p,g as xe,q as Re,c as te,d as S,o as es,j as e,a as Ee,T as je,w as We,b as Be,e as ae,f as ss,s as Qe,h as ts,u as ke,i as as,k as ns,l as is,m as os,n as ls}from"./index-C1Ikkch6.js";import{f as oe,D as rs,g as cs,i as Ie,a as Pe,t as Le,b as qe,c as _e,S as Ye,d as ds}from"./scheduleUtils-nL0Oblug.js";function ms(){const[x,F]=p.useState([]),[v,A]=p.useState([]),[R,se]=p.useState(!0),[u,L]=p.useState(null),[c,X]=p.useState({}),[W,$]=p.useState(null),[V,ne]=p.useState(""),[d,fe]=p.useState("all"),[B,de]=p.useState(null),[I,ce]=p.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[Se,ue]=p.useState([]),[be,h]=p.useState(!1),[ee,Y]=p.useState(!1),[C,H]=p.useState("list");p.useEffect(()=>{y()},[]);const y=async()=>{try{const[s,l]=await Promise.all([xe(Re(te(S,"clients"),es("name","asc"))),xe(te(S,"sessions"))]),b=s.docs.map(t=>({id:t.id,...t.data()})),a=l.docs.map(t=>({id:t.id,...t.data()}));F(b),A(a)}catch(s){console.error("Error fetching data:",s)}se(!1)},U=s=>{if(!s.totalSessions)return 0;const l=new Date,b=l.getFullYear(),a=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0"),i=`${b}-${a}-${t}`,r=`${l.getHours().toString().padStart(2,"0")}:${l.getMinutes().toString().padStart(2,"0")}`,m=s.startDate?.toDate?s.startDate.toDate():s.startDate?new Date(s.startDate):null,f=s.endDate?.toDate?s.endDate.toDate():s.endDate?new Date(s.endDate):null,w=m?`${m.getFullYear()}-${(m.getMonth()+1).toString().padStart(2,"0")}-${m.getDate().toString().padStart(2,"0")}`:null,g=f?`${f.getFullYear()}-${(f.getMonth()+1).toString().padStart(2,"0")}-${f.getDate().toString().padStart(2,"0")}`:null;return v.filter(j=>j.clientId!==s.id||w&&j.date<w||g&&j.date>g?!1:j.date<i||j.date===i&&j.time<r).length},Q=s=>{const l=U(s);return(s.totalSessions||0)-l},Ce=s=>{const l=new Date,b=l.getFullYear(),a=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0"),i=`${b}-${a}-${t}`,r=`${l.getHours().toString().padStart(2,"0")}:${l.getMinutes().toString().padStart(2,"0")}`,m=s.startDate?.toDate?s.startDate.toDate():s.startDate?new Date(s.startDate):null,f=s.endDate?.toDate?s.endDate.toDate():s.endDate?new Date(s.endDate):null,w=m?`${m.getFullYear()}-${(m.getMonth()+1).toString().padStart(2,"0")}-${m.getDate().toString().padStart(2,"0")}`:null,g=f?`${f.getFullYear()}-${(f.getMonth()+1).toString().padStart(2,"0")}-${f.getDate().toString().padStart(2,"0")}`:null;return v.filter(j=>j.clientId!==s.id||w&&j.date<w||g&&j.date>g?!1:j.date>i||j.date===i&&j.time>=r).length},ie=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",me=async(s,l)=>{if(window.confirm(`Are you sure you want to delete ${l}? This will also delete all their booked sessions.`))try{const a=v.filter(t=>t.clientId===s).map(t=>Be(ae(S,"sessions",t.id)));await Promise.all(a),await Be(ae(S,"clients",s)),F(x.filter(t=>t.id!==s)),A(v.filter(t=>t.clientId!==s))}catch(b){console.error("Error deleting client:",b),alert("Failed to delete client")}},le=s=>{if(!s)return"";const l=s.toDate?s.toDate():new Date(s),b=l.getFullYear(),a=(l.getMonth()+1).toString().padStart(2,"0"),t=l.getDate().toString().padStart(2,"0");return`${b}-${a}-${t}`},we=s=>{L(s.id),X({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:le(s.startDate),endDate:le(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,coreBuddyPlan:s.coreBuddyPlan||"free",isJunior:!!s.isJunior})},he=s=>{const{name:l,value:b}=s.target;if(X(a=>({...a,[l]:b})),l==="startDate"||l==="weeksInBlock"){const a=l==="startDate"?b:c.startDate,t=parseInt(l==="weeksInBlock"?b:c.weeksInBlock);if(a&&t>0){const i=new Date(a),r=new Date(i);r.setDate(r.getDate()+t*7);const m=r.getFullYear(),f=(r.getMonth()+1).toString().padStart(2,"0"),w=r.getDate().toString().padStart(2,"0");X(g=>({...g,[l]:b,endDate:`${m}-${f}-${w}`}))}}},ye=async s=>{try{const l=x.find(i=>i.id===s);let b=l?.uid;if(c.password&&c.password.length>=6&&!l?.uid)try{const i=await ss(Qe,c.email.trim().toLowerCase(),c.password);await ts(Qe),b=i.user.uid}catch(i){if(console.error("Error creating auth account:",i),i.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(i.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+i.message);return}}const a=c.clientType==="block",t={name:c.name.trim(),email:c.email.trim().toLowerCase(),clientType:c.clientType,status:c.status,coreBuddyAccess:c.coreBuddyAccess,isJunior:c.isJunior};if(a)t.weeksInBlock=parseInt(c.weeksInBlock)||0,t.totalSessions=parseInt(c.totalSessions)||0,t.sessionDuration=parseInt(c.sessionDuration),t.circuitAccess=c.circuitAccess,c.startDate&&(t.startDate=je.fromDate(new Date(c.startDate))),c.endDate&&(t.endDate=je.fromDate(new Date(c.endDate)));else if(c.clientType==="core_buddy")t.coreBuddyPlan=c.coreBuddyPlan||"free",t.coreBuddyAccess=!0;else{const i=x.find(r=>r.id===s);i?.circuitStrikes===void 0&&(t.circuitStrikes=0),i?.circuitBanUntil===void 0&&(t.circuitBanUntil=null)}b&&!l?.uid&&(t.uid=b),await ke(ae(S,"clients",s),t),F(x.map(i=>i.id===s?{...i,...c,uid:b||i.uid,weeksInBlock:parseInt(c.weeksInBlock),totalSessions:parseInt(c.totalSessions),sessionDuration:parseInt(c.sessionDuration),startDate:je.fromDate(new Date(c.startDate)),endDate:je.fromDate(new Date(c.endDate))}:i)),L(null),b&&!l?.uid&&alert("Portal access created! Client can now log in.")}catch(l){console.error("Error updating client:",l),alert("Failed to update client")}},$e=async s=>{if(window.confirm(`End ${s.name}'s block? This will reset their sessions to 0/0 so you can archive them cleanly.`))try{const l=new Date,b=je.fromDate(l);await ke(ae(S,"clients",s.id),{totalSessions:0,weeksInBlock:0,endDate:b}),F(x.map(a=>a.id===s.id?{...a,totalSessions:0,weeksInBlock:0,endDate:b}:a))}catch(l){console.error("Error ending block:",l),alert("Failed to end block")}},Ae=async s=>{try{const l=x.find(b=>b.id===s)?.status==="archived"?"active":"archived";await ke(ae(S,"clients",s),{status:l}),F(x.map(b=>b.id===s?{...b,status:l}:b))}catch(l){console.error("Error archiving client:",l),alert("Failed to update client status")}},De=async s=>{de({clientId:s.id,clientName:s.name}),H("list"),ce({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),h(!0);try{const l=Re(te(S,"sessionNotes"),We("clientId","==",s.id)),a=(await xe(l)).docs.map(t=>({id:t.id,...t.data()}));a.sort((t,i)=>{const r=t.createdAt?.toMillis?.()||0;return(i.createdAt?.toMillis?.()||0)-r}),ue(a)}catch(l){console.error("Error fetching notes:",l),ue([])}h(!1)},o=()=>{de(null),ue([]),H("list")},N=async()=>{if(!B)return;const{sessionNotes:s,whatWentWell:l,whatWentWrong:b,whatsNext:a}=I;if(!(!s.trim()&&!l.trim()&&!b.trim()&&!a.trim())){Y(!0);try{const i=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await Ee(te(S,"sessionNotes"),{clientId:B.clientId,date:i,sessionNotes:s.trim(),whatWentWell:l.trim(),whatWentWrong:b.trim(),whatsNext:a.trim(),createdAt:je.now()}),ce({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const r=Re(te(S,"sessionNotes"),We("clientId","==",B.clientId)),f=(await xe(r)).docs.map(w=>({id:w.id,...w.data()}));f.sort((w,g)=>{const j=w.createdAt?.toMillis?.()||0;return(g.createdAt?.toMillis?.()||0)-j}),ue(f),H("list")}catch(t){console.error("Error saving note:",t),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}Y(!1)}},k=async s=>{if(window.confirm("Delete this session note?"))try{await Be(ae(S,"sessionNotes",s)),ue(Se.filter(l=>l.id!==s))}catch(l){console.error("Error deleting note:",l)}};if(R)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(x.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const D=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",O=()=>{const s=g=>g&&g.toDate?g.toDate().toLocaleDateString("en-GB"):"",l=d==="all"?P:n,b=d==="all"?"all-clients":d==="block"?"block-members":d==="circuit"?"circuit-members":d==="core_buddy"?"core-buddy":"archived",a=["Name","Email","Type","Status","Total Sessions","Sessions Remaining","Session Duration (min)","Weeks in Block","Start Date","End Date","Portal Access","Circuit Access","Core Buddy Access","Core Buddy Plan","Is Junior","Created At"],t=l.map(g=>[g.name||"",g.email||"",D(g),g.status||"active",g.totalSessions||"",Q(g)||"",g.sessionDuration||"",g.weeksInBlock||"",s(g.startDate),s(g.endDate),g.uid?"Yes":"No",g.circuitAccess?"Yes":"No",g.coreBuddyAccess?"Yes":"No",g.coreBuddyPlan||"",g.isJunior?"Yes":"No",s(g.createdAt)]),i=g=>{const j=String(g);return j.includes(",")||j.includes('"')||j.includes(`
`)?`"${j.replace(/"/g,'""')}"`:j},r=[a,...t].map(g=>g.map(i).join(",")).join(`
`),m=new Blob([r],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(m),w=document.createElement("a");w.href=f,w.download=`mind-core-${b}-${new Date().toISOString().slice(0,10)}.csv`,w.click(),URL.revokeObjectURL(f)},E=x.filter(s=>s.name?.toLowerCase().includes(V.toLowerCase())||s.email?.toLowerCase().includes(V.toLowerCase())).sort((s,l)=>(s.name||"").localeCompare(l.name||"")),M=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",_=s=>s.clientType==="core_buddy",z=s=>s.status==="archived",P=E.filter(s=>!z(s)),K=P.filter(s=>!M(s)&&!_(s)),ge=P.filter(s=>M(s)),pe=P.filter(s=>_(s)),Ne=E.filter(s=>z(s)),n=d==="block"?K:d==="circuit"?ge:d==="core_buddy"?pe:d==="archived"?Ne:P,T=s=>{u||$(l=>l===s?null:s)},q=s=>{const l=W===s.id,b=u===s.id,a=!s.clientType||s.clientType==="block";let t=null,i=null;if(a&&s.status!=="archived"){const r=Q(s);if(r<=2&&(t={text:r<=0?"No sessions":`${r} left`,urgent:r<=0}),s.endDate){const m=s.endDate.toDate?s.endDate.toDate():new Date(s.endDate),f=Math.ceil((m-new Date)/(1e3*60*60*24));f<=7&&(i={text:f<=0?"Expired":f===1?"Ends today":`${f}d left`,urgent:f<=1})}}return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${l||b?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>T(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:a?`${Q(s)}/${s.totalSessions||0} sessions`:D(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[t&&e.jsx("span",{className:`client-warn-badge ${t.urgent?"urgent":"warning"}`,children:t.text}),i&&e.jsx("span",{className:`client-warn-badge ${i.urgent?"urgent":"expiry"}`,children:i.text}),(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:D(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${l||b?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(l||b)&&e.jsx("div",{className:"client-expand-panel",children:b?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(r=>e.jsx("button",{type:"button",className:`edit-type-btn ${c.clientType===r.value?"active":""}`,onClick:()=>X(m=>({...m,clientType:r.value})),children:r.label},r.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:c.name,onChange:he,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:c.email,onChange:he,placeholder:"Email"})]}),c.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:c.weeksInBlock,onChange:he,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:c.totalSessions,onChange:he,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:c.sessionDuration,onChange:he,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:c.startDate,onChange:he}),e.jsx("input",{type:"date",name:"endDate",value:c.endDate,onChange:he})]})]}),c.clientType==="core_buddy"&&e.jsx("div",{className:"edit-row",children:e.jsxs("select",{name:"coreBuddyPlan",value:c.coreBuddyPlan,onChange:he,children:[e.jsx("option",{value:"free",children:"Free"}),e.jsx("option",{value:"premium",children:"Premium"})]})}),e.jsx("div",{className:"edit-row password-row",children:c.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:c.password,onChange:he,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.circuitAccess,onChange:r=>X(m=>({...m,circuitAccess:r.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),c.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.coreBuddyAccess,onChange:r=>X(m=>({...m,coreBuddyAccess:r.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.isJunior,onChange:r=>X(m=>({...m,isJunior:r.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>ye(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{L(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),a?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[Q(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[Ce(s)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:ie(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:ie(s.endDate)})]})]}):s.clientType==="core_buddy"?e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Plan"}),e.jsx("span",{className:"detail-value",children:s.coreBuddyPlan==="premium"?"Premium":"Free"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ie(s.createdAt)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ie(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[a&&e.jsxs("button",{className:"action-btn notes",onClick:r=>{r.stopPropagation(),De(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:r=>{r.stopPropagation(),we(s)},children:"Edit"}),a&&s.status!=="archived"&&e.jsx("button",{className:"action-btn end-block",onClick:r=>{r.stopPropagation(),$e(s)},children:"End Block"}),e.jsx("button",{className:"action-btn archive",onClick:r=>{r.stopPropagation(),Ae(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:r=>{r.stopPropagation(),me(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:V,onChange:s=>ne(s.target.value),className:"client-search-input"}),V&&e.jsx("button",{className:"client-search-clear",onClick:()=>ne(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"client-filter-row",children:[e.jsxs("select",{className:"client-type-select",value:d,onChange:s=>fe(s.target.value),children:[e.jsxs("option",{value:"all",children:["All Clients (",P.length,")"]}),e.jsxs("option",{value:"block",children:["Block Members (",K.length,")"]}),e.jsxs("option",{value:"circuit",children:["Circuit Members (",ge.length,")"]}),e.jsxs("option",{value:"core_buddy",children:["Core Buddy (",pe.length,")"]}),e.jsxs("option",{value:"archived",children:["Archived (",Ne.length,")"]})]}),e.jsxs("button",{className:"export-csv-btn",onClick:O,title:"Export current view to CSV",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Export CSV"]})]}),d==="all"?e.jsxs(e.Fragment,{children:[K.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:K.length})]}),K.map(q)]}),ge.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:ge.length})]}),ge.map(q)]}),pe.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:pe.length})]}),pe.map(q)]})]}):d==="archived"?e.jsx(e.Fragment,{children:Ne.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:Ne.length})]}),Ne.map(q)]})}):e.jsxs(e.Fragment,{children:[n.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",d," clients found"]}),n.map(q)]}),B&&e.jsx("div",{className:"notes-modal-overlay",onClick:o,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),B.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:o,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),C==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:be?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):Se.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:Se.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>k(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>H("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:I.sessionNotes,onChange:s=>ce(l=>({...l,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:I.whatWentWell,onChange:s=>ce(l=>({...l,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:I.whatWentWrong,onChange:s=>ce(l=>({...l,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:I.whatsNext,onChange:s=>ce(l=>({...l,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>H("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:N,disabled:ee,children:ee?"Saving...":"Save Notes"})]})]})]})})]})}const hs=["Mon","Tue","Wed","Thu","Fri"],us=x=>{const F=new Date(x),v=F.getDay(),A=F.getDate()-v+(v===0?-6:1);return F.setDate(A),qe.map((R,se)=>{const u=new Date(F);return u.setDate(F.getDate()+se),u})};function ps(){const[x,F]=p.useState(new Date),[v,A]=p.useState([]),[R,se]=p.useState([]),[u,L]=p.useState([]),[c,X]=p.useState([]),[W,$]=p.useState([]),[V,ne]=p.useState([]),[d,fe]=p.useState(null),[B,de]=p.useState(null),[I,ce]=p.useState(!1),[Se,ue]=p.useState(!0),[be,h]=p.useState(""),[ee,Y]=p.useState([]),[C,H]=p.useState(null),[y,U]=p.useState(!1);p.useEffect(()=>{A(us(x))},[x]),p.useEffect(()=>{ye()},[]);const Q=a=>{fe(a),ce(!1),de(null)},Ce=()=>{if(!d)return null;const a=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),t=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),i=v[0];if(!i)return null;const r=10080*60*1e3,m=Math.floor((i-a)/r)+1,f=d.weeksInBlock||Math.ceil((t-a)/r),w=i>=a&&i<=t;return{startDate:a,endDate:t,weekNumber:m,totalWeeks:f,isWithinBlock:w}},ie=()=>{if(d?.startDate){const a=d.startDate.toDate?d.startDate.toDate():new Date(d.startDate);F(a),de(null)}},me=()=>{if(d?.endDate){const a=d.endDate.toDate?d.endDate.toDate():new Date(d.endDate);F(a),de(null)}},le=a=>{const t=new Date,i=oe(t),r=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`,m=a.startDate?.toDate?a.startDate.toDate():a.startDate?new Date(a.startDate):null,f=a.endDate?.toDate?a.endDate.toDate():a.endDate?new Date(a.endDate):null,w=m?oe(m):null,g=f?oe(f):null;return u.filter(j=>j.clientId!==a.id||w&&j.date<w||g&&j.date>g?!1:j.date<i||j.date===i&&j.time<r).length},we=a=>{const t=le(a);return(a.totalSessions||0)-t},he=a=>{const t=new Date,i=oe(t),r=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`,m=a.startDate?.toDate?a.startDate.toDate():a.startDate?new Date(a.startDate):null,f=a.endDate?.toDate?a.endDate.toDate():a.endDate?new Date(a.endDate):null,w=m?oe(m):null,g=f?oe(f):null;return u.filter(j=>j.clientId!==a.id||w&&j.date<w||g&&j.date>g?!1:j.date>i||j.date===i&&j.time>=r).length},ye=async()=>{try{const t=(await xe(te(S,"clients"))).docs.map(J=>({id:J.id,...J.data()})).filter(J=>J.status==="active").sort((J,re)=>J.name.localeCompare(re.name));se(t);const r=(await xe(te(S,"sessions"))).docs.map(J=>({id:J.id,...J.data()}));L(r);const f=(await xe(te(S,"holidays"))).docs.map(J=>({id:J.id,...J.data()}));X(f);const g=(await xe(te(S,"blockedTimes"))).docs.map(J=>({id:J.id,...J.data()}));$(g);const G=(await xe(te(S,"openedSlots"))).docs.map(J=>({id:J.id,...J.data()}));ne(G);const ve=(await xe(te(S,"sessionNotes"))).docs.map(J=>({id:J.id,...J.data()}));Y(ve)}catch(a){console.error("Error fetching data:",a)}ue(!1)},$e=a=>ee.some(t=>t.clientId===a.clientId&&t.date===a.date),Ae=(a,t)=>{if(!d)return"Unavailable";const i=d.sessionDuration||45,r=oe(a),m=Le(t),f=m+i,w=u.find(G=>{if(G.date!==r)return!1;const Z=Le(G.time),ve=Z+(G.duration||45);return m<ve&&f>Z});if(w)return`Taken — ${w.clientName}`;const g=qe[a.getDay()-1],j=Ye[g];if(j){const G=_e(t,i),Z=j.morning&&t>=j.morning.start&&t<j.morning.end,ve=j.afternoon&&t>=j.afternoon.start&&t<j.afternoon.end;if(Z&&G>j.morning.end)return"Splits break";if(ve&&G>j.afternoon.end)return"Overruns end"}return"Unavailable"},De=a=>{const t=R.find(j=>j.id===a.clientId);if(!t||!t.startDate||!t.endDate)return[];const i=t.startDate?.toDate?t.startDate.toDate():new Date(t.startDate),r=t.endDate?.toDate?t.endDate.toDate():new Date(t.endDate),m=new Date,f=new Date(m.getFullYear(),m.getMonth(),m.getDate()),w=[],g=new Date(Math.max(i.getTime(),f.getTime()));for(;g<=r;){const j=g.getDay();if(j>=1&&j<=5){const G=oe(g);c.some(Z=>Z.date===G)||w.push(new Date(g))}g.setDate(g.getDate()+1)}return w},o=(a,t)=>t?ds(t,a.duration||45,u,c,a.id,W,V):[],N=async a=>{if(H(null),window.confirm(`Cancel ${a.clientName}'s session at ${Pe(a.time)}?`))try{await Be(ae(S,"sessions",a.id)),L(u.filter(t=>t.id!==a.id))}catch(t){console.error("Error cancelling session:",t),alert("Failed to cancel session")}},k=async(a,t,i)=>{U(!0);try{const r=oe(t);await ke(ae(S,"sessions",a.id),{date:r,time:i}),L(u.map(m=>m.id===a.id?{...m,date:r,time:i}:m)),H(null)}catch(r){console.error("Error rescheduling session:",r),alert("Failed to reschedule session")}U(!1)},D=a=>{const t=new Date(x);t.setDate(t.getDate()+a*7),F(t),de(null)},O=()=>{F(new Date),de(null)},E=a=>{const t=oe(a);return c.some(i=>i.date===t)},M=(a,t)=>{const i=oe(a);return W.some(r=>r.date===i&&r.time===t)},_=(a,t)=>{const i=oe(a);return V.some(r=>r.date===i&&r.time===t)},z=a=>{const t=qe[a.getDay()-1];return t&&Ye[t]?.defaultBlocked},P=async(a,t)=>{const i=oe(a);if(z(a)){const m=V.find(f=>f.date===i&&f.time===t);try{if(m)await Be(ae(S,"openedSlots",m.id)),ne(V.filter(f=>f.id!==m.id));else{const f=await Ee(te(S,"openedSlots"),{date:i,time:t,createdAt:je.now()});ne([...V,{id:f.id,date:i,time:t}])}}catch(f){console.error("Error toggling opened slot:",f),alert("Failed to update time slot")}return}const r=W.find(m=>m.date===i&&m.time===t);try{if(r)await Be(ae(S,"blockedTimes",r.id)),$(W.filter(m=>m.id!==r.id));else{const m=await Ee(te(S,"blockedTimes"),{date:i,time:t,createdAt:je.now()});$([...W,{id:m.id,date:i,time:t}])}}catch(m){console.error("Error toggling blocked time:",m),alert("Failed to update time slot")}},K=a=>{const t=oe(a);return u.filter(i=>i.date===t)},ge=(a,t)=>{const i=oe(a);return u.find(r=>r.date===i&&r.time===t)},pe=(a,t)=>{const i=oe(a),r=Le(t);return u.find(m=>{if(m.date!==i)return!1;const f=Le(m.time),w=f+(m.duration||45);return r>=f&&r<w})},Ne=(a,t,i)=>{const r=qe[a.getDay()-1];if(!r||E(a))return!1;const m=Ye[r],f=Math.ceil(i/15);if(m.defaultBlocked)for(let re=0;re<f;re++){const Te=_e(t,re*15);if(!_(a,Te))return!1}else for(let re=0;re<f;re++){const Te=_e(t,re*15);if(M(a,Te))return!1}const w=oe(a);if(u.find(re=>re.date===w&&re.time===t))return!1;const j=_e(t,i),G=m.morning&&j<=m.morning.end,Z=m.afternoon&&j<=m.afternoon.end,ve=m.morning&&t>=m.morning.start&&t<m.morning.end,J=m.afternoon&&t>=m.afternoon.start&&t<m.afternoon.end;if(ve&&!G||J&&!Z)return!1;for(const re of u){if(re.date!==w)continue;const Te=Le(re.time),Ve=Te+(re.duration||45),Fe=Le(t),Me=Fe+i;if(Fe<Ve&&Me>Te)return!1}return!0},n=async(a,t)=>{const i=pe(a,t);if(i){if(Ie(i))return;H({session:i,step:"action",selectedDate:null,selectedTime:null});return}if(!d){alert("Please select a client first");return}if(!Ne(a,t,d.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}const r=he(d);if(le(d)+r>=d.totalSessions){alert(`${d.name} has used all ${d.totalSessions} sessions in their package`);return}try{const f=oe(a),w={clientId:d.id,clientName:d.name,date:f,time:t,duration:d.sessionDuration||45,createdAt:je.now()},g=await Ee(te(S,"sessions"),w);L([...u,{id:g.id,...w}])}catch(f){console.error("Error booking session:",f),alert("Failed to book session")}},T=async()=>{if(!d)return;const a=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),t=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),i=u.filter(j=>j.clientId!==d.id?!1:v.some(G=>oe(G)===j.date));if(i.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const r=d.weeksInBlock||Math.ceil((t-a)/(10080*60*1e3)),m=i.map(j=>({dayOfWeek:new Date(j.date).getDay(),time:j.time}));let f=[];const w=he(d)+le(d);for(let j=0;j<r;j++){const G=new Date(a);G.setDate(G.getDate()+j*7);const Z=new Date(G),ve=Z.getDay(),J=Z.getDate()-ve+(ve===0?-6:1);Z.setDate(J);for(const re of m){const Te=new Date(Z),Ve=re.dayOfWeek===0?6:re.dayOfWeek-1;Te.setDate(Z.getDate()+Ve);const Fe=oe(Te);u.some(Me=>Me.clientId===d.id&&Me.date===Fe&&Me.time===re.time)||Te<a||Te>t||c.some(Me=>Me.date===Fe)||f.push({dateKey:Fe,time:re.time,sessionDate:Te})}}const g=w+f.length;if(g>d.totalSessions){alert(`This would create ${f.length} new sessions (${g} total), but client only has ${d.totalSessions} sessions in their package.

You can still book ${d.totalSessions-w} more sessions.`);return}if(f.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${f.length} new sessions across the block.

(${w} existing + ${f.length} new = ${g} total)

Continue?`))try{const j=[];for(const G of f){const Z={clientId:d.id,clientName:d.name,date:G.dateKey,time:G.time,duration:d.sessionDuration||45,createdAt:je.now()},ve=await Ee(te(S,"sessions"),Z);j.push({id:ve.id,...Z})}L([...u,...j]),alert(`Created ${j.length} new sessions!`)}catch(j){console.error("Error repeating weekly:",j),alert("Failed to repeat sessions")}},q=async a=>{const t=oe(a),i=c.find(r=>r.date===t);try{if(i)await Be(ae(S,"holidays",i.id)),X(c.filter(r=>r.id!==i.id));else{const r=await Ee(te(S,"holidays"),{date:t,createdAt:je.now()});X([...c,{id:r.id,date:t}])}}catch(r){console.error("Error toggling day availability:",r),alert("Failed to update day availability")}};if(Se)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const s=v[0],l=v[4],b=s&&l?`${s.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${l.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>D(-1),children:"←"}),e.jsx("button",{onClick:O,children:"Today"}),e.jsx("button",{onClick:()=>D(1),children:"→"})]}),e.jsx("h3",{children:b})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),d?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:d.name}),e.jsxs("span",{children:[d.sessionDuration||45,"min • ",we(d),"/",d.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[he(d)," booked"]})]}),e.jsx("button",{onClick:()=>fe(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>ce(!0),children:"Select Client"})]}),d&&d.startDate&&d.endDate&&(()=>{const a=Ce();return a?e.jsxs("div",{className:"block-nav",children:[e.jsx("button",{onClick:ie,children:"← Block Start"}),e.jsx("span",{className:"block-range",children:a.isWithinBlock?`Week ${a.weekNumber} of ${a.totalWeeks}`:v[0]<a.startDate?"Before block":"After block"}),e.jsx("button",{onClick:me,children:"Block End →"})]}):null})(),d&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:T,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:v.map((a,t)=>{const i=K(a),r=oe(a)===oe(new Date),m=E(a);return e.jsxs("div",{className:`day-card ${B===t?"selected":""} ${r?"today":""} ${m?"holiday":""}`,onClick:()=>de(B===t?null:t),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:hs[t]}),e.jsx("span",{className:"day-date",children:a.getDate()})]}),m?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[i.length," session",i.length!==1?"s":""]})]},t)})}),B!==null&&v[B]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[rs[B]," ",v[B].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>de(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${E(v[B])?"unavailable":"available"}`,onClick:()=>q(v[B]),children:E(v[B])?"Mark Day Available":"Mark Day Unavailable"})}),E(v[B])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[z(v[B])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),cs(qe[B]).map(({time:a,period:t},i,r)=>{const m=ge(v[B],a),f=pe(v[B],a),w=!!f,g=!m&&!!f,j=f?Ie(f):!1,G=z(v[B]),Z=G?!_(v[B],a):M(v[B],a),ve=G&&_(v[B],a),J=d&&!w&&Ne(v[B],a,d.sessionDuration||45),re=i===0||r[i-1]?.period!==t;return e.jsxs("div",{children:[re&&e.jsx("div",{className:"period-label",children:t==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${w&&j?"completed":""} ${w&&!j?"booked":""} ${g?"booked-continuation":""} ${Z&&!w?"blocked":""} ${ve&&!w?"opened":""} ${J?"available":""} ${!w&&!Z&&!J&&d?"unavailable":""}`,onClick:()=>!j&&(!Z||w)&&n(v[B],a),disabled:j||Z&&!w,children:[e.jsx("span",{className:"slot-time",children:Pe(a)}),m&&j?e.jsxs("span",{className:"slot-done",children:[m.clientName," (",m.duration,"m) ✓",$e(m)&&e.jsx("span",{className:"note-dot",title:"Has session note"})]}):m?e.jsxs("span",{className:"slot-client",children:[m.clientName," (",m.duration,"m)"]}):g&&j?e.jsxs("span",{className:"slot-done",children:[f.clientName," ↑"]}):g?e.jsxs("span",{className:"slot-client",children:[f.clientName," ↑"]}):Z?e.jsx("span",{className:"slot-blocked",children:G?"Closed":"Blocked"}):J?e.jsx("span",{className:"slot-available",children:"Available"}):d?e.jsx("span",{className:"slot-unavailable",children:Ae(v[B],a)}):ve?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${G?ve?"is-opened":"":Z?"is-blocked":""}`,onClick:()=>P(v[B],a),disabled:j||!!w,title:G?ve?"Close this slot":"Open this slot":Z?"Unblock this time":"Block this time",children:G?ve?"✓":"+":Z?"✓":"✕"})]})]},a)})]})]}),C&&e.jsx("div",{className:"modal-overlay",onClick:()=>H(null),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[C.step==="action"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:C.session.clientName}),e.jsx("button",{className:"close-btn",onClick:()=>H(null),children:"×"})]}),e.jsxs("div",{className:"edit-session-info",children:[e.jsx("p",{className:"edit-session-date",children:new Date(C.session.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short",timeZone:"UTC"})}),e.jsxs("p",{className:"edit-session-time",children:[Pe(C.session.time)," · ",C.session.duration,"min"]})]}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"reschedule-edit-btn",onClick:()=>H({...C,step:"date"}),children:"Reschedule"}),e.jsx("button",{className:"cancel-session-btn",onClick:()=>N(C.session),children:"Cancel Session"})]})]}),C.step==="date"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>H({...C,step:"action"}),children:"←"}),e.jsx("h3",{children:"Pick New Date"}),e.jsx("button",{className:"close-btn",onClick:()=>H(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const a=De(C.session);return a.length===0?e.jsx("p",{className:"no-items",children:"No available dates in block"}):a.map(t=>{const i=oe(t);return e.jsx("button",{className:"client-option date-option",onClick:()=>H({...C,step:"time",selectedDate:t,selectedTime:null}),children:t.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"})},i)})})()})]}),C.step==="time"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>H({...C,step:"date",selectedTime:null}),children:"←"}),e.jsx("h3",{children:C.selectedDate?.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("button",{className:"close-btn",onClick:()=>H(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const a=o(C.session,C.selectedDate);return a.length===0?e.jsx("p",{className:"no-items",children:"No available slots on this day"}):a.map(t=>e.jsxs("button",{className:`client-option time-option ${C.selectedTime===t.time?"selected":""}`,onClick:()=>H({...C,selectedTime:t.time}),children:[Pe(t.time),e.jsx("span",{className:"time-option-period",children:t.period})]},t.time))})()}),C.selectedTime&&e.jsx("div",{className:"edit-confirm-bar",children:e.jsx("button",{className:"confirm-reschedule-btn",onClick:()=>k(C.session,C.selectedDate,C.selectedTime),disabled:y,children:y?"Saving...":`Confirm — ${Pe(C.selectedTime)}`})})]})]})}),I&&e.jsx("div",{className:"modal-overlay",onClick:()=>{ce(!1),h("")},children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>{ce(!1),h("")},children:"×"})]}),e.jsx("div",{className:"client-search-wrapper",children:e.jsx("input",{className:"client-search-input",type:"text",placeholder:"Search by name...",value:be,onChange:a=>h(a.target.value),autoFocus:!0})}),e.jsx("div",{className:"client-list-picker",children:R.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):(()=>{const a={block:"Block",core_buddy:"Core Buddy",circuit_vip:"Circuit VIP",circuit_dropin:"Circuit Drop-in"},t=R.filter(i=>i.name.toLowerCase().includes(be.toLowerCase()));return t.length===0?e.jsxs("p",{className:"no-items",children:['No clients match "',be,'"']}):t.map(i=>{const r=i.startDate&&i.endDate,m=r?i.startDate?.toDate?i.startDate.toDate():new Date(i.startDate):null,f=r?i.endDate?.toDate?i.endDate.toDate():new Date(i.endDate):null,w=we(i),g=he(i);return e.jsxs("button",{className:"client-option",onClick:()=>{Q(i),h("")},children:[e.jsxs("div",{className:"client-option-header",children:[e.jsx("strong",{children:i.name}),i.clientType&&e.jsx("span",{className:"client-type-badge",children:a[i.clientType]||i.clientType})]}),e.jsxs("span",{children:[i.sessionDuration||45,"min • ",w,"/",i.totalSessions," remaining • ",g," booked"]}),m&&f&&e.jsxs("span",{className:"client-dates",children:[m.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," – ",f.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},i.id)})})()})]})})]})}const ze=x=>{const[F,v]=x.split(":"),A=parseInt(F),R=A>=12?"pm":"am";return`${A>12?A-12:A===0?12:A}:${v}${R}`},He=x=>{const F=x.getFullYear(),v=(x.getMonth()+1).toString().padStart(2,"0"),A=x.getDate().toString().padStart(2,"0");return`${F}-${v}-${A}`},Je=x=>x===He(new Date),xs=x=>{const F=new Date;return F.setDate(F.getDate()+1),x===He(F)},Ke=x=>Je(x)?"Today":xs(x)?"Tomorrow":new Date(x).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),js=x=>{if(x.length===0)return[];const F=new Date,v=new Date(F),A=v.getDay();v.setDate(v.getDate()-(A===0?6:A-1)),v.setHours(0,0,0,0);const R=new Date(v);R.setDate(R.getDate()+7);const se=new Date(R);se.setDate(se.getDate()+7);const u=new Map;return x.forEach(L=>{const[c,X,W]=L.split("-").map(Number),$=new Date(c,X-1,W);let V,ne,d;$<R?(V="this-week",ne="This Week",d=0):$<se?(V="next-week",ne="Next Week",d=1):(V=`${$.getFullYear()}-${$.getMonth()}`,ne=$.toLocaleDateString("en-GB",{month:"long",year:"numeric"}),d=100+$.getFullYear()*12+$.getMonth()),u.has(V)||u.set(V,{key:V,label:ne,order:d,dates:[]}),u.get(V).dates.push(L)}),Array.from(u.values()).sort((L,c)=>L.order-c.order)};function fs(){const[x,F]=p.useState([]),[v,A]=p.useState(!0),[R,se]=p.useState(new Date),[u,L]=p.useState(""),[c,X]=p.useState(""),[W,$]=p.useState(!1),[V,ne]=p.useState(new Set);p.useEffect(()=>{d();const y=setInterval(()=>se(new Date),6e4);return()=>clearInterval(y)},[]);const d=async()=>{try{const U=(await xe(te(S,"sessions"))).docs.map(ie=>({id:ie.id,...ie.data()})),Q=He(new Date),Ce=U.filter(ie=>ie.date>=Q).sort((ie,me)=>ie.date!==me.date?ie.date.localeCompare(me.date):ie.time.localeCompare(me.time));F(Ce)}catch(y){console.error("Error fetching sessions:",y)}A(!1)},fe=async y=>{if(window.confirm(`Cancel ${y.clientName}'s session at ${ze(y.time)} on ${Ke(y.date)}?`))try{await Be(ae(S,"sessions",y.id)),F(x.filter(U=>U.id!==y.id))}catch(U){console.error("Error cancelling session:",U),alert("Failed to cancel session")}},B=y=>{ne(U=>{const Q=new Set(U);return Q.has(y)?Q.delete(y):Q.add(y),Q})};if(v)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const de=c?x.filter(y=>y.clientName.toLowerCase().includes(c.toLowerCase())):x,I=de.reduce((y,U)=>(y[U.date]||(y[U.date]=[]),y[U.date].push(U),y),{}),ce=Object.keys(I).sort(),Se=He(new Date),ue=I[Se]||[],be=ue.filter(y=>Ie(y)).length,h=ue.length-be,ee=de.find(y=>!Ie(y)),C=(()=>{if(!ee||ee.date!==He(new Date))return null;const[y,U]=ee.time.split(":").map(Number),Q=y*60+U-(new Date().getHours()*60+new Date().getMinutes());return Q<=0||Q>180?null:Q<60?`${Q}m`:`${Math.floor(Q/60)}h ${Q%60}m`})(),H=js(ce);return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:ue.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[be," completed"]}),e.jsxs("span",{className:"remaining-count",children:[h," remaining"]})]})}),be>0&&e.jsx("button",{className:"hide-completed-btn",onClick:()=>$(y=>!y),children:W?"Show all":"Hide done"})]}),ee&&C&&e.jsxs("div",{className:"next-session-banner",children:[e.jsx("div",{className:"next-session-label",children:"Up next"}),e.jsxs("div",{className:"next-session-info",children:[e.jsx("span",{className:"next-session-name",children:ee.clientName}),e.jsx("span",{className:"next-session-time",children:ze(ee.time)})]}),e.jsx("div",{className:"next-session-countdown",children:C})]}),ce.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:c?`No sessions found for "${c}"`:"No upcoming sessions booked"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"schedule-controls",children:[e.jsx("input",{className:"client-filter-input",type:"text",placeholder:"Filter by client...",value:c,onChange:y=>X(y.target.value)}),e.jsxs("select",{className:"date-jump-select",value:u,onChange:y=>{const U=y.target.value;L(U),U&&(document.getElementById(`date-${U}`)?.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>L(""),600))},children:[e.jsx("option",{value:"",children:"Jump to date..."}),ce.map(y=>e.jsxs("option",{value:y,children:[Ke(y)," (",I[y].length,")"]},y))]})]}),e.jsx("div",{className:"sessions-list",children:H.map(({key:y,label:U,dates:Q})=>{const ie=y!=="this-week"&&y!=="next-week"?!V.has(y):V.has(y),me=Q.reduce((le,we)=>le+I[we].length,0);return e.jsxs("div",{className:"week-group",children:[e.jsxs("button",{className:`week-group-header ${ie?"collapsed":""}`,onClick:()=>B(y),children:[e.jsx("span",{className:"week-label",children:U}),e.jsxs("span",{className:"week-count",children:[me," session",me!==1?"s":""]}),e.jsx("span",{className:"week-chevron",children:ie?"▸":"▾"})]}),!ie&&e.jsx("div",{className:"week-group-body",children:Q.map(le=>{const we=I[le],he=W&&Je(le)?we.filter(ye=>!Ie(ye)):we;return e.jsxs("div",{id:`date-${le}`,className:`date-group ${Je(le)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ke(le)}),e.jsxs("span",{className:"date-count",children:[we.length," session",we.length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:he.length===0?e.jsx("div",{className:"all-done-msg",children:"All sessions completed ✓"}):he.map(ye=>{const $e=Ie(ye);return e.jsxs("div",{className:`session-card ${$e?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:ze(ye.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:ye.clientName}),e.jsxs("span",{children:[ye.duration,"min session"]})]}),$e?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>fe(ye),children:"Cancel"})]},ye.id)})})]},le)})})]},y)})})]})]})}const gs={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},vs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},Ns={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},ys=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function bs(){const[x,F]=p.useState([]),[v,A]=p.useState(!0),[R,se]=p.useState(null),[u,L]=p.useState(null),[c,X]=p.useState("all"),[W,$]=p.useState("");p.useEffect(()=>{V()},[]);const V=async()=>{try{const ee=(await xe(te(S,"clients"))).docs.map(Y=>({id:Y.id,...Y.data()}));ee.sort((Y,C)=>(Y.name||"").localeCompare(C.name||"")),F(ee)}catch(h){console.error("Error fetching clients:",h)}A(!1)},ne=h=>!!h.welcomeForm?.completedAt,d=h=>!!h.parqForm?.completedAt,fe=h=>ne(h)||d(h),B=h=>ne(h)&&d(h),de=h=>h?(h.toDate?h.toDate():new Date(h)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",I=x.filter(h=>!W||h.name?.toLowerCase().includes(W.toLowerCase())?c==="all"?!0:c==="completed"?B(h):c==="partial"?fe(h)&&!B(h):c==="pending"?!fe(h):!0:!1),ce=x.filter(B).length,Se=x.filter(h=>fe(h)&&!B(h)).length,ue=x.filter(h=>!fe(h)).length,be=h=>{R===h?(se(null),L(null)):(se(h),L(null))};return v?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:ce}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:Se}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:ue}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:W,onChange:h=>$(h.target.value)}),W&&e.jsx("button",{className:"forms-search-clear",onClick:()=>$(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${c==="all"?"active":""}`,onClick:()=>X("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:x.length})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="completed"?"active":""}`,onClick:()=>X("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:ce})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="partial"?"active":""}`,onClick:()=>X("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:Se})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="pending"?"active":""}`,onClick:()=>X("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:ue})]})]}),I.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:I.map(h=>{const ee=R===h.id,Y=ne(h),C=d(h);return e.jsxs("div",{className:`forms-client-card ${ee?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>be(h.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(h.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:h.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${Y?"done":"not-done"}`,children:[Y?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${C?"done":"not-done"}`,children:[C?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${ee?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),ee&&e.jsx("div",{className:"forms-expand-panel",children:!Y&&!C?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[Y&&e.jsx("button",{className:`forms-toggle-btn ${u==="welcome"||!u&&Y?"active":""}`,onClick:()=>L("welcome"),children:"Welcome Questionnaire"}),C&&e.jsx("button",{className:`forms-toggle-btn ${u==="parq"||!u&&!Y&&C?"active":""}`,onClick:()=>L("parq"),children:"PAR-Q Health Screening"})]}),(u==="welcome"||!u&&Y)&&Y&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",de(h.welcomeForm.completedAt)]})]}),h.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:h.welcomeForm.fitnessGoals})]}),h.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:gs[h.welcomeForm.currentActivityLevel]||h.welcomeForm.currentActivityLevel})]}),h.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:h.welcomeForm.exerciseHistory})]}),h.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:h.welcomeForm.injuries})]}),h.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:h.welcomeForm.medicalConditions})]}),h.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:vs[h.welcomeForm.sleepHours]||h.welcomeForm.sleepHours})]}),h.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:Ns[h.welcomeForm.stressLevel]||h.welcomeForm.stressLevel})]}),h.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:h.welcomeForm.dietaryInfo})]}),h.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:h.welcomeForm.availability})]}),h.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:h.welcomeForm.additionalInfo})]})]}),u==="parq"&&C&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",de(h.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:ys.map(H=>{const y=h.parqForm[H.key];return e.jsxs("div",{className:`parq-result-item ${y?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${y?"yes":"no"}`,children:y?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:H.text})]},H.key)})}),h.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:h.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:h.parqForm.declaration?"declared":"not-declared",children:h.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},h.id)})})]})}const Ge=x=>`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`,Ze=x=>new Date(x+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),Xe=()=>{const x=new Date;let v=(6-x.getDay()+7)%7;if(v===0){const R=new Date(x);R.setHours(9,45,0,0),x>R&&(v=7)}const A=new Date(x);return A.setDate(x.getDate()+v),A},Oe=x=>x==="circuit_vip"?"VIP":x==="circuit_dropin"?"Drop-in":"Block",Ue=x=>x==="circuit_vip"?"vip":x==="circuit_dropin"?"dropin":"block";function ws(){const[x,F]=p.useState(!0),[v,A]=p.useState([]),[R,se]=p.useState([]),[u,L]=p.useState(null),[c,X]=p.useState("upcoming"),[W,$]=p.useState(!1),[V,ne]=p.useState(null),[d,fe]=p.useState(!1),[B,de]=p.useState(!1),I=p.useCallback((o,N="info")=>{ne({message:o,type:N}),setTimeout(()=>ne(null),4e3)},[]);p.useEffect(()=>{ce()},[]);const ce=async()=>{try{const N=(await xe(te(S,"circuitSessions"))).docs.map(M=>({id:M.id,...M.data()}));N.sort((M,_)=>_.date.localeCompare(M.date)),A(N);const D=(await xe(te(S,"clients"))).docs.map(M=>({id:M.id,...M.data()})).filter(M=>M.clientType==="circuit_vip"||M.clientType==="circuit_dropin"||M.circuitAccess===!0);se(D);const O=Ge(Xe());let E=N.find(M=>M.date===O);if(E){const M=E.slots.filter(K=>K.memberId).map(K=>K.memberId),_=E.vipOptOuts||[],P=D.filter(K=>K.clientType==="circuit_vip"&&K.status==="active").filter(K=>!M.includes(K.id)&&!_.includes(K.id));if(P.length>0){const K=[...E.slots];let ge=!1;for(const pe of P){const Ne=K.findIndex(n=>n.status==="available");if(Ne===-1)break;K[Ne]={slotNumber:K[Ne].slotNumber,memberId:pe.id,memberName:pe.name,memberType:"circuit_vip",status:"confirmed",bookedAt:je.now()},ge=!0}ge&&(await ke(ae(S,"circuitSessions",O),{slots:K}),E={...E,slots:K},A(N.map(pe=>pe.id===O?E:pe)))}}else{const M=D.filter(P=>P.clientType==="circuit_vip"&&P.status==="active"),_=[];for(let P=0;P<8;P++)P<M.length?_.push({slotNumber:P+1,memberId:M[P].id,memberName:M[P].name,memberType:"circuit_vip",status:"confirmed",bookedAt:je.now()}):_.push({slotNumber:P+1,memberId:null,memberName:null,memberType:null,status:"available"});const z={date:O,time:"09:00",endTime:"09:45",maxCapacity:8,slots:_,waitlist:[],createdAt:je.now()};await as(ae(S,"circuitSessions",O),z),E={id:O,...z},N.unshift(E),A([...N])}E?L(E):N.length>0&&L(N[0])}catch(o){console.error("Error loading circuit data:",o),I("Failed to load circuit data","error")}F(!1)},Se=async o=>{if(!(!u||W)&&window.confirm("Remove this member from the slot?")){$(!0);try{const N=[...u.slots],k=N.findIndex(z=>z.slotNumber===o);if(k===-1){$(!1);return}const D=N[k],O=D.memberType==="circuit_vip";let E=[...u.waitlist||[]];if(E.length>0){const z=E.shift();N[k]={slotNumber:o,memberId:z.memberId,memberName:z.memberName,memberType:z.memberType,status:"confirmed",bookedAt:je.now()},I(`Slot given to ${z.memberName} from waitlist`,"success")}else N[k]={slotNumber:o,memberId:null,memberName:null,memberType:null,status:"available"},I("Member removed from slot","success");const M={slots:N,waitlist:E};if(O&&D.memberId){const z=u.vipOptOuts||[];z.includes(D.memberId)||(M.vipOptOuts=[...z,D.memberId])}await ke(ae(S,"circuitSessions",u.id),M);const _={...u,...M};L(_),A(z=>z.map(P=>P.id===_.id?_:P))}catch(N){console.error("Error removing from slot:",N),I("Failed to remove member","error")}$(!1)}},ue=async(o,N)=>{if(!(!u||W)){$(!0);try{const k=[...u.slots],D=k.findIndex(_=>_.slotNumber===o&&_.status==="available");if(D===-1){I("Slot is not available","error"),$(!1);return}if(k.some(_=>_.memberId===N.id)){I(`${N.name} already has a slot`,"error"),$(!1);return}k[D]={slotNumber:o,memberId:N.id,memberName:N.name,memberType:N.clientType||"block",status:"confirmed",bookedAt:je.now()};const O=(u.waitlist||[]).filter(_=>_.memberId!==N.id),E={slots:k,waitlist:O};if(N.clientType==="circuit_vip"){const _=u.vipOptOuts||[];_.includes(N.id)&&(E.vipOptOuts=_.filter(z=>z!==N.id))}await ke(ae(S,"circuitSessions",u.id),E);const M={...u,...E};L(M),A(_=>_.map(z=>z.id===M.id?M:z)),I(`${N.name} added to slot ${o}`,"success")}catch(k){console.error("Error adding to slot:",k),I("Failed to add member","error")}$(!1)}},be=async o=>{if(!(!u||W)){$(!0);try{const N=(u.waitlist||[]).filter(D=>D.memberId!==o);await ke(ae(S,"circuitSessions",u.id),{waitlist:N});const k={...u,waitlist:N};L(k),A(D=>D.map(O=>O.id===k.id?k:O)),I("Removed from waitlist","success")}catch(N){console.error("Error removing from waitlist:",N),I("Failed to remove from waitlist","error")}$(!1)}},h=async(o,N)=>{if(!(!u||W)){$(!0);try{const k=[...u.slots],D=k.findIndex(E=>E.slotNumber===o);if(D===-1){$(!1);return}if(k[D]={...k[D],attended:N},await ke(ae(S,"circuitSessions",u.id),{slots:k}),N===!1){const E=k[D].memberId;if(E){const M=ae(S,"clients",E),_=await ns(M);if(_.exists()){const P=(_.data().circuitStrikes||0)+1,K={circuitStrikes:P};if(P>=3){const ge=new Date;ge.setMonth(ge.getMonth()+1),K.circuitBanUntil=je.fromDate(ge),K.circuitStrikes=0,I(`${k[D].memberName} banned for 1 month (3 strikes)`,"error")}else I(`No-show recorded - ${k[D].memberName} (${P}/3 strikes)`,"error");await ke(M,K)}}}else I(`${k[D].memberName} marked as attended`,"success");const O={...u,slots:k};L(O),A(E=>E.map(M=>M.id===O.id?O:M))}catch(k){console.error("Error marking attendance:",k),I("Failed to update attendance","error")}$(!1)}},ee=async(o,N)=>{if(!W&&window.confirm(`Reset strikes for ${N}?`)){$(!0);try{await ke(ae(S,"clients",o),{circuitStrikes:0,circuitBanUntil:null}),se(k=>k.map(D=>D.id===o?{...D,circuitStrikes:0,circuitBanUntil:null}:D)),I(`Strikes reset for ${N}`,"success")}catch(k){console.error("Error resetting strikes:",k),I("Failed to reset strikes","error")}$(!1)}},Y=async(o,N)=>{if(!W&&window.confirm(`Lift ban for ${N}?`)){$(!0);try{await ke(ae(S,"clients",o),{circuitBanUntil:null,circuitStrikes:0}),se(k=>k.map(D=>D.id===o?{...D,circuitBanUntil:null,circuitStrikes:0}:D)),I(`Ban lifted for ${N}`,"success")}catch(k){console.error("Error lifting ban:",k),I("Failed to lift ban","error")}$(!1)}};if(x)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const C=Ge(new Date),H=Ge(Xe()),y=v.filter(o=>o.date>=C),U=v.filter(o=>o.date<C),Q=c==="upcoming"?y:U,Ce=u?u.slots.filter(o=>o.status!=="available").length:0,ie=u?u.slots.filter(o=>o.status==="available").length:0,me=u?u.date>=C:!1,le=u?u.slots.filter(o=>o.memberId).map(o=>o.memberId):[],we=u?(u.waitlist||[]).map(o=>o.memberId):[],he=R.filter(o=>!le.includes(o.id)&&!we.includes(o.id)),ye=R.filter(o=>o.clientType==="circuit_vip").length,$e=R.filter(o=>o.clientType==="circuit_dropin").length,Ae=R.filter(o=>o.circuitAccess&&o.clientType!=="circuit_vip"&&o.clientType!=="circuit_dropin").length,De=R.filter(o=>o.circuitBanUntil?(o.circuitBanUntil.toDate?o.circuitBanUntil.toDate():new Date(o.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ye}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:$e}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:Ae}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:v.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${d?"":"active"}`,onClick:()=>fe(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${d?"active":""}`,onClick:()=>fe(!0),children:"Members"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${c==="upcoming"?"active":""}`,onClick:()=>X("upcoming"),children:["Upcoming (",y.length,")"]}),e.jsxs("button",{className:`cm-tab ${c==="past"?"active":""}`,onClick:()=>X("past"),children:["Past (",U.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:Q.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",c," sessions"]})}):Q.map(o=>{const N=o.slots.filter(O=>O.status!=="available").length,k=u?.id===o.id,D=o.date===H;return e.jsxs("button",{className:`cm-session-btn ${k?"selected":""} ${D?"next":""}`,onClick:()=>{L(o),de(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:Ze(o.date)}),D&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[N,"/8"]}),(o.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",o.waitlist.length," wl"]})]})]},o.id)})}),u&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:Ze(u.date)}),e.jsxs("p",{children:[u.time," - ",u.endTime," • ",Ce,"/8 booked • ",ie," available"]})]}),!me&&e.jsx("button",{className:`cm-attendance-btn ${B?"active":""}`,onClick:()=>de(!B),children:B?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:u.slots.map(o=>{const N=o.status==="available";return e.jsxs("div",{className:`cm-slot ${N?"empty":"filled"} ${o.attended===!0?"attended":""} ${o.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:o.slotNumber}),N?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),me&&e.jsx(Ds,{members:he,onSelect:k=>ue(o.slotNumber,k),disabled:W})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:o.memberName}),e.jsx("span",{className:`cm-type-badge ${Ue(o.memberType)}`,children:Oe(o.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[B&&o.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>h(o.slotNumber,!0),disabled:W,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>h(o.slotNumber,!1),disabled:W,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),o.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),o.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),me&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>Se(o.slotNumber),disabled:W,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},o.slotNumber)})}),(u.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",u.waitlist.length,")"]}),u.waitlist.map((o,N)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",N+1]}),e.jsx("span",{className:"cm-wl-name",children:o.memberName}),e.jsx("span",{className:`cm-type-badge ${Ue(o.memberType)}`,children:Oe(o.memberType)}),me&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>be(o.memberId),disabled:W,children:"Remove"})]},o.memberId))]})]})]}),d&&e.jsxs("div",{className:"cm-members",children:[De.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",De.length,")"]}),De.map(o=>{const N=o.circuitBanUntil?.toDate?o.circuitBanUntil.toDate():new Date(o.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:o.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",N.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>Y(o.id,o.name),disabled:W,children:"Lift Ban"})]},o.id)})]}),e.jsx("div",{className:"cm-members-list",children:R.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):R.map(o=>{const N=o.circuitStrikes||0,k=De.some(D=>D.id===o.id);return e.jsxs("div",{className:`cm-member-card ${k?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:o.name}),e.jsx("span",{className:`cm-type-badge ${Ue(o.clientType)}`,children:Oe(o.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(D=>e.jsx("span",{className:`cm-strike-dot ${D<N?"active":""}`},D)),e.jsxs("span",{className:"cm-strike-text",children:[N,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[k&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>Y(o.id,o.name),disabled:W,children:"Lift Ban"}),N>0&&!k&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>ee(o.id,o.name),disabled:W,children:"Reset"})]})]})]},o.id)})})]}),V&&e.jsx("div",{className:`cm-toast ${V.type}`,children:e.jsx("span",{children:V.message})})]})}function Ds({members:x,onSelect:F,disabled:v}){const[A,R]=p.useState(!1),[se,u]=p.useState(""),L=x.filter(c=>c.name.toLowerCase().includes(se.toLowerCase()));return x.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>R(!A),disabled:v,children:"+ Add"}),A&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{R(!1),u("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[x.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:se,onChange:c=>u(c.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[L.map(c=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{F(c),R(!1),u("")},children:[e.jsx("span",{children:c.name}),e.jsx("span",{className:`cm-type-badge sm ${Ue(c.clientType)}`,children:Oe(c.clientType)})]},c.id)),L.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function Cs(){const[x,F]=p.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),v=n=>{F(n),localStorage.setItem("adminActiveView",n)},[A,R]=p.useState(0),[se,u]=p.useState(!1),[L,c]=p.useState([]),[X,W]=p.useState(null),[$,V]=p.useState(null),[ne,d]=p.useState(!1),[fe,B]=p.useState([]),[de,I]=p.useState(!1),[ce,Se]=p.useState([]),[ue,be]=p.useState([]),[h,ee]=p.useState(null),{currentUser:Y,logout:C,isAdmin:H,loading:y}=is(),{isDark:U,toggleTheme:Q}=os(),Ce=ls(),ie=p.useRef(0),me=p.useRef(!1);p.useRef(null);const le=p.useCallback((n,T="info")=>{V({message:n,type:T}),setTimeout(()=>V(null),4e3)},[]);p.useEffect(()=>{!y&&(!Y||!H)&&Ce("/")},[Y,H,y,Ce]),p.useEffect(()=>{Y&&H&&ye()},[Y,H]);const we=async()=>{I(!0);try{const n=Re(te(S,"rescheduleRequests"),We("status","in",["approved","rejected"])),q=(await xe(n)).docs.map(s=>({id:s.id,...s.data()}));q.sort((s,l)=>{const b=s.respondedAt?.toDate?s.respondedAt.toDate():new Date(0);return(l.respondedAt?.toDate?l.respondedAt.toDate():new Date(0))-b}),B(q)}catch(n){console.error("Error fetching request history:",n)}I(!1)},he=()=>{!ne&&fe.length===0&&we(),d(n=>!n)},ye=async()=>{try{const n=Re(te(S,"rescheduleRequests"),We("status","==","pending")),q=(await xe(n)).docs.map(s=>({id:s.id,...s.data()}));q.sort((s,l)=>{const b=s.createdAt?.toDate?s.createdAt.toDate():new Date(0);return(l.createdAt?.toDate?l.createdAt.toDate():new Date(0))-b}),c(q)}catch(n){console.error("Error fetching reschedule requests:",n)}};p.useEffect(()=>{(async()=>{if(!(!Y||!H))try{const[T,q]=await Promise.all([xe(te(S,"clients")),xe(te(S,"sessions"))]),s=T.docs.map(t=>({id:t.id,...t.data()})),l=q.docs.map(t=>({id:t.id,...t.data()}));Se(s);const b=new Set(s.map(t=>t.id)),a=q.docs.filter(t=>!b.has(t.data().clientId));if(a.length>0){const t=a.map(i=>Be(ae(S,"sessions",i.id)));await Promise.all(t)}be(l.filter(t=>b.has(t.clientId)))}catch(T){console.error("Error fetching dashboard data:",T)}})()},[Y,H]),p.useEffect(()=>{const n=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,T=l=>{n()<=0&&(ie.current=l.touches[0].clientY,me.current=!1)},q=l=>{const b=n(),t=l.touches[0].clientY-ie.current;if(b>5||t<=0){me.current=!1,R(0);return}t>20&&b<=0&&(me.current=!0,R(Math.min((t-20)*.4,80)))},s=()=>{me.current&&A>60?(u(!0),setTimeout(()=>{window.location.reload()},300)):R(0),me.current=!1};return document.addEventListener("touchstart",T,{passive:!0}),document.addEventListener("touchmove",q,{passive:!0}),document.addEventListener("touchend",s),()=>{document.removeEventListener("touchstart",T),document.removeEventListener("touchmove",q),document.removeEventListener("touchend",s)}},[A]);const $e=async()=>{try{await C(),Ce("/")}catch(n){console.error("Failed to log out:",n)}},Ae=()=>{Ce("/add-client")},De=n=>new Date(n).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),o=n=>{const[T,q]=n.split(":"),s=parseInt(T),l=s>=12?"pm":"am";return`${s>12?s-12:s===0?12:s}:${q}${l}`},N=async n=>{if(window.confirm(`Approve reschedule for ${n.clientName}?

From: ${De(n.originalDate)} at ${o(n.originalTime)}
To: ${De(n.requestedDate)} at ${o(n.requestedTime)}`)){W(n.id);try{const T=Re(te(S,"sessions"),We("date","==",n.requestedDate),We("time","==",n.requestedTime)),s=(await xe(T)).docs.filter(l=>l.id!==n.sessionId);if(s.length>0){const l=s[0].data().clientName;le(`Cannot approve — ${l} is already booked at that time`,"error"),W(null);return}await ke(ae(S,"sessions",n.sessionId),{date:n.requestedDate,time:n.requestedTime}),await ke(ae(S,"rescheduleRequests",n.id),{status:"approved",respondedAt:je.now()}),c(L.filter(l=>l.id!==n.id)),le(`Approved reschedule for ${n.clientName}`,"success")}catch(T){console.error("Error approving request:",T),le("Failed to approve request","error")}W(null)}},k=async n=>{if(window.confirm(`Reject reschedule request from ${n.clientName}?`)){W(n.id);try{await ke(ae(S,"rescheduleRequests",n.id),{status:"rejected",respondedAt:je.now()}),c(L.filter(T=>T.id!==n.id)),le(`Request from ${n.clientName} rejected`,"info")}catch(T){console.error("Error rejecting request:",T),le("Failed to reject request","error")}W(null)}};if(y)return e.jsx("div",{className:"loading",children:"Loading..."});if(!Y||!H)return null;const D=L.length,O=new Date,E=`${O.getFullYear()}-${(O.getMonth()+1).toString().padStart(2,"0")}-${O.getDate().toString().padStart(2,"0")}`,M=`${O.getHours().toString().padStart(2,"0")}:${O.getMinutes().toString().padStart(2,"0")}`,z=ue.filter(n=>n.date===E).length,P=n=>{const T=n.startDate?.toDate?n.startDate.toDate():n.startDate?new Date(n.startDate):null,q=n.endDate?.toDate?n.endDate.toDate():n.endDate?new Date(n.endDate):null,s=T?`${T.getFullYear()}-${(T.getMonth()+1).toString().padStart(2,"0")}-${T.getDate().toString().padStart(2,"0")}`:null,l=q?`${q.getFullYear()}-${(q.getMonth()+1).toString().padStart(2,"0")}-${q.getDate().toString().padStart(2,"0")}`:null;return ue.filter(b=>b.clientId!==n.id||s&&b.date<s||l&&b.date>l?!1:b.date<E||b.date===E&&b.time<M).length},K=ce.filter(n=>n.status!=="archived"&&(!n.clientType||n.clientType==="block")),ge=new Date(O);ge.setDate(ge.getDate()+7);const pe=K.filter(n=>{if(!n.endDate)return!1;const T=n.endDate.toDate?n.endDate.toDate():new Date(n.endDate);return T>=O&&T<=ge}),Ne=K.filter(n=>(n.totalSessions||0)-P(n)<=2);return e.jsxs("div",{className:"dashboard",children:[A>0&&e.jsxs("div",{className:"pull-indicator",style:{height:A},children:[e.jsx("div",{className:`pull-spinner ${se?"spinning":""}`,children:se?"↻":"↓"}),e.jsx("span",{children:se?"Refreshing...":A>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${x==="requests"?"active":""} ${D>0?"has-badge":""}`,onClick:()=>v("requests"),children:["Requests",D>0&&e.jsx("span",{className:"nav-badge",children:D})]}),e.jsx("button",{className:`nav-btn ${x==="forms"?"active":""}`,onClick:()=>v("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${x==="circuits"?"active":""}`,onClick:()=>v("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:Q,"aria-label":U?"Switch to light mode":"Switch to dark mode",children:U?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"logout-btn",onClick:$e,children:"Log Out"})]})]}),$&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${$.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[$.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),$.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),$.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:$.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[x==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:z}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>v("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${D>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:D}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:`summary-card ${h==="expiring"?"active":""}`,onClick:()=>ee(h==="expiring"?null:"expiring"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${pe.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:pe.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:`summary-card ${h==="low"?"active":""}`,onClick:()=>ee(h==="low"?null:"low"),children:[e.jsx("div",{className:`summary-icon low-icon ${Ne.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:Ne.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),h==="expiring"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Expiring Soon"}),e.jsx("button",{className:"card-detail-close",onClick:()=>ee(null),children:"✕"})]}),pe.length===0?e.jsx("p",{className:"card-detail-empty",children:"No clients expiring within 7 days"}):pe.map(n=>{const T=n.endDate.toDate?n.endDate.toDate():new Date(n.endDate),q=Math.ceil((T-O)/(1e3*60*60*24)),s=(n.totalSessions||0)-P(n);return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:n.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:"card-detail-tag warning",children:q<=1?"Ends today":`Ends in ${q} days`}),e.jsx("span",{className:`card-detail-tag ${s<=0?"urgent":"info"}`,children:s<=0?"No sessions left":`${s} session${s!==1?"s":""} left`})]})]},n.id)})]}),h==="low"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Low / No Sessions"}),e.jsx("button",{className:"card-detail-close",onClick:()=>ee(null),children:"✕"})]}),Ne.length===0?e.jsx("p",{className:"card-detail-empty",children:"All clients have sessions available"}):[...Ne].sort((n,T)=>{const q=(n.totalSessions||0)-P(n),s=(T.totalSessions||0)-P(T);return q-s}).map(n=>{const T=(n.totalSessions||0)-P(n),q=n.endDate?n.endDate.toDate?n.endDate.toDate():new Date(n.endDate):null,s=q?Math.ceil((q-O)/(1e3*60*60*24)):null;return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:n.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:`card-detail-tag ${T<=0?"urgent":"low"}`,children:T<=0?"No sessions left":`${T} session${T!==1?"s":""} left`}),s!==null&&s<=14&&e.jsxs("span",{className:"card-detail-tag warning",children:["Block ends ",s<=1?"today":`in ${s}d`]})]})]},n.id)})]}),e.jsx(fs,{})]}),x==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:Ae,children:"+ Add Client"})]}),e.jsx(ms,{})]}),x==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(ps,{})]}),x==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Reschedule Requests"}),e.jsx("button",{className:"history-toggle-btn",onClick:he,children:ne?"Hide History":"View History"})]}),ne&&e.jsxs("div",{className:"request-history-section",children:[e.jsx("div",{className:"history-section-header",children:"Past Requests"}),de?e.jsx("p",{className:"history-empty",children:"Loading..."}):fe.length===0?e.jsx("p",{className:"history-empty",children:"No past requests"}):fe.map(n=>e.jsxs("div",{className:"history-request-card",children:[e.jsxs("div",{className:"history-request-top",children:[e.jsx("span",{className:"history-client-name",children:n.clientName}),e.jsx("span",{className:`history-status-badge ${n.status}`,children:n.status})]}),e.jsxs("div",{className:"history-request-detail",children:[e.jsxs("span",{children:[De(n.originalDate)," ",o(n.originalTime)]}),e.jsx("span",{className:"history-arrow",children:"→"}),e.jsxs("span",{children:[De(n.requestedDate)," ",o(n.requestedTime)]})]}),n.respondedAt&&e.jsx("div",{className:"history-responded-at",children:n.respondedAt.toDate?n.respondedAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):""})]},n.id))]}),L.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:L.map(n=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:n.clientName}),e.jsx("span",{className:"request-time",children:n.createdAt?.toDate?n.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[De(n.originalDate)," at ",o(n.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[De(n.requestedDate)," at ",o(n.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>N(n),disabled:X===n.id,children:X===n.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>k(n),disabled:X===n.id,children:"Reject"})]})]},n.id))})]}),x==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(bs,{})]}),x==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(ws,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${x==="schedule"?"active":""}`,onClick:()=>v("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${x==="clients"?"active":""}`,onClick:()=>v("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${x==="calendar"?"active":""}`,onClick:()=>v("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{Cs as default};
