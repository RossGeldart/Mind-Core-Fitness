import{r as f,g as Q,q as Se,c as z,d as S,o as ze,j as e,a as ye,T as ee,w as Ae,b as je,e as O,f as Ve,s as Fe,h as Ye,u as me,i as Oe,k as Ge,l as Ke,m as Je}from"./index-Cg71xLB3.js";function Qe(){const[o,g]=f.useState([]),[u,N]=f.useState([]),[T,q]=f.useState(!0),[h,W]=f.useState(null),[l,H]=f.useState({}),[L,B]=f.useState(null),[V,K]=f.useState(""),[d,E]=f.useState("all"),[k,_]=f.useState(null),[D,I]=f.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[se,X]=f.useState([]),[xe,c]=f.useState(!1),[G,R]=f.useState(!1),[Y,J]=f.useState("list");f.useEffect(()=>{oe()},[]);const oe=async()=>{try{const[s,m]=await Promise.all([Q(Se(z(S,"clients"),ze("createdAt","desc"))),Q(z(S,"sessions"))]),$=s.docs.map(j=>({id:j.id,...j.data()})),F=m.docs.map(j=>({id:j.id,...j.data()}));g($),N(F)}catch(s){console.error("Error fetching data:",s)}q(!1)},le=s=>{const m=new Date,$=m.getFullYear(),F=(m.getMonth()+1).toString().padStart(2,"0"),j=m.getDate().toString().padStart(2,"0"),M=`${$}-${F}-${j}`,Z=`${m.getHours().toString().padStart(2,"0")}:${m.getMinutes().toString().padStart(2,"0")}`;return u.filter(re=>re.clientId!==s?!1:re.date<M||re.date===M&&re.time<Z).length},he=s=>{const m=le(s.id);return(s.totalSessions||0)-m},ce=s=>{const m=new Date,$=m.getFullYear(),F=(m.getMonth()+1).toString().padStart(2,"0"),j=m.getDate().toString().padStart(2,"0"),M=`${$}-${F}-${j}`,Z=`${m.getHours().toString().padStart(2,"0")}:${m.getMinutes().toString().padStart(2,"0")}`;return u.filter(re=>re.clientId!==s?!1:re.date>M||re.date===M&&re.time>=Z).length},te=s=>s?(s.toDate?s.toDate():new Date(s)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",ue=async(s,m)=>{if(window.confirm(`Are you sure you want to delete ${m}? This will also delete all their booked sessions.`))try{const F=u.filter(j=>j.clientId===s).map(j=>je(O(S,"sessions",j.id)));await Promise.all(F),await je(O(S,"clients",s)),g(o.filter(j=>j.id!==s)),N(u.filter(j=>j.clientId!==s))}catch($){console.error("Error deleting client:",$),alert("Failed to delete client")}},fe=s=>{if(!s)return"";const m=s.toDate?s.toDate():new Date(s),$=m.getFullYear(),F=(m.getMonth()+1).toString().padStart(2,"0"),j=m.getDate().toString().padStart(2,"0");return`${$}-${F}-${j}`},ne=s=>{W(s.id),H({name:s.name,email:s.email,password:"",clientType:s.clientType||"block",weeksInBlock:s.weeksInBlock||"",totalSessions:s.totalSessions||"",sessionsRemaining:s.sessionsRemaining,sessionDuration:s.sessionDuration||45,startDate:fe(s.startDate),endDate:fe(s.endDate),status:s.status,hasPortalAccess:!!s.uid,circuitAccess:!!s.circuitAccess,coreBuddyAccess:!!s.coreBuddyAccess,isJunior:!!s.isJunior})},U=s=>{const{name:m,value:$}=s.target;if(H(F=>({...F,[m]:$})),m==="startDate"||m==="weeksInBlock"){const F=m==="startDate"?$:l.startDate,j=parseInt(m==="weeksInBlock"?$:l.weeksInBlock);if(F&&j>0){const M=new Date(F),Z=new Date(M);Z.setDate(Z.getDate()+j*7);const re=Z.getFullYear(),ke=(Z.getMonth()+1).toString().padStart(2,"0"),Ne=Z.getDate().toString().padStart(2,"0");H(Te=>({...Te,[m]:$,endDate:`${re}-${ke}-${Ne}`}))}}},pe=async s=>{try{const m=o.find(M=>M.id===s);let $=m?.uid;if(l.password&&l.password.length>=6&&!m?.uid)try{const M=await Ve(Fe,l.email.trim().toLowerCase(),l.password);await Ye(Fe),$=M.user.uid}catch(M){if(console.error("Error creating auth account:",M),M.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(M.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+M.message);return}}const F=l.clientType==="block",j={name:l.name.trim(),email:l.email.trim().toLowerCase(),clientType:l.clientType,status:l.status,coreBuddyAccess:l.coreBuddyAccess,isJunior:l.isJunior};if(F)j.weeksInBlock=parseInt(l.weeksInBlock)||0,j.totalSessions=parseInt(l.totalSessions)||0,j.sessionDuration=parseInt(l.sessionDuration),j.circuitAccess=l.circuitAccess,l.startDate&&(j.startDate=ee.fromDate(new Date(l.startDate))),l.endDate&&(j.endDate=ee.fromDate(new Date(l.endDate)));else{const M=o.find(Z=>Z.id===s);M?.circuitStrikes===void 0&&(j.circuitStrikes=0),M?.circuitBanUntil===void 0&&(j.circuitBanUntil=null)}$&&!m?.uid&&(j.uid=$),await me(O(S,"clients",s),j),g(o.map(M=>M.id===s?{...M,...l,uid:$||M.uid,weeksInBlock:parseInt(l.weeksInBlock),totalSessions:parseInt(l.totalSessions),sessionDuration:parseInt(l.sessionDuration),startDate:ee.fromDate(new Date(l.startDate)),endDate:ee.fromDate(new Date(l.endDate))}:M)),W(null),$&&!m?.uid&&alert("Portal access created! Client can now log in.")}catch(m){console.error("Error updating client:",m),alert("Failed to update client")}},ve=async s=>{try{const m=o.find($=>$.id===s)?.status==="archived"?"active":"archived";await me(O(S,"clients",s),{status:m}),g(o.map($=>$.id===s?{...$,status:m}:$))}catch(m){console.error("Error archiving client:",m),alert("Failed to update client status")}},ge=async s=>{_({clientId:s.id,clientName:s.name}),J("list"),I({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),c(!0);try{const m=Se(z(S,"sessionNotes"),Ae("clientId","==",s.id)),F=(await Q(m)).docs.map(j=>({id:j.id,...j.data()}));F.sort((j,M)=>{const Z=j.createdAt?.toMillis?.()||0;return(M.createdAt?.toMillis?.()||0)-Z}),X(F)}catch(m){console.error("Error fetching notes:",m),X([])}c(!1)},de=()=>{_(null),X([]),J("list")},i=async()=>{if(!k)return;const{sessionNotes:s,whatWentWell:m,whatWentWrong:$,whatsNext:F}=D;if(!(!s.trim()&&!m.trim()&&!$.trim()&&!F.trim())){R(!0);try{const M=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await ye(z(S,"sessionNotes"),{clientId:k.clientId,date:M,sessionNotes:s.trim(),whatWentWell:m.trim(),whatWentWrong:$.trim(),whatsNext:F.trim(),createdAt:ee.now()}),I({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const Z=Se(z(S,"sessionNotes"),Ae("clientId","==",k.clientId)),ke=(await Q(Z)).docs.map(Ne=>({id:Ne.id,...Ne.data()}));ke.sort((Ne,Te)=>{const Ue=Ne.createdAt?.toMillis?.()||0;return(Te.createdAt?.toMillis?.()||0)-Ue}),X(ke),J("list")}catch(j){console.error("Error saving note:",j),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}R(!1)}},y=async s=>{if(window.confirm("Delete this session note?"))try{await je(O(S,"sessionNotes",s)),X(se.filter(m=>m.id!==s))}catch(m){console.error("Error deleting note:",m)}};if(T)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(o.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const a=s=>s.clientType==="circuit_vip"?"VIP":s.clientType==="circuit_dropin"?"Drop-in":s.clientType==="core_buddy"?"Core Buddy":"Block",n=o.filter(s=>s.name?.toLowerCase().includes(V.toLowerCase())||s.email?.toLowerCase().includes(V.toLowerCase())),x=s=>s.clientType==="circuit_vip"||s.clientType==="circuit_dropin",p=s=>s.clientType==="core_buddy",r=s=>s.status==="archived",t=n.filter(s=>!r(s)),v=t.filter(s=>!x(s)&&!p(s)),b=t.filter(s=>x(s)),w=t.filter(s=>p(s)),A=n.filter(s=>r(s)),C=d==="block"?v:d==="circuit"?b:d==="core_buddy"?w:d==="archived"?A:t,ie=s=>{h||B(m=>m===s?null:s)},P=s=>{const m=L===s.id,$=h===s.id,F=!s.clientType||s.clientType==="block";return e.jsxs("div",{className:`client-card ${s.status==="archived"?"archived":""} ${m||$?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>ie(s.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:s.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:s.name}),e.jsx("span",{className:"client-name-sub",children:F?`${he(s)}/${s.totalSessions||0} sessions`:a(s)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[(s.clientType==="circuit_vip"||s.clientType==="circuit_dropin"||s.clientType==="core_buddy")&&e.jsx("span",{className:`client-type-badge ${s.clientType==="circuit_vip"?"vip":s.clientType==="core_buddy"?"core-buddy":"dropin"}`,children:a(s)}),e.jsx("span",{className:`status-dot ${s.status}`}),e.jsx("svg",{className:`client-chevron ${m||$?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(m||$)&&e.jsx("div",{className:"client-expand-panel",children:$?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"},{value:"core_buddy",label:"Core Buddy"}].map(j=>e.jsx("button",{type:"button",className:`edit-type-btn ${l.clientType===j.value?"active":""}`,onClick:()=>H(M=>({...M,clientType:j.value})),children:j.label},j.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:l.name,onChange:U,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:l.email,onChange:U,placeholder:"Email"})]}),l.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:l.weeksInBlock,onChange:U,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:l.totalSessions,onChange:U,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:l.sessionDuration,onChange:U,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:l.startDate,onChange:U}),e.jsx("input",{type:"date",name:"endDate",value:l.endDate,onChange:U})]})]}),e.jsx("div",{className:"edit-row password-row",children:l.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:l.password,onChange:U,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),l.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:l.circuitAccess,onChange:j=>H(M=>({...M,circuitAccess:j.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),l.clientType!=="core_buddy"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:l.coreBuddyAccess,onChange:j=>H(M=>({...M,coreBuddyAccess:j.target.checked}))}),e.jsx("span",{children:"Core Buddy Access"})]})}),l.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:l.isJunior,onChange:j=>H(M=>({...M,isJunior:j.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>pe(s.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{W(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:s.email}),e.jsx("span",{className:`status-badge ${s.status}`,children:s.status})]}),F?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[s.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[he(s)," / ",s.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[ce(s.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[s.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:te(s.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:te(s.endDate)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:s.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[s.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:te(s.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[F&&e.jsxs("button",{className:"action-btn notes",onClick:j=>{j.stopPropagation(),ge(s)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:j=>{j.stopPropagation(),ne(s)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:j=>{j.stopPropagation(),ve(s.id)},children:s.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:j=>{j.stopPropagation(),ue(s.id,s.name)},children:"Delete"})]})]})})]},s.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:V,onChange:s=>K(s.target.value),className:"client-search-input"}),V&&e.jsx("button",{className:"client-search-clear",onClick:()=>K(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsx("div",{className:"client-type-filter",children:[{value:"all",label:"All",count:t.length},{value:"block",label:"Block",count:v.length},{value:"circuit",label:"Circuit",count:b.length},{value:"core_buddy",label:"Core Buddy",count:w.length},{value:"archived",label:"Archived",count:A.length}].map(s=>e.jsxs("button",{className:`client-filter-btn ${d===s.value?"active":""}`,onClick:()=>E(s.value),children:[s.label,e.jsx("span",{className:"client-filter-count",children:s.count})]},s.value))}),d==="all"?e.jsxs(e.Fragment,{children:[v.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:v.length})]}),v.map(P)]}),b.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:b.length})]}),b.map(P)]}),w.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Core Buddy Members ",e.jsx("span",{children:w.length})]}),w.map(P)]})]}):d==="archived"?e.jsx(e.Fragment,{children:A.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:A.length})]}),A.map(P)]})}):e.jsxs(e.Fragment,{children:[C.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",d," clients found"]}),C.map(P)]}),k&&e.jsx("div",{className:"notes-modal-overlay",onClick:de,children:e.jsxs("div",{className:"notes-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),k.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:de,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),Y==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:xe?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):se.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:se.map(s=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:s.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>y(s.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),s.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:s.sessionNotes})]}),s.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:s.whatWentWell})]}),s.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:s.whatWentWrong})]}),s.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:s.whatsNext})]})]},s.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>J("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:D.sessionNotes,onChange:s=>I(m=>({...m,sessionNotes:s.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:D.whatWentWell,onChange:s=>I(m=>({...m,whatWentWell:s.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:D.whatWentWrong,onChange:s=>I(m=>({...m,whatWentWrong:s.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:D.whatsNext,onChange:s=>I(m=>({...m,whatsNext:s.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>J("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:i,disabled:G,children:G?"Saving...":"Save Notes"})]})]})]})})]})}const Me={monday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},tuesday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},wednesday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},thursday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"15:00",end:"20:00"}},friday:{morning:{start:"06:15",end:"12:00"},afternoon:{start:"12:00",end:"17:00"},defaultBlocked:!0}},De=["monday","tuesday","wednesday","thursday","friday"],Xe=["Monday","Tuesday","Wednesday","Thursday","Friday"],Ze=["Mon","Tue","Wed","Thu","Fri"],We=o=>{const[g,u]=o.split(":"),N=parseInt(g),T=N>=12?"pm":"am";return`${N>12?N-12:N===0?12:N}:${u}${T}`},es=o=>{const g=new Date(o),u=g.getDay(),N=g.getDate()-u+(u===0?-6:1);return g.setDate(N),De.map((T,q)=>{const h=new Date(g);return h.setDate(g.getDate()+q),h})},ae=o=>{const g=o.getFullYear(),u=(o.getMonth()+1).toString().padStart(2,"0"),N=o.getDate().toString().padStart(2,"0");return`${g}-${u}-${N}`},Le=o=>{const[g,u]=o.split(":").map(Number);return g*60+u},we=(o,g)=>{const u=Le(o)+g,N=Math.floor(u/60),T=u%60;return`${N.toString().padStart(2,"0")}:${T.toString().padStart(2,"0")}`},ss=o=>{const g=Me[o];if(!g)return[];const u=[];if(g.morning){let N=g.morning.start;for(;N<g.morning.end;)u.push({time:N,period:"morning"}),N=we(N,15)}if(g.afternoon){let N=g.afternoon.start;for(;N<g.afternoon.end;)u.push({time:N,period:"afternoon"}),N=we(N,15)}return u};function ts(){const[o,g]=f.useState(new Date),[u,N]=f.useState([]),[T,q]=f.useState([]),[h,W]=f.useState([]),[l,H]=f.useState([]),[L,B]=f.useState([]),[V,K]=f.useState([]),[d,E]=f.useState(null),[k,_]=f.useState(null),[D,I]=f.useState(!1),[se,X]=f.useState(!0);f.useEffect(()=>{N(es(o))},[o]),f.useEffect(()=>{Y()},[]);const xe=a=>{if(E(a),I(!1),a.startDate){const n=a.startDate.toDate?a.startDate.toDate():new Date(a.startDate);g(n)}_(null)},c=a=>{const n=new Date,x=ae(n),p=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return h.filter(r=>r.clientId!==a?!1:r.date<x||r.date===x&&r.time<p).length},G=a=>{const n=c(a.id);return(a.totalSessions||0)-n},R=a=>{const n=new Date,x=n.getFullYear(),p=(n.getMonth()+1).toString().padStart(2,"0"),r=n.getDate().toString().padStart(2,"0"),t=`${x}-${p}-${r}`,v=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return h.filter(b=>b.clientId!==a?!1:b.date>t||b.date===t&&b.time>=v).length},Y=async()=>{try{const n=(await Q(z(S,"clients"))).docs.map(C=>({id:C.id,...C.data()})).filter(C=>C.status==="active");q(n);const p=(await Q(z(S,"sessions"))).docs.map(C=>({id:C.id,...C.data()}));W(p);const t=(await Q(z(S,"holidays"))).docs.map(C=>({id:C.id,...C.data()}));H(t);const b=(await Q(z(S,"blockedTimes"))).docs.map(C=>({id:C.id,...C.data()}));B(b);const A=(await Q(z(S,"openedSlots"))).docs.map(C=>({id:C.id,...C.data()}));K(A)}catch(a){console.error("Error fetching data:",a)}X(!1)},J=a=>{const n=new Date(o);n.setDate(n.getDate()+a*7),g(n),_(null)},oe=()=>{g(new Date),_(null)},le=a=>{const n=ae(a);return l.some(x=>x.date===n)},he=(a,n)=>{const x=ae(a);return L.some(p=>p.date===x&&p.time===n)},ce=(a,n)=>{const x=ae(a);return V.some(p=>p.date===x&&p.time===n)},te=a=>{const n=De[a.getDay()-1];return n&&Me[n]?.defaultBlocked},ue=async(a,n)=>{const x=ae(a);if(te(a)){const r=V.find(t=>t.date===x&&t.time===n);try{if(r)await je(O(S,"openedSlots",r.id)),K(V.filter(t=>t.id!==r.id));else{const t=await ye(z(S,"openedSlots"),{date:x,time:n,createdAt:ee.now()});K([...V,{id:t.id,date:x,time:n}])}}catch(t){console.error("Error toggling opened slot:",t),alert("Failed to update time slot")}return}const p=L.find(r=>r.date===x&&r.time===n);try{if(p)await je(O(S,"blockedTimes",p.id)),B(L.filter(r=>r.id!==p.id));else{const r=await ye(z(S,"blockedTimes"),{date:x,time:n,createdAt:ee.now()});B([...L,{id:r.id,date:x,time:n}])}}catch(r){console.error("Error toggling blocked time:",r),alert("Failed to update time slot")}},fe=a=>{const n=ae(a);return h.filter(x=>x.date===n)},ne=(a,n)=>{const x=ae(a);return h.find(p=>p.date===x&&p.time===n)},U=(a,n,x)=>{const p=De[a.getDay()-1];if(!p||le(a))return!1;const r=Me[p],t=Math.ceil(x/15);if(r.defaultBlocked)for(let s=0;s<t;s++){const m=we(n,s*15);if(!ce(a,m))return!1}else for(let s=0;s<t;s++){const m=we(n,s*15);if(he(a,m))return!1}const v=ae(a);if(h.find(s=>s.date===v&&s.time===n))return!1;const w=we(n,x),A=r.morning&&w<=r.morning.end,C=r.afternoon&&w<=r.afternoon.end,ie=r.morning&&n>=r.morning.start&&n<r.morning.end,P=r.afternoon&&n>=r.afternoon.start&&n<r.afternoon.end;if(ie&&!A||P&&!C)return!1;for(const s of h){if(s.date!==v)continue;const m=Le(s.time),$=m+(s.duration||45),F=Le(n),j=F+x;if(F<$&&j>m)return!1}return!0},pe=async(a,n)=>{const x=ne(a,n);if(x){if(window.confirm(`Cancel ${x.clientName}'s session at ${We(n)}?`))try{await je(O(S,"sessions",x.id)),W(h.filter(r=>r.id!==x.id))}catch(r){console.error("Error cancelling session:",r),alert("Failed to cancel session")}return}if(!d){alert("Please select a client first");return}if(!U(a,n,d.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}if(h.filter(r=>r.clientId===d.id).length>=d.totalSessions){alert(`${d.name} has already booked all ${d.totalSessions} sessions`);return}try{const r=ae(a),t={clientId:d.id,clientName:d.name,date:r,time:n,duration:d.sessionDuration||45,createdAt:ee.now()},v=await ye(z(S,"sessions"),t);W([...h,{id:v.id,...t}])}catch(r){console.error("Error booking session:",r),alert("Failed to book session")}},ve=async()=>{if(!d)return;const a=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),n=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),x=h.filter(w=>w.clientId!==d.id?!1:u.some(A=>ae(A)===w.date));if(x.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const p=d.weeksInBlock||Math.ceil((n-a)/(10080*60*1e3)),r=x.map(w=>({dayOfWeek:new Date(w.date).getDay(),time:w.time}));let t=[];const v=h.filter(w=>w.clientId===d.id).length;for(let w=0;w<p;w++){const A=new Date(a);A.setDate(A.getDate()+w*7);const C=new Date(A),ie=C.getDay(),P=C.getDate()-ie+(ie===0?-6:1);C.setDate(P);for(const s of r){const m=new Date(C),$=s.dayOfWeek===0?6:s.dayOfWeek-1;m.setDate(C.getDate()+$);const F=ae(m);h.some(j=>j.clientId===d.id&&j.date===F&&j.time===s.time)||m<a||m>n||l.some(j=>j.date===F)||t.push({dateKey:F,time:s.time,sessionDate:m})}}const b=v+t.length;if(b>d.totalSessions){alert(`This would create ${t.length} new sessions (${b} total), but client only has ${d.totalSessions} sessions in their package.

You can still book ${d.totalSessions-v} more sessions.`);return}if(t.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${t.length} new sessions across the block.

(${v} existing + ${t.length} new = ${b} total)

Continue?`))try{const w=[];for(const A of t){const C={clientId:d.id,clientName:d.name,date:A.dateKey,time:A.time,duration:d.sessionDuration||45,createdAt:ee.now()},ie=await ye(z(S,"sessions"),C);w.push({id:ie.id,...C})}W([...h,...w]),alert(`Created ${w.length} new sessions!`)}catch(w){console.error("Error repeating weekly:",w),alert("Failed to repeat sessions")}},ge=async a=>{const n=ae(a),x=l.find(p=>p.date===n);try{if(x)await je(O(S,"holidays",x.id)),H(l.filter(p=>p.id!==x.id));else{const p=await ye(z(S,"holidays"),{date:n,createdAt:ee.now()});H([...l,{id:p.id,date:n}])}}catch(p){console.error("Error toggling day availability:",p),alert("Failed to update day availability")}};if(se)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const de=u[0],i=u[4],y=de&&i?`${de.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${i.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>J(-1),children:"←"}),e.jsx("button",{onClick:oe,children:"Today"}),e.jsx("button",{onClick:()=>J(1),children:"→"})]}),e.jsx("h3",{children:y})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),d?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:d.name}),e.jsxs("span",{children:[d.sessionDuration||45,"min • ",G(d),"/",d.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[R(d.id)," booked"]})]}),e.jsx("button",{onClick:()=>E(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>I(!0),children:"Select Client"})]}),d&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:ve,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:u.map((a,n)=>{const x=fe(a),p=ae(a)===ae(new Date),r=le(a);return e.jsxs("div",{className:`day-card ${k===n?"selected":""} ${p?"today":""} ${r?"holiday":""}`,onClick:()=>_(k===n?null:n),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:Ze[n]}),e.jsx("span",{className:"day-date",children:a.getDate()})]}),r?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[x.length," session",x.length!==1?"s":""]})]},n)})}),k!==null&&u[k]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[Xe[k]," ",u[k].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>_(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${le(u[k])?"unavailable":"available"}`,onClick:()=>ge(u[k]),children:le(u[k])?"Mark Day Available":"Mark Day Unavailable"})}),le(u[k])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[te(u[k])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),ss(De[k]).map(({time:a,period:n},x,p)=>{const r=ne(u[k],a),t=te(u[k]),v=t?!ce(u[k],a):he(u[k],a),b=t&&ce(u[k],a),w=d&&U(u[k],a,d.sessionDuration||45),A=x===0||p[x-1]?.period!==n;return e.jsxs("div",{children:[A&&e.jsx("div",{className:"period-label",children:n==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${r?"booked":""} ${v&&!r?"blocked":""} ${b&&!r?"opened":""} ${w?"available":""} ${!r&&!v&&!w&&d?"unavailable":""}`,onClick:()=>(!v||r)&&pe(u[k],a),disabled:v&&!r,children:[e.jsx("span",{className:"slot-time",children:We(a)}),r?e.jsxs("span",{className:"slot-client",children:[r.clientName," (",r.duration,"m)"]}):v?e.jsx("span",{className:"slot-blocked",children:t?"Closed":"Blocked"}):w?e.jsx("span",{className:"slot-available",children:"Available"}):d?e.jsx("span",{className:"slot-unavailable",children:"Unavailable"}):b?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${t?b?"is-opened":"":v?"is-blocked":""}`,onClick:()=>ue(u[k],a),disabled:!!r,title:t?b?"Close this slot":"Open this slot":v?"Unblock this time":"Block this time",children:t?b?"✓":"+":v?"✓":"✕"})]})]},a)})]})]}),D&&e.jsx("div",{className:"modal-overlay",onClick:()=>I(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>I(!1),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:T.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):T.map(a=>{const n=a.startDate?.toDate?a.startDate.toDate():new Date(a.startDate),x=a.endDate?.toDate?a.endDate.toDate():new Date(a.endDate),p=G(a),r=R(a.id);return e.jsxs("button",{className:"client-option",onClick:()=>xe(a),children:[e.jsx("strong",{children:a.name}),e.jsxs("span",{children:[a.sessionDuration||45,"min • ",p,"/",a.totalSessions," remaining • ",r," booked"]}),e.jsxs("span",{className:"client-dates",children:[n.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," - ",x.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},a.id)})})]})})]})}const Ee=o=>{const[g,u]=o.split(":"),N=parseInt(g),T=N>=12?"pm":"am";return`${N>12?N-12:N===0?12:N}:${u}${T}`},be=o=>{const g=o.getFullYear(),u=(o.getMonth()+1).toString().padStart(2,"0"),N=o.getDate().toString().padStart(2,"0");return`${g}-${u}-${N}`},_e=o=>o===be(new Date),as=o=>{const g=new Date;return g.setDate(g.getDate()+1),o===be(g)},Ie=o=>_e(o)?"Today":as(o)?"Tomorrow":new Date(o).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),Re=o=>{const g=new Date,u=be(g),N=`${g.getHours().toString().padStart(2,"0")}:${g.getMinutes().toString().padStart(2,"0")}`;if(o.date<u)return!0;if(o.date===u){const T=Pe(o.time)+(o.duration||45);return Pe(N)>=T}return!1},Pe=o=>{const[g,u]=o.split(":").map(Number);return g*60+u};function ns(){const[o,g]=f.useState([]),[u,N]=f.useState(!0),[T,q]=f.useState(new Date);f.useEffect(()=>{h();const d=setInterval(()=>{q(new Date)},6e4);return()=>clearInterval(d)},[]);const h=async()=>{try{const E=(await Q(z(S,"sessions"))).docs.map(D=>({id:D.id,...D.data()})),k=be(new Date),_=E.filter(D=>D.date>=k).sort((D,I)=>D.date!==I.date?D.date.localeCompare(I.date):D.time.localeCompare(I.time));g(_)}catch(d){console.error("Error fetching sessions:",d)}N(!1)},W=async d=>{if(window.confirm(`Cancel ${d.clientName}'s session at ${Ee(d.time)} on ${Ie(d.date)}?`))try{await je(O(S,"sessions",d.id)),g(o.filter(E=>E.id!==d.id))}catch(E){console.error("Error cancelling session:",E),alert("Failed to cancel session")}};if(u)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const l=o.reduce((d,E)=>{const k=E.date;return d[k]||(d[k]=[]),d[k].push(E),d},{}),H=Object.keys(l).sort(),L=be(new Date),B=l[L]||[],V=B.filter(d=>Re(d)).length,K=B.length-V;return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:B.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[V," completed"]}),e.jsxs("span",{className:"remaining-count",children:[K," remaining"]})]})})]}),H.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:"No upcoming sessions booked"})}):e.jsx("div",{className:"sessions-list",children:H.map(d=>e.jsxs("div",{className:`date-group ${_e(d)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ie(d)}),e.jsxs("span",{className:"date-count",children:[l[d].length," session",l[d].length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:l[d].map(E=>{const k=Re(E);return e.jsxs("div",{className:`session-card ${k?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ee(E.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:E.clientName}),e.jsxs("span",{children:[E.duration,"min session"]})]}),k?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>W(E),children:"Cancel"})]},E.id)})})]},d))})]})}const is={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},rs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},os={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},ls=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function cs(){const[o,g]=f.useState([]),[u,N]=f.useState(!0),[T,q]=f.useState(null),[h,W]=f.useState(null),[l,H]=f.useState("all"),[L,B]=f.useState("");f.useEffect(()=>{V()},[]);const V=async()=>{try{const G=(await Q(z(S,"clients"))).docs.map(R=>({id:R.id,...R.data()}));G.sort((R,Y)=>(R.name||"").localeCompare(Y.name||"")),g(G)}catch(c){console.error("Error fetching clients:",c)}N(!1)},K=c=>!!c.welcomeForm?.completedAt,d=c=>!!c.parqForm?.completedAt,E=c=>K(c)||d(c),k=c=>K(c)&&d(c),_=c=>c?(c.toDate?c.toDate():new Date(c)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",D=o.filter(c=>!L||c.name?.toLowerCase().includes(L.toLowerCase())?l==="all"?!0:l==="completed"?k(c):l==="partial"?E(c)&&!k(c):l==="pending"?!E(c):!0:!1),I=o.filter(k).length,se=o.filter(c=>E(c)&&!k(c)).length,X=o.filter(c=>!E(c)).length,xe=c=>{T===c?(q(null),W(null)):(q(c),W(null))};return u?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:I}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:se}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:X}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:L,onChange:c=>B(c.target.value)}),L&&e.jsx("button",{className:"forms-search-clear",onClick:()=>B(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${l==="all"?"active":""}`,onClick:()=>H("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:o.length})]}),e.jsxs("button",{className:`forms-filter-btn ${l==="completed"?"active":""}`,onClick:()=>H("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:I})]}),e.jsxs("button",{className:`forms-filter-btn ${l==="partial"?"active":""}`,onClick:()=>H("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:se})]}),e.jsxs("button",{className:`forms-filter-btn ${l==="pending"?"active":""}`,onClick:()=>H("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:X})]})]}),D.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:D.map(c=>{const G=T===c.id,R=K(c),Y=d(c);return e.jsxs("div",{className:`forms-client-card ${G?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>xe(c.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(c.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:c.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${R?"done":"not-done"}`,children:[R?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${Y?"done":"not-done"}`,children:[Y?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${G?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),G&&e.jsx("div",{className:"forms-expand-panel",children:!R&&!Y?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[R&&e.jsx("button",{className:`forms-toggle-btn ${h==="welcome"||!h&&R?"active":""}`,onClick:()=>W("welcome"),children:"Welcome Questionnaire"}),Y&&e.jsx("button",{className:`forms-toggle-btn ${h==="parq"||!h&&!R&&Y?"active":""}`,onClick:()=>W("parq"),children:"PAR-Q Health Screening"})]}),(h==="welcome"||!h&&R)&&R&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",_(c.welcomeForm.completedAt)]})]}),c.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:c.welcomeForm.fitnessGoals})]}),c.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:is[c.welcomeForm.currentActivityLevel]||c.welcomeForm.currentActivityLevel})]}),c.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:c.welcomeForm.exerciseHistory})]}),c.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:c.welcomeForm.injuries})]}),c.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:c.welcomeForm.medicalConditions})]}),c.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:rs[c.welcomeForm.sleepHours]||c.welcomeForm.sleepHours})]}),c.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:os[c.welcomeForm.stressLevel]||c.welcomeForm.stressLevel})]}),c.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:c.welcomeForm.dietaryInfo})]}),c.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:c.welcomeForm.availability})]}),c.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:c.welcomeForm.additionalInfo})]})]}),h==="parq"&&Y&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",_(c.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:ls.map(J=>{const oe=c.parqForm[J.key];return e.jsxs("div",{className:`parq-result-item ${oe?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${oe?"yes":"no"}`,children:oe?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:J.text})]},J.key)})}),c.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:c.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:c.parqForm.declaration?"declared":"not-declared",children:c.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},c.id)})})]})}const Be=o=>`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,qe=o=>new Date(o+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),He=()=>{const o=new Date;let u=(6-o.getDay()+7)%7;if(u===0){const T=new Date(o);T.setHours(9,45,0,0),o>T&&(u=7)}const N=new Date(o);return N.setDate(o.getDate()+u),N},Ce=o=>o==="circuit_vip"?"VIP":o==="circuit_dropin"?"Drop-in":"Block",$e=o=>o==="circuit_vip"?"vip":o==="circuit_dropin"?"dropin":"block";function ds(){const[o,g]=f.useState(!0),[u,N]=f.useState([]),[T,q]=f.useState([]),[h,W]=f.useState(null),[l,H]=f.useState("upcoming"),[L,B]=f.useState(!1),[V,K]=f.useState(null),[d,E]=f.useState(!1),[k,_]=f.useState(!1),D=f.useCallback((i,y="info")=>{K({message:i,type:y}),setTimeout(()=>K(null),4e3)},[]);f.useEffect(()=>{I()},[]);const I=async()=>{try{const y=(await Q(z(S,"circuitSessions"))).docs.map(r=>({id:r.id,...r.data()}));y.sort((r,t)=>t.date.localeCompare(r.date)),N(y);const n=(await Q(z(S,"clients"))).docs.map(r=>({id:r.id,...r.data()})).filter(r=>r.clientType==="circuit_vip"||r.clientType==="circuit_dropin"||r.circuitAccess===!0);q(n);const x=Be(He()),p=y.find(r=>r.date===x);p?W(p):y.length>0&&W(y[0])}catch(i){console.error("Error loading circuit data:",i),D("Failed to load circuit data","error")}g(!1)},se=async i=>{if(!(!h||L)&&window.confirm("Remove this member from the slot?")){B(!0);try{const y=[...h.slots],a=y.findIndex(p=>p.slotNumber===i);if(a===-1){B(!1);return}let n=[...h.waitlist||[]];if(n.length>0){const p=n.shift();y[a]={slotNumber:i,memberId:p.memberId,memberName:p.memberName,memberType:p.memberType,status:"confirmed",bookedAt:ee.now()},D(`Slot given to ${p.memberName} from waitlist`,"success")}else y[a]={slotNumber:i,memberId:null,memberName:null,memberType:null,status:"available"},D("Member removed from slot","success");await me(O(S,"circuitSessions",h.id),{slots:y,waitlist:n});const x={...h,slots:y,waitlist:n};W(x),N(p=>p.map(r=>r.id===x.id?x:r))}catch(y){console.error("Error removing from slot:",y),D("Failed to remove member","error")}B(!1)}},X=async(i,y)=>{if(!(!h||L)){B(!0);try{const a=[...h.slots],n=a.findIndex(r=>r.slotNumber===i&&r.status==="available");if(n===-1){D("Slot is not available","error"),B(!1);return}if(a.some(r=>r.memberId===y.id)){D(`${y.name} already has a slot`,"error"),B(!1);return}a[n]={slotNumber:i,memberId:y.id,memberName:y.name,memberType:y.clientType||"block",status:"confirmed",bookedAt:ee.now()};const x=(h.waitlist||[]).filter(r=>r.memberId!==y.id);await me(O(S,"circuitSessions",h.id),{slots:a,waitlist:x});const p={...h,slots:a,waitlist:x};W(p),N(r=>r.map(t=>t.id===p.id?p:t)),D(`${y.name} added to slot ${i}`,"success")}catch(a){console.error("Error adding to slot:",a),D("Failed to add member","error")}B(!1)}},xe=async i=>{if(!(!h||L)){B(!0);try{const y=(h.waitlist||[]).filter(n=>n.memberId!==i);await me(O(S,"circuitSessions",h.id),{waitlist:y});const a={...h,waitlist:y};W(a),N(n=>n.map(x=>x.id===a.id?a:x)),D("Removed from waitlist","success")}catch(y){console.error("Error removing from waitlist:",y),D("Failed to remove from waitlist","error")}B(!1)}},c=async(i,y)=>{if(!(!h||L)){B(!0);try{const a=[...h.slots],n=a.findIndex(p=>p.slotNumber===i);if(n===-1){B(!1);return}if(a[n]={...a[n],attended:y},await me(O(S,"circuitSessions",h.id),{slots:a}),y===!1){const p=a[n].memberId;if(p){const r=O(S,"clients",p),t=await Oe(r);if(t.exists()){const b=(t.data().circuitStrikes||0)+1,w={circuitStrikes:b};if(b>=3){const A=new Date;A.setMonth(A.getMonth()+1),w.circuitBanUntil=ee.fromDate(A),w.circuitStrikes=0,D(`${a[n].memberName} banned for 1 month (3 strikes)`,"error")}else D(`No-show recorded - ${a[n].memberName} (${b}/3 strikes)`,"error");await me(r,w)}}}else D(`${a[n].memberName} marked as attended`,"success");const x={...h,slots:a};W(x),N(p=>p.map(r=>r.id===x.id?x:r))}catch(a){console.error("Error marking attendance:",a),D("Failed to update attendance","error")}B(!1)}},G=async(i,y)=>{if(!L&&window.confirm(`Reset strikes for ${y}?`)){B(!0);try{await me(O(S,"clients",i),{circuitStrikes:0,circuitBanUntil:null}),q(a=>a.map(n=>n.id===i?{...n,circuitStrikes:0,circuitBanUntil:null}:n)),D(`Strikes reset for ${y}`,"success")}catch(a){console.error("Error resetting strikes:",a),D("Failed to reset strikes","error")}B(!1)}},R=async(i,y)=>{if(!L&&window.confirm(`Lift ban for ${y}?`)){B(!0);try{await me(O(S,"clients",i),{circuitBanUntil:null,circuitStrikes:0}),q(a=>a.map(n=>n.id===i?{...n,circuitBanUntil:null,circuitStrikes:0}:n)),D(`Ban lifted for ${y}`,"success")}catch(a){console.error("Error lifting ban:",a),D("Failed to lift ban","error")}B(!1)}};if(o)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const Y=Be(new Date),J=Be(He()),oe=u.filter(i=>i.date>=Y),le=u.filter(i=>i.date<Y),he=l==="upcoming"?oe:le,ce=h?h.slots.filter(i=>i.status!=="available").length:0,te=h?h.slots.filter(i=>i.status==="available").length:0,ue=h?h.date>=Y:!1,fe=h?h.slots.filter(i=>i.memberId).map(i=>i.memberId):[],ne=h?(h.waitlist||[]).map(i=>i.memberId):[],U=T.filter(i=>!fe.includes(i.id)&&!ne.includes(i.id)),pe=T.filter(i=>i.clientType==="circuit_vip").length,ve=T.filter(i=>i.clientType==="circuit_dropin").length,ge=T.filter(i=>i.circuitAccess&&i.clientType!=="circuit_vip"&&i.clientType!=="circuit_dropin").length,de=T.filter(i=>i.circuitBanUntil?(i.circuitBanUntil.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:pe}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ve}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ge}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:u.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${d?"":"active"}`,onClick:()=>E(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${d?"active":""}`,onClick:()=>E(!0),children:"Members"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${l==="upcoming"?"active":""}`,onClick:()=>H("upcoming"),children:["Upcoming (",oe.length,")"]}),e.jsxs("button",{className:`cm-tab ${l==="past"?"active":""}`,onClick:()=>H("past"),children:["Past (",le.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:he.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",l," sessions"]})}):he.map(i=>{const y=i.slots.filter(x=>x.status!=="available").length,a=h?.id===i.id,n=i.date===J;return e.jsxs("button",{className:`cm-session-btn ${a?"selected":""} ${n?"next":""}`,onClick:()=>{W(i),_(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:qe(i.date)}),n&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[y,"/8"]}),(i.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",i.waitlist.length," wl"]})]})]},i.id)})}),h&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:qe(h.date)}),e.jsxs("p",{children:[h.time," - ",h.endTime," • ",ce,"/8 booked • ",te," available"]})]}),!ue&&e.jsx("button",{className:`cm-attendance-btn ${k?"active":""}`,onClick:()=>_(!k),children:k?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:h.slots.map(i=>{const y=i.status==="available";return e.jsxs("div",{className:`cm-slot ${y?"empty":"filled"} ${i.attended===!0?"attended":""} ${i.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:i.slotNumber}),y?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),ue&&e.jsx(ms,{members:U,onSelect:a=>X(i.slotNumber,a),disabled:L})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${$e(i.memberType)}`,children:Ce(i.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[k&&i.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>c(i.slotNumber,!0),disabled:L,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>c(i.slotNumber,!1),disabled:L,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),i.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),i.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),ue&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>se(i.slotNumber),disabled:L,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},i.slotNumber)})}),(h.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",h.waitlist.length,")"]}),h.waitlist.map((i,y)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",y+1]}),e.jsx("span",{className:"cm-wl-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${$e(i.memberType)}`,children:Ce(i.memberType)}),ue&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>xe(i.memberId),disabled:L,children:"Remove"})]},i.memberId))]})]})]}),d&&e.jsxs("div",{className:"cm-members",children:[de.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",de.length,")"]}),de.map(i=>{const y=i.circuitBanUntil?.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:i.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",y.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>R(i.id,i.name),disabled:L,children:"Lift Ban"})]},i.id)})]}),e.jsx("div",{className:"cm-members-list",children:T.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):T.map(i=>{const y=i.circuitStrikes||0,a=de.some(n=>n.id===i.id);return e.jsxs("div",{className:`cm-member-card ${a?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:i.name}),e.jsx("span",{className:`cm-type-badge ${$e(i.clientType)}`,children:Ce(i.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(n=>e.jsx("span",{className:`cm-strike-dot ${n<y?"active":""}`},n)),e.jsxs("span",{className:"cm-strike-text",children:[y,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[a&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>R(i.id,i.name),disabled:L,children:"Lift Ban"}),y>0&&!a&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>G(i.id,i.name),disabled:L,children:"Reset"})]})]})]},i.id)})})]}),V&&e.jsx("div",{className:`cm-toast ${V.type}`,children:e.jsx("span",{children:V.message})})]})}function ms({members:o,onSelect:g,disabled:u}){const[N,T]=f.useState(!1),[q,h]=f.useState(""),W=o.filter(l=>l.name.toLowerCase().includes(q.toLowerCase()));return o.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>T(!N),disabled:u,children:"+ Add"}),N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{T(!1),h("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[o.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:q,onChange:l=>h(l.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[W.map(l=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{g(l),T(!1),h("")},children:[e.jsx("span",{children:l.name}),e.jsx("span",{className:`cm-type-badge sm ${$e(l.clientType)}`,children:Ce(l.clientType)})]},l.id)),W.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function xs(){const[o,g]=f.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),u=t=>{g(t),localStorage.setItem("adminActiveView",t)},[N,T]=f.useState(0),[q,h]=f.useState(!1),[W,l]=f.useState([]),[H,L]=f.useState(null),[B,V]=f.useState(null),[K,d]=f.useState([]),[E,k]=f.useState([]),{currentUser:_,logout:D,isAdmin:I,loading:se}=Ge(),{isDark:X,toggleTheme:xe}=Ke(),c=Je(),G=f.useRef(0),R=f.useRef(!1);f.useRef(null);const Y=f.useCallback((t,v="info")=>{V({message:t,type:v}),setTimeout(()=>V(null),4e3)},[]);f.useEffect(()=>{!se&&(!_||!I)&&c("/")},[_,I,se,c]),f.useEffect(()=>{_&&I&&J()},[_,I]);const J=async()=>{try{const t=Se(z(S,"rescheduleRequests"),Ae("status","==","pending")),b=(await Q(t)).docs.map(w=>({id:w.id,...w.data()}));b.sort((w,A)=>{const C=w.createdAt?.toDate?w.createdAt.toDate():new Date(0);return(A.createdAt?.toDate?A.createdAt.toDate():new Date(0))-C}),l(b)}catch(t){console.error("Error fetching reschedule requests:",t)}};f.useEffect(()=>{(async()=>{if(!(!_||!I))try{const[v,b]=await Promise.all([Q(z(S,"clients")),Q(z(S,"sessions"))]),w=v.docs.map(P=>({id:P.id,...P.data()})),A=b.docs.map(P=>({id:P.id,...P.data()}));d(w);const C=new Set(w.map(P=>P.id)),ie=b.docs.filter(P=>!C.has(P.data().clientId));if(ie.length>0){const P=ie.map(s=>je(O(S,"sessions",s.id)));await Promise.all(P)}k(A.filter(P=>C.has(P.clientId)))}catch(v){console.error("Error fetching dashboard data:",v)}})()},[_,I]),f.useEffect(()=>{const t=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,v=A=>{t()<=0&&(G.current=A.touches[0].clientY,R.current=!1)},b=A=>{const C=t(),P=A.touches[0].clientY-G.current;if(C>5||P<=0){R.current=!1,T(0);return}P>20&&C<=0&&(R.current=!0,T(Math.min((P-20)*.4,80)))},w=()=>{R.current&&N>60?(h(!0),setTimeout(()=>{window.location.reload()},300)):T(0),R.current=!1};return document.addEventListener("touchstart",v,{passive:!0}),document.addEventListener("touchmove",b,{passive:!0}),document.addEventListener("touchend",w),()=>{document.removeEventListener("touchstart",v),document.removeEventListener("touchmove",b),document.removeEventListener("touchend",w)}},[N]);const oe=()=>{h(!0),setTimeout(()=>{window.location.reload()},300)},le=async()=>{try{await D(),c("/")}catch(t){console.error("Failed to log out:",t)}},he=()=>{c("/add-client")},ce=t=>new Date(t).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),te=t=>{const[v,b]=t.split(":"),w=parseInt(v),A=w>=12?"pm":"am";return`${w>12?w-12:w===0?12:w}:${b}${A}`},ue=async t=>{if(window.confirm(`Approve reschedule for ${t.clientName}?

From: ${ce(t.originalDate)} at ${te(t.originalTime)}
To: ${ce(t.requestedDate)} at ${te(t.requestedTime)}`)){L(t.id);try{await me(O(S,"sessions",t.sessionId),{date:t.requestedDate,time:t.requestedTime}),await me(O(S,"rescheduleRequests",t.id),{status:"approved",respondedAt:ee.now()}),l(W.filter(v=>v.id!==t.id)),Y(`Approved reschedule for ${t.clientName}`,"success")}catch(v){console.error("Error approving request:",v),Y("Failed to approve request","error")}L(null)}},fe=async t=>{if(window.confirm(`Reject reschedule request from ${t.clientName}?`)){L(t.id);try{await me(O(S,"rescheduleRequests",t.id),{status:"rejected",respondedAt:ee.now()}),l(W.filter(v=>v.id!==t.id)),Y(`Request from ${t.clientName} rejected`,"info")}catch(v){console.error("Error rejecting request:",v),Y("Failed to reject request","error")}L(null)}};if(se)return e.jsx("div",{className:"loading",children:"Loading..."});if(!_||!I)return null;const ne=W.length,U=new Date,pe=`${U.getFullYear()}-${(U.getMonth()+1).toString().padStart(2,"0")}-${U.getDate().toString().padStart(2,"0")}`,ve=`${U.getHours().toString().padStart(2,"0")}:${U.getMinutes().toString().padStart(2,"0")}`,de=E.filter(t=>t.date===pe).length,i=t=>E.filter(v=>v.clientId!==t?!1:v.date<pe||v.date===pe&&v.time<ve).length,y=K.filter(t=>t.status!=="archived"&&(!t.clientType||t.clientType==="block")),a=new Date(U);a.setDate(a.getDate()+7);const n=y.filter(t=>{if(!t.endDate)return!1;const v=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate);return v>=U&&v<=a}),x=y.filter(t=>(t.totalSessions||0)-i(t.id)<=2),p=new Map;n.forEach(t=>{const v=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate),b=Math.ceil((v-U)/(1e3*60*60*24));p.set(t.id,{client:t,reasons:[`Block ends in ${b} day${b!==1?"s":""}`]})}),x.forEach(t=>{const v=(t.totalSessions||0)-i(t.id),b=v<=0?"No sessions left":`${v} session${v!==1?"s":""} left`;p.has(t.id)?p.get(t.id).reasons.push(b):p.set(t.id,{client:t,reasons:[b]})});const r=Array.from(p.values());return e.jsxs("div",{className:"dashboard",children:[N>0&&e.jsxs("div",{className:"pull-indicator",style:{height:N},children:[e.jsx("div",{className:`pull-spinner ${q?"spinning":""}`,children:q?"↻":"↓"}),e.jsx("span",{children:q?"Refreshing...":N>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${o==="requests"?"active":""} ${ne>0?"has-badge":""}`,onClick:()=>u("requests"),children:["Requests",ne>0&&e.jsx("span",{className:"nav-badge",children:ne})]}),e.jsx("button",{className:`nav-btn ${o==="forms"?"active":""}`,onClick:()=>u("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${o==="circuits"?"active":""}`,onClick:()=>u("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:xe,"aria-label":X?"Switch to light mode":"Switch to dark mode",children:X?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"refresh-btn",onClick:oe,disabled:q,children:q?"↻":"⟳"}),e.jsx("button",{className:"logout-btn",onClick:le,children:"Log Out"})]})]}),B&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${B.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[B.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),B.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),B.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:B.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[o==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:de}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>ne>0&&u("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${ne>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ne}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>u("clients"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${n.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:n.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>u("clients"),children:[e.jsx("div",{className:`summary-icon low-icon ${x.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:x.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),r.length>0&&e.jsxs("div",{className:"attention-section",children:[e.jsxs("div",{className:"attention-header",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),e.jsx("span",{children:"Needs Attention"})]}),r.map(({client:t,reasons:v})=>e.jsxs("div",{className:"attention-item",children:[e.jsx("span",{className:"attention-name",children:t.name}),e.jsx("div",{className:"attention-reasons",children:v.map((b,w)=>e.jsx("span",{className:`attention-tag ${b.includes("No sessions")?"urgent":b.includes("ends")?"warning":"low"}`,children:b},w))})]},t.id))]}),e.jsx(ns,{})]}),o==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:he,children:"+ Add Client"})]}),e.jsx(Qe,{})]}),o==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(ts,{})]}),o==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Reschedule Requests"})}),W.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:W.map(t=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:t.clientName}),e.jsx("span",{className:"request-time",children:t.createdAt?.toDate?t.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[ce(t.originalDate)," at ",te(t.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[ce(t.requestedDate)," at ",te(t.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>ue(t),disabled:H===t.id,children:H===t.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>fe(t),disabled:H===t.id,children:"Reject"})]})]},t.id))})]}),o==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(cs,{})]}),o==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(ds,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${o==="schedule"?"active":""}`,onClick:()=>u("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${o==="clients"?"active":""}`,onClick:()=>u("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${o==="calendar"?"active":""}`,onClick:()=>u("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{xs as default};
