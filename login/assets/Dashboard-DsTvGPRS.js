import{r as h,g as pe,q as Re,c as te,d as S,o as es,j as e,a as We,T as fe,w as Ee,b as Be,e as oe,f as ss,s as Qe,h as ts,u as De,i as as,k as ns,l as is,m as ls,n as os}from"./index-C-N-wVvC.js";import{f as ue,D as rs,g as cs,i as Ie,a as qe,t as Fe,b as Pe,c as Ue,S as ze,d as ds}from"./scheduleUtils-a2tn0x12.js";function ms(){const[p,L]=h.useState([]),[j,M]=h.useState([]),[I,ee]=h.useState(!0),[m,F]=h.useState(null),[c,se]=h.useState({}),[W,T]=h.useState(null),[z,ae]=h.useState(""),[d,xe]=h.useState("all"),[$,ce]=h.useState(null),[E,re]=h.useState({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),[we,he]=h.useState([]),[Ne,l]=h.useState(!1),[Z,G]=h.useState(!1),[C,q]=h.useState("list");h.useEffect(()=>{g()},[]);const g=async()=>{try{const[t,s]=await Promise.all([pe(Re(te(S,"clients"),es("name","asc"))),pe(te(S,"sessions"))]),u=t.docs.map(r=>({id:r.id,...r.data()})),y=s.docs.map(r=>({id:r.id,...r.data()}));L(u),M(y)}catch(t){console.error("Error fetching data:",t)}ee(!1)},_=t=>{const s=new Date,u=s.getFullYear(),y=(s.getMonth()+1).toString().padStart(2,"0"),r=s.getDate().toString().padStart(2,"0"),N=`${u}-${y}-${r}`,D=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;return j.filter(n=>n.clientId!==t?!1:n.date<N||n.date===N&&n.time<D).length},X=t=>{const s=_(t.id);return(t.totalSessions||0)-s},be=t=>{const s=new Date,u=s.getFullYear(),y=(s.getMonth()+1).toString().padStart(2,"0"),r=s.getDate().toString().padStart(2,"0"),N=`${u}-${y}-${r}`,D=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;return j.filter(n=>n.clientId!==t?!1:n.date>N||n.date===N&&n.time>=D).length},ne=t=>t?(t.toDate?t.toDate():new Date(t)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-",de=async(t,s)=>{if(window.confirm(`Are you sure you want to delete ${s}? This will also delete all their booked sessions.`))try{const y=j.filter(r=>r.clientId===t).map(r=>Be(oe(S,"sessions",r.id)));await Promise.all(y),await Be(oe(S,"clients",t)),L(p.filter(r=>r.id!==t)),M(j.filter(r=>r.clientId!==t))}catch(u){console.error("Error deleting client:",u),alert("Failed to delete client")}},ie=t=>{if(!t)return"";const s=t.toDate?t.toDate():new Date(t),u=s.getFullYear(),y=(s.getMonth()+1).toString().padStart(2,"0"),r=s.getDate().toString().padStart(2,"0");return`${u}-${y}-${r}`},ye=t=>{F(t.id),se({name:t.name,email:t.email,password:"",clientType:t.clientType||"block",weeksInBlock:t.weeksInBlock||"",totalSessions:t.totalSessions||"",sessionsRemaining:t.sessionsRemaining,sessionDuration:t.sessionDuration||45,startDate:ie(t.startDate),endDate:ie(t.endDate),status:t.status,hasPortalAccess:!!t.uid,circuitAccess:!!t.circuitAccess,isJunior:!!t.isJunior})},me=t=>{const{name:s,value:u}=t.target;if(se(y=>({...y,[s]:u})),s==="startDate"||s==="weeksInBlock"){const y=s==="startDate"?u:c.startDate,r=parseInt(s==="weeksInBlock"?u:c.weeksInBlock);if(y&&r>0){const N=new Date(y),D=new Date(N);D.setDate(D.getDate()+r*7);const n=D.getFullYear(),a=(D.getMonth()+1).toString().padStart(2,"0"),o=D.getDate().toString().padStart(2,"0");se(v=>({...v,[s]:u,endDate:`${n}-${a}-${o}`}))}}},ge=async t=>{try{const s=p.find(N=>N.id===t);let u=s?.uid;if(c.password&&c.password.length>=6&&!s?.uid)try{const N=await ss(Qe,c.email.trim().toLowerCase(),c.password);await ts(Qe),u=N.user.uid}catch(N){if(console.error("Error creating auth account:",N),N.code==="auth/email-already-in-use")alert("This email already has a portal account. Password not changed.");else if(N.code==="auth/weak-password"){alert("Password must be at least 6 characters.");return}else{alert("Failed to create portal account: "+N.message);return}}const y=c.clientType==="block",r={name:c.name.trim(),email:c.email.trim().toLowerCase(),clientType:c.clientType,status:c.status,isJunior:c.isJunior};if(y)r.weeksInBlock=parseInt(c.weeksInBlock)||0,r.totalSessions=parseInt(c.totalSessions)||0,r.sessionDuration=parseInt(c.sessionDuration),r.circuitAccess=c.circuitAccess,c.startDate&&(r.startDate=fe.fromDate(new Date(c.startDate))),c.endDate&&(r.endDate=fe.fromDate(new Date(c.endDate)));else{const N=p.find(D=>D.id===t);N?.circuitStrikes===void 0&&(r.circuitStrikes=0),N?.circuitBanUntil===void 0&&(r.circuitBanUntil=null)}u&&!s?.uid&&(r.uid=u),await De(oe(S,"clients",t),r),L(p.map(N=>N.id===t?{...N,...c,uid:u||N.uid,weeksInBlock:parseInt(c.weeksInBlock),totalSessions:parseInt(c.totalSessions),sessionDuration:parseInt(c.sessionDuration),startDate:fe.fromDate(new Date(c.startDate)),endDate:fe.fromDate(new Date(c.endDate))}:N)),F(null),u&&!s?.uid&&alert("Portal access created! Client can now log in.")}catch(s){console.error("Error updating client:",s),alert("Failed to update client")}},$e=async t=>{try{const s=p.find(u=>u.id===t)?.status==="archived"?"active":"archived";await De(oe(S,"clients",t),{status:s}),L(p.map(u=>u.id===t?{...u,status:s}:u))}catch(s){console.error("Error archiving client:",s),alert("Failed to update client status")}},Ae=async t=>{ce({clientId:t.id,clientName:t.name}),q("list"),re({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""}),l(!0);try{const s=Re(te(S,"sessionNotes"),Ee("clientId","==",t.id)),y=(await pe(s)).docs.map(r=>({id:r.id,...r.data()}));y.sort((r,N)=>{const D=r.createdAt?.toMillis?.()||0;return(N.createdAt?.toMillis?.()||0)-D}),he(y)}catch(s){console.error("Error fetching notes:",s),he([])}l(!1)},ve=()=>{ce(null),he([]),q("list")},i=async()=>{if(!$)return;const{sessionNotes:t,whatWentWell:s,whatWentWrong:u,whatsNext:y}=E;if(!(!t.trim()&&!s.trim()&&!u.trim()&&!y.trim())){G(!0);try{const N=new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});await We(te(S,"sessionNotes"),{clientId:$.clientId,date:N,sessionNotes:t.trim(),whatWentWell:s.trim(),whatWentWrong:u.trim(),whatsNext:y.trim(),createdAt:fe.now()}),re({sessionNotes:"",whatWentWell:"",whatWentWrong:"",whatsNext:""});const D=Re(te(S,"sessionNotes"),Ee("clientId","==",$.clientId)),a=(await pe(D)).docs.map(o=>({id:o.id,...o.data()}));a.sort((o,v)=>{const x=o.createdAt?.toMillis?.()||0;return(v.createdAt?.toMillis?.()||0)-x}),he(a),q("list")}catch(r){console.error("Error saving note:",r),alert("Failed to save note. Check Firestore rules for sessionNotes collection.")}G(!1)}},f=async t=>{if(window.confirm("Delete this session note?"))try{await Be(oe(S,"sessionNotes",t)),he(we.filter(s=>s.id!==t))}catch(s){console.error("Error deleting note:",s)}};if(I)return e.jsx("div",{className:"client-list-loading",children:"Loading clients..."});if(p.length===0)return e.jsxs("div",{className:"client-list-empty",children:[e.jsx("p",{children:"No clients yet"}),e.jsx("span",{children:"Add your first client to get started"})]});const w=t=>t.clientType==="circuit_vip"?"VIP":t.clientType==="circuit_dropin"?"Drop-in":"Block",b=p.filter(t=>t.name?.toLowerCase().includes(z.toLowerCase())||t.email?.toLowerCase().includes(z.toLowerCase())).sort((t,s)=>(t.name||"").localeCompare(s.name||"")),U=t=>t.clientType==="circuit_vip"||t.clientType==="circuit_dropin",H=t=>t.status==="archived",A=b.filter(t=>!H(t)),R=A.filter(t=>!U(t)),O=A.filter(t=>U(t)),V=b.filter(t=>H(t)),Ce=d==="block"?R:d==="circuit"?O:d==="archived"?V:A,Te=t=>{m||T(s=>s===t?null:t)},ke=t=>{const s=W===t.id,u=m===t.id,y=!t.clientType||t.clientType==="block";let r=null,N=null;if(y&&t.status!=="archived"){const D=X(t);if(D<=2&&(r={text:D<=0?"No sessions":`${D} left`,urgent:D<=0}),t.endDate){const n=t.endDate.toDate?t.endDate.toDate():new Date(t.endDate),a=Math.ceil((n-new Date)/(1e3*60*60*24));a<=7&&(N={text:a<=0?"Expired":a===1?"Ends today":`${a}d left`,urgent:a<=1})}}return e.jsxs("div",{className:`client-card ${t.status==="archived"?"archived":""} ${s||u?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"client-name-row",onClick:()=>Te(t.id),children:[e.jsxs("div",{className:"client-name-row-left",children:[e.jsx("span",{className:"client-name-initial",children:t.name?.charAt(0)?.toUpperCase()}),e.jsxs("div",{className:"client-name-text",children:[e.jsx("h3",{children:t.name}),e.jsx("span",{className:"client-name-sub",children:y?`${X(t)}/${t.totalSessions||0} sessions`:w(t)})]})]}),e.jsxs("div",{className:"client-name-row-right",children:[r&&e.jsx("span",{className:`client-warn-badge ${r.urgent?"urgent":"warning"}`,children:r.text}),N&&e.jsx("span",{className:`client-warn-badge ${N.urgent?"urgent":"expiry"}`,children:N.text}),(t.clientType==="circuit_vip"||t.clientType==="circuit_dropin")&&e.jsx("span",{className:`client-type-badge ${t.clientType==="circuit_vip"?"vip":"dropin"}`,children:w(t)}),e.jsx("span",{className:`status-dot ${t.status}`}),e.jsx("svg",{className:`client-chevron ${s||u?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]})]}),(s||u)&&e.jsx("div",{className:"client-expand-panel",children:u?e.jsxs("div",{className:"edit-form",children:[e.jsx("div",{className:"edit-type-toggle",children:[{value:"block",label:"Block"},{value:"circuit_vip",label:"VIP"},{value:"circuit_dropin",label:"Drop-in"}].map(D=>e.jsx("button",{type:"button",className:`edit-type-btn ${c.clientType===D.value?"active":""}`,onClick:()=>se(n=>({...n,clientType:D.value})),children:D.label},D.value))}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"text",name:"name",value:c.name,onChange:me,placeholder:"Name"}),e.jsx("input",{type:"email",name:"email",value:c.email,onChange:me,placeholder:"Email"})]}),c.clientType==="block"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"number",name:"weeksInBlock",value:c.weeksInBlock,onChange:me,placeholder:"Weeks",min:"1"}),e.jsx("input",{type:"number",name:"totalSessions",value:c.totalSessions,onChange:me,placeholder:"Total Sessions",min:"1"}),e.jsxs("select",{name:"sessionDuration",value:c.sessionDuration,onChange:me,children:[e.jsx("option",{value:"30",children:"30 min"}),e.jsx("option",{value:"45",children:"45 min"})]})]}),e.jsxs("div",{className:"edit-row",children:[e.jsx("input",{type:"date",name:"startDate",value:c.startDate,onChange:me}),e.jsx("input",{type:"date",name:"endDate",value:c.endDate,onChange:me})]})]}),e.jsx("div",{className:"edit-row password-row",children:c.hasPortalAccess?e.jsx("div",{className:"portal-status has-access",children:"Has portal access"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"password",value:c.password,onChange:me,placeholder:"Set portal password (min 6 chars)"}),e.jsx("span",{className:"password-hint",children:"Set password to enable client portal"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.circuitAccess,onChange:D=>se(n=>({...n,circuitAccess:D.target.checked}))}),e.jsx("span",{children:"Circuit Class Access"})]})}),c.clientType==="block"&&e.jsx("div",{className:"edit-row circuit-row",children:e.jsxs("label",{className:"circuit-access-toggle",children:[e.jsx("input",{type:"checkbox",checked:c.isJunior,onChange:D=>se(n=>({...n,isJunior:D.target.checked}))}),e.jsx("span",{children:"Junior Client (Kids)"})]})}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"save-edit-btn",onClick:()=>ge(t.id),children:"Save"}),e.jsx("button",{className:"cancel-edit-btn",onClick:()=>{F(null)},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-expand-info",children:[e.jsx("span",{className:"client-email",children:t.email}),e.jsx("span",{className:`status-badge ${t.status}`,children:t.status})]}),y?e.jsxs("div",{className:"client-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Block"}),e.jsxs("span",{className:"detail-value",children:[t.weeksInBlock," weeks"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Sessions"}),e.jsxs("span",{className:"detail-value",children:[X(t)," / ",t.totalSessions," remaining"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Booked"}),e.jsxs("span",{className:"detail-value",children:[be(t.id)," sessions"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Duration"}),e.jsxs("span",{className:"detail-value",children:[t.sessionDuration||45," min"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Start"}),e.jsx("span",{className:"detail-value",children:ne(t.startDate)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"End"}),e.jsx("span",{className:"detail-value",children:ne(t.endDate)})]})]}):e.jsxs("div",{className:"client-details circuit-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Type"}),e.jsx("span",{className:"detail-value",children:t.clientType==="circuit_vip"?"Monthly VIP":"Drop-in"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Strikes"}),e.jsxs("span",{className:"detail-value",children:[t.circuitStrikes||0,"/3"]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Joined"}),e.jsx("span",{className:"detail-value",children:ne(t.createdAt)})]})]}),e.jsxs("div",{className:"client-actions",children:[y&&e.jsxs("button",{className:"action-btn notes",onClick:D=>{D.stopPropagation(),Ae(t)},children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),"Notes"]}),e.jsx("button",{className:"action-btn edit",onClick:D=>{D.stopPropagation(),ye(t)},children:"Edit"}),e.jsx("button",{className:"action-btn archive",onClick:D=>{D.stopPropagation(),$e(t.id)},children:t.status==="archived"?"Reactivate":"Archive"}),e.jsx("button",{className:"action-btn delete",onClick:D=>{D.stopPropagation(),de(t.id,t.name)},children:"Delete"})]})]})})]},t.id)};return e.jsxs("div",{className:"client-list",children:[e.jsxs("div",{className:"client-search",children:[e.jsxs("svg",{className:"client-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"M21 21l-4.35-4.35"})]}),e.jsx("input",{type:"text",placeholder:"Search clients...",value:z,onChange:t=>ae(t.target.value),className:"client-search-input"}),z&&e.jsx("button",{className:"client-search-clear",onClick:()=>ae(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("select",{className:"client-type-select",value:d,onChange:t=>xe(t.target.value),children:[e.jsxs("option",{value:"all",children:["All Clients (",A.length,")"]}),e.jsxs("option",{value:"block",children:["Block Members (",R.length,")"]}),e.jsxs("option",{value:"circuit",children:["Circuit Members (",O.length,")"]}),e.jsxs("option",{value:"archived",children:["Archived (",V.length,")"]})]}),d==="all"?e.jsxs(e.Fragment,{children:[R.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Block Members ",e.jsx("span",{children:R.length})]}),R.map(ke)]}),O.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Circuit Members ",e.jsx("span",{children:O.length})]}),O.map(ke)]})]}):d==="archived"?e.jsx(e.Fragment,{children:V.length===0?e.jsx("div",{className:"client-section-empty",children:"No archived clients"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"client-section-header",children:["Archived Clients ",e.jsx("span",{children:V.length})]}),V.map(ke)]})}):e.jsxs(e.Fragment,{children:[Ce.length===0&&e.jsxs("div",{className:"client-section-empty",children:["No ",d," clients found"]}),Ce.map(ke)]}),$&&e.jsx("div",{className:"notes-modal-overlay",onClick:ve,children:e.jsxs("div",{className:"notes-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"notes-modal-header",children:[e.jsxs("h3",{children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"20",height:"20",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),$.clientName]}),e.jsx("button",{className:"notes-modal-close",onClick:ve,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),C==="list"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:Ne?e.jsx("div",{className:"notes-loading",children:"Loading notes..."}):we.length===0?e.jsxs("div",{className:"notes-empty",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",width:"40",height:"40",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]}),e.jsx("p",{children:"No session notes yet"}),e.jsx("span",{children:"Add notes after each session"})]}):e.jsx("div",{className:"notes-list",children:we.map(t=>e.jsxs("div",{className:"note-card",children:[e.jsxs("div",{className:"note-card-header",children:[e.jsx("span",{className:"note-date",children:t.date}),e.jsx("button",{className:"note-delete-btn",onClick:()=>f(t.id),children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"14",height:"14",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})})]}),t.sessionNotes&&e.jsxs("div",{className:"note-section",children:[e.jsx("span",{className:"note-section-label",children:"Session Notes"}),e.jsx("p",{children:t.sessionNotes})]}),t.whatWentWell&&e.jsxs("div",{className:"note-section went-well",children:[e.jsx("span",{className:"note-section-label",children:"What Went Well"}),e.jsx("p",{children:t.whatWentWell})]}),t.whatWentWrong&&e.jsxs("div",{className:"note-section went-wrong",children:[e.jsx("span",{className:"note-section-label",children:"What Went Wrong"}),e.jsx("p",{children:t.whatWentWrong})]}),t.whatsNext&&e.jsxs("div",{className:"note-section whats-next",children:[e.jsx("span",{className:"note-section-label",children:"What's Next"}),e.jsx("p",{children:t.whatsNext})]})]},t.id))})}),e.jsx("div",{className:"notes-modal-footer",children:e.jsxs("button",{className:"notes-add-btn",onClick:()=>q("add"),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add Session Notes"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"notes-modal-body",children:e.jsxs("div",{className:"notes-form",children:[e.jsxs("div",{className:"notes-form-group",children:[e.jsx("label",{children:"Session Notes"}),e.jsx("textarea",{value:E.sessionNotes,onChange:t=>re(s=>({...s,sessionNotes:t.target.value})),placeholder:"Overview of the session...",rows:"3"})]}),e.jsxs("div",{className:"notes-form-group went-well",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),"What Went Well"]}),e.jsx("textarea",{value:E.whatWentWell,onChange:t=>re(s=>({...s,whatWentWell:t.target.value})),placeholder:"Positives from the session...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group went-wrong",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),"What Went Wrong"]}),e.jsx("textarea",{value:E.whatWentWrong,onChange:t=>re(s=>({...s,whatWentWrong:t.target.value})),placeholder:"Areas to improve...",rows:"2"})]}),e.jsxs("div",{className:"notes-form-group whats-next",children:[e.jsxs("label",{children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14",children:e.jsx("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})}),"What's Next"]}),e.jsx("textarea",{value:E.whatsNext,onChange:t=>re(s=>({...s,whatsNext:t.target.value})),placeholder:"Goals for next session...",rows:"2"})]})]})}),e.jsxs("div",{className:"notes-modal-footer",children:[e.jsx("button",{className:"notes-cancel-btn",onClick:()=>q("list"),children:"Back"}),e.jsx("button",{className:"notes-save-btn",onClick:i,disabled:Z,children:Z?"Saving...":"Save Notes"})]})]})]})})]})}const hs=["Mon","Tue","Wed","Thu","Fri"],us=p=>{const L=new Date(p),j=L.getDay(),M=L.getDate()-j+(j===0?-6:1);return L.setDate(M),Pe.map((I,ee)=>{const m=new Date(L);return m.setDate(L.getDate()+ee),m})};function ps(){const[p,L]=h.useState(new Date),[j,M]=h.useState([]),[I,ee]=h.useState([]),[m,F]=h.useState([]),[c,se]=h.useState([]),[W,T]=h.useState([]),[z,ae]=h.useState([]),[d,xe]=h.useState(null),[$,ce]=h.useState(null),[E,re]=h.useState(!1),[we,he]=h.useState(!0),[Ne,l]=h.useState(""),[Z,G]=h.useState([]),[C,q]=h.useState(null),[g,_]=h.useState(!1);h.useEffect(()=>{M(us(p))},[p]),h.useEffect(()=>{ge()},[]);const X=n=>{xe(n),re(!1),ce(null)},be=()=>{if(!d)return null;const n=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),a=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),o=j[0];if(!o)return null;const v=10080*60*1e3,x=Math.floor((o-n)/v)+1,k=d.weeksInBlock||Math.ceil((a-n)/v),P=o>=n&&o<=a;return{startDate:n,endDate:a,weekNumber:x,totalWeeks:k,isWithinBlock:P}},ne=()=>{if(d?.startDate){const n=d.startDate.toDate?d.startDate.toDate():new Date(d.startDate);L(n),ce(null)}},de=()=>{if(d?.endDate){const n=d.endDate.toDate?d.endDate.toDate():new Date(d.endDate);L(n),ce(null)}},ie=n=>{const a=new Date,o=ue(a),v=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`;return m.filter(x=>x.clientId!==n?!1:x.date<o||x.date===o&&x.time<v).length},ye=n=>{const a=ie(n.id);return(n.totalSessions||0)-a},me=n=>{const a=new Date,o=a.getFullYear(),v=(a.getMonth()+1).toString().padStart(2,"0"),x=a.getDate().toString().padStart(2,"0"),k=`${o}-${v}-${x}`,P=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`;return m.filter(J=>J.clientId!==n?!1:J.date>k||J.date===k&&J.time>=P).length},ge=async()=>{try{const a=(await pe(te(S,"clients"))).docs.map(K=>({id:K.id,...K.data()})).filter(K=>K.status==="active").sort((K,le)=>K.name.localeCompare(le.name));ee(a);const v=(await pe(te(S,"sessions"))).docs.map(K=>({id:K.id,...K.data()}));F(v);const k=(await pe(te(S,"holidays"))).docs.map(K=>({id:K.id,...K.data()}));se(k);const J=(await pe(te(S,"blockedTimes"))).docs.map(K=>({id:K.id,...K.data()}));T(J);const Y=(await pe(te(S,"openedSlots"))).docs.map(K=>({id:K.id,...K.data()}));ae(Y);const je=(await pe(te(S,"sessionNotes"))).docs.map(K=>({id:K.id,...K.data()}));G(je)}catch(n){console.error("Error fetching data:",n)}he(!1)},$e=n=>Z.some(a=>a.clientId===n.clientId&&a.date===n.date),Ae=(n,a)=>{if(!d)return"Unavailable";const o=d.sessionDuration||45,v=ue(n),x=Fe(a),k=x+o,P=m.find(Y=>{if(Y.date!==v)return!1;const Q=Fe(Y.time),je=Q+(Y.duration||45);return x<je&&k>Q});if(P)return`Taken — ${P.clientName}`;const J=Pe[n.getDay()-1],B=ze[J];if(B){const Y=Ue(a,o),Q=B.morning&&a>=B.morning.start&&a<B.morning.end,je=B.afternoon&&a>=B.afternoon.start&&a<B.afternoon.end;if(Q&&Y>B.morning.end)return"Splits break";if(je&&Y>B.afternoon.end)return"Overruns end"}return"Unavailable"},ve=n=>{const a=I.find(B=>B.id===n.clientId);if(!a||!a.startDate||!a.endDate)return[];const o=a.startDate?.toDate?a.startDate.toDate():new Date(a.startDate),v=a.endDate?.toDate?a.endDate.toDate():new Date(a.endDate),x=new Date,k=new Date(x.getFullYear(),x.getMonth(),x.getDate()),P=[],J=new Date(Math.max(o.getTime(),k.getTime()));for(;J<=v;){const B=J.getDay();if(B>=1&&B<=5){const Y=ue(J);c.some(Q=>Q.date===Y)||P.push(new Date(J))}J.setDate(J.getDate()+1)}return P},i=(n,a)=>a?ds(a,n.duration||45,m,c,n.id,W,z):[],f=async n=>{if(q(null),window.confirm(`Cancel ${n.clientName}'s session at ${qe(n.time)}?`))try{await Be(oe(S,"sessions",n.id)),F(m.filter(a=>a.id!==n.id))}catch(a){console.error("Error cancelling session:",a),alert("Failed to cancel session")}},w=async(n,a,o)=>{_(!0);try{const v=ue(a);await De(oe(S,"sessions",n.id),{date:v,time:o}),F(m.map(x=>x.id===n.id?{...x,date:v,time:o}:x)),q(null)}catch(v){console.error("Error rescheduling session:",v),alert("Failed to reschedule session")}_(!1)},b=n=>{const a=new Date(p);a.setDate(a.getDate()+n*7),L(a),ce(null)},U=()=>{L(new Date),ce(null)},H=n=>{const a=ue(n);return c.some(o=>o.date===a)},A=(n,a)=>{const o=ue(n);return W.some(v=>v.date===o&&v.time===a)},R=(n,a)=>{const o=ue(n);return z.some(v=>v.date===o&&v.time===a)},O=n=>{const a=Pe[n.getDay()-1];return a&&ze[a]?.defaultBlocked},V=async(n,a)=>{const o=ue(n);if(O(n)){const x=z.find(k=>k.date===o&&k.time===a);try{if(x)await Be(oe(S,"openedSlots",x.id)),ae(z.filter(k=>k.id!==x.id));else{const k=await We(te(S,"openedSlots"),{date:o,time:a,createdAt:fe.now()});ae([...z,{id:k.id,date:o,time:a}])}}catch(k){console.error("Error toggling opened slot:",k),alert("Failed to update time slot")}return}const v=W.find(x=>x.date===o&&x.time===a);try{if(v)await Be(oe(S,"blockedTimes",v.id)),T(W.filter(x=>x.id!==v.id));else{const x=await We(te(S,"blockedTimes"),{date:o,time:a,createdAt:fe.now()});T([...W,{id:x.id,date:o,time:a}])}}catch(x){console.error("Error toggling blocked time:",x),alert("Failed to update time slot")}},Ce=n=>{const a=ue(n);return m.filter(o=>o.date===a)},Te=(n,a)=>{const o=ue(n);return m.find(v=>v.date===o&&v.time===a)},ke=(n,a)=>{const o=ue(n),v=Fe(a);return m.find(x=>{if(x.date!==o)return!1;const k=Fe(x.time),P=k+(x.duration||45);return v>=k&&v<P})},t=(n,a,o)=>{const v=Pe[n.getDay()-1];if(!v||H(n))return!1;const x=ze[v],k=Math.ceil(o/15);if(x.defaultBlocked)for(let le=0;le<k;le++){const Se=Ue(a,le*15);if(!R(n,Se))return!1}else for(let le=0;le<k;le++){const Se=Ue(a,le*15);if(A(n,Se))return!1}const P=ue(n);if(m.find(le=>le.date===P&&le.time===a))return!1;const B=Ue(a,o),Y=x.morning&&B<=x.morning.end,Q=x.afternoon&&B<=x.afternoon.end,je=x.morning&&a>=x.morning.start&&a<x.morning.end,K=x.afternoon&&a>=x.afternoon.start&&a<x.afternoon.end;if(je&&!Y||K&&!Q)return!1;for(const le of m){if(le.date!==P)continue;const Se=Fe(le.time),Ve=Se+(le.duration||45),Le=Fe(a),Me=Le+o;if(Le<Ve&&Me>Se)return!1}return!0},s=async(n,a)=>{const o=ke(n,a);if(o){if(Ie(o))return;q({session:o,step:"action",selectedDate:null,selectedTime:null});return}if(!d){alert("Please select a client first");return}if(!t(n,a,d.sessionDuration||45)){alert("This slot is not available for this client's session duration");return}const v=me(d.id);if(ie(d.id)+v>=d.totalSessions){alert(`${d.name} has used all ${d.totalSessions} sessions in their package`);return}try{const k=ue(n),P={clientId:d.id,clientName:d.name,date:k,time:a,duration:d.sessionDuration||45,createdAt:fe.now()},J=await We(te(S,"sessions"),P);F([...m,{id:J.id,...P}])}catch(k){console.error("Error booking session:",k),alert("Failed to book session")}},u=async()=>{if(!d)return;const n=d.startDate?.toDate?d.startDate.toDate():new Date(d.startDate),a=d.endDate?.toDate?d.endDate.toDate():new Date(d.endDate),o=m.filter(B=>B.clientId!==d.id?!1:j.some(Y=>ue(Y)===B.date));if(o.length===0){alert("No sessions in current week to repeat. Book some sessions first, then use this button.");return}const v=d.weeksInBlock||Math.ceil((a-n)/(10080*60*1e3)),x=o.map(B=>({dayOfWeek:new Date(B.date).getDay(),time:B.time}));let k=[];const P=me(d.id)+ie(d.id);for(let B=0;B<v;B++){const Y=new Date(n);Y.setDate(Y.getDate()+B*7);const Q=new Date(Y),je=Q.getDay(),K=Q.getDate()-je+(je===0?-6:1);Q.setDate(K);for(const le of x){const Se=new Date(Q),Ve=le.dayOfWeek===0?6:le.dayOfWeek-1;Se.setDate(Q.getDate()+Ve);const Le=ue(Se);m.some(Me=>Me.clientId===d.id&&Me.date===Le&&Me.time===le.time)||Se<n||Se>a||c.some(Me=>Me.date===Le)||k.push({dateKey:Le,time:le.time,sessionDate:Se})}}const J=P+k.length;if(J>d.totalSessions){alert(`This would create ${k.length} new sessions (${J} total), but client only has ${d.totalSessions} sessions in their package.

You can still book ${d.totalSessions-P} more sessions.`);return}if(k.length===0){alert("All weeks already have sessions booked for this pattern.");return}if(window.confirm(`This will create ${k.length} new sessions across the block.

(${P} existing + ${k.length} new = ${J} total)

Continue?`))try{const B=[];for(const Y of k){const Q={clientId:d.id,clientName:d.name,date:Y.dateKey,time:Y.time,duration:d.sessionDuration||45,createdAt:fe.now()},je=await We(te(S,"sessions"),Q);B.push({id:je.id,...Q})}F([...m,...B]),alert(`Created ${B.length} new sessions!`)}catch(B){console.error("Error repeating weekly:",B),alert("Failed to repeat sessions")}},y=async n=>{const a=ue(n),o=c.find(v=>v.date===a);try{if(o)await Be(oe(S,"holidays",o.id)),se(c.filter(v=>v.id!==o.id));else{const v=await We(te(S,"holidays"),{date:a,createdAt:fe.now()});se([...c,{id:v.id,date:a}])}}catch(v){console.error("Error toggling day availability:",v),alert("Failed to update day availability")}};if(we)return e.jsx("div",{className:"calendar-loading",children:"Loading calendar..."});const r=j[0],N=j[4],D=r&&N?`${r.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${N.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`:"";return e.jsxs("div",{className:"calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsxs("div",{className:"calendar-nav",children:[e.jsx("button",{onClick:()=>b(-1),children:"←"}),e.jsx("button",{onClick:U,children:"Today"}),e.jsx("button",{onClick:()=>b(1),children:"→"})]}),e.jsx("h3",{children:D})]}),e.jsxs("div",{className:"client-selector",children:[e.jsx("span",{className:"selector-label",children:"Booking for:"}),d?e.jsxs("div",{className:"selected-client",children:[e.jsxs("div",{className:"selected-info",children:[e.jsx("strong",{children:d.name}),e.jsxs("span",{children:[d.sessionDuration||45,"min • ",ye(d),"/",d.totalSessions," remaining"]}),e.jsxs("span",{className:"booked-info",children:[me(d.id)," booked"]})]}),e.jsx("button",{onClick:()=>xe(null),children:"Change"})]}):e.jsx("button",{className:"select-client-btn",onClick:()=>re(!0),children:"Select Client"})]}),d&&d.startDate&&d.endDate&&(()=>{const n=be();return n?e.jsxs("div",{className:"block-nav",children:[e.jsx("button",{onClick:ne,children:"← Block Start"}),e.jsx("span",{className:"block-range",children:n.isWithinBlock?`Week ${n.weekNumber} of ${n.totalWeeks}`:j[0]<n.startDate?"Before block":"After block"}),e.jsx("button",{onClick:de,children:"Block End →"})]}):null})(),d&&e.jsxs("div",{className:"repeat-weekly-section",children:[e.jsx("button",{className:"repeat-weekly-btn",onClick:u,children:"Repeat This Week's Schedule For All Weeks"}),e.jsx("span",{className:"repeat-hint",children:"Copies current week's sessions to all weeks in block"})]}),e.jsx("div",{className:"day-cards",children:j.map((n,a)=>{const o=Ce(n),v=ue(n)===ue(new Date),x=H(n);return e.jsxs("div",{className:`day-card ${$===a?"selected":""} ${v?"today":""} ${x?"holiday":""}`,onClick:()=>ce($===a?null:a),children:[e.jsxs("div",{className:"day-card-header",children:[e.jsx("span",{className:"day-name",children:hs[a]}),e.jsx("span",{className:"day-date",children:n.getDate()})]}),x?e.jsx("div",{className:"day-card-status holiday",children:"Unavailable"}):e.jsxs("div",{className:"day-card-status",children:[o.length," session",o.length!==1?"s":""]})]},a)})}),$!==null&&j[$]&&e.jsxs("div",{className:"time-panel",children:[e.jsxs("div",{className:"time-panel-header",children:[e.jsxs("h4",{children:[rs[$]," ",j[$].getDate()]}),e.jsx("button",{className:"close-panel",onClick:()=>ce(null),children:"×"})]}),e.jsx("div",{className:"availability-toggle",children:e.jsx("button",{className:`toggle-availability-btn ${H(j[$])?"unavailable":"available"}`,onClick:()=>y(j[$]),children:H(j[$])?"Mark Day Available":"Mark Day Unavailable"})}),H(j[$])?e.jsxs("div",{className:"day-unavailable-message",children:[e.jsx("p",{children:"This day is marked as unavailable"}),e.jsx("span",{children:"Tap the button above to make it available again"})]}):e.jsxs("div",{className:"time-slots",children:[O(j[$])&&e.jsx("div",{className:"default-blocked-notice",children:"Flex day — slots are closed by default. Tap the toggle to open slots."}),cs(Pe[$]).map(({time:n,period:a},o,v)=>{const x=Te(j[$],n),k=ke(j[$],n),P=!!k,J=!x&&!!k,B=k?Ie(k):!1,Y=O(j[$]),Q=Y?!R(j[$],n):A(j[$],n),je=Y&&R(j[$],n),K=d&&!P&&t(j[$],n,d.sessionDuration||45),le=o===0||v[o-1]?.period!==a;return e.jsxs("div",{children:[le&&e.jsx("div",{className:"period-label",children:a==="morning"?"Morning":"Afternoon"}),e.jsxs("div",{className:"time-slot-row",children:[e.jsxs("button",{className:`time-slot ${P&&B?"completed":""} ${P&&!B?"booked":""} ${J?"booked-continuation":""} ${Q&&!P?"blocked":""} ${je&&!P?"opened":""} ${K?"available":""} ${!P&&!Q&&!K&&d?"unavailable":""}`,onClick:()=>!B&&(!Q||P)&&s(j[$],n),disabled:B||Q&&!P,children:[e.jsx("span",{className:"slot-time",children:qe(n)}),x&&B?e.jsxs("span",{className:"slot-done",children:[x.clientName," (",x.duration,"m) ✓",$e(x)&&e.jsx("span",{className:"note-dot",title:"Has session note"})]}):x?e.jsxs("span",{className:"slot-client",children:[x.clientName," (",x.duration,"m)"]}):J&&B?e.jsxs("span",{className:"slot-done",children:[k.clientName," ↑"]}):J?e.jsxs("span",{className:"slot-client",children:[k.clientName," ↑"]}):Q?e.jsx("span",{className:"slot-blocked",children:Y?"Closed":"Blocked"}):K?e.jsx("span",{className:"slot-available",children:"Available"}):d?e.jsx("span",{className:"slot-unavailable",children:Ae(j[$],n)}):je?e.jsx("span",{className:"slot-available",children:"Open"}):e.jsx("span",{className:"slot-empty",children:"Select client to book"})]}),e.jsx("button",{className:`block-toggle-btn ${Y?je?"is-opened":"":Q?"is-blocked":""}`,onClick:()=>V(j[$],n),disabled:B||!!P,title:Y?je?"Close this slot":"Open this slot":Q?"Unblock this time":"Block this time",children:Y?je?"✓":"+":Q?"✓":"✕"})]})]},n)})]})]}),C&&e.jsx("div",{className:"modal-overlay",onClick:()=>q(null),children:e.jsxs("div",{className:"modal-content",onClick:n=>n.stopPropagation(),children:[C.step==="action"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:C.session.clientName}),e.jsx("button",{className:"close-btn",onClick:()=>q(null),children:"×"})]}),e.jsxs("div",{className:"edit-session-info",children:[e.jsx("p",{className:"edit-session-date",children:new Date(C.session.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short",timeZone:"UTC"})}),e.jsxs("p",{className:"edit-session-time",children:[qe(C.session.time)," · ",C.session.duration,"min"]})]}),e.jsxs("div",{className:"edit-actions",children:[e.jsx("button",{className:"reschedule-edit-btn",onClick:()=>q({...C,step:"date"}),children:"Reschedule"}),e.jsx("button",{className:"cancel-session-btn",onClick:()=>f(C.session),children:"Cancel Session"})]})]}),C.step==="date"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>q({...C,step:"action"}),children:"←"}),e.jsx("h3",{children:"Pick New Date"}),e.jsx("button",{className:"close-btn",onClick:()=>q(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const n=ve(C.session);return n.length===0?e.jsx("p",{className:"no-items",children:"No available dates in block"}):n.map(a=>{const o=ue(a);return e.jsx("button",{className:"client-option date-option",onClick:()=>q({...C,step:"time",selectedDate:a,selectedTime:null}),children:a.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"})},o)})})()})]}),C.step==="time"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("button",{className:"close-btn",onClick:()=>q({...C,step:"date",selectedTime:null}),children:"←"}),e.jsx("h3",{children:C.selectedDate?.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("button",{className:"close-btn",onClick:()=>q(null),children:"×"})]}),e.jsx("div",{className:"client-list-picker",children:(()=>{const n=i(C.session,C.selectedDate);return n.length===0?e.jsx("p",{className:"no-items",children:"No available slots on this day"}):n.map(a=>e.jsxs("button",{className:`client-option time-option ${C.selectedTime===a.time?"selected":""}`,onClick:()=>q({...C,selectedTime:a.time}),children:[qe(a.time),e.jsx("span",{className:"time-option-period",children:a.period})]},a.time))})()}),C.selectedTime&&e.jsx("div",{className:"edit-confirm-bar",children:e.jsx("button",{className:"confirm-reschedule-btn",onClick:()=>w(C.session,C.selectedDate,C.selectedTime),disabled:g,children:g?"Saving...":`Confirm — ${qe(C.selectedTime)}`})})]})]})}),E&&e.jsx("div",{className:"modal-overlay",onClick:()=>{re(!1),l("")},children:e.jsxs("div",{className:"modal-content",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Select Client"}),e.jsx("button",{className:"close-btn",onClick:()=>{re(!1),l("")},children:"×"})]}),e.jsx("div",{className:"client-search-wrapper",children:e.jsx("input",{className:"client-search-input",type:"text",placeholder:"Search by name...",value:Ne,onChange:n=>l(n.target.value),autoFocus:!0})}),e.jsx("div",{className:"client-list-picker",children:I.length===0?e.jsx("p",{className:"no-items",children:"No active clients"}):(()=>{const n={block:"Block",circuit_vip:"Circuit VIP",circuit_dropin:"Circuit Drop-in"},a=I.filter(o=>o.name.toLowerCase().includes(Ne.toLowerCase()));return a.length===0?e.jsxs("p",{className:"no-items",children:['No clients match "',Ne,'"']}):a.map(o=>{const v=o.startDate&&o.endDate,x=v?o.startDate?.toDate?o.startDate.toDate():new Date(o.startDate):null,k=v?o.endDate?.toDate?o.endDate.toDate():new Date(o.endDate):null,P=ye(o),J=me(o.id);return e.jsxs("button",{className:"client-option",onClick:()=>{X(o),l("")},children:[e.jsxs("div",{className:"client-option-header",children:[e.jsx("strong",{children:o.name}),o.clientType&&e.jsx("span",{className:"client-type-badge",children:n[o.clientType]||o.clientType})]}),e.jsxs("span",{children:[o.sessionDuration||45,"min • ",P,"/",o.totalSessions," remaining • ",J," booked"]}),x&&k&&e.jsxs("span",{className:"client-dates",children:[x.toLocaleDateString("en-GB",{day:"numeric",month:"short"})," – ",k.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]},o.id)})})()})]})})]})}const Ge=p=>{const[L,j]=p.split(":"),M=parseInt(L),I=M>=12?"pm":"am";return`${M>12?M-12:M===0?12:M}:${j}${I}`},He=p=>{const L=p.getFullYear(),j=(p.getMonth()+1).toString().padStart(2,"0"),M=p.getDate().toString().padStart(2,"0");return`${L}-${j}-${M}`},Je=p=>p===He(new Date),xs=p=>{const L=new Date;return L.setDate(L.getDate()+1),p===He(L)},Ye=p=>Je(p)?"Today":xs(p)?"Tomorrow":new Date(p).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"short"}),js=p=>{if(p.length===0)return[];const L=new Date,j=new Date(L),M=j.getDay();j.setDate(j.getDate()-(M===0?6:M-1)),j.setHours(0,0,0,0);const I=new Date(j);I.setDate(I.getDate()+7);const ee=new Date(I);ee.setDate(ee.getDate()+7);const m=new Map;return p.forEach(F=>{const[c,se,W]=F.split("-").map(Number),T=new Date(c,se-1,W);let z,ae,d;T<I?(z="this-week",ae="This Week",d=0):T<ee?(z="next-week",ae="Next Week",d=1):(z=`${T.getFullYear()}-${T.getMonth()}`,ae=T.toLocaleDateString("en-GB",{month:"long",year:"numeric"}),d=100+T.getFullYear()*12+T.getMonth()),m.has(z)||m.set(z,{key:z,label:ae,order:d,dates:[]}),m.get(z).dates.push(F)}),Array.from(m.values()).sort((F,c)=>F.order-c.order)};function fs(){const[p,L]=h.useState([]),[j,M]=h.useState(!0),[I,ee]=h.useState(new Date),[m,F]=h.useState(""),[c,se]=h.useState(""),[W,T]=h.useState(!1),[z,ae]=h.useState(new Set);h.useEffect(()=>{d();const g=setInterval(()=>ee(new Date),6e4);return()=>clearInterval(g)},[]);const d=async()=>{try{const _=(await pe(te(S,"sessions"))).docs.map(ne=>({id:ne.id,...ne.data()})),X=He(new Date),be=_.filter(ne=>ne.date>=X).sort((ne,de)=>ne.date!==de.date?ne.date.localeCompare(de.date):ne.time.localeCompare(de.time));L(be)}catch(g){console.error("Error fetching sessions:",g)}M(!1)},xe=async g=>{if(window.confirm(`Cancel ${g.clientName}'s session at ${Ge(g.time)} on ${Ye(g.date)}?`))try{await Be(oe(S,"sessions",g.id)),L(p.filter(_=>_.id!==g.id))}catch(_){console.error("Error cancelling session:",_),alert("Failed to cancel session")}},$=g=>{ae(_=>{const X=new Set(_);return X.has(g)?X.delete(g):X.add(g),X})};if(j)return e.jsx("div",{className:"schedule-loading",children:"Loading schedule..."});const ce=c?p.filter(g=>g.clientName.toLowerCase().includes(c.toLowerCase())):p,E=ce.reduce((g,_)=>(g[_.date]||(g[_.date]=[]),g[_.date].push(_),g),{}),re=Object.keys(E).sort(),we=He(new Date),he=E[we]||[],Ne=he.filter(g=>Ie(g)).length,l=he.length-Ne,Z=ce.find(g=>!Ie(g)),C=(()=>{if(!Z||Z.date!==He(new Date))return null;const[g,_]=Z.time.split(":").map(Number),X=g*60+_-(new Date().getHours()*60+new Date().getMinutes());return X<=0||X>180?null:X<60?`${X}m`:`${Math.floor(X/60)}h ${X%60}m`})(),q=js(re);return e.jsxs("div",{className:"schedule",children:[e.jsxs("div",{className:"today-summary",children:[e.jsx("h3",{children:"Today's Sessions"}),e.jsx("div",{className:"today-count",children:he.length===0?e.jsx("span",{className:"no-sessions",children:"No sessions today"}):e.jsxs("div",{className:"today-stats",children:[e.jsxs("span",{className:"completed-count",children:[Ne," completed"]}),e.jsxs("span",{className:"remaining-count",children:[l," remaining"]})]})}),Ne>0&&e.jsx("button",{className:"hide-completed-btn",onClick:()=>T(g=>!g),children:W?"Show all":"Hide done"})]}),Z&&C&&e.jsxs("div",{className:"next-session-banner",children:[e.jsx("div",{className:"next-session-label",children:"Up next"}),e.jsxs("div",{className:"next-session-info",children:[e.jsx("span",{className:"next-session-name",children:Z.clientName}),e.jsx("span",{className:"next-session-time",children:Ge(Z.time)})]}),e.jsx("div",{className:"next-session-countdown",children:C})]}),re.length===0?e.jsx("div",{className:"no-upcoming",children:e.jsx("p",{children:c?`No sessions found for "${c}"`:"No upcoming sessions booked"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"schedule-controls",children:[e.jsx("input",{className:"client-filter-input",type:"text",placeholder:"Filter by client...",value:c,onChange:g=>se(g.target.value)}),e.jsxs("select",{className:"date-jump-select",value:m,onChange:g=>{const _=g.target.value;F(_),_&&(document.getElementById(`date-${_}`)?.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>F(""),600))},children:[e.jsx("option",{value:"",children:"Jump to date..."}),re.map(g=>e.jsxs("option",{value:g,children:[Ye(g)," (",E[g].length,")"]},g))]})]}),e.jsx("div",{className:"sessions-list",children:q.map(({key:g,label:_,dates:X})=>{const ne=g!=="this-week"&&g!=="next-week"?!z.has(g):z.has(g),de=X.reduce((ie,ye)=>ie+E[ye].length,0);return e.jsxs("div",{className:"week-group",children:[e.jsxs("button",{className:`week-group-header ${ne?"collapsed":""}`,onClick:()=>$(g),children:[e.jsx("span",{className:"week-label",children:_}),e.jsxs("span",{className:"week-count",children:[de," session",de!==1?"s":""]}),e.jsx("span",{className:"week-chevron",children:ne?"▸":"▾"})]}),!ne&&e.jsx("div",{className:"week-group-body",children:X.map(ie=>{const ye=E[ie],me=W&&Je(ie)?ye.filter(ge=>!Ie(ge)):ye;return e.jsxs("div",{id:`date-${ie}`,className:`date-group ${Je(ie)?"today":""}`,children:[e.jsxs("div",{className:"date-header",children:[e.jsx("span",{className:"date-label",children:Ye(ie)}),e.jsxs("span",{className:"date-count",children:[ye.length," session",ye.length!==1?"s":""]})]}),e.jsx("div",{className:"date-sessions",children:me.length===0?e.jsx("div",{className:"all-done-msg",children:"All sessions completed ✓"}):me.map(ge=>{const $e=Ie(ge);return e.jsxs("div",{className:`session-card ${$e?"completed":""}`,children:[e.jsx("div",{className:"session-time",children:Ge(ge.time)}),e.jsxs("div",{className:"session-details",children:[e.jsx("strong",{children:ge.clientName}),e.jsxs("span",{children:[ge.duration,"min session"]})]}),$e?e.jsx("div",{className:"completed-badge",children:"✓"}):e.jsx("button",{className:"cancel-session-btn",onClick:()=>xe(ge),children:"Cancel"})]},ge.id)})})]},ie)})})]},g)})})]})]})}const gs={sedentary:"Sedentary (little to no exercise)",light:"Lightly Active (1-2 days/week)",moderate:"Moderately Active (3-4 days/week)",active:"Very Active (5+ days/week)",athlete:"Athlete/Highly Active"},vs={"less-5":"Less than 5 hours","5-6":"5-6 hours","7-8":"7-8 hours","more-8":"More than 8 hours"},Ns={low:"Low",moderate:"Moderate",high:"High","very-high":"Very High"},ys=[{key:"q1HeartCondition",text:"Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor?"},{key:"q2ChestPain",text:"Do you feel pain in your chest when you do physical activity?"},{key:"q3ChestPainLastMonth",text:"In the past month, have you had chest pain when you were not doing physical activity?"},{key:"q4Balance",text:"Do you lose your balance because of dizziness or do you ever lose consciousness?"},{key:"q5BoneJoint",text:"Do you have a bone or joint problem that could be made worse by a change in your physical activity?"},{key:"q6BloodPressure",text:"Is your doctor currently prescribing drugs for your blood pressure or heart condition?"},{key:"q7OtherReason",text:"Do you know of any other reason why you should not do physical activity?"}];function ws(){const[p,L]=h.useState([]),[j,M]=h.useState(!0),[I,ee]=h.useState(null),[m,F]=h.useState(null),[c,se]=h.useState("all"),[W,T]=h.useState("");h.useEffect(()=>{z()},[]);const z=async()=>{try{const Z=(await pe(te(S,"clients"))).docs.map(G=>({id:G.id,...G.data()}));Z.sort((G,C)=>(G.name||"").localeCompare(C.name||"")),L(Z)}catch(l){console.error("Error fetching clients:",l)}M(!1)},ae=l=>!!l.welcomeForm?.completedAt,d=l=>!!l.parqForm?.completedAt,xe=l=>ae(l)||d(l),$=l=>ae(l)&&d(l),ce=l=>l?(l.toDate?l.toDate():new Date(l)).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"",E=p.filter(l=>!W||l.name?.toLowerCase().includes(W.toLowerCase())?c==="all"?!0:c==="completed"?$(l):c==="partial"?xe(l)&&!$(l):c==="pending"?!xe(l):!0:!1),re=p.filter($).length,we=p.filter(l=>xe(l)&&!$(l)).length,he=p.filter(l=>!xe(l)).length,Ne=l=>{I===l?(ee(null),F(null)):(ee(l),F(null))};return j?e.jsx("div",{className:"forms-loading",children:"Loading form submissions..."}):e.jsxs("div",{className:"form-submissions",children:[e.jsxs("div",{className:"forms-stats",children:[e.jsxs("div",{className:"forms-stat",children:[e.jsx("span",{className:"stat-number",children:re}),e.jsx("span",{className:"stat-label",children:"Complete"})]}),e.jsxs("div",{className:"forms-stat partial",children:[e.jsx("span",{className:"stat-number",children:we}),e.jsx("span",{className:"stat-label",children:"Partial"})]}),e.jsxs("div",{className:"forms-stat pending",children:[e.jsx("span",{className:"stat-number",children:he}),e.jsx("span",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"forms-search",children:[e.jsxs("svg",{className:"forms-search-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"})]}),e.jsx("input",{type:"text",className:"forms-search-input",placeholder:"Search clients...",value:W,onChange:l=>T(l.target.value)}),W&&e.jsx("button",{className:"forms-search-clear",onClick:()=>T(""),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"forms-filter",children:[e.jsxs("button",{className:`forms-filter-btn ${c==="all"?"active":""}`,onClick:()=>se("all"),children:["All ",e.jsx("span",{className:"forms-filter-count",children:p.length})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="completed"?"active":""}`,onClick:()=>se("completed"),children:["Complete ",e.jsx("span",{className:"forms-filter-count",children:re})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="partial"?"active":""}`,onClick:()=>se("partial"),children:["Partial ",e.jsx("span",{className:"forms-filter-count",children:we})]}),e.jsxs("button",{className:`forms-filter-btn ${c==="pending"?"active":""}`,onClick:()=>se("pending"),children:["Pending ",e.jsx("span",{className:"forms-filter-count",children:he})]})]}),E.length===0?e.jsxs("div",{className:"forms-empty",children:[e.jsx("div",{className:"forms-empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"15",width:"60",height:"70",rx:"4"}),e.jsx("path",{d:"M35 35h30M35 50h30M35 65h20"}),e.jsx("circle",{cx:"70",cy:"70",r:"18",fill:"var(--bg-card)",strokeWidth:"3"}),e.jsx("path",{d:"M63 70h14M70 63v14",strokeWidth:"3",strokeLinecap:"round"})]})}),e.jsx("p",{children:"No clients match this filter"}),e.jsx("span",{children:"Try adjusting your search or filter"})]}):e.jsx("div",{className:"forms-client-list",children:E.map(l=>{const Z=I===l.id,G=ae(l),C=d(l);return e.jsxs("div",{className:`forms-client-card ${Z?"expanded":""}`,children:[e.jsxs("div",{className:"forms-client-row",onClick:()=>Ne(l.id),children:[e.jsxs("div",{className:"forms-client-left",children:[e.jsx("div",{className:"forms-client-initial",children:(l.name||"?")[0].toUpperCase()}),e.jsxs("div",{className:"forms-client-info",children:[e.jsx("h3",{children:l.name||"Unknown"}),e.jsxs("div",{className:"forms-badges",children:[e.jsxs("span",{className:`form-badge ${G?"done":"not-done"}`,children:[G?"✓":"○"," Welcome"]}),e.jsxs("span",{className:`form-badge ${C?"done":"not-done"}`,children:[C?"✓":"○"," PAR-Q"]})]})]})]}),e.jsx("svg",{className:`forms-chevron ${Z?"open":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})]}),Z&&e.jsx("div",{className:"forms-expand-panel",children:!G&&!C?e.jsxs("div",{className:"forms-no-data",children:[e.jsx("p",{children:"No forms submitted yet"}),e.jsx("span",{children:"This client hasn't completed any forms"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"forms-toggle",children:[G&&e.jsx("button",{className:`forms-toggle-btn ${m==="welcome"||!m&&G?"active":""}`,onClick:()=>F("welcome"),children:"Welcome Questionnaire"}),C&&e.jsx("button",{className:`forms-toggle-btn ${m==="parq"||!m&&!G&&C?"active":""}`,onClick:()=>F("parq"),children:"PAR-Q Health Screening"})]}),(m==="welcome"||!m&&G)&&G&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"Welcome Questionnaire"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",ce(l.welcomeForm.completedAt)]})]}),l.welcomeForm.fitnessGoals&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Fitness Goals"}),e.jsx("p",{children:l.welcomeForm.fitnessGoals})]}),l.welcomeForm.currentActivityLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Activity Level"}),e.jsx("p",{children:gs[l.welcomeForm.currentActivityLevel]||l.welcomeForm.currentActivityLevel})]}),l.welcomeForm.exerciseHistory&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Exercise History"}),e.jsx("p",{children:l.welcomeForm.exerciseHistory})]}),l.welcomeForm.injuries&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Injuries"}),e.jsx("p",{children:l.welcomeForm.injuries})]}),l.welcomeForm.medicalConditions&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Medical Conditions"}),e.jsx("p",{children:l.welcomeForm.medicalConditions})]}),l.welcomeForm.sleepHours&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Sleep"}),e.jsx("p",{children:vs[l.welcomeForm.sleepHours]||l.welcomeForm.sleepHours})]}),l.welcomeForm.stressLevel&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Stress Level"}),e.jsx("p",{children:Ns[l.welcomeForm.stressLevel]||l.welcomeForm.stressLevel})]}),l.welcomeForm.dietaryInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Diet / Nutrition"}),e.jsx("p",{children:l.welcomeForm.dietaryInfo})]}),l.welcomeForm.availability&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Availability"}),e.jsx("p",{children:l.welcomeForm.availability})]}),l.welcomeForm.additionalInfo&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Info"}),e.jsx("p",{children:l.welcomeForm.additionalInfo})]})]}),m==="parq"&&C&&e.jsxs("div",{className:"form-data",children:[e.jsxs("div",{className:"form-data-header",children:[e.jsx("span",{className:"form-data-title",children:"PAR-Q Health Screening"}),e.jsxs("span",{className:"form-data-date",children:["Submitted ",ce(l.parqForm.completedAt)]})]}),e.jsx("div",{className:"parq-results",children:ys.map(q=>{const g=l.parqForm[q.key];return e.jsxs("div",{className:`parq-result-item ${g?"flagged":""}`,children:[e.jsx("span",{className:`parq-answer ${g?"yes":"no"}`,children:g?"YES":"NO"}),e.jsx("span",{className:"parq-question-text",children:q.text})]},q.key)})}),l.parqForm.additionalDetails&&e.jsxs("div",{className:"form-data-field",children:[e.jsx("label",{children:"Additional Details"}),e.jsx("p",{children:l.parqForm.additionalDetails})]}),e.jsx("div",{className:"parq-declaration-status",children:e.jsx("span",{className:l.parqForm.declaration?"declared":"not-declared",children:l.parqForm.declaration?"✓ Declaration signed":"✗ Declaration not signed"})})]})]})})]},l.id)})})]})}const Ke=p=>`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}-${String(p.getDate()).padStart(2,"0")}`,Ze=p=>new Date(p+"T09:00:00").toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),Xe=()=>{const p=new Date;let j=(6-p.getDay()+7)%7;if(j===0){const I=new Date(p);I.setHours(9,45,0,0),p>I&&(j=7)}const M=new Date(p);return M.setDate(p.getDate()+j),M},Oe=p=>p==="circuit_vip"?"VIP":p==="circuit_dropin"?"Drop-in":"Block",_e=p=>p==="circuit_vip"?"vip":p==="circuit_dropin"?"dropin":"block";function bs(){const[p,L]=h.useState(!0),[j,M]=h.useState([]),[I,ee]=h.useState([]),[m,F]=h.useState(null),[c,se]=h.useState("upcoming"),[W,T]=h.useState(!1),[z,ae]=h.useState(null),[d,xe]=h.useState(!1),[$,ce]=h.useState(!1),E=h.useCallback((i,f="info")=>{ae({message:i,type:f}),setTimeout(()=>ae(null),4e3)},[]);h.useEffect(()=>{re()},[]);const re=async()=>{try{const f=(await pe(te(S,"circuitSessions"))).docs.map(A=>({id:A.id,...A.data()}));f.sort((A,R)=>R.date.localeCompare(A.date)),M(f);const b=(await pe(te(S,"clients"))).docs.map(A=>({id:A.id,...A.data()})).filter(A=>A.clientType==="circuit_vip"||A.clientType==="circuit_dropin"||A.circuitAccess===!0);ee(b);const U=Ke(Xe());let H=f.find(A=>A.date===U);if(!H){const A=b.filter(V=>V.clientType==="circuit_vip"&&V.status==="active"),R=[];for(let V=0;V<8;V++)V<A.length?R.push({slotNumber:V+1,memberId:A[V].id,memberName:A[V].name,memberType:"circuit_vip",status:"confirmed",bookedAt:fe.now()}):R.push({slotNumber:V+1,memberId:null,memberName:null,memberType:null,status:"available"});const O={date:U,time:"09:00",endTime:"09:45",maxCapacity:8,slots:R,waitlist:[],createdAt:fe.now()};await as(oe(S,"circuitSessions",U),O),H={id:U,...O},f.unshift(H),M([...f])}H?F(H):f.length>0&&F(f[0])}catch(i){console.error("Error loading circuit data:",i),E("Failed to load circuit data","error")}L(!1)},we=async i=>{if(!(!m||W)&&window.confirm("Remove this member from the slot?")){T(!0);try{const f=[...m.slots],w=f.findIndex(O=>O.slotNumber===i);if(w===-1){T(!1);return}const b=f[w],U=b.memberType==="circuit_vip";let H=[...m.waitlist||[]];if(H.length>0){const O=H.shift();f[w]={slotNumber:i,memberId:O.memberId,memberName:O.memberName,memberType:O.memberType,status:"confirmed",bookedAt:fe.now()},E(`Slot given to ${O.memberName} from waitlist`,"success")}else f[w]={slotNumber:i,memberId:null,memberName:null,memberType:null,status:"available"},E("Member removed from slot","success");const A={slots:f,waitlist:H};if(U&&b.memberId){const O=m.vipOptOuts||[];O.includes(b.memberId)||(A.vipOptOuts=[...O,b.memberId])}await De(oe(S,"circuitSessions",m.id),A);const R={...m,...A};F(R),M(O=>O.map(V=>V.id===R.id?R:V))}catch(f){console.error("Error removing from slot:",f),E("Failed to remove member","error")}T(!1)}},he=async(i,f)=>{if(!(!m||W)){T(!0);try{const w=[...m.slots],b=w.findIndex(R=>R.slotNumber===i&&R.status==="available");if(b===-1){E("Slot is not available","error"),T(!1);return}if(w.some(R=>R.memberId===f.id)){E(`${f.name} already has a slot`,"error"),T(!1);return}w[b]={slotNumber:i,memberId:f.id,memberName:f.name,memberType:f.clientType||"block",status:"confirmed",bookedAt:fe.now()};const U=(m.waitlist||[]).filter(R=>R.memberId!==f.id),H={slots:w,waitlist:U};if(f.clientType==="circuit_vip"){const R=m.vipOptOuts||[];R.includes(f.id)&&(H.vipOptOuts=R.filter(O=>O!==f.id))}await De(oe(S,"circuitSessions",m.id),H);const A={...m,...H};F(A),M(R=>R.map(O=>O.id===A.id?A:O)),E(`${f.name} added to slot ${i}`,"success")}catch(w){console.error("Error adding to slot:",w),E("Failed to add member","error")}T(!1)}},Ne=async i=>{if(!(!m||W)){T(!0);try{const f=(m.waitlist||[]).filter(b=>b.memberId!==i);await De(oe(S,"circuitSessions",m.id),{waitlist:f});const w={...m,waitlist:f};F(w),M(b=>b.map(U=>U.id===w.id?w:U)),E("Removed from waitlist","success")}catch(f){console.error("Error removing from waitlist:",f),E("Failed to remove from waitlist","error")}T(!1)}},l=async(i,f)=>{if(!(!m||W)){T(!0);try{const w=[...m.slots],b=w.findIndex(H=>H.slotNumber===i);if(b===-1){T(!1);return}if(w[b]={...w[b],attended:f},await De(oe(S,"circuitSessions",m.id),{slots:w}),f===!1){const H=w[b].memberId;if(H){const A=oe(S,"clients",H),R=await ns(A);if(R.exists()){const V=(R.data().circuitStrikes||0)+1,Ce={circuitStrikes:V};if(V>=3){const Te=new Date;Te.setMonth(Te.getMonth()+1),Ce.circuitBanUntil=fe.fromDate(Te),Ce.circuitStrikes=0,E(`${w[b].memberName} banned for 1 month (3 strikes)`,"error")}else E(`No-show recorded - ${w[b].memberName} (${V}/3 strikes)`,"error");await De(A,Ce)}}}else E(`${w[b].memberName} marked as attended`,"success");const U={...m,slots:w};F(U),M(H=>H.map(A=>A.id===U.id?U:A))}catch(w){console.error("Error marking attendance:",w),E("Failed to update attendance","error")}T(!1)}},Z=async(i,f)=>{if(!W&&window.confirm(`Reset strikes for ${f}?`)){T(!0);try{await De(oe(S,"clients",i),{circuitStrikes:0,circuitBanUntil:null}),ee(w=>w.map(b=>b.id===i?{...b,circuitStrikes:0,circuitBanUntil:null}:b)),E(`Strikes reset for ${f}`,"success")}catch(w){console.error("Error resetting strikes:",w),E("Failed to reset strikes","error")}T(!1)}},G=async(i,f)=>{if(!W&&window.confirm(`Lift ban for ${f}?`)){T(!0);try{await De(oe(S,"clients",i),{circuitBanUntil:null,circuitStrikes:0}),ee(w=>w.map(b=>b.id===i?{...b,circuitBanUntil:null,circuitStrikes:0}:b)),E(`Ban lifted for ${f}`,"success")}catch(w){console.error("Error lifting ban:",w),E("Failed to lift ban","error")}T(!1)}};if(p)return e.jsxs("div",{className:"cm-loading",children:[e.jsx("div",{className:"cm-loading-spinner"}),e.jsx("span",{children:"Loading circuit data..."})]});const C=Ke(new Date),q=Ke(Xe()),g=j.filter(i=>i.date>=C),_=j.filter(i=>i.date<C),X=c==="upcoming"?g:_,be=m?m.slots.filter(i=>i.status!=="available").length:0,ne=m?m.slots.filter(i=>i.status==="available").length:0,de=m?m.date>=C:!1,ie=m?m.slots.filter(i=>i.memberId).map(i=>i.memberId):[],ye=m?(m.waitlist||[]).map(i=>i.memberId):[],me=I.filter(i=>!ie.includes(i.id)&&!ye.includes(i.id)),ge=I.filter(i=>i.clientType==="circuit_vip").length,$e=I.filter(i=>i.clientType==="circuit_dropin").length,Ae=I.filter(i=>i.circuitAccess&&i.clientType!=="circuit_vip"&&i.clientType!=="circuit_dropin").length,ve=I.filter(i=>i.circuitBanUntil?(i.circuitBanUntil.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil))>new Date:!1);return e.jsxs("div",{className:"cm-container",children:[e.jsxs("div",{className:"cm-stats-row",children:[e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:ge}),e.jsx("span",{className:"cm-stat-label",children:"VIP"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:$e}),e.jsx("span",{className:"cm-stat-label",children:"Drop-in"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:Ae}),e.jsx("span",{className:"cm-stat-label",children:"Block"})]}),e.jsxs("div",{className:"cm-stat-pill",children:[e.jsx("span",{className:"cm-stat-num",children:j.length}),e.jsx("span",{className:"cm-stat-label",children:"Sessions"})]})]}),e.jsxs("div",{className:"cm-view-toggle",children:[e.jsx("button",{className:`cm-toggle-btn ${d?"":"active"}`,onClick:()=>xe(!1),children:"Sessions"}),e.jsx("button",{className:`cm-toggle-btn ${d?"active":""}`,onClick:()=>xe(!0),children:"Members"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cm-tabs",children:[e.jsxs("button",{className:`cm-tab ${c==="upcoming"?"active":""}`,onClick:()=>se("upcoming"),children:["Upcoming (",g.length,")"]}),e.jsxs("button",{className:`cm-tab ${c==="past"?"active":""}`,onClick:()=>se("past"),children:["Past (",_.length,")"]})]}),e.jsx("div",{className:"cm-sessions-list",children:X.length===0?e.jsx("div",{className:"cm-empty",children:e.jsxs("p",{children:["No ",c," sessions"]})}):X.map(i=>{const f=i.slots.filter(U=>U.status!=="available").length,w=m?.id===i.id,b=i.date===q;return e.jsxs("button",{className:`cm-session-btn ${w?"selected":""} ${b?"next":""}`,onClick:()=>{F(i),ce(!1)},children:[e.jsxs("div",{className:"cm-session-btn-left",children:[e.jsx("span",{className:"cm-session-date",children:Ze(i.date)}),b&&e.jsx("span",{className:"cm-next-badge",children:"Next"})]}),e.jsxs("div",{className:"cm-session-btn-right",children:[e.jsxs("span",{className:"cm-session-fill",children:[f,"/8"]}),(i.waitlist?.length||0)>0&&e.jsxs("span",{className:"cm-waitlist-count",children:["+",i.waitlist.length," wl"]})]})]},i.id)})}),m&&e.jsxs("div",{className:"cm-detail",children:[e.jsxs("div",{className:"cm-detail-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:Ze(m.date)}),e.jsxs("p",{children:[m.time," - ",m.endTime," • ",be,"/8 booked • ",ne," available"]})]}),!de&&e.jsx("button",{className:`cm-attendance-btn ${$?"active":""}`,onClick:()=>ce(!$),children:$?"Done":"Attendance"})]}),e.jsx("div",{className:"cm-slots",children:m.slots.map(i=>{const f=i.status==="available";return e.jsxs("div",{className:`cm-slot ${f?"empty":"filled"} ${i.attended===!0?"attended":""} ${i.attended===!1?"no-show":""}`,children:[e.jsx("span",{className:"cm-slot-num",children:i.slotNumber}),f?e.jsxs("div",{className:"cm-slot-empty",children:[e.jsx("span",{children:"Available"}),de&&e.jsx(Ds,{members:me,onSelect:w=>he(i.slotNumber,w),disabled:W})]}):e.jsxs("div",{className:"cm-slot-filled",children:[e.jsxs("div",{className:"cm-slot-info",children:[e.jsx("span",{className:"cm-slot-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${_e(i.memberType)}`,children:Oe(i.memberType)})]}),e.jsxs("div",{className:"cm-slot-actions",children:[$&&i.attended===void 0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cm-attend-yes",onClick:()=>l(i.slotNumber,!0),disabled:W,title:"Attended",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}),e.jsx("button",{className:"cm-attend-no",onClick:()=>l(i.slotNumber,!1),disabled:W,title:"No-show",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),i.attended===!0&&e.jsx("span",{className:"cm-attended-label",children:"Attended"}),i.attended===!1&&e.jsx("span",{className:"cm-noshow-label",children:"No-show"}),de&&e.jsx("button",{className:"cm-remove-btn",onClick:()=>we(i.slotNumber),disabled:W,title:"Remove from slot",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]})]},i.slotNumber)})}),(m.waitlist?.length||0)>0&&e.jsxs("div",{className:"cm-waitlist",children:[e.jsxs("h4",{children:["Waitlist (",m.waitlist.length,")"]}),m.waitlist.map((i,f)=>e.jsxs("div",{className:"cm-waitlist-row",children:[e.jsxs("span",{className:"cm-wl-pos",children:["#",f+1]}),e.jsx("span",{className:"cm-wl-name",children:i.memberName}),e.jsx("span",{className:`cm-type-badge ${_e(i.memberType)}`,children:Oe(i.memberType)}),de&&e.jsx("button",{className:"cm-wl-remove",onClick:()=>Ne(i.memberId),disabled:W,children:"Remove"})]},i.memberId))]})]})]}),d&&e.jsxs("div",{className:"cm-members",children:[ve.length>0&&e.jsxs("div",{className:"cm-ban-alert",children:[e.jsxs("h4",{children:["Currently Banned (",ve.length,")"]}),ve.map(i=>{const f=i.circuitBanUntil?.toDate?i.circuitBanUntil.toDate():new Date(i.circuitBanUntil);return e.jsxs("div",{className:"cm-ban-row",children:[e.jsxs("div",{className:"cm-ban-info",children:[e.jsx("span",{className:"cm-ban-name",children:i.name}),e.jsxs("span",{className:"cm-ban-until",children:["Until ",f.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]}),e.jsx("button",{className:"cm-lift-ban-btn",onClick:()=>G(i.id,i.name),disabled:W,children:"Lift Ban"})]},i.id)})]}),e.jsx("div",{className:"cm-members-list",children:I.length===0?e.jsxs("div",{className:"cm-empty",children:[e.jsx("p",{children:"No circuit members yet"}),e.jsx("span",{children:"Add members via the Clients page"})]}):I.map(i=>{const f=i.circuitStrikes||0,w=ve.some(b=>b.id===i.id);return e.jsxs("div",{className:`cm-member-card ${w?"banned":""}`,children:[e.jsxs("div",{className:"cm-member-top",children:[e.jsx("span",{className:"cm-member-name",children:i.name}),e.jsx("span",{className:`cm-type-badge ${_e(i.clientType)}`,children:Oe(i.clientType)})]}),e.jsxs("div",{className:"cm-member-bottom",children:[e.jsxs("div",{className:"cm-strikes",children:[[0,1,2].map(b=>e.jsx("span",{className:`cm-strike-dot ${b<f?"active":""}`},b)),e.jsxs("span",{className:"cm-strike-text",children:[f,"/3 strikes"]})]}),e.jsxs("div",{className:"cm-member-actions",children:[w&&e.jsx("button",{className:"cm-small-btn ban",onClick:()=>G(i.id,i.name),disabled:W,children:"Lift Ban"}),f>0&&!w&&e.jsx("button",{className:"cm-small-btn reset",onClick:()=>Z(i.id,i.name),disabled:W,children:"Reset"})]})]})]},i.id)})})]}),z&&e.jsx("div",{className:`cm-toast ${z.type}`,children:e.jsx("span",{children:z.message})})]})}function Ds({members:p,onSelect:L,disabled:j}){const[M,I]=h.useState(!1),[ee,m]=h.useState(""),F=p.filter(c=>c.name.toLowerCase().includes(ee.toLowerCase()));return p.length===0?null:e.jsxs("div",{className:"cm-add-dropdown",children:[e.jsx("button",{className:"cm-add-trigger",onClick:()=>I(!M),disabled:j,children:"+ Add"}),M&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cm-dropdown-backdrop",onClick:()=>{I(!1),m("")}}),e.jsxs("div",{className:"cm-dropdown-menu",children:[p.length>4&&e.jsx("input",{type:"text",className:"cm-dropdown-search",placeholder:"Search...",value:ee,onChange:c=>m(c.target.value),autoFocus:!0}),e.jsxs("div",{className:"cm-dropdown-list",children:[F.map(c=>e.jsxs("button",{className:"cm-dropdown-item",onClick:()=>{L(c),I(!1),m("")},children:[e.jsx("span",{children:c.name}),e.jsx("span",{className:`cm-type-badge sm ${_e(c.clientType)}`,children:Oe(c.clientType)})]},c.id)),F.length===0&&e.jsx("div",{className:"cm-dropdown-empty",children:"No members found"})]})]})]})]})}function Cs(){const[p,L]=h.useState(()=>localStorage.getItem("adminActiveView")||"schedule"),j=s=>{L(s),localStorage.setItem("adminActiveView",s)},[M,I]=h.useState(0),[ee,m]=h.useState(!1),[F,c]=h.useState([]),[se,W]=h.useState(null),[T,z]=h.useState(null),[ae,d]=h.useState(!1),[xe,$]=h.useState([]),[ce,E]=h.useState(!1),[re,we]=h.useState([]),[he,Ne]=h.useState([]),[l,Z]=h.useState(null),{currentUser:G,logout:C,isAdmin:q,loading:g}=is(),{isDark:_,toggleTheme:X}=ls(),be=os(),ne=h.useRef(0),de=h.useRef(!1);h.useRef(null);const ie=h.useCallback((s,u="info")=>{z({message:s,type:u}),setTimeout(()=>z(null),4e3)},[]);h.useEffect(()=>{!g&&(!G||!q)&&be("/")},[G,q,g,be]),h.useEffect(()=>{G&&q&&ge()},[G,q]);const ye=async()=>{E(!0);try{const s=Re(te(S,"rescheduleRequests"),Ee("status","in",["approved","rejected"])),y=(await pe(s)).docs.map(r=>({id:r.id,...r.data()}));y.sort((r,N)=>{const D=r.respondedAt?.toDate?r.respondedAt.toDate():new Date(0);return(N.respondedAt?.toDate?N.respondedAt.toDate():new Date(0))-D}),$(y)}catch(s){console.error("Error fetching request history:",s)}E(!1)},me=()=>{!ae&&xe.length===0&&ye(),d(s=>!s)},ge=async()=>{try{const s=Re(te(S,"rescheduleRequests"),Ee("status","==","pending")),y=(await pe(s)).docs.map(r=>({id:r.id,...r.data()}));y.sort((r,N)=>{const D=r.createdAt?.toDate?r.createdAt.toDate():new Date(0);return(N.createdAt?.toDate?N.createdAt.toDate():new Date(0))-D}),c(y)}catch(s){console.error("Error fetching reschedule requests:",s)}};h.useEffect(()=>{(async()=>{if(!(!G||!q))try{const[u,y]=await Promise.all([pe(te(S,"clients")),pe(te(S,"sessions"))]),r=u.docs.map(a=>({id:a.id,...a.data()})),N=y.docs.map(a=>({id:a.id,...a.data()}));we(r);const D=new Set(r.map(a=>a.id)),n=y.docs.filter(a=>!D.has(a.data().clientId));if(n.length>0){const a=n.map(o=>Be(oe(S,"sessions",o.id)));await Promise.all(a)}Ne(N.filter(a=>D.has(a.clientId)))}catch(u){console.error("Error fetching dashboard data:",u)}})()},[G,q]),h.useEffect(()=>{const s=()=>window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,u=N=>{s()<=0&&(ne.current=N.touches[0].clientY,de.current=!1)},y=N=>{const D=s(),a=N.touches[0].clientY-ne.current;if(D>5||a<=0){de.current=!1,I(0);return}a>20&&D<=0&&(de.current=!0,I(Math.min((a-20)*.4,80)))},r=()=>{de.current&&M>60?(m(!0),setTimeout(()=>{window.location.reload()},300)):I(0),de.current=!1};return document.addEventListener("touchstart",u,{passive:!0}),document.addEventListener("touchmove",y,{passive:!0}),document.addEventListener("touchend",r),()=>{document.removeEventListener("touchstart",u),document.removeEventListener("touchmove",y),document.removeEventListener("touchend",r)}},[M]);const $e=async()=>{try{await C(),be("/")}catch(s){console.error("Failed to log out:",s)}},Ae=()=>{be("/add-client")},ve=s=>new Date(s).toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"}),i=s=>{const[u,y]=s.split(":"),r=parseInt(u),N=r>=12?"pm":"am";return`${r>12?r-12:r===0?12:r}:${y}${N}`},f=async s=>{if(window.confirm(`Approve reschedule for ${s.clientName}?

From: ${ve(s.originalDate)} at ${i(s.originalTime)}
To: ${ve(s.requestedDate)} at ${i(s.requestedTime)}`)){W(s.id);try{const u=Re(te(S,"sessions"),Ee("date","==",s.requestedDate),Ee("time","==",s.requestedTime)),r=(await pe(u)).docs.filter(N=>N.id!==s.sessionId);if(r.length>0){const N=r[0].data().clientName;ie(`Cannot approve — ${N} is already booked at that time`,"error"),W(null);return}await De(oe(S,"sessions",s.sessionId),{date:s.requestedDate,time:s.requestedTime}),await De(oe(S,"rescheduleRequests",s.id),{status:"approved",respondedAt:fe.now()}),c(F.filter(N=>N.id!==s.id)),ie(`Approved reschedule for ${s.clientName}`,"success")}catch(u){console.error("Error approving request:",u),ie("Failed to approve request","error")}W(null)}},w=async s=>{if(window.confirm(`Reject reschedule request from ${s.clientName}?`)){W(s.id);try{await De(oe(S,"rescheduleRequests",s.id),{status:"rejected",respondedAt:fe.now()}),c(F.filter(u=>u.id!==s.id)),ie(`Request from ${s.clientName} rejected`,"info")}catch(u){console.error("Error rejecting request:",u),ie("Failed to reject request","error")}W(null)}};if(g)return e.jsx("div",{className:"loading",children:"Loading..."});if(!G||!q)return null;const b=F.length,U=new Date,H=`${U.getFullYear()}-${(U.getMonth()+1).toString().padStart(2,"0")}-${U.getDate().toString().padStart(2,"0")}`,A=`${U.getHours().toString().padStart(2,"0")}:${U.getMinutes().toString().padStart(2,"0")}`,O=he.filter(s=>s.date===H).length,V=s=>he.filter(u=>u.clientId!==s?!1:u.date<H||u.date===H&&u.time<A).length,Ce=re.filter(s=>s.status!=="archived"&&(!s.clientType||s.clientType==="block")),Te=new Date(U);Te.setDate(Te.getDate()+7);const ke=Ce.filter(s=>{if(!s.endDate)return!1;const u=s.endDate.toDate?s.endDate.toDate():new Date(s.endDate);return u>=U&&u<=Te}),t=Ce.filter(s=>(s.totalSessions||0)-V(s.id)<=2);return e.jsxs("div",{className:"dashboard",children:[M>0&&e.jsxs("div",{className:"pull-indicator",style:{height:M},children:[e.jsx("div",{className:`pull-spinner ${ee?"spinning":""}`,children:ee?"↻":"↓"}),e.jsx("span",{children:ee?"Refreshing...":M>60?"Release to refresh":"Pull to refresh"})]}),e.jsxs("header",{className:"dashboard-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("img",{src:"/Logo.webp",alt:"Mind Core Fitness",className:"admin-header-logo",width:"50",height:"50"}),e.jsx("span",{className:"admin-badge",children:"Admin"})]}),e.jsxs("nav",{className:"header-nav",children:[e.jsxs("button",{className:`nav-btn ${p==="requests"?"active":""} ${b>0?"has-badge":""}`,onClick:()=>j("requests"),children:["Requests",b>0&&e.jsx("span",{className:"nav-badge",children:b})]}),e.jsx("button",{className:`nav-btn ${p==="forms"?"active":""}`,onClick:()=>j("forms"),children:"Forms"}),e.jsx("button",{className:`nav-btn ${p==="circuits"?"active":""}`,onClick:()=>j("circuits"),children:"Circuits"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"theme-toggle-btn",onClick:X,"aria-label":_?"Switch to light mode":"Switch to dark mode",children:_?e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"})}):e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"})})}),e.jsx("button",{className:"logout-btn",onClick:$e,children:"Log Out"})]})]}),T&&e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${T.type}`,children:[e.jsxs("span",{className:"toast-icon",children:[T.type==="success"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}),T.type==="error"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})}),T.type==="info"&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"})})]}),e.jsx("span",{className:"toast-message",children:T.message})]})}),e.jsxs("main",{className:"dashboard-main",children:[p==="schedule"&&e.jsxs("div",{className:"schedule-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Schedule"})}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card",onClick:()=>{},children:[e.jsx("div",{className:"summary-icon sessions-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:O}),e.jsx("span",{className:"summary-label",children:"Today"})]})]}),e.jsxs("div",{className:"summary-card",onClick:()=>j("requests"),children:[e.jsx("div",{className:`summary-icon requests-icon ${b>0?"has-items":""}`,children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"})})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:b}),e.jsx("span",{className:"summary-label",children:"Requests"})]})]}),e.jsxs("div",{className:`summary-card ${l==="expiring"?"active":""}`,onClick:()=>Z(l==="expiring"?null:"expiring"),children:[e.jsx("div",{className:`summary-icon expiring-icon ${ke.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:ke.length}),e.jsx("span",{className:"summary-label",children:"Expiring"})]})]}),e.jsxs("div",{className:`summary-card ${l==="low"?"active":""}`,onClick:()=>Z(l==="low"?null:"low"),children:[e.jsx("div",{className:`summary-icon low-icon ${t.length>0?"has-items":""}`,children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]})}),e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{className:"summary-number",children:t.length}),e.jsx("span",{className:"summary-label",children:"Low Sessions"})]})]})]}),l==="expiring"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Expiring Soon"}),e.jsx("button",{className:"card-detail-close",onClick:()=>Z(null),children:"✕"})]}),ke.length===0?e.jsx("p",{className:"card-detail-empty",children:"No clients expiring within 7 days"}):ke.map(s=>{const u=s.endDate.toDate?s.endDate.toDate():new Date(s.endDate),y=Math.ceil((u-U)/(1e3*60*60*24)),r=(s.totalSessions||0)-V(s.id);return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:s.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:"card-detail-tag warning",children:y<=1?"Ends today":`Ends in ${y} days`}),e.jsx("span",{className:`card-detail-tag ${r<=0?"urgent":"info"}`,children:r<=0?"No sessions left":`${r} session${r!==1?"s":""} left`})]})]},s.id)})]}),l==="low"&&e.jsxs("div",{className:"card-detail-panel",children:[e.jsxs("div",{className:"card-detail-header",children:[e.jsx("span",{children:"Low / No Sessions"}),e.jsx("button",{className:"card-detail-close",onClick:()=>Z(null),children:"✕"})]}),t.length===0?e.jsx("p",{className:"card-detail-empty",children:"All clients have sessions available"}):[...t].sort((s,u)=>{const y=(s.totalSessions||0)-V(s.id),r=(u.totalSessions||0)-V(u.id);return y-r}).map(s=>{const u=(s.totalSessions||0)-V(s.id),y=s.endDate?s.endDate.toDate?s.endDate.toDate():new Date(s.endDate):null,r=y?Math.ceil((y-U)/(1e3*60*60*24)):null;return e.jsxs("div",{className:"card-detail-item",children:[e.jsx("span",{className:"card-detail-name",children:s.name}),e.jsxs("div",{className:"card-detail-tags",children:[e.jsx("span",{className:`card-detail-tag ${u<=0?"urgent":"low"}`,children:u<=0?"No sessions left":`${u} session${u!==1?"s":""} left`}),r!==null&&r<=14&&e.jsxs("span",{className:"card-detail-tag warning",children:["Block ends ",r<=1?"today":`in ${r}d`]})]})]},s.id)})]}),e.jsx(fs,{})]}),p==="clients"&&e.jsxs("div",{className:"clients-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Clients"}),e.jsx("button",{className:"add-btn",onClick:Ae,children:"+ Add Client"})]}),e.jsx(ms,{})]}),p==="calendar"&&e.jsxs("div",{className:"calendar-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Calendar"})}),e.jsx(ps,{})]}),p==="requests"&&e.jsxs("div",{className:"requests-view",children:[e.jsxs("div",{className:"view-header",children:[e.jsx("h2",{children:"Reschedule Requests"}),e.jsx("button",{className:"history-toggle-btn",onClick:me,children:ae?"Hide History":"View History"})]}),ae&&e.jsxs("div",{className:"request-history-section",children:[e.jsx("div",{className:"history-section-header",children:"Past Requests"}),ce?e.jsx("p",{className:"history-empty",children:"Loading..."}):xe.length===0?e.jsx("p",{className:"history-empty",children:"No past requests"}):xe.map(s=>e.jsxs("div",{className:"history-request-card",children:[e.jsxs("div",{className:"history-request-top",children:[e.jsx("span",{className:"history-client-name",children:s.clientName}),e.jsx("span",{className:`history-status-badge ${s.status}`,children:s.status})]}),e.jsxs("div",{className:"history-request-detail",children:[e.jsxs("span",{children:[ve(s.originalDate)," ",i(s.originalTime)]}),e.jsx("span",{className:"history-arrow",children:"→"}),e.jsxs("span",{children:[ve(s.requestedDate)," ",i(s.requestedTime)]})]}),s.respondedAt&&e.jsx("div",{className:"history-responded-at",children:s.respondedAt.toDate?s.respondedAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):""})]},s.id))]}),F.length===0?e.jsxs("div",{className:"no-requests",children:[e.jsx("div",{className:"empty-icon",children:e.jsxs("svg",{viewBox:"0 0 100 100",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4"}),e.jsx("path",{d:"M20 35 L50 55 L80 35"}),e.jsx("circle",{cx:"50",cy:"70",r:"3",fill:"currentColor"})]})}),e.jsx("p",{children:"No pending requests"}),e.jsx("span",{children:"When clients request to reschedule, they will appear here"})]}):e.jsx("div",{className:"requests-list",children:F.map(s=>e.jsxs("div",{className:"request-card",children:[e.jsxs("div",{className:"request-header",children:[e.jsx("span",{className:"client-name",children:s.clientName}),e.jsx("span",{className:"request-time",children:s.createdAt?.toDate?s.createdAt.toDate().toLocaleDateString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):""})]}),e.jsx("div",{className:"request-details",children:e.jsxs("div",{className:"request-change",children:[e.jsxs("div",{className:"from-session",children:[e.jsx("span",{className:"label",children:"From:"}),e.jsxs("span",{className:"value",children:[ve(s.originalDate)," at ",i(s.originalTime)]})]}),e.jsx("div",{className:"arrow",children:"→"}),e.jsxs("div",{className:"to-session",children:[e.jsx("span",{className:"label",children:"To:"}),e.jsxs("span",{className:"value",children:[ve(s.requestedDate)," at ",i(s.requestedTime)]})]})]})}),e.jsxs("div",{className:"request-actions",children:[e.jsx("button",{className:"approve-btn",onClick:()=>f(s),disabled:se===s.id,children:se===s.id?"Processing...":"Approve"}),e.jsx("button",{className:"reject-btn",onClick:()=>w(s),disabled:se===s.id,children:"Reject"})]})]},s.id))})]}),p==="forms"&&e.jsxs("div",{className:"forms-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Client Forms"})}),e.jsx(ws,{})]}),p==="circuits"&&e.jsxs("div",{className:"circuits-view",children:[e.jsx("div",{className:"view-header",children:e.jsx("h2",{children:"Circuit Management"})}),e.jsx(bs,{})]})]}),e.jsxs("nav",{className:"admin-bottom-nav",children:[e.jsxs("button",{className:`admin-nav-tab ${p==="schedule"?"active":""}`,onClick:()=>j("schedule"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),e.jsx("span",{children:"Today"})]}),e.jsxs("button",{className:`admin-nav-tab ${p==="clients"?"active":""}`,onClick:()=>j("clients"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"9",cy:"7",r:"4"}),e.jsx("path",{d:"M23 21v-2a4 4 0 0 0-3-3.87"}),e.jsx("path",{d:"M16 3.13a4 4 0 0 1 0 7.75"})]}),e.jsx("span",{children:"Clients"})]}),e.jsxs("button",{className:`admin-nav-tab ${p==="calendar"?"active":""}`,onClick:()=>j("calendar"),children:[e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"}),e.jsx("path",{d:"M8 14h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 18h.01"}),e.jsx("path",{d:"M12 18h.01"})]}),e.jsx("span",{children:"Calendar"})]})]})]})}export{Cs as default};
