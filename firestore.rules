rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──────────────────────────────────────────────
    function isAdmin() {
      return request.auth != null
          && request.auth.uid == 'EYdciKDOi3UYBLk1u8hHams5tmO2';
    }

    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Check if the document's clientId field matches the caller
    function isClientOwner() {
      return isAuth() && resource.data.clientId == request.auth.uid;
    }

    // Check if the incoming document's clientId field matches the caller
    function isIncomingClientOwner() {
      return isAuth() && request.resource.data.clientId == request.auth.uid;
    }

    // ── clients ───────────────────────────────────────────────────────
    // Admin: full CRUD | Client: read own document
    match /clients/{clientId} {
      allow read:   if isOwner(clientId) || isAdmin();
      allow create: if isAdmin();
      allow update: if isOwner(clientId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── sessions ──────────────────────────────────────────────────────
    // Admin: full CRUD | Client: read own, create own
    match /sessions/{sessionId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── rescheduleRequests ────────────────────────────────────────────
    // Admin: full CRUD | Client: create own, read own, update own
    match /rescheduleRequests/{requestId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── personalBests ─────────────────────────────────────────────────
    // Doc ID = {clientId}_{YYYY-MM}
    // Admin: full CRUD | Client: read/write own
    match /personalBests/{docId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── personalBestTargets ───────────────────────────────────────────
    // Doc ID = targets_{clientId}
    // Admin: full CRUD | Client: read/write own
    match /personalBestTargets/{docId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── achievements ──────────────────────────────────────────────────
    // Doc ID = {clientId}
    // Admin: full CRUD | Client: read own
    match /achievements/{clientId} {
      allow read:   if isOwner(clientId) || isAdmin();
      allow write:  if isAdmin();
    }

    // ── sessionNotes ──────────────────────────────────────────────────
    // Admin: full CRUD | Client: read own
    match /sessionNotes/{noteId} {
      allow read:   if isClientOwner() || isAdmin();
      allow write:  if isAdmin();
    }

    // ── holidays ──────────────────────────────────────────────────────
    // Admin: full CRUD | All authenticated users: read
    match /holidays/{holidayId} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }

    // ── blockedTimes ──────────────────────────────────────────────────
    // Admin: full CRUD | All authenticated users: read
    match /blockedTimes/{blockId} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }

    // ── openedSlots ───────────────────────────────────────────────────
    // Admin: full CRUD | All authenticated users: read
    match /openedSlots/{slotId} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }

    // ── circuitSessions ───────────────────────────────────────────────
    // Doc ID = {YYYY-MM-DD}
    // Admin: full CRUD | Authenticated users: read, update (book slots)
    match /circuitSessions/{dateId} {
      allow read:   if isAuth();
      allow create: if isAdmin();
      allow update: if isAuth();
      allow delete: if isAdmin();
    }

    // ── workoutLogs ───────────────────────────────────────────────────
    // Client: create/read own | Admin: read all
    match /workoutLogs/{logId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── clientProgrammes ──────────────────────────────────────────────
    // Doc ID = {clientId}
    // Client: full CRUD on own | Admin: read all
    match /clientProgrammes/{clientId} {
      allow read:   if isOwner(clientId) || isAdmin();
      allow create: if isOwner(clientId) || isAdmin();
      allow update: if isOwner(clientId) || isAdmin();
      allow delete: if isOwner(clientId) || isAdmin();
    }

    // ── nutritionTargets ──────────────────────────────────────────────
    // Doc ID = {clientId}
    // Client: read/write own | Admin: read all
    match /nutritionTargets/{clientId} {
      allow read:   if isOwner(clientId) || isAdmin();
      allow create: if isOwner(clientId) || isAdmin();
      allow update: if isOwner(clientId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── nutritionLogs ─────────────────────────────────────────────────
    // Doc ID = {clientId}_{YYYY-MM-DD}
    // Client: read/write own | Admin: read all
    match /nutritionLogs/{docId} {
      allow read:   if isClientOwner() || isAdmin();
      allow create: if isIncomingClientOwner() || isAdmin();
      allow update: if isClientOwner() || isAdmin();
      allow delete: if isAdmin();
    }

    // ── settings ──────────────────────────────────────────────────────
    // Admin: full CRUD | All authenticated users: read
    match /settings/{document} {
      allow read:  if isAuth();
      allow write: if isAdmin();
    }

    // ── users (legacy) ────────────────────────────────────────────────
    match /users/{userId} {
      allow read:   if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── Deny everything else ──────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
