<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Mind Core Fitness</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../js/dashboard-styles.css">

    <!-- Additional Client Styles -->
    <style>
        .client-header {
            background: linear-gradient(135deg, var(--accent-color) 0%, #b33a47 100%);
            color: #ffffff;
            padding: 40px 32px;
        }

        .client-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .client-header p {
            opacity: 0.9;
        }

        .client-nav {
            background: #ffffff;
            padding: 0 32px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            gap: 32px;
        }

        .client-nav-item {
            padding: 16px 0;
            color: var(--text-muted);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .client-nav-item:hover {
            color: var(--text-color);
        }

        .client-nav-item.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .client-content {
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .next-session {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--accent-color);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
        }

        .next-session-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .next-session-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .next-session-time {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .calendar-week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .week-day {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .week-day:hover {
            border-color: var(--accent-color);
        }

        .week-day.selected {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }

        .week-day.has-session {
            background: rgba(45, 138, 78, 0.1);
            border-color: var(--success-color);
        }

        .week-day.has-session.selected {
            background: var(--success-color);
        }

        .week-day-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .week-day-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .week-day-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
            margin: 8px auto 0;
        }

        .week-day.selected .week-day-dot {
            background: #ffffff;
        }

        .slots-container {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .slots-header {
            padding: 16px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid var(--card-border);
        }

        .slots-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
        }

        .slots-body {
            padding: 20px;
        }

        .slot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .slot-item:last-child {
            margin-bottom: 0;
        }

        .slot-item.available {
            background: rgba(45, 138, 78, 0.08);
            border: 1px solid rgba(45, 138, 78, 0.2);
            cursor: pointer;
        }

        .slot-item.available:hover {
            background: rgba(45, 138, 78, 0.15);
            border-color: var(--success-color);
        }

        .slot-item.unavailable {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .slot-item.booked {
            background: rgba(153, 49, 60, 0.08);
            border: 1px solid rgba(153, 49, 60, 0.2);
        }

        .slot-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .slot-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .slot-status.available {
            background: var(--success-color);
            color: #ffffff;
        }

        .slot-status.unavailable {
            background: #ddd;
            color: #666;
        }

        .slot-status.your-session {
            background: var(--accent-color);
            color: #ffffff;
        }

        .my-sessions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .session-date-box {
            background: var(--accent-color);
            color: #ffffff;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            min-width: 70px;
        }

        .session-date-box .month {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .session-date-box .day {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .session-details {
            flex: 1;
        }

        .session-details h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-details p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .session-actions {
            display: flex;
            gap: 8px;
        }

        .block-info {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .block-info-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-color);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .block-info-text h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .block-info-text p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .top-bar {
            background: #1a1a1a;
            padding: 12px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ffffff;
            text-decoration: none;
        }

        .top-bar-logo img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .top-bar-logo span {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .top-bar-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .top-bar-user span {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .top-bar-user button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .top-bar-user button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .setup-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .setup-notice h3 {
            font-family: 'Montserrat', sans-serif;
            color: #856404;
            margin-bottom: 8px;
        }

        .setup-notice p {
            color: #856404;
        }

        @media (max-width: 768px) {
            .calendar-week-view {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }

            .week-day {
                padding: 10px 4px;
            }

            .week-day-name {
                font-size: 0.65rem;
            }

            .week-day-date {
                font-size: 1rem;
            }

            .client-content {
                padding: 20px;
            }

            .session-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .session-actions {
                width: 100%;
            }

            .session-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .client-nav {
                padding: 0 16px;
                gap: 16px;
                overflow-x: auto;
            }

            .client-header {
                padding: 24px 20px;
            }

            .top-bar {
                padding: 12px 16px;
            }

            .block-info {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../Logo.PNG">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <a href="../index.html" class="top-bar-logo">
            <img src="../Logo.PNG" alt="Mind Core Fitness">
            <span>Mind Core Fitness</span>
        </a>
        <div class="top-bar-user">
            <span id="userEmail"></span>
            <button id="logoutBtn" onclick="window.location.href='login.html'">Sign Out</button>
        </div>
    </div>

    <!-- Header -->
    <header class="client-header">
        <h1>Welcome back, <span id="userName">Client</span></h1>
        <p>Manage your sessions and book new training times</p>
    </header>

    <!-- Navigation -->
    <nav class="client-nav">
        <a class="client-nav-item active" data-section="overview">Overview</a>
        <a class="client-nav-item" data-section="book">Book / Reschedule</a>
        <a class="client-nav-item" data-section="sessions">My Sessions</a>
    </nav>

    <!-- Content -->
    <div class="client-content">

        <!-- Overview Section -->
        <section class="client-section active" id="section-overview">
            <div class="block-info" id="blockInfo">
                <div class="block-info-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="block-info-text">
                    <h4>Your Training Block</h4>
                    <p><span id="blockDuration">60</span> minute sessions | Block ends: <span id="blockEndDate">-</span></p>
                </div>
            </div>

            <div class="next-session" id="nextSessionCard">
                <div class="next-session-label">Your Next Session</div>
                <div class="next-session-date" id="nextSessionDate">No upcoming sessions</div>
                <div class="next-session-time" id="nextSessionTime"></div>
                <button class="btn btn-primary" id="rescheduleNextBtn" style="display: none;">Reschedule</button>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h3>This Week</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-week-view" id="weekView">
                        <!-- Week days will be generated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Book / Reschedule Section -->
        <section class="client-section" id="section-book" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">Book a Session</h2>

            <div class="dashboard-card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h3>Select a Date</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-container" style="border: none;">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth">&lt;</button>
                            </div>
                            <h3 id="calendarMonth">February 2025</h3>
                            <div class="calendar-nav">
                                <button id="nextMonth">&gt;</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="slots-container" id="slotsContainer" style="display: none;">
                <div class="slots-header">
                    <h3>Available Times for <span id="selectedDateDisplay"></span></h3>
                </div>
                <div class="slots-body" id="slotsBody">
                    <!-- Slots will be generated by JS -->
                </div>
            </div>
        </section>

        <!-- My Sessions Section -->
        <section class="client-section" id="section-sessions" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">My Upcoming Sessions</h2>

            <div class="my-sessions-list" id="sessionsList">
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                    </svg>
                    <h4>No upcoming sessions</h4>
                    <p>Book a session to get started!</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal-overlay" id="rescheduleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Reschedule Session</h3>
                <button class="modal-close" id="closeRescheduleModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Moving session from: <strong id="originalDateTime"></strong></p>

                <div class="form-group">
                    <label>New Date</label>
                    <input type="date" id="newDate">
                </div>

                <div class="form-group">
                    <label>Available Time Slots</label>
                    <div class="time-slots-grid" id="rescheduleSlots">
                        <p style="color: var(--text-muted);">Select a date to see available slots</p>
                    </div>
                </div>

                <input type="hidden" id="rescheduleBookingId">
                <input type="hidden" id="rescheduleSelectedSlot">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRescheduleBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmRescheduleBtn">Confirm Reschedule</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Welcome Form Overlay -->
    <div class="welcome-overlay" id="welcomeOverlay" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-header">
                <img src="../Logo.PNG" alt="Mind Core Fitness" class="welcome-logo">
                <h1>Welcome to Mind Core Fitness</h1>
                <p>Please complete this quick form to help us personalise your training experience</p>
            </div>

            <div class="welcome-progress">
                <div class="progress-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">About You</span>
                </div>
                <div class="progress-step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">Fitness Background</span>
                </div>
                <div class="progress-step" data-step="3">
                    <span class="step-number">3</span>
                    <span class="step-label">Your Goals</span>
                </div>
                <div class="progress-step" data-step="4">
                    <span class="step-number">4</span>
                    <span class="step-label">PAR-Q</span>
                </div>
            </div>

            <form id="welcomeForm">
                <!-- Step 1: About You -->
                <div class="welcome-step active" data-step="1">
                    <h2>About You</h2>

                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" id="dob" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Height</label>
                            <div class="input-with-unit">
                                <input type="number" id="height" placeholder="175">
                                <span class="unit">cm</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Weight</label>
                            <div class="input-with-unit">
                                <input type="number" id="weight" placeholder="70">
                                <span class="unit">kg</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="phone" placeholder="07XXX XXXXXX">
                    </div>

                    <div class="form-group">
                        <label>Emergency Contact Name *</label>
                        <input type="text" id="emergencyName" required placeholder="Full name">
                    </div>

                    <div class="form-group">
                        <label>Emergency Contact Phone *</label>
                        <input type="tel" id="emergencyPhone" required placeholder="07XXX XXXXXX">
                    </div>
                </div>

                <!-- Step 2: Fitness Background -->
                <div class="welcome-step" data-step="2">
                    <h2>Your Fitness Background</h2>

                    <div class="form-group">
                        <label>How would you describe your current fitness level? *</label>
                        <select id="fitnessLevel" required>
                            <option value="">Select an option</option>
                            <option value="beginner">Beginner - New to exercise or returning after a long break</option>
                            <option value="intermediate">Intermediate - Exercise regularly (1-3 times per week)</option>
                            <option value="advanced">Advanced - Very active (4+ times per week)</option>
                            <option value="athlete">Athlete - Competitive or professional sports background</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>What types of exercise have you done before? (Select all that apply)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="weights"> Weight Training
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="cardio"> Cardio (Running, Cycling, etc.)
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="hiit"> HIIT / Circuit Training
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="yoga"> Yoga / Pilates
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="sports"> Team Sports
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="swimming"> Swimming
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="martial-arts"> Martial Arts / Boxing
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="none"> None / Very Little
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Do you have any current injuries or physical limitations?</label>
                        <textarea id="injuries" rows="3" placeholder="Please describe any injuries, conditions, or areas of concern..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Have you worked with a personal trainer before?</label>
                        <select id="previousTrainer">
                            <option value="">Select an option</option>
                            <option value="no">No, this is my first time</option>
                            <option value="briefly">Yes, briefly (less than 3 months)</option>
                            <option value="yes">Yes, for an extended period</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Goals -->
                <div class="welcome-step" data-step="3">
                    <h2>Your Goals</h2>

                    <div class="form-group">
                        <label>What are your main fitness goals? (Select up to 3) *</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="weight-loss"> Weight Loss / Fat Loss
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="muscle-gain"> Build Muscle / Strength
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="tone"> Tone Up / Get Lean
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="endurance"> Improve Endurance / Stamina
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="flexibility"> Improve Flexibility / Mobility
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="health"> General Health & Wellbeing
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="sport"> Sport-Specific Performance
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="rehab"> Injury Rehabilitation
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tell us more about what you want to achieve</label>
                        <textarea id="goalDetails" rows="3" placeholder="Any specific targets, events you're training for, or things you'd like to accomplish..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>How many times per week do you plan to train? *</label>
                        <select id="trainingFrequency" required>
                            <option value="">Select an option</option>
                            <option value="1">1 time per week</option>
                            <option value="2">2 times per week</option>
                            <option value="3">3 times per week</option>
                            <option value="4">4+ times per week</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Is there anything else you'd like us to know?</label>
                        <textarea id="additionalInfo" rows="3" placeholder="Dietary requirements, scheduling preferences, or anything else..."></textarea>
                    </div>
                </div>

                <!-- Step 4: PAR-Q -->
                <div class="welcome-step" data-step="4">
                    <h2>Physical Activity Readiness Questionnaire (PAR-Q)</h2>
                    <p class="parq-intro">For most people, physical activity should not pose a problem. This questionnaire has been designed to identify the small number of adults for whom physical activity might be inappropriate.</p>

                    <div class="parq-questions">
                        <div class="parq-question">
                            <label>1. Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq1" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq1" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>2. Do you feel pain in your chest when you do physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq2" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq2" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>3. In the past month, have you had chest pain when you were not doing physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq3" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq3" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>4. Do you lose your balance because of dizziness or do you ever lose consciousness? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq4" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq4" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>5. Do you have a bone or joint problem that could be made worse by a change in your physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq5" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq5" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>6. Is your doctor currently prescribing drugs for your blood pressure or heart condition? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq6" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq6" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>7. Do you know of any other reason why you should not do physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq7" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq7" value="no" required> No
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="parqDetailsGroup" style="display: none;">
                        <label>Please provide details about your "Yes" answers:</label>
                        <textarea id="parqDetails" rows="3" placeholder="Please explain..."></textarea>
                    </div>

                    <div class="parq-declaration">
                        <label class="checkbox-item">
                            <input type="checkbox" id="parqConsent" required>
                            <span>I confirm that I have read, understood and completed this questionnaire honestly. I understand that if my health changes, I should inform my trainer immediately. *</span>
                        </label>
                    </div>
                </div>
            </form>

            <div class="welcome-footer">
                <button type="button" class="btn btn-secondary" id="welcomePrevBtn" style="display: none;">Previous</button>
                <button type="button" class="btn btn-primary" id="welcomeNextBtn">Next</button>
                <button type="button" class="btn btn-primary" id="welcomeSubmitBtn" style="display: none;">Submit</button>
            </div>
        </div>
    </div>

    <style>
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 10000;
            overflow-y: auto;
        }

        .welcome-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 24px;
        }

        .welcome-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .welcome-header p {
            color: var(--text-muted);
        }

        .welcome-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            position: relative;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: calc(50% + 20px);
            width: calc(100% - 40px);
            height: 2px;
            background: #e0e0e0;
        }

        .progress-step.active:not(:last-child)::after,
        .progress-step.completed:not(:last-child)::after {
            background: var(--accent-color);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }

        .progress-step.active .step-number,
        .progress-step.completed .step-number {
            background: var(--accent-color);
            color: #ffffff;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        .progress-step.active .step-label {
            color: var(--accent-color);
            font-weight: 500;
        }

        .welcome-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .welcome-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-step h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 24px;
            color: var(--text-color);
        }

        .welcome-step .form-group {
            margin-bottom: 20px;
        }

        .welcome-step label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .welcome-step input[type="text"],
        .welcome-step input[type="email"],
        .welcome-step input[type="tel"],
        .welcome-step input[type="date"],
        .welcome-step input[type="number"],
        .welcome-step select,
        .welcome-step textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.2s ease;
        }

        .welcome-step input:focus,
        .welcome-step select:focus,
        .welcome-step textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-unit input {
            flex: 1;
        }

        .input-with-unit .unit {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-weight: 400;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--accent-color);
        }

        .radio-group {
            display: flex;
            gap: 24px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .parq-intro {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .parq-questions {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .parq-question {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .parq-question label {
            font-weight: 400;
            line-height: 1.4;
        }

        .parq-declaration {
            margin-top: 24px;
            padding: 20px;
            background: rgba(153, 49, 60, 0.05);
            border: 1px solid rgba(153, 49, 60, 0.2);
            border-radius: 8px;
        }

        .parq-declaration .checkbox-item span {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .welcome-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }

        .welcome-footer .btn {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .welcome-container {
                padding: 24px 16px;
            }

            .welcome-progress {
                padding: 0;
            }

            .step-label {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .progress-step:not(:last-child)::after {
                left: calc(50% + 16px);
                width: calc(100% - 32px);
            }
        }
    </style>

    <script src="../js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let currentUserId = null;

            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not logged in, redirect to login
                    window.location.href = '/dashboard/login.html';
                    return;
                }

                currentUserId = user.uid;

                // Check if admin - redirect to admin dashboard
                const role = await getUserRole(user.uid);
                if (role === 'admin') {
                    window.location.href = '/admin/index.html';
                    return;
                }

                // Get user data and display
                const userData = await getUserData(user.uid);
                if (userData) {
                    document.getElementById('userName').textContent = userData.name || 'Client';
                    document.getElementById('userEmail').textContent = user.email;

                    // Check if onboarding is complete
                    if (!userData.onboardingComplete) {
                        showWelcomeForm();
                    }
                } else {
                    document.getElementById('userName').textContent = user.email.split('@')[0];
                    document.getElementById('userEmail').textContent = user.email;
                    // No user data means they definitely need onboarding
                    showWelcomeForm();
                }
            });

            // ==================
            // WELCOME FORM
            // ==================
            let currentStep = 1;
            const totalSteps = 4;

            function showWelcomeForm() {
                document.getElementById('welcomeOverlay').style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function hideWelcomeForm() {
                document.getElementById('welcomeOverlay').style.display = 'none';
                document.body.style.overflow = '';
            }

            function updateStepDisplay() {
                // Update progress steps
                document.querySelectorAll('.progress-step').forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    if (stepNum === currentStep) {
                        step.classList.add('active');
                    } else if (stepNum < currentStep) {
                        step.classList.add('completed');
                    }
                });

                // Update form steps
                document.querySelectorAll('.welcome-step').forEach(step => {
                    step.classList.remove('active');
                    if (parseInt(step.dataset.step) === currentStep) {
                        step.classList.add('active');
                    }
                });

                // Update buttons
                document.getElementById('welcomePrevBtn').style.display = currentStep > 1 ? 'block' : 'none';
                document.getElementById('welcomeNextBtn').style.display = currentStep < totalSteps ? 'block' : 'none';
                document.getElementById('welcomeSubmitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

                // Scroll to top of form
                document.querySelector('.welcome-container').scrollTop = 0;
            }

            function validateCurrentStep() {
                const currentStepEl = document.querySelector(`.welcome-step[data-step="${currentStep}"]`);
                const requiredFields = currentStepEl.querySelectorAll('[required]');

                for (const field of requiredFields) {
                    if (field.type === 'radio') {
                        const radioGroup = currentStepEl.querySelectorAll(`input[name="${field.name}"]`);
                        const isChecked = Array.from(radioGroup).some(r => r.checked);
                        if (!isChecked) {
                            showToast('Please answer all required questions', 'error');
                            return false;
                        }
                    } else if (field.type === 'checkbox') {
                        if (!field.checked) {
                            showToast('Please confirm the declaration', 'error');
                            return false;
                        }
                    } else if (!field.value.trim()) {
                        field.focus();
                        showToast('Please fill in all required fields', 'error');
                        return false;
                    }
                }

                // Check goals limit (max 3) on step 3
                if (currentStep === 3) {
                    const selectedGoals = document.querySelectorAll('input[name="goals"]:checked');
                    if (selectedGoals.length === 0) {
                        showToast('Please select at least one fitness goal', 'error');
                        return false;
                    }
                    if (selectedGoals.length > 3) {
                        showToast('Please select a maximum of 3 goals', 'error');
                        return false;
                    }
                }

                return true;
            }

            // Goal checkbox limit
            document.querySelectorAll('input[name="goals"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checked = document.querySelectorAll('input[name="goals"]:checked');
                    if (checked.length > 3) {
                        this.checked = false;
                        showToast('Maximum 3 goals allowed', 'error');
                    }
                });
            });

            // PAR-Q yes answer detection
            document.querySelectorAll('.parq-question input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const hasYes = Array.from(document.querySelectorAll('.parq-question input[value="yes"]'))
                        .some(r => r.checked);
                    document.getElementById('parqDetailsGroup').style.display = hasYes ? 'block' : 'none';
                });
            });

            // Next button
            document.getElementById('welcomeNextBtn').addEventListener('click', function() {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                }
            });

            // Previous button
            document.getElementById('welcomePrevBtn').addEventListener('click', function() {
                currentStep--;
                updateStepDisplay();
            });

            // Submit button
            document.getElementById('welcomeSubmitBtn').addEventListener('click', async function() {
                if (!validateCurrentStep()) return;

                const submitBtn = this;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    // Collect all form data
                    const formData = {
                        // Personal info
                        dateOfBirth: document.getElementById('dob').value,
                        height: document.getElementById('height').value ? parseInt(document.getElementById('height').value) : null,
                        weight: document.getElementById('weight').value ? parseInt(document.getElementById('weight').value) : null,
                        phone: document.getElementById('phone').value.trim(),
                        emergencyContact: {
                            name: document.getElementById('emergencyName').value.trim(),
                            phone: document.getElementById('emergencyPhone').value.trim()
                        },

                        // Fitness background
                        fitnessLevel: document.getElementById('fitnessLevel').value,
                        exerciseTypes: Array.from(document.querySelectorAll('input[name="exerciseTypes"]:checked')).map(c => c.value),
                        injuries: document.getElementById('injuries').value.trim(),
                        previousTrainer: document.getElementById('previousTrainer').value,

                        // Goals
                        goals: Array.from(document.querySelectorAll('input[name="goals"]:checked')).map(c => c.value),
                        goalDetails: document.getElementById('goalDetails').value.trim(),
                        trainingFrequency: document.getElementById('trainingFrequency').value,
                        additionalInfo: document.getElementById('additionalInfo').value.trim(),

                        // PAR-Q
                        parq: {
                            q1: document.querySelector('input[name="parq1"]:checked')?.value === 'yes',
                            q2: document.querySelector('input[name="parq2"]:checked')?.value === 'yes',
                            q3: document.querySelector('input[name="parq3"]:checked')?.value === 'yes',
                            q4: document.querySelector('input[name="parq4"]:checked')?.value === 'yes',
                            q5: document.querySelector('input[name="parq5"]:checked')?.value === 'yes',
                            q6: document.querySelector('input[name="parq6"]:checked')?.value === 'yes',
                            q7: document.querySelector('input[name="parq7"]:checked')?.value === 'yes',
                            details: document.getElementById('parqDetails').value.trim(),
                            consentGiven: document.getElementById('parqConsent').checked,
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },

                        // Metadata
                        onboardingComplete: true,
                        onboardingCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Save to Firestore (use set with merge to create doc if it doesn't exist)
                    await db.collection('users').doc(currentUserId).set(formData, { merge: true });

                    showToast('Welcome form completed successfully!');
                    hideWelcomeForm();

                } catch (error) {
                    console.error('Error saving welcome form:', error);
                    showToast('Failed to save form. Please try again.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            });

            // Toast notification
            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                logout();
            });

            // Navigation
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;

                    document.querySelectorAll('.client-nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.client-section').forEach(s => s.style.display = 'none');
                    document.getElementById('section-' + section).style.display = 'block';
                });
            });

            // Render week view
            function renderWeekView() {
                const container = document.getElementById('weekView');
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const isToday = date.toDateString() === today.toDateString();

                    html += `
                        <div class="week-day ${isToday ? 'selected' : ''}">
                            <div class="week-day-name">${DAYS_SHORT[date.getDay()]}</div>
                            <div class="week-day-date">${date.getDate()}</div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            }

            renderWeekView();
        });
    </script>
</body>
</html>
