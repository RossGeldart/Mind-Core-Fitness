<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Mind Core Fitness</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../js/dashboard-styles.css">

    <!-- Additional Client Styles -->
    <style>
        .client-header {
            background: linear-gradient(135deg, var(--accent-color) 0%, #b33a47 100%);
            color: #ffffff;
            padding: 40px 32px;
        }

        .client-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .client-header p {
            opacity: 0.9;
        }

        .client-nav {
            background: #ffffff;
            padding: 0 32px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            gap: 32px;
        }

        .client-nav-item {
            padding: 16px 0;
            color: var(--text-muted);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .client-nav-item:hover {
            color: var(--text-color);
        }

        .client-nav-item.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .client-content {
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .next-session {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--accent-color);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
        }

        .next-session-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .next-session-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .next-session-time {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .calendar-week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .week-day {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .week-day:hover {
            border-color: var(--accent-color);
        }

        .week-day.selected {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }

        .week-day.has-session {
            background: rgba(45, 138, 78, 0.1);
            border-color: var(--success-color);
        }

        .week-day.has-session.selected {
            background: var(--success-color);
        }

        .week-day-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .week-day-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .week-day-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
            margin: 8px auto 0;
        }

        .week-day.selected .week-day-dot {
            background: #ffffff;
        }

        .slots-container {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .slots-header {
            padding: 16px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid var(--card-border);
        }

        .slots-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
        }

        .slots-body {
            padding: 20px;
        }

        .slot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .slot-item:last-child {
            margin-bottom: 0;
        }

        .slot-item.available {
            background: rgba(45, 138, 78, 0.08);
            border: 1px solid rgba(45, 138, 78, 0.2);
            cursor: pointer;
        }

        .slot-item.available:hover {
            background: rgba(45, 138, 78, 0.15);
            border-color: var(--success-color);
        }

        .slot-item.unavailable {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .slot-item.booked {
            background: rgba(153, 49, 60, 0.08);
            border: 1px solid rgba(153, 49, 60, 0.2);
        }

        .slot-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .slot-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .slot-status.available {
            background: var(--success-color);
            color: #ffffff;
        }

        .slot-status.unavailable {
            background: #ddd;
            color: #666;
        }

        .slot-status.your-session {
            background: var(--accent-color);
            color: #ffffff;
        }

        .my-sessions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .session-date-box {
            background: var(--accent-color);
            color: #ffffff;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            min-width: 70px;
        }

        .session-date-box .month {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .session-date-box .day {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .session-details {
            flex: 1;
        }

        .session-details h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-details p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .session-actions {
            display: flex;
            gap: 8px;
        }

        .block-info {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .block-info-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-color);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .block-info-text h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .block-info-text p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .top-bar {
            background: #1a1a1a;
            padding: 12px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ffffff;
            text-decoration: none;
        }

        .top-bar-logo img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .top-bar-logo span {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .top-bar-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .top-bar-user span {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .top-bar-user button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .top-bar-user button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .calendar-week-view {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }

            .week-day {
                padding: 10px 4px;
            }

            .week-day-name {
                font-size: 0.65rem;
            }

            .week-day-date {
                font-size: 1rem;
            }

            .client-content {
                padding: 20px;
            }

            .session-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .session-actions {
                width: 100%;
            }

            .session-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .client-nav {
                padding: 0 16px;
                gap: 16px;
                overflow-x: auto;
            }

            .client-header {
                padding: 24px 20px;
            }

            .top-bar {
                padding: 12px 16px;
            }

            .block-info {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../Logo.PNG">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <a href="../index.html" class="top-bar-logo">
            <img src="../Logo.PNG" alt="Mind Core Fitness">
            <span>Mind Core Fitness</span>
        </a>
        <div class="top-bar-user">
            <span id="userEmail"></span>
            <button id="logoutBtn">Sign Out</button>
        </div>
    </div>

    <!-- Header -->
    <header class="client-header">
        <h1>Welcome back, <span id="userName">Client</span></h1>
        <p>Manage your sessions and book new training times</p>
    </header>

    <!-- Navigation -->
    <nav class="client-nav">
        <a class="client-nav-item active" data-section="overview">Overview</a>
        <a class="client-nav-item" data-section="book">Book / Reschedule</a>
        <a class="client-nav-item" data-section="sessions">My Sessions</a>
    </nav>

    <!-- Content -->
    <div class="client-content">
        <!-- Overview Section -->
        <section class="client-section active" id="section-overview">
            <div class="block-info" id="blockInfo">
                <div class="block-info-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="block-info-text">
                    <h4>Your Training Block</h4>
                    <p><span id="blockDuration">60</span> minute sessions | Block ends: <span id="blockEndDate">-</span></p>
                </div>
            </div>

            <div class="next-session" id="nextSessionCard">
                <div class="next-session-label">Your Next Session</div>
                <div class="next-session-date" id="nextSessionDate">No upcoming sessions</div>
                <div class="next-session-time" id="nextSessionTime"></div>
                <button class="btn btn-primary" id="rescheduleNextBtn" style="display: none;">Reschedule</button>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h3>This Week</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-week-view" id="weekView">
                        <!-- Week days will be generated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Book / Reschedule Section -->
        <section class="client-section" id="section-book" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">Book a Session</h2>

            <div class="dashboard-card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h3>Select a Date</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-container" style="border: none;">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth">&lt;</button>
                            </div>
                            <h3 id="calendarMonth">February 2025</h3>
                            <div class="calendar-nav">
                                <button id="nextMonth">&gt;</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="slots-container" id="slotsContainer" style="display: none;">
                <div class="slots-header">
                    <h3>Available Times for <span id="selectedDateDisplay"></span></h3>
                </div>
                <div class="slots-body" id="slotsBody">
                    <!-- Slots will be generated by JS -->
                </div>
            </div>
        </section>

        <!-- My Sessions Section -->
        <section class="client-section" id="section-sessions" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">My Upcoming Sessions</h2>

            <div class="my-sessions-list" id="sessionsList">
                <!-- Sessions will be generated by JS -->
            </div>
        </section>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal-overlay" id="rescheduleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Reschedule Session</h3>
                <button class="modal-close" id="closeRescheduleModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Moving session from: <strong id="originalDateTime"></strong></p>

                <div class="form-group">
                    <label>New Date</label>
                    <input type="date" id="newDate">
                </div>

                <div class="form-group">
                    <label>Available Time Slots</label>
                    <div class="time-slots-grid" id="rescheduleSlots">
                        <p style="color: var(--text-muted);">Select a date to see available slots</p>
                    </div>
                </div>

                <input type="hidden" id="rescheduleBookingId">
                <input type="hidden" id="rescheduleSelectedSlot">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRescheduleBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmRescheduleBtn">Confirm Reschedule</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const MONTHS_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            let currentUser = null;
            let clientData = null;
            let currentMonth = new Date();
            let selectedDate = null;
            let myBookings = [];

            // Initialize auth
            MCFAuth.init(async function(user, role) {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;

                // Get client data
                const userDoc = await MCF.db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    clientData = userDoc.data();
                    document.getElementById('userName').textContent = clientData.name.split(' ')[0];
                    document.getElementById('blockDuration').textContent = clientData.blockDuration || 60;

                    if (clientData.blockEndDate) {
                        document.getElementById('blockEndDate').textContent =
                            clientData.blockEndDate.toDate().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    } else {
                        document.getElementById('blockEndDate').textContent = 'Ongoing';
                    }
                }

                // Load dashboard data
                loadDashboardData();
            });

            // Navigation
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;

                    document.querySelectorAll('.client-nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.client-section').forEach(s => s.style.display = 'none');
                    document.getElementById('section-' + section).style.display = 'block';

                    if (section === 'book') {
                        renderCalendar();
                    } else if (section === 'sessions') {
                        loadMySessions();
                    }
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                await MCFAuth.signOut();
                window.location.href = 'login.html';
            });

            // ==================
            // DASHBOARD DATA
            // ==================
            async function loadDashboardData() {
                // Load my bookings
                const bookingsResult = await MCFDatabase.getClientBookings(currentUser.uid);
                if (bookingsResult.success) {
                    myBookings = bookingsResult.bookings.filter(b => b.status !== 'cancelled');

                    // Show next session
                    if (myBookings.length > 0) {
                        const next = myBookings[0];
                        document.getElementById('nextSessionDate').textContent =
                            next.date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
                        document.getElementById('nextSessionTime').textContent =
                            `${next.startTime} - ${next.endTime}`;
                        document.getElementById('rescheduleNextBtn').style.display = 'inline-flex';
                        document.getElementById('rescheduleNextBtn').onclick = () => openRescheduleModal(next);
                    }
                }

                // Render week view
                renderWeekView();
            }

            function renderWeekView() {
                const container = document.getElementById('weekView');
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay()); // Start from Sunday

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];

                    const hasSession = myBookings.some(b =>
                        b.date.toISOString().split('T')[0] === dateStr
                    );

                    const isToday = date.toDateString() === today.toDateString();

                    html += `
                        <div class="week-day ${hasSession ? 'has-session' : ''} ${isToday ? 'selected' : ''}" data-date="${dateStr}">
                            <div class="week-day-name">${DAYS_SHORT[date.getDay()]}</div>
                            <div class="week-day-date">${date.getDate()}</div>
                            ${hasSession ? '<div class="week-day-dot"></div>' : ''}
                        </div>
                    `;
                }
                container.innerHTML = html;
            }

            // ==================
            // BOOKING CALENDAR
            // ==================
            function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();

                document.getElementById('calendarMonth').textContent =
                    currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

                let html = DAYS_SHORT.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay();

                // Previous month
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = startDay - 1; i >= 0; i--) {
                    html += `<div class="calendar-day other-month"><span class="calendar-date">${prevMonthLastDay - i}</span></div>`;
                }

                // Current month
                const today = new Date();
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const isToday = date.toDateString() === today.toDateString();
                    const isPast = date < today && !isToday;
                    const dateStr = date.toISOString().split('T')[0];

                    // Check if client can book on this day
                    const allowedDays = (clientData?.allowedSlots || []).map(s => s.day);
                    const isAllowed = allowedDays.length === 0 || allowedDays.includes(date.getDay());

                    html += `
                        <div class="calendar-day ${isToday ? 'today' : ''} ${isPast || !isAllowed ? 'other-month' : ''}"
                             data-date="${dateStr}" ${!isPast && isAllowed ? '' : 'style="cursor: not-allowed;"'}>
                            <span class="calendar-date">${day}</span>
                        </div>
                    `;
                }

                // Next month
                const remainingDays = 42 - (startDay + lastDay.getDate());
                for (let day = 1; day <= remainingDays; day++) {
                    html += `<div class="calendar-day other-month"><span class="calendar-date">${day}</span></div>`;
                }

                grid.innerHTML = html;

                // Click handlers
                grid.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
                    day.addEventListener('click', function() {
                        const date = this.dataset.date;
                        if (!date) return;

                        selectedDate = date;
                        showAvailableSlots(date);

                        // Highlight selected
                        grid.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('has-booking'));
                        this.classList.add('has-booking');
                    });
                });
            }

            document.getElementById('prevMonth').addEventListener('click', function() {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', function() {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            async function showAvailableSlots(dateStr) {
                document.getElementById('slotsContainer').style.display = 'block';
                document.getElementById('selectedDateDisplay').textContent =
                    new Date(dateStr).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });

                const duration = clientData?.blockDuration || 60;
                const slots = await MCFDatabase.getAvailableSlots(dateStr, duration);
                const container = document.getElementById('slotsBody');

                if (slots.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 40px;">
                            <p>No availability on this day</p>
                        </div>
                    `;
                    return;
                }

                // Check if I already have a booking on this day
                const myBookingOnDay = myBookings.find(b =>
                    b.date.toISOString().split('T')[0] === dateStr
                );

                container.innerHTML = slots.map(slot => {
                    const isMyBooking = myBookingOnDay &&
                        myBookingOnDay.startTime === slot.startTime;

                    if (isMyBooking) {
                        return `
                            <div class="slot-item booked">
                                <span class="slot-time">${slot.startTime} - ${slot.endTime}</span>
                                <span class="slot-status your-session">Your Session</span>
                            </div>
                        `;
                    } else if (slot.available) {
                        return `
                            <div class="slot-item available" data-start="${slot.startTime}" data-end="${slot.endTime}">
                                <span class="slot-time">${slot.startTime} - ${slot.endTime}</span>
                                <span class="slot-status available">Available</span>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="slot-item unavailable">
                                <span class="slot-time">${slot.startTime} - ${slot.endTime}</span>
                                <span class="slot-status unavailable">Booked</span>
                            </div>
                        `;
                    }
                }).join('');

                // Click to book
                container.querySelectorAll('.slot-item.available').forEach(slot => {
                    slot.addEventListener('click', async function() {
                        const startTime = this.dataset.start;
                        const endTime = this.dataset.end;

                        if (confirm(`Book session on ${document.getElementById('selectedDateDisplay').textContent} at ${startTime}?`)) {
                            await MCFDatabase.createBooking(
                                currentUser.uid,
                                clientData.name,
                                selectedDate,
                                startTime,
                                endTime,
                                ''
                            );
                            showToast('Session booked!', 'success');
                            loadDashboardData();
                            showAvailableSlots(selectedDate);
                        }
                    });
                });
            }

            // ==================
            // MY SESSIONS
            // ==================
            async function loadMySessions() {
                const result = await MCFDatabase.getClientBookings(currentUser.uid);
                const container = document.getElementById('sessionsList');

                if (!result.success || result.bookings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                            </svg>
                            <h4>No upcoming sessions</h4>
                            <p>Book a session to get started!</p>
                        </div>
                    `;
                    return;
                }

                const upcomingSessions = result.bookings.filter(b => b.status !== 'cancelled');

                container.innerHTML = upcomingSessions.map(session => {
                    const date = session.date;
                    return `
                        <div class="session-card">
                            <div class="session-date-box">
                                <div class="month">${MONTHS_SHORT[date.getMonth()]}</div>
                                <div class="day">${date.getDate()}</div>
                            </div>
                            <div class="session-details">
                                <h4>${date.toLocaleDateString('en-GB', { weekday: 'long' })}</h4>
                                <p>${session.startTime} - ${session.endTime}</p>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-secondary btn-sm reschedule-btn"
                                    data-id="${session.id}"
                                    data-date="${date.toISOString()}"
                                    data-start="${session.startTime}"
                                    data-end="${session.endTime}">
                                    Reschedule
                                </button>
                                <button class="btn btn-danger btn-sm cancel-btn" data-id="${session.id}">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Event listeners
                container.querySelectorAll('.reschedule-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const session = {
                            id: this.dataset.id,
                            date: new Date(this.dataset.date),
                            startTime: this.dataset.start,
                            endTime: this.dataset.end
                        };
                        openRescheduleModal(session);
                    });
                });

                container.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (confirm('Are you sure you want to cancel this session?')) {
                            await MCFDatabase.cancelBooking(this.dataset.id);
                            showToast('Session cancelled', 'success');
                            loadMySessions();
                            loadDashboardData();
                        }
                    });
                });
            }

            // ==================
            // RESCHEDULE MODAL
            // ==================
            let rescheduleBooking = null;

            function openRescheduleModal(booking) {
                rescheduleBooking = booking;
                document.getElementById('originalDateTime').textContent =
                    `${booking.date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })} at ${booking.startTime}`;
                document.getElementById('rescheduleBookingId').value = booking.id;
                document.getElementById('newDate').value = '';
                document.getElementById('rescheduleSlots').innerHTML = '<p style="color: var(--text-muted);">Select a date to see available slots</p>';
                document.getElementById('rescheduleModal').classList.add('show');
            }

            document.getElementById('closeRescheduleModal').addEventListener('click', closeRescheduleModal);
            document.getElementById('cancelRescheduleBtn').addEventListener('click', closeRescheduleModal);

            function closeRescheduleModal() {
                document.getElementById('rescheduleModal').classList.remove('show');
                rescheduleBooking = null;
            }

            document.getElementById('newDate').addEventListener('change', async function() {
                const date = this.value;
                if (!date) return;

                const duration = clientData?.blockDuration || 60;
                const slots = await MCFDatabase.getAvailableSlots(date, duration);
                const container = document.getElementById('rescheduleSlots');

                if (slots.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No availability on this day</p>';
                    return;
                }

                container.innerHTML = slots.filter(s => s.available).map(slot => `
                    <div class="time-slot available" data-start="${slot.startTime}" data-end="${slot.endTime}">
                        ${slot.startTime}
                    </div>
                `).join('') || '<p style="color: var(--text-muted);">No available slots</p>';

                container.querySelectorAll('.time-slot').forEach(slot => {
                    slot.addEventListener('click', function() {
                        container.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('rescheduleSelectedSlot').value = this.dataset.start + '-' + this.dataset.end;
                    });
                });
            });

            document.getElementById('confirmRescheduleBtn').addEventListener('click', async function() {
                const newDate = document.getElementById('newDate').value;
                const slotValue = document.getElementById('rescheduleSelectedSlot').value;
                const bookingId = document.getElementById('rescheduleBookingId').value;

                if (!newDate || !slotValue) {
                    showToast('Please select a date and time slot', 'error');
                    return;
                }

                const [startTime, endTime] = slotValue.split('-');

                this.disabled = true;
                this.textContent = 'Rescheduling...';

                await MCFDatabase.updateBooking(bookingId, {
                    date: newDate,
                    startTime: startTime,
                    endTime: endTime
                });

                this.disabled = false;
                this.textContent = 'Confirm Reschedule';

                showToast('Session rescheduled!', 'success');
                closeRescheduleModal();
                loadDashboardData();
                loadMySessions();
            });

            // ==================
            // TOAST
            // ==================
            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22,4 12,14.01 9,11.01"></polyline>' : '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'}
                    </svg>
                    <span>${message}</span>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>
