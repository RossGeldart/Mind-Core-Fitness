<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Dashboard | Mind Core Fitness</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#8B2635">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mind Core">
    <link rel="apple-touch-icon" href="../Logo.PNG">
    <link rel="icon" type="image/png" href="../Logo.PNG">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../js/dashboard-styles.css">

    <!-- Additional Client Styles -->
    <style>
        .client-header {
            background: linear-gradient(135deg, var(--accent-color) 0%, #b33a47 100%);
            color: #ffffff;
            padding: 40px 32px;
        }

        .client-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .client-header p {
            opacity: 0.9;
        }

        .client-nav {
            background: #ffffff;
            padding: 0 32px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            gap: 32px;
        }

        .client-nav-item {
            padding: 16px 0;
            color: var(--text-muted);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .client-nav-item:hover {
            color: var(--text-color);
        }

        .client-nav-item.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .client-content {
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .next-session {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--accent-color);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
        }

        .next-session-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .next-session-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .next-session-time {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .calendar-week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .week-day {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .week-day:hover {
            border-color: var(--accent-color);
        }

        .week-day.selected {
            background: var(--accent-color);
            color: #ffffff;
            border-color: var(--accent-color);
        }

        .week-day.has-session {
            background: rgba(45, 138, 78, 0.1);
            border-color: var(--success-color);
        }

        .week-day.has-session.selected {
            background: var(--success-color);
        }

        .week-day-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .week-day-date {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .week-day-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
            margin: 8px auto 0;
        }

        .week-day.selected .week-day-dot {
            background: #ffffff;
        }

        .slots-container {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .slots-header {
            padding: 16px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid var(--card-border);
        }

        .slots-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
        }

        .slots-body {
            padding: 20px;
        }

        .slot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .slot-item:last-child {
            margin-bottom: 0;
        }

        .slot-item.available {
            background: rgba(45, 138, 78, 0.08);
            border: 1px solid rgba(45, 138, 78, 0.2);
            cursor: pointer;
        }

        .slot-item.available:hover {
            background: rgba(45, 138, 78, 0.15);
            border-color: var(--success-color);
        }

        .slot-item.unavailable {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .slot-item.booked {
            background: rgba(153, 49, 60, 0.08);
            border: 1px solid rgba(153, 49, 60, 0.2);
        }

        .slot-item.booked.own-booking {
            cursor: pointer;
        }

        .slot-item.booked.own-booking:hover {
            background: rgba(153, 49, 60, 0.15);
            border-color: var(--accent-color);
        }

        .slot-time {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .slot-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .slot-status.available {
            background: var(--success-color);
            color: #ffffff;
        }

        .slot-status.unavailable {
            background: #ddd;
            color: #666;
        }

        .slot-status.your-session {
            background: var(--accent-color);
            color: #ffffff;
        }

        .my-sessions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .session-date-box {
            background: var(--accent-color);
            color: #ffffff;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            min-width: 70px;
        }

        .session-date-box .month {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .session-date-box .day {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .session-details {
            flex: 1;
        }

        .session-details h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-details p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .session-actions {
            display: flex;
            gap: 8px;
        }

        .block-info {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .block-info-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-color);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .block-info-text h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .block-info-text p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .banked-sessions-notice {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .banked-sessions-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #4caf50;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .banked-sessions-text h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
            color: #2e7d32;
        }

        .banked-sessions-text p {
            font-size: 0.9rem;
            color: #1b5e20;
        }

        .banked-sessions-text a {
            color: #1b5e20;
            font-weight: 600;
            text-decoration: underline;
        }

        .top-bar {
            background: #1a1a1a;
            padding: 12px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ffffff;
            text-decoration: none;
        }

        .top-bar-logo img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .top-bar-logo span {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .top-bar-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .top-bar-user span {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .top-bar-user button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .top-bar-user button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .setup-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .setup-notice h3 {
            font-family: 'Montserrat', sans-serif;
            color: #856404;
            margin-bottom: 8px;
        }

        .setup-notice p {
            color: #856404;
        }

        @media (max-width: 768px) {
            .calendar-week-view {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }

            .week-day {
                padding: 10px 4px;
            }

            .week-day-name {
                font-size: 0.65rem;
            }

            .week-day-date {
                font-size: 1rem;
            }

            .client-content {
                padding: 20px;
            }

            .session-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .session-actions {
                width: 100%;
            }

            .session-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .client-nav {
                padding: 0 16px;
                gap: 16px;
                overflow-x: auto;
            }

            .client-header {
                padding: 24px 20px;
            }

            .top-bar {
                padding: 12px 16px;
            }

            .block-info {
                flex-direction: column;
                text-align: center;
            }

            .banked-sessions-notice {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../Logo.PNG">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <a href="../index.html" class="top-bar-logo">
            <img src="../Logo.PNG" alt="Mind Core Fitness">
            <span>Mind Core Fitness</span>
        </a>
        <div class="top-bar-user">
            <span id="userEmail"></span>
            <button id="logoutBtn" onclick="window.location.href='login.html'">Sign Out</button>
        </div>
    </div>

    <!-- Header -->
    <header class="client-header">
        <h1>Welcome back, <span id="userName">Client</span></h1>
        <p>Manage your sessions and book new training times</p>
    </header>

    <!-- Navigation -->
    <nav class="client-nav">
        <a class="client-nav-item active" data-section="overview">Overview</a>
        <a class="client-nav-item" data-section="book">Book / Reschedule</a>
        <a class="client-nav-item" data-section="sessions">My Sessions</a>
    </nav>

    <!-- Content -->
    <div class="client-content">

        <!-- Overview Section -->
        <section class="client-section active" id="section-overview">
            <div class="block-info" id="blockInfo">
                <div class="block-info-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="block-info-text">
                    <h4>Your Training Block</h4>
                    <p><span id="blockDuration">60</span> minute sessions | Block ends: <span id="blockEndDate">-</span></p>
                </div>
            </div>

            <!-- Banked Sessions Notice -->
            <div class="banked-sessions-notice" id="bankedSessionsNotice" style="display: none;">
                <div class="banked-sessions-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="banked-sessions-text">
                    <h4>Banked Sessions</h4>
                    <p>You have <strong id="bankedSessionsCount">0</strong> session(s) available to reschedule. Select a day and time in the <a href="#" onclick="switchToBookSection(); return false;">Book / Reschedule</a> section.</p>
                </div>
            </div>

            <div class="next-session" id="nextSessionCard">
                <div class="next-session-label">Your Next Session</div>
                <div class="next-session-date" id="nextSessionDate">No upcoming sessions</div>
                <div class="next-session-time" id="nextSessionTime"></div>
                <div class="next-session-actions" id="nextSessionActions" style="display: none; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" id="rescheduleNextBtn">Reschedule</button>
                    <button class="btn btn-danger" id="cancelNextBtn">Cancel Session</button>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h3>This Week</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-week-view" id="weekView">
                        <!-- Week days will be generated by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Book / Reschedule Section -->
        <section class="client-section" id="section-book" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">Book a Session</h2>

            <div class="dashboard-card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h3>Select a Date</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-container" style="border: none;">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button id="prevMonth">&lt;</button>
                            </div>
                            <h3 id="calendarMonth">February 2025</h3>
                            <div class="calendar-nav">
                                <button id="nextMonth">&gt;</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="slots-container" id="slotsContainer" style="display: none;">
                <div class="slots-header">
                    <h3>Available Times for <span id="selectedDateDisplay"></span></h3>
                </div>
                <div class="slots-body" id="slotsBody">
                    <!-- Slots will be generated by JS -->
                </div>
            </div>
        </section>

        <!-- My Sessions Section -->
        <section class="client-section" id="section-sessions" style="display: none;">
            <h2 style="font-family: 'Montserrat', sans-serif; margin-bottom: 24px;">My Upcoming Sessions</h2>

            <div class="my-sessions-list" id="sessionsList">
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                    </svg>
                    <h4>No upcoming sessions</h4>
                    <p>Book a session to get started!</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal-overlay" id="rescheduleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Reschedule Session</h3>
                <button class="modal-close" id="closeRescheduleModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Moving session from: <strong id="originalDateTime"></strong></p>

                <div class="form-group">
                    <label>New Date</label>
                    <input type="date" id="newDate">
                </div>

                <div class="form-group">
                    <label>Available Time Slots</label>
                    <div class="time-slots-grid" id="rescheduleSlots">
                        <p style="color: var(--text-muted);">Select a date to see available slots</p>
                    </div>
                </div>

                <input type="hidden" id="rescheduleBookingId">
                <input type="hidden" id="rescheduleSelectedSlot">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRescheduleBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmRescheduleBtn">Confirm Reschedule</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Welcome Form Overlay -->
    <div class="welcome-overlay" id="welcomeOverlay" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-header">
                <img src="../Logo.PNG" alt="Mind Core Fitness" class="welcome-logo">
                <h1>Welcome to Mind Core Fitness</h1>
                <p>Please complete this quick form to help us personalise your training experience</p>
            </div>

            <div class="welcome-progress">
                <div class="progress-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">About You</span>
                </div>
                <div class="progress-step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">Fitness Background</span>
                </div>
                <div class="progress-step" data-step="3">
                    <span class="step-number">3</span>
                    <span class="step-label">Your Goals</span>
                </div>
                <div class="progress-step" data-step="4">
                    <span class="step-number">4</span>
                    <span class="step-label">PAR-Q</span>
                </div>
            </div>

            <form id="welcomeForm">
                <!-- Step 1: About You -->
                <div class="welcome-step active" data-step="1">
                    <h2>About You</h2>

                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" id="dob" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Height</label>
                            <div class="input-with-unit">
                                <input type="number" id="height" placeholder="175">
                                <span class="unit">cm</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Weight</label>
                            <div class="input-with-unit">
                                <input type="number" id="weight" placeholder="70">
                                <span class="unit">kg</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="phone" placeholder="07XXX XXXXXX">
                    </div>

                    <div class="form-group">
                        <label>Emergency Contact Name *</label>
                        <input type="text" id="emergencyName" required placeholder="Full name">
                    </div>

                    <div class="form-group">
                        <label>Emergency Contact Phone *</label>
                        <input type="tel" id="emergencyPhone" required placeholder="07XXX XXXXXX">
                    </div>
                </div>

                <!-- Step 2: Fitness Background -->
                <div class="welcome-step" data-step="2">
                    <h2>Your Fitness Background</h2>

                    <div class="form-group">
                        <label>How would you describe your current fitness level? *</label>
                        <select id="fitnessLevel" required>
                            <option value="">Select an option</option>
                            <option value="beginner">Beginner - New to exercise or returning after a long break</option>
                            <option value="intermediate">Intermediate - Exercise regularly (1-3 times per week)</option>
                            <option value="advanced">Advanced - Very active (4+ times per week)</option>
                            <option value="athlete">Athlete - Competitive or professional sports background</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>What types of exercise have you done before? (Select all that apply)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="weights"> Weight Training
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="cardio"> Cardio (Running, Cycling, etc.)
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="hiit"> HIIT / Circuit Training
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="yoga"> Yoga / Pilates
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="sports"> Team Sports
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="swimming"> Swimming
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="martial-arts"> Martial Arts / Boxing
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="exerciseTypes" value="none"> None / Very Little
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Do you have any current injuries or physical limitations?</label>
                        <textarea id="injuries" rows="3" placeholder="Please describe any injuries, conditions, or areas of concern..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Have you worked with a personal trainer before?</label>
                        <select id="previousTrainer">
                            <option value="">Select an option</option>
                            <option value="no">No, this is my first time</option>
                            <option value="briefly">Yes, briefly (less than 3 months)</option>
                            <option value="yes">Yes, for an extended period</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Goals -->
                <div class="welcome-step" data-step="3">
                    <h2>Your Goals</h2>

                    <div class="form-group">
                        <label>What are your main fitness goals? (Select up to 3) *</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="weight-loss"> Weight Loss / Fat Loss
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="muscle-gain"> Build Muscle / Strength
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="tone"> Tone Up / Get Lean
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="endurance"> Improve Endurance / Stamina
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="flexibility"> Improve Flexibility / Mobility
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="health"> General Health & Wellbeing
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="sport"> Sport-Specific Performance
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="goals" value="rehab"> Injury Rehabilitation
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tell us more about what you want to achieve</label>
                        <textarea id="goalDetails" rows="3" placeholder="Any specific targets, events you're training for, or things you'd like to accomplish..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>How many times per week do you plan to train? *</label>
                        <select id="trainingFrequency" required>
                            <option value="">Select an option</option>
                            <option value="1">1 time per week</option>
                            <option value="2">2 times per week</option>
                            <option value="3">3 times per week</option>
                            <option value="4">4+ times per week</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Is there anything else you'd like us to know?</label>
                        <textarea id="additionalInfo" rows="3" placeholder="Dietary requirements, scheduling preferences, or anything else..."></textarea>
                    </div>
                </div>

                <!-- Step 4: PAR-Q -->
                <div class="welcome-step" data-step="4">
                    <h2>Physical Activity Readiness Questionnaire (PAR-Q)</h2>
                    <p class="parq-intro">For most people, physical activity should not pose a problem. This questionnaire has been designed to identify the small number of adults for whom physical activity might be inappropriate.</p>

                    <div class="parq-questions">
                        <div class="parq-question">
                            <label>1. Has your doctor ever said that you have a heart condition and that you should only do physical activity recommended by a doctor? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq1" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq1" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>2. Do you feel pain in your chest when you do physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq2" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq2" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>3. In the past month, have you had chest pain when you were not doing physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq3" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq3" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>4. Do you lose your balance because of dizziness or do you ever lose consciousness? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq4" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq4" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>5. Do you have a bone or joint problem that could be made worse by a change in your physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq5" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq5" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>6. Is your doctor currently prescribing drugs for your blood pressure or heart condition? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq6" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq6" value="no" required> No
                                </label>
                            </div>
                        </div>

                        <div class="parq-question">
                            <label>7. Do you know of any other reason why you should not do physical activity? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="parq7" value="yes" required> Yes
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="parq7" value="no" required> No
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="parqDetailsGroup" style="display: none;">
                        <label>Please provide details about your "Yes" answers:</label>
                        <textarea id="parqDetails" rows="3" placeholder="Please explain..."></textarea>
                    </div>

                    <div class="parq-declaration">
                        <label class="checkbox-item">
                            <input type="checkbox" id="parqConsent" required>
                            <span>I confirm that I have read, understood and completed this questionnaire honestly. I understand that if my health changes, I should inform my trainer immediately. *</span>
                        </label>
                    </div>
                </div>
            </form>

            <div class="welcome-footer">
                <button type="button" class="btn btn-secondary" id="welcomePrevBtn" style="display: none;">Previous</button>
                <button type="button" class="btn btn-primary" id="welcomeNextBtn">Next</button>
                <button type="button" class="btn btn-primary" id="welcomeSubmitBtn" style="display: none;">Submit</button>
            </div>
        </div>
    </div>

    <style>
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 10000;
            overflow-y: auto;
        }

        .welcome-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 24px;
        }

        .welcome-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .welcome-header p {
            color: var(--text-muted);
        }

        .welcome-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            position: relative;
        }

        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: calc(50% + 20px);
            width: calc(100% - 40px);
            height: 2px;
            background: #e0e0e0;
        }

        .progress-step.active:not(:last-child)::after,
        .progress-step.completed:not(:last-child)::after {
            background: var(--accent-color);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }

        .progress-step.active .step-number,
        .progress-step.completed .step-number {
            background: var(--accent-color);
            color: #ffffff;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        .progress-step.active .step-label {
            color: var(--accent-color);
            font-weight: 500;
        }

        .welcome-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .welcome-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-step h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 24px;
            color: var(--text-color);
        }

        .welcome-step .form-group {
            margin-bottom: 20px;
        }

        .welcome-step label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .welcome-step input[type="text"],
        .welcome-step input[type="email"],
        .welcome-step input[type="tel"],
        .welcome-step input[type="date"],
        .welcome-step input[type="number"],
        .welcome-step select,
        .welcome-step textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.2s ease;
        }

        .welcome-step input:focus,
        .welcome-step select:focus,
        .welcome-step textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-unit input {
            flex: 1;
        }

        .input-with-unit .unit {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-weight: 400;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--accent-color);
        }

        .radio-group {
            display: flex;
            gap: 24px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .parq-intro {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .parq-questions {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .parq-question {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .parq-question label {
            font-weight: 400;
            line-height: 1.4;
        }

        .parq-declaration {
            margin-top: 24px;
            padding: 20px;
            background: rgba(153, 49, 60, 0.05);
            border: 1px solid rgba(153, 49, 60, 0.2);
            border-radius: 8px;
        }

        .parq-declaration .checkbox-item span {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .welcome-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }

        .welcome-footer .btn {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .welcome-container {
                padding: 24px 16px;
            }

            .welcome-progress {
                padding: 0;
            }

            .step-label {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .progress-step:not(:last-child)::after {
                left: calc(50% + 16px);
                width: calc(100% - 32px);
            }
        }
    </style>

    <script src="../js/firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let currentUserId = null;
            let userSessionDuration = 30; // Default to 30 minutes, updated from user data
            let currentUserData = null; // Store user data globally for access in functions
            let userBlockEndDate = null; // Store block end date for banked session validation

            // Update banked sessions display
            function updateBankedSessionsDisplay(count) {
                const notice = document.getElementById('bankedSessionsNotice');
                const countEl = document.getElementById('bankedSessionsCount');
                if (count > 0) {
                    notice.style.display = 'flex';
                    countEl.textContent = count;
                } else {
                    notice.style.display = 'none';
                }
            }

            // Switch to Book/Reschedule section
            function switchToBookSection() {
                document.querySelectorAll('.client-nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('.client-nav-item[data-section="book"]').classList.add('active');
                document.querySelectorAll('.client-section').forEach(s => s.style.display = 'none');
                document.getElementById('section-book').style.display = 'block';
                document.querySelector('#section-book h2').textContent = 'Book Session';
            }

            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not logged in, redirect to login
                    window.location.href = '/dashboard/login.html';
                    return;
                }

                currentUserId = user.uid;

                // Check if admin - redirect to admin dashboard
                const role = await getUserRole(user.uid);
                if (role === 'admin') {
                    window.location.href = '/admin/index.html';
                    return;
                }

                // Get user data and display
                let userData = await getUserData(user.uid);

                // If no data found by UID, try finding by email (for fallback-created clients)
                if (!userData && user.email) {
                    try {
                        const querySnapshot = await db.collection('users')
                            .where('email', '==', user.email)
                            .where('role', '==', 'client')
                            .limit(1)
                            .get();

                        if (!querySnapshot.empty) {
                            const doc = querySnapshot.docs[0];
                            const oldDocId = doc.id;
                            userData = doc.data();

                            // Migrate the document to use the correct UID
                            // This ensures future lookups work correctly
                            await db.collection('users').doc(user.uid).set({
                                ...userData,
                                migratedFrom: oldDocId,
                                migratedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            // Also update any bookings that reference the old clientId
                            try {
                                const bookingsSnapshot = await db.collection('bookings')
                                    .where('clientId', '==', oldDocId)
                                    .get();

                                const batch = db.batch();
                                bookingsSnapshot.forEach(bookingDoc => {
                                    batch.update(bookingDoc.ref, { clientId: user.uid });
                                });
                                if (!bookingsSnapshot.empty) {
                                    await batch.commit();
                                    console.log(`Migrated ${bookingsSnapshot.size} bookings to new clientId`);
                                }
                            } catch (bookingError) {
                                console.error('Error migrating bookings:', bookingError);
                            }

                            // Delete the old document with wrong ID
                            await db.collection('users').doc(oldDocId).delete();
                        }
                    } catch (error) {
                        console.error('Error looking up user by email:', error);
                    }
                }

                if (userData) {
                    // Store user data globally for access in other functions
                    currentUserData = userData;
                    userBlockEndDate = userData.blockEndDate || null;

                    document.getElementById('userName').textContent = userData.name || 'Client';
                    document.getElementById('userEmail').textContent = user.email;

                    // Display block info from user data
                    if (userData.blockDuration) {
                        document.getElementById('blockDuration').textContent = userData.blockDuration;
                        userSessionDuration = parseInt(userData.blockDuration) || 30;
                    }
                    if (userData.blockEndDate) {
                        const endDate = new Date(userData.blockEndDate);
                        document.getElementById('blockEndDate').textContent = endDate.toLocaleDateString('en-GB', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        });
                    }

                    // Display banked sessions if any
                    const bankedSessions = userData.bankedSessions || 0;
                    updateBankedSessionsDisplay(bankedSessions);

                    // Check if onboarding is complete
                    if (!userData.onboardingComplete) {
                        showWelcomeForm();
                    }
                } else {
                    document.getElementById('userName').textContent = user.email.split('@')[0];
                    document.getElementById('userEmail').textContent = user.email;
                    // No user data means they definitely need onboarding
                    showWelcomeForm();
                }

                // Load user's upcoming sessions
                loadUserBookings();
            });

            // ==================
            // WELCOME FORM
            // ==================
            let currentStep = 1;
            const totalSteps = 4;

            function showWelcomeForm() {
                document.getElementById('welcomeOverlay').style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function hideWelcomeForm() {
                document.getElementById('welcomeOverlay').style.display = 'none';
                document.body.style.overflow = '';
            }

            function updateStepDisplay() {
                // Update progress steps
                document.querySelectorAll('.progress-step').forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    if (stepNum === currentStep) {
                        step.classList.add('active');
                    } else if (stepNum < currentStep) {
                        step.classList.add('completed');
                    }
                });

                // Update form steps
                document.querySelectorAll('.welcome-step').forEach(step => {
                    step.classList.remove('active');
                    if (parseInt(step.dataset.step) === currentStep) {
                        step.classList.add('active');
                    }
                });

                // Update buttons
                document.getElementById('welcomePrevBtn').style.display = currentStep > 1 ? 'block' : 'none';
                document.getElementById('welcomeNextBtn').style.display = currentStep < totalSteps ? 'block' : 'none';
                document.getElementById('welcomeSubmitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

                // Scroll to top of form (target the overlay which has overflow-y: auto)
                document.querySelector('.welcome-overlay').scrollTop = 0;
            }

            function validateCurrentStep() {
                const currentStepEl = document.querySelector(`.welcome-step[data-step="${currentStep}"]`);
                const requiredFields = currentStepEl.querySelectorAll('[required]');

                for (const field of requiredFields) {
                    if (field.type === 'radio') {
                        const radioGroup = currentStepEl.querySelectorAll(`input[name="${field.name}"]`);
                        const isChecked = Array.from(radioGroup).some(r => r.checked);
                        if (!isChecked) {
                            showToast('Please answer all required questions', 'error');
                            return false;
                        }
                    } else if (field.type === 'checkbox') {
                        if (!field.checked) {
                            showToast('Please confirm the declaration', 'error');
                            return false;
                        }
                    } else if (!field.value.trim()) {
                        field.focus();
                        showToast('Please fill in all required fields', 'error');
                        return false;
                    }
                }

                // Check goals limit (max 3) on step 3
                if (currentStep === 3) {
                    const selectedGoals = document.querySelectorAll('input[name="goals"]:checked');
                    if (selectedGoals.length === 0) {
                        showToast('Please select at least one fitness goal', 'error');
                        return false;
                    }
                    if (selectedGoals.length > 3) {
                        showToast('Please select a maximum of 3 goals', 'error');
                        return false;
                    }
                }

                return true;
            }

            // Goal checkbox limit
            document.querySelectorAll('input[name="goals"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checked = document.querySelectorAll('input[name="goals"]:checked');
                    if (checked.length > 3) {
                        this.checked = false;
                        showToast('Maximum 3 goals allowed', 'error');
                    }
                });
            });

            // PAR-Q yes answer detection
            document.querySelectorAll('.parq-question input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const hasYes = Array.from(document.querySelectorAll('.parq-question input[value="yes"]'))
                        .some(r => r.checked);
                    document.getElementById('parqDetailsGroup').style.display = hasYes ? 'block' : 'none';
                });
            });

            // Next button
            document.getElementById('welcomeNextBtn').addEventListener('click', function() {
                if (validateCurrentStep()) {
                    currentStep++;
                    updateStepDisplay();
                }
            });

            // Previous button
            document.getElementById('welcomePrevBtn').addEventListener('click', function() {
                currentStep--;
                updateStepDisplay();
            });

            // Submit button
            document.getElementById('welcomeSubmitBtn').addEventListener('click', async function() {
                if (!validateCurrentStep()) return;

                const submitBtn = this;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    // Collect all form data
                    const formData = {
                        // Personal info
                        dateOfBirth: document.getElementById('dob').value,
                        height: document.getElementById('height').value ? parseInt(document.getElementById('height').value) : null,
                        weight: document.getElementById('weight').value ? parseInt(document.getElementById('weight').value) : null,
                        phone: document.getElementById('phone').value.trim(),
                        emergencyContact: {
                            name: document.getElementById('emergencyName').value.trim(),
                            phone: document.getElementById('emergencyPhone').value.trim()
                        },

                        // Fitness background
                        fitnessLevel: document.getElementById('fitnessLevel').value,
                        exerciseTypes: Array.from(document.querySelectorAll('input[name="exerciseTypes"]:checked')).map(c => c.value),
                        injuries: document.getElementById('injuries').value.trim(),
                        previousTrainer: document.getElementById('previousTrainer').value,

                        // Goals
                        goals: Array.from(document.querySelectorAll('input[name="goals"]:checked')).map(c => c.value),
                        goalDetails: document.getElementById('goalDetails').value.trim(),
                        trainingFrequency: document.getElementById('trainingFrequency').value,
                        additionalInfo: document.getElementById('additionalInfo').value.trim(),

                        // PAR-Q
                        parq: {
                            q1: document.querySelector('input[name="parq1"]:checked')?.value === 'yes',
                            q2: document.querySelector('input[name="parq2"]:checked')?.value === 'yes',
                            q3: document.querySelector('input[name="parq3"]:checked')?.value === 'yes',
                            q4: document.querySelector('input[name="parq4"]:checked')?.value === 'yes',
                            q5: document.querySelector('input[name="parq5"]:checked')?.value === 'yes',
                            q6: document.querySelector('input[name="parq6"]:checked')?.value === 'yes',
                            q7: document.querySelector('input[name="parq7"]:checked')?.value === 'yes',
                            details: document.getElementById('parqDetails').value.trim(),
                            consentGiven: document.getElementById('parqConsent').checked,
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },

                        // Metadata
                        onboardingComplete: true,
                        onboardingCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Save to Firestore (use set with merge to create doc if it doesn't exist)
                    await db.collection('users').doc(currentUserId).set(formData, { merge: true });

                    showToast('Welcome form completed successfully!');
                    hideWelcomeForm();

                } catch (error) {
                    console.error('Error saving welcome form:', error);
                    showToast('Failed to save form. Please try again.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            });

            // Toast notification
            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                logout();
            });

            // Navigation
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;

                    document.querySelectorAll('.client-nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.client-section').forEach(s => s.style.display = 'none');
                    document.getElementById('section-' + section).style.display = 'block';
                });
            });

            // Render week view
            function renderWeekView() {
                const container = document.getElementById('weekView');
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const isToday = date.toDateString() === today.toDateString();

                    html += `
                        <div class="week-day ${isToday ? 'selected' : ''}">
                            <div class="week-day-name">${DAYS_SHORT[date.getDay()]}</div>
                            <div class="week-day-date">${date.getDate()}</div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            }

            renderWeekView();

            // ==================
            // LOAD USER DATA & SESSIONS
            // ==================

            let userBookings = [];

            // Load user's upcoming sessions from bookings collection
            async function loadUserBookings() {
                if (!currentUserId) {
                    console.log('No currentUserId, skipping booking load');
                    return;
                }

                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayStr = today.toISOString().split('T')[0];

                    console.log('Loading bookings for userId:', currentUserId);

                    // First try to find bookings by clientId (UID)
                    let snapshot = await db.collection('bookings')
                        .where('clientId', '==', currentUserId)
                        .get();

                    console.log('Bookings found by UID:', snapshot.size);

                    // If no bookings found by UID, try finding by email
                    if (snapshot.empty && auth.currentUser && auth.currentUser.email) {
                        console.log('No bookings by UID, trying email:', auth.currentUser.email);
                        snapshot = await db.collection('bookings')
                            .where('clientEmail', '==', auth.currentUser.email)
                            .get();
                        console.log('Bookings found by email:', snapshot.size);

                        // If found by email, update these bookings to use correct clientId
                        if (!snapshot.empty) {
                            console.log('Migrating bookings to correct clientId...');
                            const batch = db.batch();
                            snapshot.forEach(doc => {
                                batch.update(doc.ref, { clientId: currentUserId });
                            });
                            await batch.commit();
                            console.log('Bookings migrated successfully');
                        }
                    }

                    userBookings = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Only include confirmed bookings with future dates
                        if (data.status !== 'cancelled' && data.date >= todayStr) {
                            userBookings.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });

                    // Sort by date and time
                    userBookings.sort((a, b) => {
                        const dateCompare = a.date.localeCompare(b.date);
                        if (dateCompare !== 0) return dateCompare;
                        return (a.time || '00:00').localeCompare(b.time || '00:00');
                    });

                    console.log('Upcoming sessions found:', userBookings.length);
                    if (userBookings.length > 0) {
                        console.log('Next session:', userBookings[0].date, userBookings[0].time);
                    }

                    // Update displays
                    displayNextSession();
                    displayUpcomingSessions();
                    updateWeekViewWithSessions();

                } catch (error) {
                    console.error('Error loading user bookings:', error);
                    // Show error to user if it's an index issue
                    if (error.message && error.message.includes('index')) {
                        console.error('Firestore index may be required. Check Firebase console.');
                    }
                }
            }

            // Display the next upcoming session
            function displayNextSession() {
                const nextSessionCard = document.getElementById('nextSessionCard');
                const nextSessionDate = document.getElementById('nextSessionDate');
                const nextSessionTime = document.getElementById('nextSessionTime');
                const actionsContainer = document.getElementById('nextSessionActions');
                const rescheduleBtn = document.getElementById('rescheduleNextBtn');
                const cancelBtn = document.getElementById('cancelNextBtn');

                if (userBookings.length === 0) {
                    nextSessionDate.textContent = 'No upcoming sessions';
                    nextSessionTime.textContent = '';
                    actionsContainer.style.display = 'none';
                    return;
                }

                const nextBooking = userBookings[0];
                const sessionDate = new Date(nextBooking.date + 'T00:00:00');

                // Format date nicely
                const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                nextSessionDate.textContent = sessionDate.toLocaleDateString('en-GB', dateOptions);

                // Format time
                if (nextBooking.time) {
                    const [hours, minutes] = nextBooking.time.split(':');
                    const timeDate = new Date();
                    timeDate.setHours(parseInt(hours), parseInt(minutes));
                    nextSessionTime.textContent = timeDate.toLocaleTimeString('en-GB', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                } else {
                    nextSessionTime.textContent = 'Time TBC';
                }

                // Show action buttons and store booking ID
                actionsContainer.style.display = 'flex';
                rescheduleBtn.dataset.bookingId = nextBooking.id;
                cancelBtn.dataset.bookingId = nextBooking.id;
            }

            // Display list of upcoming sessions
            function displayUpcomingSessions() {
                const sessionsList = document.getElementById('sessionsList');

                if (userBookings.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="empty-state">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                            </svg>
                            <h4>No upcoming sessions</h4>
                            <p>Your trainer will schedule your sessions soon!</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                userBookings.forEach(booking => {
                    const sessionDate = new Date(booking.date + 'T00:00:00');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                    // Format time
                    let timeStr = 'Time TBC';
                    if (booking.time) {
                        const [hours, minutes] = booking.time.split(':');
                        const timeDate = new Date();
                        timeDate.setHours(parseInt(hours), parseInt(minutes));
                        timeStr = timeDate.toLocaleTimeString('en-GB', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                    }

                    // Duration
                    const duration = parseInt(booking.duration) || 60;

                    html += `
                        <div class="session-card" data-booking-id="${booking.id}">
                            <div class="session-date-box">
                                <div class="month">${monthNames[sessionDate.getMonth()]}</div>
                                <div class="day">${sessionDate.getDate()}</div>
                            </div>
                            <div class="session-details">
                                <h4>${dayNames[sessionDate.getDay()]}</h4>
                                <p>${timeStr} - ${duration} minutes</p>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-sm btn-primary" onclick="startReschedule('${booking.id}')">Reschedule</button>
                                <button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}')">Cancel</button>
                            </div>
                        </div>
                    `;
                });

                sessionsList.innerHTML = html;
            }

            // Update week view to show sessions
            function updateWeekViewWithSessions() {
                const container = document.getElementById('weekView');
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());

                // Create a set of dates that have sessions
                const sessionDates = new Set();
                userBookings.forEach(booking => {
                    sessionDates.add(booking.date);
                });

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = date.toDateString() === today.toDateString();
                    const hasSession = sessionDates.has(dateStr);

                    html += `
                        <div class="week-day ${isToday ? 'selected' : ''} ${hasSession ? 'has-session' : ''}">
                            <div class="week-day-name">${DAYS_SHORT[date.getDay()]}</div>
                            <div class="week-day-date">${date.getDate()}</div>
                            ${hasSession ? '<div class="week-day-dot"></div>' : ''}
                        </div>
                    `;
                }
                container.innerHTML = html;
            }

            // ==================
            // BOOKING CALENDAR
            // ==================

            let calendarDate = new Date();
            let selectedDate = null;
            let availableSlots = [];
            let trainerAvailability = null;
            let rescheduleMode = false;
            let rescheduleBookingId = null;

            // Load trainer availability
            async function loadTrainerAvailability() {
                try {
                    // Get the admin/trainer's availability
                    const adminsSnapshot = await db.collection('users')
                        .where('role', '==', 'admin')
                        .limit(1)
                        .get();

                    if (!adminsSnapshot.empty) {
                        const adminId = adminsSnapshot.docs[0].id;
                        const availDoc = await db.collection('availability').doc(adminId).get();
                        if (availDoc.exists) {
                            trainerAvailability = availDoc.data();
                            console.log('Loaded trainer availability');
                        }
                    }
                } catch (error) {
                    console.error('Error loading trainer availability:', error);
                }
            }

            // Render the booking calendar
            function renderBookingCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthLabel = document.getElementById('calendarMonth');

                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();

                // Update month label
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                monthLabel.textContent = `${monthNames[month]} ${year}`;

                // Get first day of month and total days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Create set of dates with sessions
                const sessionDates = new Set();
                userBookings.forEach(booking => {
                    sessionDates.add(booking.date);
                });

                // Build calendar HTML
                let html = '';

                // Day headers (weekdays only: Monday to Friday)
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                dayNames.forEach(day => {
                    html += `<div class="calendar-day-header">${day}</div>`;
                });

                // Find the first weekday of the month
                // Convert Sunday=0...Saturday=6 to Monday=0...Friday=4 (skip weekends)
                let firstWeekday = firstDay;
                // If first day is Sunday (0), first weekday is Monday (day 2)
                // If first day is Saturday (6), first weekday is Monday (day 3)
                let firstWeekdayDate = 1;
                if (firstDay === 0) {
                    firstWeekdayDate = 2; // Skip Sunday, start Monday
                } else if (firstDay === 6) {
                    firstWeekdayDate = 3; // Skip Saturday and Sunday, start Monday
                }

                // Calculate which column (Mon=0, Tue=1, Wed=2, Thu=3, Fri=4) the first weekday falls on
                const firstWeekdayColumn = firstDay === 0 ? 0 : (firstDay === 6 ? 0 : firstDay - 1);

                // Empty cells before first weekday
                for (let i = 0; i < firstWeekdayColumn; i++) {
                    html += '<div class="calendar-day empty"></div>';
                }

                // Days of month (only weekdays)
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();

                    // Skip weekends (Saturday = 6, Sunday = 0)
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        continue;
                    }

                    const dateStr = date.toISOString().split('T')[0];
                    const isPast = date < today;
                    const isToday = date.toDateString() === today.toDateString();
                    const hasSession = sessionDates.has(dateStr);
                    const isSelected = selectedDate === dateStr;

                    // Check if trainer is available on this day
                    let isAvailable = false;
                    if (trainerAvailability && trainerAvailability.schedule && trainerAvailability.schedule[dayOfWeek]) {
                        const daySchedule = trainerAvailability.schedule[dayOfWeek];
                        isAvailable = daySchedule.slots && daySchedule.slots.length > 0;
                    }

                    // Check if blocked
                    let isBlocked = false;
                    if (trainerAvailability && trainerAvailability.blockedTimes) {
                        isBlocked = trainerAvailability.blockedTimes.some(bt =>
                            bt.date === dateStr && bt.allDay
                        );
                    }

                    const classes = ['calendar-day'];
                    if (isPast) classes.push('past');
                    if (isToday) classes.push('today');
                    if (hasSession) classes.push('has-session');
                    if (isSelected) classes.push('selected');
                    if (!isPast && isAvailable && !isBlocked) classes.push('available');

                    html += `
                        <div class="${classes.join(' ')}" data-date="${dateStr}" ${isPast ? '' : 'onclick="selectBookingDate(\'' + dateStr + '\')"'}>
                            <span class="day-number">${day}</span>
                            ${hasSession ? '<span class="session-dot"></span>' : ''}
                        </div>
                    `;
                }

                grid.innerHTML = html;
            }

            // Select a date for booking/rescheduling
            window.selectBookingDate = async function(dateStr) {
                selectedDate = dateStr;
                renderBookingCalendar();

                // Only show reschedule info if already in reschedule mode (user clicked reschedule button)
                // Don't auto-enter reschedule mode when browsing dates

                // Show the slots container
                const slotsContainer = document.getElementById('slotsContainer');
                slotsContainer.style.display = 'block';

                // Update date display
                const date = new Date(dateStr + 'T00:00:00');
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('selectedDateDisplay').textContent = date.toLocaleDateString('en-GB', options);

                // Generate available time slots
                await generateTimeSlots(dateStr);
            };

            // Generate time slots for selected date
            async function generateTimeSlots(dateStr) {
                const slotsBody = document.getElementById('slotsBody');
                slotsBody.innerHTML = '<p style="color: var(--text-muted);">Loading available times...</p>';

                const date = new Date(dateStr + 'T00:00:00');
                const dayOfWeek = date.getDay();

                // Get trainer's schedule for this day
                let daySchedule = null;
                if (trainerAvailability && trainerAvailability.schedule && trainerAvailability.schedule[dayOfWeek]) {
                    daySchedule = trainerAvailability.schedule[dayOfWeek];
                }

                if (!daySchedule || !daySchedule.slots || daySchedule.slots.length === 0) {
                    slotsBody.innerHTML = '<p style="color: var(--text-muted);">No available times on this day</p>';
                    return;
                }

                // Get existing bookings for this date
                const existingBookings = await db.collection('bookings')
                    .where('date', '==', dateStr)
                    .get();

                const bookedTimes = [];
                existingBookings.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'cancelled') {
                        bookedTimes.push({
                            time: data.time,
                            duration: data.duration || 30,
                            isOwn: data.clientId === currentUserId,
                            bookingId: doc.id
                        });
                    }
                });

                // Get blocked times for this date
                const blockedTimes = [];
                if (trainerAvailability && trainerAvailability.blockedTimes) {
                    trainerAvailability.blockedTimes.forEach(bt => {
                        if (bt.date === dateStr && !bt.allDay) {
                            blockedTimes.push({ start: bt.startTime, end: bt.endTime });
                        }
                    });
                }

                // Generate slots from schedule using 15-minute increments
                let html = '';
                const slotIncrement = 15; // 15 minute increments
                const sessionDuration = userSessionDuration; // User's session duration (30 or 45 mins)

                // Check if the selected date is today and calculate min allowed time
                const todayStr = new Date().toISOString().split('T')[0];
                const isToday = dateStr === todayStr;
                let minAllowedMinutes = 0;
                if (isToday) {
                    const now = new Date();
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();
                    // Round up to the next 15-minute slot + 15 min buffer
                    minAllowedMinutes = Math.ceil((currentMinutes + 15) / 15) * 15;
                }

                daySchedule.slots.forEach(slot => {
                    const [startHour, startMin] = slot.start.split(':').map(Number);
                    const [endHour, endMin] = slot.end.split(':').map(Number);
                    const availStartMinutes = startHour * 60 + startMin;
                    const availEndMinutes = endHour * 60 + endMin;

                    // Generate 15-minute increment slots
                    for (let time = availStartMinutes; time + sessionDuration <= availEndMinutes; time += slotIncrement) {
                        const hour = Math.floor(time / 60);
                        const min = time % 60;
                        const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                        const slotEndTime = time + sessionDuration;

                        // Check if this is the user's own booking
                        const ownBooking = bookedTimes.find(bt => bt.time === timeStr && bt.isOwn);

                        // Check if slot would overlap with any OTHER booking
                        const overlapsOtherBooking = bookedTimes.some(bt => {
                            if (bt.isOwn) return false; // Don't count own booking as conflict
                            const [btH, btM] = bt.time.split(':').map(Number);
                            const bookingStart = btH * 60 + btM;
                            const bookingDuration = parseInt(bt.duration) || 60;
                            const bookingEnd = bookingStart + bookingDuration;
                            // Check if proposed session [time, time+sessionDuration] overlaps [bookingStart, bookingEnd]
                            return time < bookingEnd && slotEndTime > bookingStart;
                        });

                        // Check if blocked
                        const isBlocked = blockedTimes.some(bt => {
                            const [bsH, bsM] = bt.start.split(':').map(Number);
                            const [beH, beM] = bt.end.split(':').map(Number);
                            const blockStart = bsH * 60 + bsM;
                            const blockEnd = beH * 60 + beM;
                            return time < blockEnd && slotEndTime > blockStart;
                        });

                        // Check if this time has already passed today
                        const isPastTime = isToday && time < minAllowedMinutes;

                        // Format display time
                        const displayDate = new Date();
                        displayDate.setHours(hour, min);
                        const displayTime = displayDate.toLocaleTimeString('en-GB', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });

                        let slotClass = 'slot-item';
                        let statusText = '';
                        let clickable = false;

                        if (ownBooking) {
                            // User's own booking - show as current session, clickable if in reschedule mode
                            slotClass += ' booked own-booking';
                            statusText = '<span class="slot-status your-session">Your Session</span>';
                            clickable = rescheduleMode; // Allow clicking to keep same time in reschedule mode
                        } else if (isPastTime) {
                            slotClass += ' unavailable past-time';
                            statusText = '<span class="slot-status unavailable">Passed</span>';
                        } else if (overlapsOtherBooking || isBlocked) {
                            slotClass += ' unavailable';
                            statusText = '<span class="slot-status unavailable">Unavailable</span>';
                        } else {
                            slotClass += ' available';
                            statusText = '<span class="slot-status available">Available</span>';
                            clickable = true;
                        }

                        html += `
                            <div class="${slotClass}" ${clickable ? `onclick="selectTimeSlot('${dateStr}', '${timeStr}')"` : ''}>
                                <span class="slot-time">${displayTime}</span>
                                ${statusText}
                            </div>
                        `;
                    }
                });

                if (html === '') {
                    html = '<p style="color: var(--text-muted);">No available times on this day</p>';
                }

                slotsBody.innerHTML = html;
            }

            // Select a time slot for booking
            window.selectTimeSlot = async function(dateStr, timeStr) {
                if (rescheduleMode && rescheduleBookingId) {
                    // Reschedule existing booking
                    if (confirm(`Reschedule your session to ${dateStr} at ${timeStr}?`)) {
                        try {
                            await db.collection('bookings').doc(rescheduleBookingId).update({
                                date: dateStr,
                                time: timeStr,
                                rescheduledAt: firebase.firestore.FieldValue.serverTimestamp(),
                                rescheduledBy: 'client'
                            });
                            showToast('Session rescheduled successfully!');
                            rescheduleMode = false;
                            rescheduleBookingId = null;

                            // Reload bookings and update displays
                            await loadUserBookings();
                            renderBookingCalendar();
                            await generateTimeSlots(dateStr);
                        } catch (error) {
                            console.error('Error rescheduling:', error);
                            showToast('Failed to reschedule. Please try again.', 'error');
                        }
                    }
                } else {
                    // Check if user has banked sessions available
                    const bankedSessions = currentUserData?.bankedSessions || 0;

                    if (bankedSessions > 0) {
                        // Check if within block end date
                        let withinBlockPeriod = true;
                        if (userBlockEndDate) {
                            const blockEnd = new Date(userBlockEndDate);
                            const bookingDate = new Date(dateStr);
                            withinBlockPeriod = bookingDate <= blockEnd;
                        }

                        if (!withinBlockPeriod) {
                            showToast('This date is outside your training block period.', 'error');
                            return;
                        }

                        // Confirm booking with banked session
                        const bookingDateFormatted = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-GB', {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long'
                        });
                        const [hours, minutes] = timeStr.split(':');
                        const timeDate = new Date();
                        timeDate.setHours(parseInt(hours), parseInt(minutes));
                        const timeFormatted = timeDate.toLocaleTimeString('en-GB', { hour: 'numeric', minute: '2-digit', hour12: true });

                        if (confirm(`Book your session on ${bookingDateFormatted} at ${timeFormatted}?\n\nThis will use one of your ${bankedSessions} banked session(s).`)) {
                            try {
                                // Create the new booking
                                await db.collection('bookings').add({
                                    clientId: currentUserId,
                                    clientName: currentUserData?.name || 'Client',
                                    clientEmail: auth.currentUser?.email || '',
                                    date: dateStr,
                                    time: timeStr,
                                    duration: userSessionDuration,
                                    status: 'confirmed',
                                    isRecurring: false,
                                    bookedFromBankedSession: true,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    createdBy: currentUserId
                                });

                                // Decrement banked sessions
                                await db.collection('users').doc(currentUserId).update({
                                    bankedSessions: firebase.firestore.FieldValue.increment(-1)
                                });

                                // Update local display
                                const newBankedCount = bankedSessions - 1;
                                if (currentUserData) {
                                    currentUserData.bankedSessions = newBankedCount;
                                }
                                updateBankedSessionsDisplay(newBankedCount);

                                showToast('Session booked successfully!', 'success');

                                // Reload bookings and update displays
                                await loadUserBookings();
                                renderBookingCalendar();
                                await generateTimeSlots(dateStr);
                            } catch (error) {
                                console.error('Error booking session:', error);
                                showToast('Failed to book session. Please try again.', 'error');
                            }
                        }
                    } else {
                        // No banked sessions available
                        showToast('Please contact your trainer to book additional sessions.', 'info');
                    }
                }
            };

            // Start reschedule mode
            window.startReschedule = function(bookingId) {
                rescheduleMode = true;
                rescheduleBookingId = bookingId;

                // Find the booking
                const booking = userBookings.find(b => b.id === bookingId);
                if (booking) {
                    // Switch to Book/Reschedule tab
                    document.querySelectorAll('.client-nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelector('.client-nav-item[data-section="book"]').classList.add('active');
                    document.querySelectorAll('.client-section').forEach(s => s.style.display = 'none');
                    document.getElementById('section-book').style.display = 'block';

                    // Update heading
                    document.querySelector('#section-book h2').textContent = `Reschedule Session (${booking.date})`;

                    showToast('Select a new date and time for your session', 'info');
                }
            };

            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', function() {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderBookingCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', function() {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderBookingCalendar();
            });

            // Reschedule button on next session card
            document.getElementById('rescheduleNextBtn').addEventListener('click', function() {
                const bookingId = this.dataset.bookingId;
                if (bookingId) {
                    startReschedule(bookingId);
                }
            });

            // Cancel button on next session card
            document.getElementById('cancelNextBtn').addEventListener('click', function() {
                const bookingId = this.dataset.bookingId;
                if (bookingId) {
                    cancelBooking(bookingId);
                }
            });

            // Cancel booking function for clients
            window.cancelBooking = async function(bookingId) {
                const booking = userBookings.find(b => b.id === bookingId);
                if (!booking) {
                    showToast('Session not found', 'error');
                    return;
                }

                // Format date and time for confirmation
                const sessionDate = new Date(booking.date + 'T00:00:00');
                const dateStr = sessionDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
                let timeStr = booking.time || 'TBC';
                if (booking.time) {
                    const [hours, minutes] = booking.time.split(':');
                    const timeDate = new Date();
                    timeDate.setHours(parseInt(hours), parseInt(minutes));
                    timeStr = timeDate.toLocaleTimeString('en-GB', { hour: 'numeric', minute: '2-digit', hour12: true });
                }

                // Check if cancellation is within block end date for banked session
                let canBankSession = false;
                if (userBlockEndDate) {
                    const blockEnd = new Date(userBlockEndDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    canBankSession = today <= blockEnd;
                }

                const confirmMessage = canBankSession
                    ? `Are you sure you want to cancel your session on ${dateStr} at ${timeStr}?\n\nYou will receive a banked session credit that you can use to book a new time within your training block.`
                    : `Are you sure you want to cancel your session on ${dateStr} at ${timeStr}?\n\nThis action cannot be undone.`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    // Update the booking status to cancelled
                    await db.collection('bookings').doc(bookingId).update({
                        status: 'cancelled',
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        cancelledBy: 'client'
                    });

                    // Add banked session credit if within block period
                    if (canBankSession && currentUserId) {
                        await db.collection('users').doc(currentUserId).update({
                            bankedSessions: firebase.firestore.FieldValue.increment(1)
                        });

                        // Update local display
                        const newBankedCount = (currentUserData?.bankedSessions || 0) + 1;
                        if (currentUserData) {
                            currentUserData.bankedSessions = newBankedCount;
                        }
                        updateBankedSessionsDisplay(newBankedCount);

                        showToast('Session cancelled. You have a banked session to reschedule!', 'success');
                    } else {
                        showToast('Session cancelled successfully');
                    }

                    // Reload bookings and update displays
                    await loadUserBookings();
                    renderBookingCalendar();

                    // If on the slots view, refresh it
                    if (selectedDate) {
                        await generateTimeSlots(selectedDate);
                    }
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    showToast('Failed to cancel session. Please try again.', 'error');
                }
            };

            // Initialize calendar when switching to Book section
            document.querySelector('.client-nav-item[data-section="book"]').addEventListener('click', async function() {
                if (!trainerAvailability) {
                    await loadTrainerAvailability();
                }
                renderBookingCalendar();
            });

            // Load trainer availability on page load
            loadTrainerAvailability();

        });
    </script>

    <style>
        /* Calendar styles for client dashboard */
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 8px 0;
            text-transform: uppercase;
        }

        #calendarGrid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            background: #f9f9f9;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.past {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .calendar-day.today {
            border: 2px solid var(--accent-color);
        }

        .calendar-day.available:not(.past):hover {
            background: rgba(45, 138, 78, 0.1);
            border-color: var(--success-color);
        }

        .calendar-day.has-session {
            background: rgba(45, 138, 78, 0.15);
        }

        .calendar-day.selected {
            background: var(--accent-color);
            color: #ffffff;
        }

        .calendar-day .day-number {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-day .session-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
            position: absolute;
            bottom: 4px;
        }

        .calendar-day.selected .session-dot {
            background: #ffffff;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .calendar-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin: 0;
        }

        .calendar-nav button {
            background: #f0f0f0;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease;
        }

        .calendar-nav button:hover {
            background: #e0e0e0;
        }

        .slot-item {
            cursor: pointer;
        }

        .slot-item.available:hover {
            transform: translateX(4px);
        }
    </style>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
